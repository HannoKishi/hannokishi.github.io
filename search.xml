<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Libgoåç¨‹åº“</title>
    <url>/2022/01/19/Libgo%E5%8D%8F%E7%A8%8B%E5%BA%93/</url>
    <content><![CDATA[<hr>
<p>libgoæœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š<br>1.æä¾›golangä¸€èˆ¬åŠŸèƒ½å¼ºå¤§åç¨‹ï¼ŒåŸºäºcorontineç¼–å†™ä»£ç ï¼Œå¯ä»¥ä»¥åŒæ­¥çš„æ–¹å¼ç¼–å†™ç®€å•çš„ä»£ç ï¼ŒåŒæ—¶è·å¾—å¼‚æ­¥çš„æ€§èƒ½<br>2.æ”¯æŒæµ·é‡åç¨‹, åˆ›å»º100ä¸‡ä¸ªåç¨‹åªéœ€ä½¿ç”¨2GBç‰©ç†å†…å­˜<br>3.å…è®¸ç”¨æˆ·è‡ªç”±æ§åˆ¶åç¨‹è°ƒåº¦ç‚¹ï¼Œéšæ—¶éšåœ°å˜æ›´è°ƒåº¦çº¿ç¨‹æ•°<br>4.æ”¯æŒå¤šçº¿ç¨‹è°ƒåº¦åç¨‹ï¼Œææ˜“ç¼–å†™å¹¶è¡Œä»£ç ï¼Œé«˜æ•ˆçš„å¹¶è¡Œè°ƒåº¦ç®—æ³•ï¼Œå¯ä»¥æœ‰æ•ˆåˆ©ç”¨å¤šä¸ªCPUæ ¸å¿ƒ<br>5.å¯ä»¥è®©é“¾æ¥è¿›ç¨‹åºçš„åŒæ­¥çš„ç¬¬ä¸‰æ–¹åº“å˜ä¸ºå¼‚æ­¥è°ƒç”¨ï¼Œå¤§å¤§æå‡å…¶æ€§èƒ½ã€‚å†ä¹Ÿä¸ç”¨æ‹…å¿ƒæŸäº›DBå®˜æ–¹ä¸æä¾›å¼‚æ­¥driveräº†ï¼Œæ¯”å¦‚hiredisã€mysqlclientè¿™ç§å®¢æˆ·ç«¯é©±åŠ¨å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œå¹¶ä¸”å¯ä»¥å¾—åˆ°ä¸è¾“äºå¼‚æ­¥driverçš„æ€§èƒ½<br>6.åŠ¨æ€é“¾æ¥å’Œé™æ€é“¾æ¥å…¨éƒ½æ”¯æŒï¼Œä¾¿äºä½¿ç”¨C++11çš„ç”¨æˆ·é™æ€é“¾æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶å¹¶éƒ¨ç½²è‡³ä½ç‰ˆæœ¬çš„linuxç³»ç»Ÿä¸Š<br>7.æä¾›åç¨‹é”(co_mutex), å®šæ—¶å™¨, channelç­‰ç‰¹æ€§, å¸®åŠ©ç”¨æˆ·æ›´åŠ å®¹æ˜“åœ°ç¼–å†™ç¨‹åº.<br>8.ç½‘ç»œæ€§èƒ½å¼ºåŠ²ï¼Œè¶…è¶Šboost.asioå¼‚æ­¥æ¨¡å‹ï¼›å°¤å…¶åœ¨å¤„ç†å°åŒ…å’Œå¤šçº¿ç¨‹å¹¶è¡Œæ–¹é¢éå¸¸å¼ºå¤§ã€‚</p>
<span id="more"></span>
<!-- toc -->

<p>[toc]</p>
<p><a href="https://github.com/yyzybb537/libgo/tree/master">å‚è€ƒæ•™ç¨‹1</a><br><a href="https://gitee.com/lwj8507/libgo">å‚è€ƒæ•™ç¨‹2</a></p>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/yyzybb537/libgo.git</span><br><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line">cmake ..</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘é‡åˆ°äº†ä¸€ä¸ªç¼–è¯‘é”™è¯¯:å¤§æ¦‚æ„æ€æ˜¯ atomicç±»å‹çš„æ‹·è´æ„é€ è¢«åˆ é™¤äº†<br>æ‰‹åŠ¨ç»™ VntValueTypeæ·»åŠ ä¸€ä¸ªé»˜è®¤æ„é€ å‡½æ•°è§£å†³</p>
<h2 id="é“¾æ¥"><a href="#é“¾æ¥" class="headerlink" title="é“¾æ¥"></a>é“¾æ¥</h2><ul>
<li>é™æ€é“¾æ¥<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">g++ -std=c++11 sample1_go.cpp -llibgo -static -static-libgcc -static-libstdc++ -ldl -lpthread -lc</span><br><span class="line"></span><br><span class="line">g++ -static -static-libstdc++ -static-libgcc -lc -llibgo sample1_go.cpp -lpthread -std=c++11</span><br><span class="line"></span><br><span class="line">g++ -std=c++11 test.cpp -llibgo -Wl,--whole-archive -lstatic_hook -lc -lpthread -Wl,--no-whole-archive [-lother_libs] -static</span><br></pre></td></tr></table></figure></li>
<li> åŠ¨æ€é“¾æ¥<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">g++ -std=c++11 sample1_go.cpp -llibgo -ldl -pthread -std=c++11</span><br></pre></td></tr></table></figure></li>
<li>æ£€æŸ¥æ˜¯å¦æ˜¯é™æ€é“¾æ¥<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ldd a.out </span><br><span class="line">not a dynamic executable</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="åç¨‹çš„åˆ›å»º"><a href="#åç¨‹çš„åˆ›å»º" class="headerlink" title="åç¨‹çš„åˆ›å»º"></a>åç¨‹çš„åˆ›å»º</h2><h3 id="åç¨‹ä¸è°ƒåº¦å™¨"><a href="#åç¨‹ä¸è°ƒåº¦å™¨" class="headerlink" title="åç¨‹ä¸è°ƒåº¦å™¨"></a>åç¨‹ä¸è°ƒåº¦å™¨</h3><p>ä½¿ç”¨å…³é”®å­—goåˆ›å»ºåç¨‹, goåé¢å¯ä»¥ä½¿ç”¨:</p>
<ol>
<li>void(*)()å‡½æ•°æŒ‡é’ˆ, æ¯”å¦‚:foo.<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">go foo;</span><br></pre></td></tr></table></figure></li>
<li>ä¹Ÿå¯ä»¥ä½¿ç”¨æ— å‚æ•°çš„lambda, std::bindå¯¹è±¡, functionå¯¹è±¡,<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">go []&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;lambda\n&quot;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li>ä»¥åŠä¸€åˆ‡å¯ä»¥æ— å‚è°ƒç”¨çš„ä»¿å‡½æ•°å¯¹è±¡<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">std::function&lt;<span class="title">void</span><span class="params">()</span>&gt; <span class="title">fn</span><span class="params">(std::bind(&amp;A::fB, A()))</span></span>;</span><br><span class="line">go fn;</span><br></pre></td></tr></table></figure></li>
</ol>
<ul>
<li><p>ä¹Ÿå¯ä»¥ä½¿ç”¨go_stackåˆ›å»ºæŒ‡å®šæ ˆå¤§å°çš„åç¨‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//   åˆ›å»ºæ‹¥æœ‰10MBå¤§æ ˆçš„åç¨‹</span><br><span class="line">go co_stack(10 * 1024 * 1024) []&#123;</span><br><span class="line">	printf(&quot;large stack\n&quot;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>æ³¨æ„</code>ï¼šåç¨‹åˆ›å»ºä»¥åä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯æš‚å­˜è‡³å¯æ‰§è¡Œåˆ—è¡¨ä¸­ï¼Œç­‰å¾…è°ƒåº¦å™¨è°ƒåº¦ã€‚<code>co_sched</code>æ˜¯é»˜è®¤çš„åç¨‹è°ƒåº¦å™¨ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªåˆ›å»ºçš„åç¨‹è°ƒåº¦å™¨ã€‚å½“ä»…ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œåç¨‹è°ƒåº¦æ—¶, åç¨‹åœ°æ‰§è¡Œä¼šä¸¥æ ¼åœ°éµå¾ªå…¶åˆ›å»ºé¡ºåº.</p>
</li>
<li><p>ä»…ä½¿ç”¨ä¸»çº¿ç¨‹è°ƒåº¦åç¨‹.</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">co_sched.<span class="built_in">Start</span>();</span><br></pre></td></tr></table></figure></li>
<li><p>ä»¥ä¸‹ä»£ç å¯ä»¥ä½¿ç”¨ç­‰åŒäºcpuæ ¸å¿ƒæ•°çš„çº¿ç¨‹è°ƒåº¦åç¨‹.(åŒ…æ‹¬ä¸»çº¿ç¨‹)</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">co_sched.<span class="built_in">Start</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure></li>
<li><p>ä»¥ä¸‹ä»£ç å…è®¸è°ƒåº¦å™¨è‡ªç”±æ‰©å±•çº¿ç¨‹æ•°ï¼Œä¸Šé™ä¸º1024.</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"> <span class="comment">// å½“æœ‰çº¿ç¨‹è¢«åç¨‹é˜»å¡æ—¶, è°ƒåº¦å™¨ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„çº¿ç¨‹, ä»¥æ­¤ä¿éšœ</span></span><br><span class="line"> <span class="comment">// å¯ç”¨çº¿ç¨‹æ•°æ€»æ˜¯ç­‰äºStartçš„ç¬¬ä¸€ä¸ªå‚æ•°(0è¡¨ç¤ºcpuæ ¸å¿ƒæ•°).</span></span><br><span class="line">co_sched.<span class="built_in">Start</span>(<span class="number">0</span>, <span class="number">1024</span>);</span><br></pre></td></tr></table></figure></li>
<li><p>å¦èµ·ä¸€ä¸ªçº¿ç¨‹è·‘è°ƒåº¦å™¨</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœä¸æƒ³è®©è°ƒåº¦å™¨å¡ä½ä¸»çº¿ç¨‹, å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼:</span></span><br><span class="line"><span class="function">std::thread <span class="title">t</span><span class="params">([]&#123; co_sched.Start(); &#125;)</span></span>;</span><br><span class="line">t.<span class="built_in">detach</span>();</span><br><span class="line"><span class="built_in">co_sleep</span>(<span class="number">100</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="è‡ªå®šä¹‰çš„è°ƒåº¦å™¨"><a href="#è‡ªå®šä¹‰çš„è°ƒåº¦å™¨" class="headerlink" title="è‡ªå®šä¹‰çš„è°ƒåº¦å™¨"></a>è‡ªå®šä¹‰çš„è°ƒåº¦å™¨</h3><ul>
<li>åˆ›å»ºä¸€ä¸ªè°ƒåº¦å™¨<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">co::Scheduler* sched = co::Scheduler::<span class="built_in">Create</span>();</span><br></pre></td></tr></table></figure></li>
<li> å¯åŠ¨æ–°çš„è°ƒåº¦å™¨<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">std::thread <span class="title">t2</span><span class="params">([sched]&#123; sched-&gt;Start(<span class="number">4</span>); &#125;)</span></span>;</span><br><span class="line">t2.<span class="built_in">detach</span>();</span><br></pre></td></tr></table></figure></li>
<li>æŒ‡å®šè°ƒåº¦å™¨ä¸Šåˆ›å»ºåç¨‹<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">go <span class="title">co_scheduler</span><span class="params">(sched)</span> []</span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;run in my scheduler.\n&quot;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="åç¨‹çš„ä¸»åŠ¨åˆ‡æ¢"><a href="#åç¨‹çš„ä¸»åŠ¨åˆ‡æ¢" class="headerlink" title="åç¨‹çš„ä¸»åŠ¨åˆ‡æ¢"></a>åç¨‹çš„ä¸»åŠ¨åˆ‡æ¢</h2><ul>
<li>co_yieldå…³é”®å­—<br>å¯ä»¥ä¸»åŠ¨è®©å‡ºè°ƒåº¦å™¨æ‰§è¡Œæƒé™,è®©è°ƒåº¦å™¨æœ‰æœºä¼šå»æ‰§è¡Œå…¶ä»–åç¨‹,å¹¶å°†å½“å‰åç¨‹ç§»åŠ¨åˆ°å¯æ‰§è¡Œåç¨‹åˆ—è¡¨çš„å°¾éƒ¨ã€‚</li>
<li>co_sched.Stop();<br>åœæ­¢è°ƒåº¦<br>æ³¨æ„: åœæ­¢åæ— æ³•æ¢å¤, ä»…ç”¨äºå®‰å…¨é€€å‡ºmainå‡½æ•°, ä¸ä¿è¯ç»ˆæ­¢æ‰€æœ‰çº¿ç¨‹.<br>å¦‚æœæŸä¸ªè°ƒåº¦çº¿ç¨‹è¢«åç¨‹é˜»å¡, å¿…é¡»ç­‰å¾…é˜»å¡ç»“æŸæ‰èƒ½é€€å‡º.</li>
</ul>
<h2 id="åç¨‹ä¸­çš„é€šä¿¡-channel"><a href="#åç¨‹ä¸­çš„é€šä¿¡-channel" class="headerlink" title="åç¨‹ä¸­çš„é€šä¿¡(channel)"></a>åç¨‹ä¸­çš„é€šä¿¡(channel)</h2><ul>
<li>æ— ç¼“å†²åŒºçš„channel<br>channelæ˜¯å¼•ç”¨è¯­ä¹‰, åœ¨åç¨‹é—´å…±äº«ç›´æ¥copyå³å¯.<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">co_chan&lt;<span class="keyword">int</span>&gt; ch_0;</span><br><span class="line"><span class="comment">// channelæ˜¯å¼•ç”¨è¯­ä¹‰, åœ¨åç¨‹é—´å…±äº«ç›´æ¥copyå³å¯.</span></span><br><span class="line"><span class="comment">// å‘é€šé“å†™å…¥</span></span><br><span class="line">go [=]&#123;</span><br><span class="line">	<span class="comment">// åœ¨åç¨‹ä¸­, å‘ch_0å†™å…¥ä¸€ä¸ªæ•´æ•°1.</span></span><br><span class="line">	<span class="comment">// ç”±äºch_0æ²¡æœ‰ç¼“å†²åŒº, å› æ­¤ä¼šé˜»å¡å½“å‰åç¨‹, ç›´åˆ°æœ‰äººä»ch_0ä¸­è¯»å–æ•°æ®:</span></span><br><span class="line">	ch_0 &lt;&lt; <span class="number">1</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// ä»é€šé“è¯»å–</span></span><br><span class="line">go [=] &#123;</span><br><span class="line">  <span class="comment">// Channelæ˜¯å¼•ç”¨è®¡æ•°çš„, å¤åˆ¶Channelå¹¶ä¸ä¼šäº§ç”Ÿæ–°çš„Channel, åªä¼šå¼•ç”¨æ—§çš„Channel.</span></span><br><span class="line">  <span class="comment">// å› æ­¤, åˆ›å»ºåç¨‹æ—¶å¯ä»¥ç›´æ¥æ‹·è´Channel.</span></span><br><span class="line">  <span class="comment">// Channelæ˜¯mutableçš„, å› æ­¤å¯ä»¥ç›´æ¥ä½¿ç”¨const Channelè¯»å†™æ•°æ®, </span></span><br><span class="line">  <span class="comment">// è¿™åœ¨ä½¿ç”¨lambdaè¡¨è¾¾å¼æ—¶æ˜¯æä¸ºæ–¹ä¾¿çš„ç‰¹æ€§.</span></span><br><span class="line">  <span class="comment">// ä»ch_0ä¸­è¯»å–æ•°æ®:</span></span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	ch_0 &gt;&gt; i;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;i = %d\n&quot;</span>, i);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li>å¸¦ç¼“å†²åŒºçš„channel<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºç¼“å†²åŒºå®¹é‡ä¸º1çš„Channel, ä¼ é€’æ™ºèƒ½æŒ‡é’ˆ:</span></span><br><span class="line">co_chan&lt;std::shared_ptr&lt;<span class="keyword">int</span>&gt;&gt; <span class="built_in">ch_1</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// å†™å…¥</span></span><br><span class="line">go [=] &#123;</span><br><span class="line">	std::shared_ptr&lt;<span class="keyword">int</span>&gt; <span class="built_in">p1</span>(<span class="keyword">new</span> <span class="built_in"><span class="keyword">int</span></span>(<span class="number">1</span>));</span><br><span class="line">	<span class="comment">// å‘ch_1ä¸­å†™å…¥ä¸€ä¸ªæ•°æ®, ç”±äºch_1æœ‰ä¸€ä¸ªç¼“å†²åŒºç©ºä½, å› æ­¤å¯ä»¥ç›´æ¥å†™å…¥è€Œä¸ä¼šé˜»å¡å½“å‰åç¨‹.</span></span><br><span class="line">	ch_1 &lt;&lt; p1;</span><br><span class="line">	<span class="comment">// å†æ¬¡å‘ch_1ä¸­å†™å…¥æ•´æ•°2, ç”±äºch_1ç¼“å†²åŒºå·²æ»¡, å› æ­¤é˜»å¡å½“å‰åç¨‹, ç­‰å¾…ç¼“å†²åŒºå‡ºç°ç©ºä½.</span></span><br><span class="line">	ch_1 &lt;&lt; p1;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// è¯»å–</span></span><br><span class="line">go [=] &#123;</span><br><span class="line">	std::shared_ptr&lt;<span class="keyword">int</span>&gt; ptr;</span><br><span class="line">	<span class="comment">// ç”±äºch_1åœ¨æ‰§è¡Œå‰ä¸€ä¸ªåç¨‹æ—¶è¢«å†™å…¥äº†ä¸€ä¸ªå…ƒç´ , å› æ­¤ä¸‹é¢è¿™ä¸ªè¯»å–æ•°æ®çš„æ“ä½œä¼šç«‹å³å®Œæˆ.</span></span><br><span class="line">	ch_1 &gt;&gt; ptr;</span><br><span class="line">	<span class="comment">// ç”±äºch_1ç¼“å†²åŒºå·²ç©º, ä¸‹é¢è¿™ä¸ªæ“ä½œä¼šä½¿å½“å‰åç¨‹æ”¾å¼ƒæ‰§è¡Œæƒ, ç­‰å¾…ç¬¬ä¸€ä¸ªåç¨‹å†™å…¥æ•°æ®å®Œæˆ.</span></span><br><span class="line">	ch_1 &gt;&gt; ptr;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;*ptr = %d\n&quot;</span>, *ptr);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li> channelçš„è¶…æ—¶å’Œéé˜»å¡è¯»<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">co_chan&lt;<span class="keyword">int</span>&gt; ch_2;</span><br><span class="line">go [=] &#123;</span><br><span class="line"><span class="comment">// ä½¿ç”¨TryPopå’ŒTryPushæ¥å£, å¯ä»¥ç«‹å³è¿”å›æ— éœ€ç­‰å¾….</span></span><br><span class="line"><span class="comment">// å½“Channelä¸ºç©ºæ—¶, TryPopä¼šå¤±è´¥; å½“Channelå†™æ»¡æ—¶, TryPushä¼šå¤±è´¥.</span></span><br><span class="line"><span class="comment">// å¦‚æœæ“ä½œæˆåŠŸ, è¿”å›true, å¦åˆ™è¿”å›false.</span></span><br><span class="line"><span class="keyword">int</span> val = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">bool</span> isSuccess = ch_2.<span class="built_in">TryPop</span>(val);</span><br><span class="line"><span class="comment">// ä½¿ç”¨TimedPopå’ŒTimedPushæ¥å£, å¯ä»¥åœ¨ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®ç­‰å¾…çš„è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="comment">// å¦‚æœè¶…æ—¶, è¿”å›false, å¦åˆ™è¿”å›true.</span></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼šå½“å‰ç‰ˆæœ¬, åŸç”Ÿçº¿ç¨‹ä¸­ä½¿ç”¨Channelæ—¶ä¸æ”¯æŒè¶…æ—¶æ—¶é—´, é€€åŒ–ä¸ºæ— é™æœŸç­‰å¾….</span></span><br><span class="line">isSuccess = ch_2.<span class="built_in">TimedPush</span>(<span class="number">1</span>, std::chrono::<span class="built_in">microseconds</span>(<span class="number">100</span>));</span><br><span class="line">(<span class="keyword">void</span>)isSuccess;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="åç¨‹é”-co-mutex"><a href="#åç¨‹é”-co-mutex" class="headerlink" title="åç¨‹é”(co_mutex)"></a>åç¨‹é”(co_mutex)</h2></li>
<li>co_mutex<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¸ºå±•ç¤ºco_mutexè‡ªåŠ¨åˆ‡æ¢åç¨‹çš„åŠŸèƒ½ï¼Œå…ˆé”ä½mutex</span></span><br><span class="line">cm.<span class="built_in">lock</span>();</span><br><span class="line"><span class="comment">// æ ‡å‡†åº“æ–¹å¼</span></span><br><span class="line"><span class="function">std::lock_guard&lt;co_mutex&gt; <span class="title">lock</span><span class="params">(cm)</span></span>;</span><br><span class="line"><span class="comment">// è§£é”</span></span><br><span class="line">cm.<span class="built_in">unlock</span>();</span><br></pre></td></tr></table></figure></li>
<li>co_rwmutexè¯»å†™é”<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¯»é”</span></span><br><span class="line">m.<span class="built_in">reader</span>().<span class="built_in">lock</span>();</span><br><span class="line">m.<span class="built_in">reader</span>().<span class="built_in">unlock</span>();</span><br><span class="line"><span class="comment">// æˆ–ä½¿ç”¨æ ‡å‡†åº“æä¾›çš„lockç³»åˆ—çš„å·¥å…·</span></span><br><span class="line"><span class="comment">// è¯»é”è§†å›¾çš„ç±»å‹ä¸ºï¼šco_rmutex</span></span><br><span class="line"><span class="function">std::unique_lock&lt;co_rmutex&gt; <span class="title">lock</span><span class="params">(m.Reader())</span></span>;</span><br><span class="line"><span class="comment">// å†™é”</span></span><br><span class="line">m.<span class="built_in">writer</span>().<span class="built_in">lock</span>();</span><br><span class="line">m.<span class="built_in">writer</span>().<span class="built_in">unlock</span>();</span><br><span class="line"><span class="comment">// æˆ–ä½¿ç”¨æ ‡å‡†åº“æä¾›çš„lockç³»åˆ—çš„å·¥å…·</span></span><br><span class="line"><span class="comment">// å†™é”è§†å›¾çš„ç±»å‹ä¸ºï¼šco_wmutex</span></span><br><span class="line"><span class="function">std::unique_lock&lt;co_wmutex&gt; <span class="title">lock</span><span class="params">(m.Writer())</span></span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="å®šæ—¶å™¨-co-timer"><a href="#å®šæ—¶å™¨-co-timer" class="headerlink" title="å®šæ—¶å™¨(co_timer)"></a>å®šæ—¶å™¨(co_timer)</h2><ul>
<li>å®šæ—¶å™¨çš„åˆ›å»ºå¹¶ç»‘å®šè°ƒåº¦å™¨<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨</span></span><br><span class="line"><span class="comment">// ç¬¬ä¸€ä¸ªå‚æ•°: ç²¾åº¦</span></span><br><span class="line"><span class="comment">// ç¬¬äºŒä¸ªå‚æ•°: ç»‘å®šåˆ°ä¸€ä¸ªè°ƒåº¦å™¨(Scheduler)</span></span><br><span class="line"><span class="comment">// ä¸¤ä¸ªå‚æ•°éƒ½æœ‰é»˜è®¤å€¼, å¯ä»¥ç®€ä¾¿åœ°åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨: co_timer timer; </span></span><br><span class="line"><span class="function">co_timer <span class="title">timer</span><span class="params">(std::chrono::milliseconds(<span class="number">1</span>), &amp;co_sched)</span></span>;</span><br></pre></td></tr></table></figure></li>
<li>è®¾ç½®å®šæ—¶ä»»åŠ¡<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨timer.ExpireAtæ¥å£è®¾ç½®ä¸€ä¸ªå®šæ—¶ä»»åŠ¡</span></span><br><span class="line"><span class="comment">// ç¬¬ä¸€ä¸ªå‚æ•°å¯ä»¥æ˜¯std::chronoä¸­çš„æ—¶é—´é•¿åº¦ï¼Œä¹Ÿå¯ä»¥æ˜¯æ—¶é—´ç‚¹ã€‚</span></span><br><span class="line"><span class="comment">// ç¬¬äºŒä¸ªå‚æ•°æ˜¯å®šæ—¶å™¨å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="comment">// è¿”å›ä¸€ä¸ªco_timer_idç±»å‹çš„ID, é€šè¿‡è¿™ä¸ªIDå¯ä»¥æ’¤é”€è¿˜æœªæ‰§è¡Œçš„å®šæ—¶å‡½æ•°</span></span><br><span class="line">co_timer_id id1 = timer.<span class="built_in">ExpireAt</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">1</span>), []&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Timer Callback.\n&quot;</span>);&#125;);</span><br></pre></td></tr></table></figure></li>
<li>å–æ¶ˆå®šæ—¶ä»»åŠ¡<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// co_timer_id::StopTimeræ¥å£å¯ä»¥æ’¤é”€è¿˜æœªå¼€å§‹æ‰§è¡Œçš„å®šæ—¶å‡½æ•°</span></span><br><span class="line"><span class="comment">// å®ƒè¿”å›boolç±»å‹çš„ç»“æœï¼Œå¦‚æœæ’¤é”€æˆåŠŸï¼Œè¿”å›trueï¼›</span></span><br><span class="line"><span class="comment">//     å¦‚æœæœªæ¥å¾—åŠæ’¤é”€ï¼Œè¿”å›false, æ­¤æ—¶ä¸ä¿è¯å›è°ƒå‡½æ•°å·²æ‰§è¡Œå®Œæ¯•ã€‚</span></span><br><span class="line"><span class="keyword">bool</span> cancelled = id1.<span class="built_in">StopTimer</span>();</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;cancelled:%s\n&quot;</span>, cancelled ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="åç¨‹æ± "><a href="#åç¨‹æ± " class="headerlink" title="åç¨‹æ± "></a>åç¨‹æ± </h2><ul>
<li>åˆ›å»ºåç¨‹æ± <figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">co::AsyncCoroutinePool * pPool = co::AsyncCoroutinePool::<span class="built_in">Create</span>();</span><br></pre></td></tr></table></figure></li>
<li>åˆå§‹åŒ–åç¨‹æ± <figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¯ä»¥è‡ªå®šä¹‰åç¨‹æ± ä¸­çš„æœ€å¤§åç¨‹æ•°,</span></span><br><span class="line"><span class="comment">// å»ºè®®è®¾ç½®çš„å¤šä¸€äº›, ä¸è¢«æ‰§è¡Œçš„åç¨‹ä¸ä¼šå ç”¨cpuèµ„æº.</span></span><br><span class="line">pPool-&gt;<span class="built_in">InitCoroutinePool</span>(<span class="number">1024</span>);</span><br><span class="line"><span class="comment">// å¯åŠ¨åç¨‹æ± </span></span><br><span class="line"><span class="comment">// ç¬¬ä¸€ä¸ªå‚æ•°: æœ€å°è°ƒåº¦çº¿ç¨‹æ•°</span></span><br><span class="line"><span class="comment">// ç¬¬äºŒä¸ªå‚æ•°: æœ€å¤§è°ƒåº¦çº¿ç¨‹æ•°</span></span><br><span class="line"><span class="comment">// æœ‰æ•ˆçš„è°ƒåº¦çº¿ç¨‹æ•°æ€»æ˜¯ä¿æŒä¸æœ€å°å€¼ç›¸åŒ, ä»…å½“æœ‰è°ƒåº¦çº¿ç¨‹è¢«é˜»å¡ä½æ—¶,</span></span><br><span class="line"><span class="comment">// æ‰ä¼šåŠ¨æ€æ‰©å±•è°ƒåº¦çº¿ç¨‹æ•°.</span></span><br><span class="line">pPool-&gt;<span class="built_in">Start</span>(<span class="number">4</span>, <span class="number">128</span>);</span><br></pre></td></tr></table></figure></li>
<li>ç»‘å®šå›è°ƒå¤„ç†å‡½æ•°<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¸€ä¸ªæˆ–å¤šä¸ªå›è°ƒå¤„ç†å™¨.</span></span><br><span class="line"><span class="comment">// å¦‚æœä¸ç»‘å®šå›è°ƒå¤„ç†å™¨, å®Œæˆå›è°ƒå°±ç›´æ¥åœ¨åç¨‹æ± ä¸­è¢«è°ƒç”¨.</span></span><br><span class="line"><span class="keyword">auto</span> cbp = <span class="keyword">new</span> co::AsyncCoroutinePool::CallbackPoint;</span><br><span class="line">pPool-&gt;<span class="built_in">AddCallbackPoint</span>(cbp);  <span class="comment">// æ³¨æ„åªèƒ½åŠ å…¥, ä¸èƒ½åˆ é™¤, è¦ä¿è¯å¤„ç†å™¨çš„ç”Ÿå‘½æœŸè¶³å¤Ÿé•¿.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.ä»¥å›è°ƒçš„æ–¹å¼æŠ•é€’ä»»åŠ¡ (é€‚ç”¨äºå¼‚æ­¥å›è°ƒæ¨¡å‹çš„é¡¹ç›®)</span></span><br><span class="line"><span class="comment">// pPool-&gt;Post(&amp;foo, &amp;done);</span></span><br><span class="line">pPool-&gt;<span class="built_in">Post</span>(&amp;foo, &amp;done);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.è¿˜å¯ä»¥æŠ•é€’å¸¦è¿”å›å€¼çš„å›è°ƒå‡½æ•°, callbackæ¥å—è¿”å›å€¼, ä»¥æ­¤å½¢æˆå›è°ƒé“¾.</span></span><br><span class="line">pPool-&gt;Post&lt;<span class="keyword">int</span>&gt;(&amp;calc, &amp;callback);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¾ªç¯æ‰§è¡Œå›è°ƒå¤„ç†å™¨, ç›´åˆ°å‰é¢æŠ•é€’çš„ä»»åŠ¡å®Œæˆä¸ºæ­¢.</span></span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">	<span class="keyword">size_t</span> trigger = cbp-&gt;<span class="built_in">Run</span>();</span><br><span class="line">	<span class="keyword">if</span> (trigger &gt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>ä½¿ç”¨channelæ–¹å¼æŠ•é€’<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä»¥Channelçš„æ–¹å¼æŠ•é€’ä»»åŠ¡ (é€‚ç”¨äºåç¨‹ä¸­, æˆ–åŒæ­¥æ¨¡å‹çš„åŸç”Ÿçº¿ç¨‹)</span></span><br><span class="line"><span class="comment">// channelæ–¹å¼ç­‰å¾…ä»»åŠ¡å®Œæˆæ—¶, callbackä¸ä¼šç»è¿‡å›è°ƒå¤„ç†å™¨.</span></span><br><span class="line"><span class="function">co_chan&lt;<span class="keyword">int</span>&gt; <span class="title">ch</span><span class="params">(<span class="number">1</span>)</span></span>;</span><br><span class="line">pPool-&gt;Post&lt;<span class="keyword">int</span>&gt;(ch, []&#123; <span class="keyword">return</span> <span class="number">8</span>; &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰å¾…ä»»åŠ¡å®Œæˆ</span></span><br><span class="line"><span class="keyword">int</span> val = <span class="number">0</span>;</span><br><span class="line">ch &gt;&gt; val;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;val = %d\n&quot;</span>, val);</span><br><span class="line"></span><br><span class="line"><span class="comment">//-----------------------------------------------</span></span><br><span class="line"><span class="comment">// è¿˜å¯ä»¥æŠ•é€’voidè¿”å›å€¼ç±»å‹çš„ä»»åŠ¡</span></span><br><span class="line"><span class="function">co_chan&lt;<span class="keyword">void</span>&gt; <span class="title">ch2</span><span class="params">(<span class="number">1</span>)</span></span>;</span><br><span class="line">pPool-&gt;<span class="built_in">Post</span>(ch2, []&#123; <span class="built_in">printf</span>(<span class="string">&quot;void task.\n&quot;</span>); &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰å¾…ä»»åŠ¡å®Œæˆ</span></span><br><span class="line">ch2 &gt;&gt; <span class="literal">nullptr</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="è¿æ¥æ± "><a href="#è¿æ¥æ± " class="headerlink" title="è¿æ¥æ± "></a>è¿æ¥æ± </h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªè¿æ¥æ± </span></span><br><span class="line"><span class="comment">// @Factory: åˆ›å»ºè¿æ¥çš„å·¥å‚</span></span><br><span class="line"><span class="comment">// @Deleter: é”€æ¯è¿æ¥, ä¼ é€’NULLæ—¶ä¼šä½¿ç”¨deleteåˆ é™¤è¿æ¥.</span></span><br><span class="line"><span class="comment">// @maxConnection: æœ€å¤§è¿æ¥æ•°, 0è¡¨ç¤ºä¸é™æ•°é‡</span></span><br><span class="line"><span class="comment">// @maxIdleConnection: æœ€å¤§ç©ºé—²è¿æ¥æ•°, 0è¡¨ç¤ºä¸é™æ•°é‡</span></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼šFactoryå’ŒDeleterçš„è°ƒç”¨å¯èƒ½ä¼šå¹¶è¡Œ.</span></span><br><span class="line"><span class="comment">//   ConnectionPool(Factory f, Deleter d = NULL, size_t maxConnection = 0, size_t maxIdleConnection = 0)</span></span><br><span class="line"><span class="function">co::ConnectionPool&lt;MySQLConnection&gt; <span class="title">cPool</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        []&#123; <span class="keyword">return</span> <span class="keyword">new</span> MySQLConnection; &#125;,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="literal">NULL</span>, </span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="number">100</span>, <span class="comment">// é™åˆ¶æœ€å¤§100ä¸ªè¿æ¥, é˜²æ­¢æŠŠmysqlå†²å®</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="number">20</span>)</span></span>; <span class="comment">// æœ€å¤šä¿ç•™20æ¡ç©ºé—²è¿æ¥</span></span><br><span class="line"><span class="comment">// Reserveæ¥å£å¯ä»¥é¢„åˆ›å»ºä¸€äº›è¿æ¥, ä¸èƒ½è¶…è¿‡æœ€å¤§ç©ºé—²è¿æ¥æ•°, å³: 20</span></span><br><span class="line">cPool.<span class="built_in">Reserve</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="comment">// è·å–ä¸€ä¸ªè¿æ¥, æ— é™æœŸç­‰å¾…</span></span><br><span class="line"><span class="comment">// @checkAliveOnGet: ç”³è¯·æ—¶æ£€æŸ¥è¿æ¥æ˜¯å¦è¿˜æœ‰æ•ˆ, é»˜è®¤NULLè¡¨ç¤ºä¸æ£€æŸ¥</span></span><br><span class="line"><span class="comment">// @checkAliveOnPut: å½’è¿˜æ—¶æ£€æŸ¥è¿æ¥æ˜¯å¦è¿˜æœ‰æ•ˆ, é»˜è®¤NULLè¡¨ç¤ºä¸æ£€æŸ¥</span></span><br><span class="line"><span class="comment">// @return: è¿”å›MySQLConnectionçš„æ™ºèƒ½æŒ‡é’ˆ, å¼•ç”¨è®¡æ•°å½’é›¶æ—¶è‡ªåŠ¨å°†è¿æ¥è¿˜å›æ± é‡Œ.</span></span><br><span class="line"><span class="keyword">auto</span> connPtr = cPool.<span class="built_in">Get</span>();</span><br><span class="line"><span class="keyword">if</span> (connPtr) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;get connection ok.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸»åŠ¨å½’è¿˜</span></span><br><span class="line">connPtr.<span class="built_in">reset</span>();</span><br><span class="line"><span class="comment">// @return: è¿”å›MySQLConnectionçš„æ™ºèƒ½æŒ‡é’ˆ, å¼•ç”¨è®¡æ•°å½’é›¶æ—¶è‡ªåŠ¨å°†è¿æ¥è¿˜å›æ± é‡Œ.</span></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼šåœ¨åŸç”Ÿçº¿ç¨‹ä¸­ä½¿ç”¨æ—¶, è¶…æ—¶æ—¶é•¿æ˜¯ä¸ç”Ÿæ•ˆçš„.</span></span><br><span class="line">go [&amp;]&#123;</span><br><span class="line">    connPtr = cPool.<span class="built_in">Get</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">100</span>));</span><br><span class="line">    <span class="keyword">if</span> (connPtr) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;get connection ok.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    co_sched.<span class="built_in">Stop</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="åç¨‹å±€éƒ¨å˜é‡"><a href="#åç¨‹å±€éƒ¨å˜é‡" class="headerlink" title="åç¨‹å±€éƒ¨å˜é‡"></a>åç¨‹å±€éƒ¨å˜é‡</h2><ul>
<li>libgoçš„åç¨‹ä¹Ÿæœ‰CLS(coroutine local storage)<br>åŒæ ·æ”¯æŒTLSçš„ä¸‰ç§ä½¿ç”¨åœºæ™¯ï¼š</li>
</ul>
<ol>
<li>å—ä½œç”¨åŸŸ(å‡½æ•°å†…)</li>
<li>å…¨å±€ä½œç”¨åŸŸ</li>
<li>ç±»é™æ€æˆå‘˜å˜é‡<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å£°æ˜ä¸€ä¸ªclså˜é‡ä½¿ç”¨å®: co_cls</span></span><br><span class="line"><span class="comment">//Eg:</span></span><br><span class="line">    <span class="keyword">int</span>&amp; var = <span class="built_in">co_cls</span>(<span class="keyword">int</span>);</span><br><span class="line">    <span class="comment">//æˆ–</span></span><br><span class="line">    <span class="built_in">co_cls_ref</span>(<span class="keyword">int</span>) var = <span class="built_in">co_cls</span>(<span class="keyword">int</span>);</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="co-defer"><a href="#co-defer" class="headerlink" title="co_defer"></a>co_defer</h2><ul>
<li>co_defer<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//co_deferçš„è¯­æ³•å’Œgoå…³é”®å­—ä¸€æ ·, ä¹Ÿæ˜¯åé¢è·Ÿä¸€ä¸ªfunction.</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>;</span><br><span class="line">co_defer foo;</span><br></pre></td></tr></table></figure></li>
<li>co_defer_scopeå¯ä»¥ç›´æ¥åœ¨å‚æ•°ä¸­å†™å¤šæ¡è¯­å¥<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">co_defer_scope &#123;</span><br><span class="line">       cout &lt;&lt; <span class="string">&quot;1&quot;</span> &lt;&lt; endl;</span><br><span class="line">       cout &lt;&lt; <span class="string">&quot;2&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure></li>
<li>deferçš„è§£é™¤<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å¾—ä¸Šä¸€æ¬¡çš„deferä»»åŠ¡</span></span><br><span class="line"><span class="keyword">auto</span> &amp; defer_obj = <span class="built_in">co_last_defer</span>();</span><br><span class="line"><span class="comment">// è§£é™¤</span></span><br><span class="line">defer_obj.<span class="built_in">dismiss</span>();</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="åç¨‹çš„æ¡ä»¶å˜é‡"><a href="#åç¨‹çš„æ¡ä»¶å˜é‡" class="headerlink" title="åç¨‹çš„æ¡ä»¶å˜é‡"></a>åç¨‹çš„æ¡ä»¶å˜é‡</h2><p>libgoåç¨‹çš„æ¡ä»¶å˜é‡ä½¿ç”¨å’Œc++11è¯­æ³•ä¸€è‡´</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å…ˆåˆ›å»ºäº’æ–¥é‡å’Œæ¡ä»¶å˜é‡</span></span><br><span class="line">co_mutex cm;</span><br><span class="line">co_condition_variable cv2;</span><br><span class="line"><span class="comment">// å¯åŠ¨ä¸¤ä¸ªåç¨‹</span></span><br><span class="line">    go []&#123;</span><br><span class="line">      	<span class="comment">// ç­‰å¾…åç¨‹</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;lambda\n&quot;</span>);</span><br><span class="line">        <span class="function">std::unique_lock&lt;co_mutex&gt; <span class="title">lock</span><span class="params">(cm)</span></span>;</span><br><span class="line">        <span class="keyword">while</span>(pass !=<span class="number">1</span>)&#123;</span><br><span class="line">          <span class="comment">//pthread_cond_wait(&amp;cv,&amp;lock_);</span></span><br><span class="line">          cv2.<span class="built_in">wait</span>(lock);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;lambda wait over\n&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    go []&#123;</span><br><span class="line">    	<span class="comment">// é€šçŸ¥åç¨‹</span></span><br><span class="line">      cm.<span class="built_in">lock</span>();</span><br><span class="line">      pass =<span class="number">1</span>;</span><br><span class="line">      cm.<span class="built_in">unlock</span>();</span><br><span class="line">      cv2.<span class="built_in">notify_one</span>();</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;notify_one\n&quot;</span>);</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>æ¡†æ¶å­¦ä¹ </category>
        <category>libgo</category>
      </categories>
      <tags>
        <tag>åç¨‹</tag>
        <tag>c++</tag>
      </tags>
  </entry>
  <entry>
    <title>Kubernetesç®€ä»‹</title>
    <url>/2022/03/21/Kubernetes%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<hr>
<p>kubernetesï¼Œç®€ç§°K8sï¼Œæ˜¯ç”¨8ä»£æ›¿åå­—ä¸­é—´çš„8ä¸ªå­—ç¬¦â€œuberneteâ€è€Œæˆçš„ç¼©å†™ã€‚æ˜¯ä¸€ä¸ªå¼€æºçš„ï¼Œç”¨äºç®¡ç†äº‘å¹³å°ä¸­å¤šä¸ªä¸»æœºä¸Šçš„å®¹å™¨åŒ–çš„åº”ç”¨ï¼ŒKubernetesçš„ç›®æ ‡æ˜¯è®©éƒ¨ç½²å®¹å™¨åŒ–çš„åº”ç”¨ç®€å•å¹¶ä¸”é«˜æ•ˆï¼ˆpowerfulï¼‰,Kubernetesæä¾›äº†åº”ç”¨éƒ¨ç½²ï¼Œè§„åˆ’ï¼Œæ›´æ–°ï¼Œç»´æŠ¤çš„ä¸€ç§æœºåˆ¶ã€‚</p>
<span id="more"></span>

<!-- toc -->


<p>[toc]</p>
<p><a href="https://k8s.easydoc.net/docs/dRiQjyTY/28366845/6GiNOzyZ/9EX8Cp45">å‚è€ƒèµ„æ–™</a></p>
<h2 id="K8Sæ˜¯ä»€ä¹ˆ"><a href="#K8Sæ˜¯ä»€ä¹ˆ" class="headerlink" title="K8Sæ˜¯ä»€ä¹ˆ"></a>K8Sæ˜¯ä»€ä¹ˆ</h2><p>å®ƒæ˜¯ä¸€ä¸ªä¸º <strong>å®¹å™¨åŒ–</strong> åº”ç”¨æä¾›é›†ç¾¤éƒ¨ç½²å’Œç®¡ç†çš„å¼€æºå·¥å…·ï¼Œç”± Google å¼€å‘ã€‚</p>
<h3 id="K8Sæ¡†æ¶"><a href="#K8Sæ¡†æ¶" class="headerlink" title="K8Sæ¡†æ¶"></a>K8Sæ¡†æ¶</h3><p><img src="/2022/03/21/Kubernetes%E7%AE%80%E4%BB%8B/20220319000957.png" alt="K8Sæ¡†æ¶"></p>
<ul>
<li>master: ä¸»èŠ‚ç‚¹ï¼Œæ§åˆ¶å¹³å°ï¼Œä¸éœ€è¦å¾ˆé«˜æ€§èƒ½ï¼Œä¸è·‘ä»»åŠ¡ï¼Œé€šå¸¸ä¸€ä¸ªå°±è¡Œäº†ï¼Œä¹Ÿå¯ä»¥å¼€å¤šä¸ªä¸»èŠ‚ç‚¹æ¥æé«˜é›†ç¾¤å¯ç”¨åº¦ã€‚</li>
<li>slave: å·¥ä½œèŠ‚ç‚¹ï¼Œå¯ä»¥æ˜¯è™šæ‹Ÿæœºæˆ–ç‰©ç†è®¡ç®—æœºï¼Œä»»åŠ¡éƒ½åœ¨è¿™é‡Œè·‘ï¼Œæœºå™¨æ€§èƒ½éœ€è¦å¥½ç‚¹ï¼›é€šå¸¸éƒ½æœ‰å¾ˆå¤šä¸ªï¼Œå¯ä»¥ä¸æ–­åŠ æœºå™¨æ‰©å¤§é›†ç¾¤ï¼›æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ç”±ä¸»èŠ‚ç‚¹ç®¡ç†</li>
<li>pod: è±†èšï¼ŒK8S è°ƒåº¦ã€ç®¡ç†çš„æœ€å°å•ä½ï¼Œä¸€ä¸ª Pod å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ï¼Œæ¯ä¸ª Pod æœ‰è‡ªå·±çš„è™šæ‹ŸIPã€‚</li>
</ul>
<h3 id="K8Sç»„ä»¶"><a href="#K8Sç»„ä»¶" class="headerlink" title="K8Sç»„ä»¶"></a>K8Sç»„ä»¶</h3><ul>
<li><code>kube-apiserver</code> API æœåŠ¡å™¨ï¼Œå…¬å¼€äº† Kubernetes API  </li>
<li><code>etcd</code> é”®å€¼æ•°æ®åº“ï¼Œå¯ä»¥ä½œä¸ºä¿å­˜ Kubernetes æ‰€æœ‰é›†ç¾¤æ•°æ®çš„åå°æ•°æ®åº“  </li>
<li><code>kube-scheduler</code> è°ƒåº¦ Pod åˆ°å“ªä¸ªèŠ‚ç‚¹è¿è¡Œ  </li>
<li><code>kube-controller</code> é›†ç¾¤æ§åˆ¶å™¨  </li>
<li><code>cloud-controller</code> ä¸äº‘æœåŠ¡å•†äº¤äº’</li>
</ul>
<p><img src="/2022/03/21/Kubernetes%E7%AE%80%E4%BB%8B/20220319001803.png" alt="K8Sç»„ä»¶å›¾"></p>
<h2 id="é›†ç¾¤æ­å»º"><a href="#é›†ç¾¤æ­å»º" class="headerlink" title="é›†ç¾¤æ­å»º"></a>é›†ç¾¤æ­å»º</h2><p>è¿™é‡Œæˆ‘ä½¿ç”¨ä¸‰å°devcloudå¼€å‘æœº</p>
<ul>
<li>ç¼–è¾‘/etc/hosts</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">9.134.165.72 master</span><br><span class="line">9.135.119.203 node1</span><br><span class="line">9.135.144.179 node2</span><br></pre></td></tr></table></figure>

<ul>
<li>æ¯å°æœºå­å®‰è£…ç›¸åº”çš„è½¯ä»¶<ul>
<li><code>docker-ce</code>: docker</li>
<li>kubelet: </li>
<li>kubeadm</li>
<li>kubectl: é›†ç¾¤æ§åˆ¶å™¨</li>
</ul>
</li>
</ul>
<p>è¿™é‡Œè¦è®¾ç½®kubernetesçš„é•œåƒæºæ˜¯è…¾è®¯äº‘ï¼Œtxå¥½ğŸ¶å•Š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.tencent.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.tencent.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>shellå‘½ä»¤<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum install -y kubelet kubeadm kubectl docker-ce</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="ä¸»èŠ‚ç‚¹kubeadmåˆå§‹åŒ–"><a href="#ä¸»èŠ‚ç‚¹kubeadmåˆå§‹åŒ–" class="headerlink" title="ä¸»èŠ‚ç‚¹kubeadmåˆå§‹åŒ–"></a>ä¸»èŠ‚ç‚¹kubeadmåˆå§‹åŒ–</h3><ul>
<li><p>kubeadm init</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubeadm init --image-repository=registry.aliyuncs.com/google_containers</span><br></pre></td></tr></table></figure></li>
<li><p>è¾“å‡ºjoinå‘½ä»¤è¡Œ</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubeadm join 9.134.165.72:6443 --token 7z5l51.ehxdba3ie7zrit6i \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:b7616fe77ba3d4b14bc8ba7e6b65d37b43ed69d9e012d18b9753df227337e8d0 </span><br><span class="line"></span><br><span class="line">// </span><br><span class="line"><span class="meta">#</span><span class="bash"> è®°å¾—æŠŠ kubeadm join xxx ä¿å­˜èµ·æ¥ <span class="comment"># å¿˜è®°äº†é‡æ–°è·å–ï¼škubeadm token create --print-join-command</span></span></span><br></pre></td></tr></table></figure></li>
<li><p>å¤åˆ¶æˆæƒæ–‡ä»¶</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å¤åˆ¶æˆæƒæ–‡ä»¶ï¼Œä»¥ä¾¿ kubectl å¯ä»¥æœ‰æƒé™è®¿é—®é›†ç¾¤ <span class="comment"># å¦‚æœä½ å…¶ä»–èŠ‚ç‚¹éœ€è¦è®¿é—®é›†ç¾¤ï¼Œéœ€è¦ä»ä¸»èŠ‚ç‚¹å¤åˆ¶è¿™ä¸ªæ–‡ä»¶è¿‡å»å…¶ä»–èŠ‚ç‚¹</span></span> </span><br><span class="line">mkdir -p $HOME/.kube </span><br><span class="line">cp -i /etc/kubernetes/admin.conf $HOME/.kube/config </span><br><span class="line">chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="å·¥ä½œèŠ‚ç‚¹åŠ å…¥é›†ç¾¤"><a href="#å·¥ä½œèŠ‚ç‚¹åŠ å…¥é›†ç¾¤" class="headerlink" title="å·¥ä½œèŠ‚ç‚¹åŠ å…¥é›†ç¾¤"></a>å·¥ä½œèŠ‚ç‚¹åŠ å…¥é›†ç¾¤</h3><ul>
<li>ä½¿ç”¨joinçš„token (å»æ‰æ¢è¡Œç¬¦)<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubeadm join 9.134.165.72:6443 --token 7z5l51.ehxdba3ie7zrit6i --discovery-token-ca-cert-hash sha256:b7616fe77ba3d4b14bc8ba7e6b65d37b43ed69d9e012d18b9753df227337e8d0 </span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="æ§åˆ¶ä¸»æœºæŸ¥çœ‹cluster"><a href="#æ§åˆ¶ä¸»æœºæŸ¥çœ‹cluster" class="headerlink" title="æ§åˆ¶ä¸»æœºæŸ¥çœ‹cluster"></a>æ§åˆ¶ä¸»æœºæŸ¥çœ‹cluster</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line">NAME     STATUS     ROLES                  AGE     VERSION</span><br><span class="line">master   NotReady   control-plane,master   8m37s   v1.23.5</span><br><span class="line">node1    NotReady   &lt;none&gt;                 62s     v1.23.5</span><br><span class="line">node2    NotReady   &lt;none&gt;                 49s     v1.23.5</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ä¸‰å°æœºå™¨çš„é›†ç¾¤</p>
<h3 id="å®‰è£…ç½‘ç»œæ’ä»¶"><a href="#å®‰è£…ç½‘ç»œæ’ä»¶" class="headerlink" title="å®‰è£…ç½‘ç»œæ’ä»¶"></a>å®‰è£…ç½‘ç»œæ’ä»¶</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>

<ul>
<li>è¿›å…¥readyçŠ¶æ€<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line">NAME     STATUS   ROLES                  AGE     VERSION</span><br><span class="line">master   Ready    control-plane,master   11m     v1.23.5</span><br><span class="line">node1    Ready    &lt;none&gt;                 4m5s    v1.23.5</span><br><span class="line">node2    Ready    &lt;none&gt;                 3m52s   v1.23.5</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="éƒ¨ç½²åº”ç”¨"><a href="#éƒ¨ç½²åº”ç”¨" class="headerlink" title="éƒ¨ç½²åº”ç”¨"></a>éƒ¨ç½²åº”ç”¨</h2><p><a href="https://github.com/HannoKishi/gin-docker-learning/tree/k8s">é¡¹ç›®åœ°å€</a><br>ps: ä½¿ç”¨k8såˆ†æ”¯,<br>ç„¶åè¦ä½è¦é•œåƒçš„cpuæ„æ¶v2æ˜¯armï¼Œv3æ˜¯x86</p>
<h3 id="podæ–‡ä»¶"><a href="#podæ–‡ä»¶" class="headerlink" title="podæ–‡ä»¶"></a>podæ–‡ä»¶</h3><ul>
<li><p>eg pod.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span> <span class="comment">#æŒ‡å®šapiç‰ˆæœ¬ï¼Œæ­¤å€¼å¿…é¡»åœ¨kubectl apiversionä¸­  </span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span> <span class="comment">#æŒ‡å®šåˆ›å»ºèµ„æºçš„è§’è‰²/ç±»å‹  </span></span><br><span class="line"><span class="attr">metadata:</span> <span class="comment">#èµ„æºçš„å…ƒæ•°æ®/å±æ€§  </span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">test-k8s</span> <span class="comment">#èµ„æºçš„åå­—ï¼Œåœ¨åŒä¸€ä¸ªnamespaceä¸­å¿…é¡»å”¯ä¸€  </span></span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="comment"># å®šä¹‰å®¹å™¨ï¼Œå¯ä»¥å¤šä¸ª  </span></span><br><span class="line"> <span class="attr">containers:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-k8s</span> <span class="comment"># å®¹å™¨åå­—  </span></span><br><span class="line"> <span class="attr">image:</span> <span class="string">ccr.ccs.tencentyun.com/hannokishi/k8s-test:v2</span> <span class="comment"># é•œåƒåœ°å€</span></span><br></pre></td></tr></table></figure></li>
<li><p>minikubeä½¿ç”¨è¯¥yamlåˆ›å»ºä¸€ä¸ªpod</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å‘½ä»¤</span></span><br><span class="line">kubectl apply -f ./pod.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash"> è¾“å‡º</span></span><br><span class="line">pod/test-k8s created</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹</span></span><br><span class="line">kubectl get pod</span><br><span class="line"><span class="meta">#</span><span class="bash"> ç»“æœ</span></span><br><span class="line">NAME       READY   STATUS             RESTARTS      AGE</span><br><span class="line">test-k8s   0/1     CrashLoopBackOff   4 (42s ago)   2m23s</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="ç›´æ¥ä½¿ç”¨é•œåƒåœ°å€åˆ›å»ºpod"><a href="#ç›´æ¥ä½¿ç”¨é•œåƒåœ°å€åˆ›å»ºpod" class="headerlink" title="ç›´æ¥ä½¿ç”¨é•œåƒåœ°å€åˆ›å»ºpod"></a>ç›´æ¥ä½¿ç”¨é•œåƒåœ°å€åˆ›å»ºpod</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å‘½ä»¤</span></span><br><span class="line">kubectl run testapp --image=ccr.ccs.tencentyun.com/hannokishi/k8s-test:v3</span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹</span></span><br><span class="line">kubectl get pod</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">test-k8s   1/1     Running   0          13s</span><br><span class="line">testapp    1/1     Running   0          8s</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ é™¤pod</span></span><br><span class="line">kubectl delete pod podname</span><br></pre></td></tr></table></figure>


<h3 id="deploymentæ–‡ä»¶"><a href="#deploymentæ–‡ä»¶" class="headerlink" title="deploymentæ–‡ä»¶"></a>deploymentæ–‡ä»¶</h3><p>eg: </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1  </span><br><span class="line">kind: Deployment  </span><br><span class="line">metadata:  </span><br><span class="line"><span class="meta">  #</span><span class="bash"> éƒ¨ç½²åå­—</span>  </span><br><span class="line"> name: test-k8s  </span><br><span class="line">spec:  </span><br><span class="line"><span class="meta">  #</span><span class="bash"> å£°æ˜å‰¯æœ¬æ•°ç›®</span>  </span><br><span class="line"> replicas: 5  </span><br><span class="line"><span class="meta">  #</span><span class="bash"> ç”¨æ¥æŸ¥æ‰¾å…³è”çš„ Podï¼Œæ‰€æœ‰æ ‡ç­¾éƒ½åŒ¹é…æ‰è¡Œ</span>  </span><br><span class="line"><span class="meta">  #</span><span class="bash"> å…³è”podï¼Œé€šè¿‡æ ‡ç­¾ <span class="comment"># é€‰æ‹©å™¨ selector:</span></span>  </span><br><span class="line">    matchLabels:  </span><br><span class="line">      app: test-k8s  </span><br><span class="line"><span class="meta">  #</span><span class="bash"> å®šä¹‰ Pod ç›¸å…³æ•°æ®</span>  </span><br><span class="line"> template:  </span><br><span class="line">    metadata:  </span><br><span class="line">      labels:  </span><br><span class="line">        app: test-k8s  </span><br><span class="line">    spec:  </span><br><span class="line">      # å®šä¹‰å®¹å™¨ï¼Œå¯ä»¥å¤šä¸ª  </span><br><span class="line"> containers:  </span><br><span class="line">        # å®¹å™¨åå­—  </span><br><span class="line"> - name: test-k8s  </span><br><span class="line">          # é•œåƒè·¯å¾„  </span><br><span class="line"> image: ccr.ccs.tencentyun.com/hannokishi/k8s-test:v3</span><br></pre></td></tr></table></figure>

<ul>
<li>éƒ¨ç½²ä¸æŸ¥çœ‹<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> éƒ¨ç½²</span></span><br><span class="line">kubectl apply -f ./app.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹</span></span><br><span class="line">kubectl get deployment                                                 </span><br><span class="line">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">test-k8s   2/2     2            0           16s</span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ é™¤deployment</span></span><br><span class="line">kubectl delete deployment dplname</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="éƒ¨ç½²åæ§åˆ¶å‘½ä»¤æ¼”ç¤º"><a href="#éƒ¨ç½²åæ§åˆ¶å‘½ä»¤æ¼”ç¤º" class="headerlink" title="éƒ¨ç½²åæ§åˆ¶å‘½ä»¤æ¼”ç¤º"></a>éƒ¨ç½²åæ§åˆ¶å‘½ä»¤æ¼”ç¤º</h2><ul>
<li>éƒ¨ç½²åº”ç”¨<ul>
<li>kubectl apply -f app.yaml</li>
</ul>
</li>
<li>æŸ¥çœ‹ deployment<ul>
<li>kubectl get deployment</li>
</ul>
</li>
<li>æŸ¥çœ‹ pod<ul>
<li>kubectl get pod -o wide</li>
</ul>
</li>
<li>æŸ¥çœ‹ pod è¯¦æƒ…<ul>
<li>kubectl describe pod pod-name</li>
</ul>
</li>
<li>æŸ¥çœ‹ log<ul>
<li>kubectl logs pod-name</li>
<li>kubectl logs pod-name -f</li>
</ul>
</li>
<li>è¿›å…¥ Pod å®¹å™¨ç»ˆç«¯ï¼Œ -c container-name å¯ä»¥æŒ‡å®šè¿›å…¥å“ªä¸ªå®¹å™¨ã€‚<ul>
<li>kubectl exec -it pod-name â€“ bash</li>
<li>kubectl exec -it pod-name â€“ sh</li>
</ul>
</li>
<li>ä¼¸ç¼©æ‰©å±•å‰¯æœ¬ (å¯å¢å¯å‡)<ul>
<li>kubectl scale deployment test-k8s â€“replicas=5</li>
</ul>
</li>
<li>æŠŠé›†ç¾¤å†…ç«¯å£æ˜ å°„åˆ°èŠ‚ç‚¹ (å¯ä»¥è®¿é—®æœåŠ¡äº†)<ul>
<li>kubectl port-forward pod-name 8082:8081</li>
</ul>
</li>
<li>æŸ¥çœ‹å†å²<ul>
<li>kubectl rollout history deployment test-k8s</li>
</ul>
</li>
<li>å›åˆ°ä¸Šä¸ªç‰ˆæœ¬<ul>
<li>kubectl rollout undo deployment test-k8s</li>
</ul>
</li>
<li>å›åˆ°æŒ‡å®šç‰ˆæœ¬<ul>
<li>kubectl rollout undo deployment test-k8s â€“to-revision=2</li>
</ul>
</li>
<li>åˆ é™¤éƒ¨ç½²<ul>
<li>kubectl delete deployment test-k8s</li>
</ul>
</li>
</ul>
<h3 id="æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯"><a href="#æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯"></a>æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</h3><p>ä½¿ç”¨<code>kubectl get pod -o wide</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">NAME                        READY   STATUS    RESTARTS   AGE   IP           NODE       NOMINATED NODE   READINESS GATES</span><br><span class="line">test-k8s                    1/1     Running   0          30m   172.17.0.3   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">test-k8s-685466c884-4v6x9   1/1     Running   0          19m   172.17.0.6   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">test-k8s-685466c884-rx5q5   1/1     Running   0          19m   172.17.0.5   minikube   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">testapp                     1/1     Running   0          30m   172.17.0.4   minikube   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥æŸ¥çœ‹ipï¼Œç”±äºä½¿ç”¨çš„æ˜¯minikubeï¼Œæ‰€ä»¥è·‘çš„éƒ½æ˜¯ä¸€ä¸ªèŠ‚ç‚¹</p>
<h3 id="ç«¯å£æ˜ å°„"><a href="#ç«¯å£æ˜ å°„" class="headerlink" title="ç«¯å£æ˜ å°„"></a>ç«¯å£æ˜ å°„</h3><p>ä½¿ç”¨ <code>kubectl port-forward pod-name 8082:8081</code> å°†æŸä¸ªpodçš„ç«¯å£æ˜ å°„å‡ºæ¥<br>ç„¶åè®¿é—®<code>http://localhost:8082/name</code></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;elapsedTime/ms&quot;</span>:<span class="number">0</span>,<span class="attr">&quot;hostname&quot;</span>:<span class="string">&quot;test-k8s&quot;</span>,<span class="attr">&quot;method&quot;</span>:<span class="string">&quot;GET&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥å¾—åˆ°è¯¥podé‡Œé¢å®¹å™¨çš„ä¸»æœºåå­—ï¼Œè¯´æ˜apiè°ƒç”¨æˆåŠŸ</p>
<h3 id="å®æœºæ¼”ç¤º"><a href="#å®æœºæ¼”ç¤º" class="headerlink" title="å®æœºæ¼”ç¤º"></a>å®æœºæ¼”ç¤º</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æŸ¥çœ‹å…¨éƒ¨</span></span><br><span class="line">kubectl get all</span><br><span class="line"><span class="meta">#</span><span class="bash"> é‡æ–°éƒ¨ç½²</span></span><br><span class="line">kubectl rollout restart deployment test-k8s</span><br><span class="line"><span class="meta">#</span><span class="bash"> å‘½ä»¤ä¿®æ”¹é•œåƒï¼Œ--record è¡¨ç¤ºæŠŠè¿™ä¸ªå‘½ä»¤è®°å½•åˆ°æ“ä½œå†å²ä¸­</span></span><br><span class="line">kubectl set image deployment test-k8s test-k8s=ccr.ccs.tencentyun.com/k8s-tutorial/test-k8s:v2-with-error --record</span><br><span class="line"><span class="meta">#</span><span class="bash"> æš‚åœè¿è¡Œï¼Œæš‚åœåï¼Œå¯¹ deployment çš„ä¿®æ”¹ä¸ä¼šç«‹åˆ»ç”Ÿæ•ˆï¼Œæ¢å¤åæ‰åº”ç”¨è®¾ç½®</span></span><br><span class="line">kubectl rollout pause deployment test-k8s</span><br><span class="line"><span class="meta">#</span><span class="bash"> æ¢å¤</span></span><br><span class="line">kubectl rollout resume deployment test-k8s</span><br><span class="line"><span class="meta">#</span><span class="bash"> é…ç½®ä¿¡æ¯è¾“å‡ºåˆ°æ–‡ä»¶</span></span><br><span class="line">kubectl get deployment test-k8s -o yaml &gt;&gt; app2.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ é™¤å…¨éƒ¨èµ„æº</span></span><br><span class="line">kubectl delete all --all</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="å·¥ä½œè´Ÿè½½åˆ†ç±»"><a href="#å·¥ä½œè´Ÿè½½åˆ†ç±»" class="headerlink" title="å·¥ä½œè´Ÿè½½åˆ†ç±»"></a>å·¥ä½œè´Ÿè½½åˆ†ç±»</h2><ul>
<li>Deployment<br>  é€‚åˆæ— çŠ¶æ€åº”ç”¨ï¼Œæ‰€æœ‰podç­‰ä»·ï¼Œå¯æ›¿ä»£</li>
<li>StatefulSet<br>  æœ‰çŠ¶æ€çš„åº”ç”¨ï¼Œé€‚åˆæ•°æ®åº“è¿™ç§ç±»å‹ã€‚</li>
<li>DaemonSet<br>  åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè·‘ä¸€ä¸ª Podï¼Œå¯ä»¥ç”¨æ¥åšèŠ‚ç‚¹ç›‘æ§ã€èŠ‚ç‚¹æ—¥å¿—æ”¶é›†ç­‰</li>
<li>Job &amp; CronJob<br>  Job ç”¨æ¥è¡¨è¾¾çš„æ˜¯ä¸€æ¬¡æ€§çš„ä»»åŠ¡ï¼Œè€Œ CronJob ä¼šæ ¹æ®å…¶æ—¶é—´è§„åˆ’åå¤è¿è¡Œã€‚</li>
</ul>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><h3 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h3><ul>
<li>  Service é€šè¿‡ label å…³è”å¯¹åº”çš„ Pod</li>
<li>  Servcie ç”Ÿå‘½å‘¨æœŸä¸è·Ÿ Pod ç»‘å®šï¼Œä¸ä¼šå› ä¸º Pod é‡åˆ›æ”¹å˜ IP</li>
<li>  æä¾›äº†è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œè‡ªåŠ¨è½¬å‘æµé‡åˆ°ä¸åŒ Pod</li>
<li>  å¯å¯¹é›†ç¾¤å¤–éƒ¨æä¾›è®¿é—®ç«¯å£</li>
<li>  é›†ç¾¤å†…éƒ¨å¯é€šè¿‡æœåŠ¡åå­—è®¿é—®<br><img src="/2022/03/21/Kubernetes%E7%AE%80%E4%BB%8B/20220319193746.png"></li>
</ul>
<h3 id="serviceçš„yamlé…ç½®"><a href="#serviceçš„yamlé…ç½®" class="headerlink" title="serviceçš„yamlé…ç½®"></a>serviceçš„yamlé…ç½®</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-k8s</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">selector:</span>  </span><br><span class="line">    <span class="attr">app:</span> <span class="string">test-k8s</span>  </span><br><span class="line">  <span class="comment"># é»˜è®¤ ClusterIP é›†ç¾¤å†…å¯è®¿é—®ï¼ŒNodePort èŠ‚ç‚¹å¯è®¿é—®ï¼ŒLoadBalancer è´Ÿè½½å‡è¡¡æ¨¡å¼ï¼ˆéœ€è¦è´Ÿè½½å‡è¡¡å™¨æ‰å¯ç”¨ï¼‰  </span></span><br><span class="line"> <span class="attr">type:</span> <span class="string">NodePort</span>  </span><br><span class="line">  <span class="attr">ports:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span>        <span class="comment"># æœ¬ Service çš„ç«¯å£  </span></span><br><span class="line">	   <span class="attr">targetPort:</span> <span class="number">8081</span>  <span class="comment"># å®¹å™¨ç«¯å£  </span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">31000</span>   <span class="comment"># èŠ‚ç‚¹ç«¯å£ï¼ŒèŒƒå›´å›ºå®š 30000 ~ 32767</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åº”ç”¨é…ç½® <code>kubectl apply -f service.yaml</code></p>
<ul>
<li>æœåŠ¡çš„é»˜è®¤ç±»å‹æ˜¯<code>ClusterIP</code>ï¼Œåªèƒ½åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥è¿›å…¥åˆ° Pod é‡Œé¢è®¿é—®ï¼š</li>
<li><code>å¯¹å¤–æš´éœ²æœåŠ¡</code>:ä¸Šé¢æˆ‘ä»¬æ˜¯é€šè¿‡ç«¯å£è½¬å‘çš„æ–¹å¼å¯ä»¥åœ¨å¤–é¢è®¿é—®åˆ°é›†ç¾¤é‡Œçš„æœåŠ¡ï¼Œå¦‚æœæƒ³è¦ç›´æ¥æŠŠé›†ç¾¤æœåŠ¡æš´éœ²å‡ºæ¥ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>NodePort</code> å’Œ <code>Loadbalancer</code> ç±»å‹çš„ Service</li>
</ul>
<h2 id="StatefulSet-æœ‰çŠ¶æ€çš„æœåŠ¡"><a href="#StatefulSet-æœ‰çŠ¶æ€çš„æœåŠ¡" class="headerlink" title="StatefulSet æœ‰çŠ¶æ€çš„æœåŠ¡"></a>StatefulSet æœ‰çŠ¶æ€çš„æœåŠ¡</h2><h3 id="ä»€ä¹ˆæ˜¯-StatefulSet"><a href="#ä»€ä¹ˆæ˜¯-StatefulSet" class="headerlink" title="ä»€ä¹ˆæ˜¯ StatefulSet"></a>ä»€ä¹ˆæ˜¯ StatefulSet</h3><p>StatefulSet æ˜¯ç”¨æ¥ç®¡ç†æœ‰çŠ¶æ€çš„åº”ç”¨ï¼Œä¾‹å¦‚æ•°æ®åº“ã€‚</p>
<ul>
<li><p>yamlé…ç½®</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongodb</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span>  </span><br><span class="line">  <span class="attr">selector:</span>  </span><br><span class="line">    <span class="attr">matchLabels:</span>  </span><br><span class="line">      <span class="attr">app:</span> <span class="string">mongodb</span>  </span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">mongodb</span>  </span><br><span class="line">  <span class="attr">template:</span>  </span><br><span class="line">    <span class="attr">metadata:</span>  </span><br><span class="line">      <span class="attr">labels:</span>  </span><br><span class="line">        <span class="attr">app:</span> <span class="string">mongodb</span>  </span><br><span class="line">    <span class="attr">spec:</span>  </span><br><span class="line">      <span class="attr">containers:</span>  </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mongo</span>  </span><br><span class="line">          <span class="attr">image:</span> <span class="string">mongo:4.4</span>  </span><br><span class="line">          <span class="comment"># IfNotPresent ä»…æœ¬åœ°æ²¡æœ‰é•œåƒæ—¶æ‰è¿œç¨‹æ‹‰ï¼ŒAlways æ°¸è¿œéƒ½æ˜¯ä»è¿œç¨‹æ‹‰ï¼ŒNever æ°¸è¿œåªç”¨æœ¬åœ°é•œåƒï¼Œæœ¬åœ°æ²¡æœ‰åˆ™æŠ¥é”™  </span></span><br><span class="line"> <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span>  </span><br><span class="line"><span class="meta">---  </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span>  </span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongodb</span>  </span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">selector:</span>  </span><br><span class="line">    <span class="attr">app:</span> <span class="string">mongodb</span>  </span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span>  </span><br><span class="line">  <span class="comment"># HeadLess  </span></span><br><span class="line"> <span class="attr">clusterIP:</span> <span class="string">None</span>  </span><br><span class="line">  <span class="attr">ports:</span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">27017</span>  </span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">27017</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>kubectl apply -f mongo.yaml</code>å¯åŠ¨statefulsetæœåŠ¡</p>
</li>
<li><p><code>kubectl get pod</code>æŸ¥çœ‹</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">mongodb-0                   1/1     Running   0          2m37s</span><br><span class="line">mongodb-1                   1/1     Running   0          60s</span><br><span class="line">mongodb-2                   1/1     Running   0          59s</span><br></pre></td></tr></table></figure></li>
<li><p><code>kubectl get svc</code>æŸ¥çœ‹</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)     AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP     46h</span><br><span class="line">mongodb      ClusterIP   None         &lt;none&gt;        27017/TCP   3m1s</span><br></pre></td></tr></table></figure></li>
<li><p>è¿æ¥æŒ‡å®špod: <code>pod-name.service-name</code></p>
<ul>
<li>pod-name.service-nameç›¸å½“äºæ˜¯hostname</li>
<li><code>mongodb --host mongodb-0.mongodb</code>æ¥è®¿é—®</li>
</ul>
</li>
</ul>
<h3 id="Web-åº”ç”¨è¿æ¥-Mongodb"><a href="#Web-åº”ç”¨è¿æ¥-Mongodb" class="headerlink" title="Web åº”ç”¨è¿æ¥ Mongodb"></a>Web åº”ç”¨è¿æ¥ Mongodb</h3><p>åœ¨<code>é›†ç¾¤å†…éƒ¨</code>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æœåŠ¡åå­—è®¿é—®åˆ°ä¸åŒçš„æœåŠ¡<br>æŒ‡å®šè¿æ¥ç¬¬ä¸€ä¸ªï¼š<code>mongodb-0.mongodb</code></p>
<h2 id="æ•°æ®æŒä¹…åŒ–"><a href="#æ•°æ®æŒä¹…åŒ–" class="headerlink" title="æ•°æ®æŒä¹…åŒ–"></a>æ•°æ®æŒä¹…åŒ–</h2><p>kubernetes é›†ç¾¤ä¸ä¼šä¸ºä½ å¤„ç†æ•°æ®çš„å­˜å‚¨ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ•°æ®åº“æŒ‚è½½ä¸€ä¸ªç£ç›˜æ¥ç¡®ä¿æ•°æ®çš„å®‰å…¨ã€‚<br>ä½ å¯ä»¥é€‰æ‹©äº‘å­˜å‚¨ã€æœ¬åœ°ç£ç›˜ã€NFSã€‚</p>
<ul>
<li>  æœ¬åœ°ç£ç›˜ï¼šå¯ä»¥æŒ‚è½½æŸä¸ªèŠ‚ç‚¹ä¸Šçš„ç›®å½•ï¼Œä½†æ˜¯è¿™éœ€è¦é™å®š pod åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œ</li>
<li>  äº‘å­˜å‚¨ï¼šä¸é™å®šèŠ‚ç‚¹ï¼Œä¸å—é›†ç¾¤å½±å“ï¼Œå®‰å…¨ç¨³å®šï¼›éœ€è¦äº‘æœåŠ¡å•†æä¾›ï¼Œè£¸æœºé›†ç¾¤æ˜¯æ²¡æœ‰çš„ã€‚</li>
<li>  NFSï¼šä¸é™å®šèŠ‚ç‚¹ï¼Œä¸å—é›†ç¾¤å½±å“</li>
</ul>
<h3 id="Storage-Class-SC"><a href="#Storage-Class-SC" class="headerlink" title="Storage Class (SC)"></a>Storage Class (SC)</h3><p>å°†å­˜å‚¨å·åˆ’åˆ†ä¸ºä¸åŒçš„ç§ç±»ï¼Œä¾‹å¦‚ï¼šSSDï¼Œæ™®é€šç£ç›˜ï¼Œæœ¬åœ°ç£ç›˜ï¼ŒæŒ‰éœ€ä½¿ç”¨ã€‚</p>
<h4 id="Persistent-Volume-PV"><a href="#Persistent-Volume-PV" class="headerlink" title="Persistent Volume (PV)"></a>Persistent Volume (PV)</h4><p>æè¿°å·çš„å…·ä½“ä¿¡æ¯ï¼Œä¾‹å¦‚ç£ç›˜å¤§å°</p>
<h3 id="Persistent-Volume-Claim-PVC"><a href="#Persistent-Volume-Claim-PVC" class="headerlink" title="Persistent Volume Claim (PVC)"></a>Persistent Volume Claim (PVC)</h3><p>å¯¹å­˜å‚¨éœ€æ±‚çš„ä¸€ä¸ªç”³æ˜ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªç”³è¯·å•ï¼Œç³»ç»Ÿæ ¹æ®è¿™ä¸ªç”³è¯·å•å»æ‰¾ä¸€ä¸ªåˆé€‚çš„ PV<br>è¿˜å¯ä»¥æ ¹æ® PVC è‡ªåŠ¨åˆ›å»º PVã€‚</p>
<h2 id="ConfigMap-amp-Secret"><a href="#ConfigMap-amp-Secret" class="headerlink" title="ConfigMap &amp; Secret"></a>ConfigMap &amp; Secret</h2><p>æ•°æ®åº“è¿æ¥åœ°å€ï¼Œè¿™ç§å¯èƒ½æ ¹æ®éƒ¨ç½²ç¯å¢ƒå˜åŒ–çš„ï¼Œæˆ‘ä»¬ä¸åº”è¯¥å†™æ­»åœ¨ä»£ç é‡Œã€‚<br>Kubernetes ä¸ºæˆ‘ä»¬æä¾›äº† ConfigMapï¼Œå¯ä»¥æ–¹ä¾¿çš„é…ç½®ä¸€äº›å˜é‡ã€‚</p>
<h3 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="comment"># åå­—</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongo-config</span></span><br><span class="line"><span class="comment"># æ•°æ®</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">mongoHost:</span> <span class="string">mongodb-0.mongodb</span></span><br></pre></td></tr></table></figure>

<h3 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongo-secret</span></span><br><span class="line"><span class="comment"># Opaque ç”¨æˆ·å®šä¹‰çš„ä»»æ„æ•°æ®ï¼Œæ›´å¤šç±»å‹ä»‹ç» https://kubernetes.io/zh/docs/concepts/configuration/secret/#secret-types</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># æ•°æ®è¦ base64ã€‚https://tools.fun/base64.html</span></span><br><span class="line">  <span class="attr">mongo-username:</span> <span class="string">bW9uZ291c2Vy</span></span><br><span class="line">  <span class="attr">mongo-password:</span> <span class="string">bW9uZ29wYXNz</span></span><br></pre></td></tr></table></figure>

<h3 id="ä½¿ç”¨æ–¹æ³•"><a href="#ä½¿ç”¨æ–¹æ³•" class="headerlink" title="ä½¿ç”¨æ–¹æ³•"></a>ä½¿ç”¨æ–¹æ³•</h3><p>ä½œä¸ºç¯å¢ƒå˜é‡æ”¾åˆ°yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongodb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mongodb</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mongodb</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mongo</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">mongo:4.4</span></span><br><span class="line">          <span class="comment"># IfNotPresent ä»…æœ¬åœ°æ²¡æœ‰é•œåƒæ—¶æ‰è¿œç¨‹æ‹‰ï¼ŒAlways æ°¸è¿œéƒ½æ˜¯ä»è¿œç¨‹æ‹‰ï¼ŒNever æ°¸è¿œåªç”¨æœ¬åœ°é•œåƒï¼Œæœ¬åœ°æ²¡æœ‰åˆ™æŠ¥é”™</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MONGO_INITDB_ROOT_USERNAME</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">secretKeyRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">mongo-secret</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">mongo-username</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MONGO_INITDB_ROOT_PASSWORD</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">secretKeyRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">mongo-secret</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">mongo-password</span></span><br><span class="line">          <span class="comment"># Secret çš„æ‰€æœ‰æ•°æ®å®šä¹‰ä¸ºå®¹å™¨çš„ç¯å¢ƒå˜é‡ï¼ŒSecret ä¸­çš„é”®åç§°ä¸º Pod ä¸­çš„ç¯å¢ƒå˜é‡åç§°</span></span><br><span class="line">          <span class="comment"># envFrom:</span></span><br><span class="line">          <span class="comment"># - secretRef:</span></span><br><span class="line">          <span class="comment">#     name: mongo-secret</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å®¹å™¨</category>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>å®¹å™¨</tag>
        <tag>docker</tag>
        <tag>kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>c++è¯­è¨€è¿è¡ŒæœŸçš„å¼ºåŒ–</title>
    <url>/2022/03/28/c-%E8%AF%AD%E8%A8%80%E8%BF%90%E8%A1%8C%E6%9C%9F%E7%9A%84%E5%BC%BA%E5%8C%96/</url>
    <content><![CDATA[<p>c++11/17/20æ–°ç‰¹æ€§å­¦ä¹ ç¬”è®°</p>
<span id="more"></span>

<!-- toc -->
<h2 id="lambdaè¡¨è¾¾å¼"><a href="#lambdaè¡¨è¾¾å¼" class="headerlink" title="lambdaè¡¨è¾¾å¼"></a>lambdaè¡¨è¾¾å¼</h2><p>Lambda è¡¨è¾¾å¼æ˜¯ç°ä»£ C++ ä¸­æœ€é‡è¦çš„ç‰¹æ€§ä¹‹ä¸€ï¼Œè€Œ Lambda è¡¨è¾¾å¼ï¼Œå®é™…ä¸Šå°±æ˜¯æä¾›äº†ä¸€ä¸ªç±» ä¼¼åŒ¿åå‡½æ•°çš„ç‰¹æ€§</p>
<ul>
<li>è¯­æ³•<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[æ•è·åˆ—è¡¨](å‚æ•°åˆ—è¡¨) mutable(å¯é€‰) å¼‚å¸¸å±æ€§ -&gt; è¿”å›ç±»å‹ &#123; </span><br><span class="line">// å‡½æ•°ä½“  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>å€¼æ•è·<ul>
<li> ä¸å‚æ•°ä¼ å€¼ç±»ä¼¼ï¼Œå€¼æ•è·çš„å‰ææ˜¯å˜é‡å¯ä»¥æ‹·è´ï¼Œä¸åŒä¹‹å¤„åˆ™åœ¨äºï¼Œè¢«æ•è·çš„å˜é‡åœ¨ Lambda è¡¨è¾¾å¼è¢«<code>åˆ›å»ºæ—¶æ‹·è´</code>ï¼Œè€Œéè°ƒç”¨æ—¶æ‰æ‹·è´</li>
</ul>
</li>
<li>å¼•ç”¨æ•è·<ul>
<li> ä¸å¼•ç”¨ä¼ å‚ç±»ä¼¼ï¼Œå¼•ç”¨æ•è·ä¿å­˜çš„æ˜¯å¼•ç”¨ï¼Œå€¼ä¼šå‘ç”Ÿå˜åŒ–</li>
</ul>
</li>
<li>éšå¼æ•è·<ul>
<li> æ•è·åˆ—è¡¨ä¸­å†™ä¸€ä¸ª &amp; æˆ– = å‘ç¼–è¯‘å™¨å£°æ˜é‡‡ç”¨å¼•ç”¨æ•è·æˆ–è€…å€¼æ•è·</li>
</ul>
</li>
</ul>
<p>æ€»ç»“ä¸€ä¸‹ï¼Œæ•è·æä¾›äº† Lambda è¡¨è¾¾å¼å¯¹å¤–éƒ¨å€¼è¿›è¡Œä½¿ç”¨çš„åŠŸèƒ½ï¼Œæ•è·åˆ—è¡¨çš„æœ€å¸¸ç”¨çš„å››ç§å½¢å¼å¯ä»¥æ˜¯:</p>
<ul>
<li><code>[]</code>ç©ºæ•è·åˆ—è¡¨  </li>
<li><code>[name1, name2, . . . ]</code> æ•è·ä¸€ç³»åˆ—å˜é‡</li>
<li><code>[&amp;]</code> å¼•ç”¨æ•è·, è®©ç¼–è¯‘å™¨è‡ªè¡Œæ¨å¯¼å¼•ç”¨åˆ—è¡¨</li>
<li><code>[=]</code> å€¼æ•è·, è®©ç¼–è¯‘å™¨è‡ªè¡Œæ¨å¯¼å€¼æ•è·åˆ—è¡¨<br>c++14 å…è®¸è¡¨è¾¾å¼å’Œå³å€¼æ•è·</li>
</ul>
<h3 id="èŒƒå‹lambda"><a href="#èŒƒå‹lambda" class="headerlink" title="èŒƒå‹lambda"></a>èŒƒå‹lambda</h3><p>c++14å¼€å§‹Lambda å‡½æ•°çš„å½¢å¼å‚æ•°å¯ä»¥ä½¿ç”¨ auto å…³é”®å­—æ¥äº§ç”Ÿæ„ä¹‰ä¸Šçš„æ³›å‹:</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">auto</span> add = [](<span class="keyword">auto</span> x, <span class="keyword">auto</span> y) &#123; </span><br><span class="line">	<span class="keyword">return</span> x+y;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">add</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="built_in">add</span>(<span class="number">1.1</span>, <span class="number">2.2</span>);</span><br></pre></td></tr></table></figure>

<h2 id="å‡½æ•°å¯¹è±¡åŒ…è£…å™¨"><a href="#å‡½æ•°å¯¹è±¡åŒ…è£…å™¨" class="headerlink" title="å‡½æ•°å¯¹è±¡åŒ…è£…å™¨"></a>å‡½æ•°å¯¹è±¡åŒ…è£…å™¨</h2><h3 id="std-function"><a href="#std-function" class="headerlink" title="std::function"></a>std::function</h3><p>Lambda è¡¨è¾¾å¼çš„æœ¬è´¨æ˜¯ä¸€ä¸ªå’Œå‡½æ•°å¯¹è±¡ç±»å‹ç›¸ä¼¼çš„ç±»ç±»å‹(ç§°ä¸ºé—­åŒ…ç±»å‹)çš„<code>å¯¹è±¡</code>(ç§°ä¸ºé—­åŒ…å¯¹è±¡)ï¼Œå½“ Lambda è¡¨è¾¾å¼çš„æ•è·åˆ—è¡¨ä¸ºç©ºæ—¶ï¼Œé—­åŒ…å¯¹è±¡è¿˜èƒ½å¤Ÿè½¬æ¢ä¸ºå‡½æ•°æŒ‡é’ˆå€¼è¿›è¡Œä¼ é€’ã€‚</p>
<p>C++11 std::function æ˜¯ä¸€ç§é€šç”¨ã€å¤šæ€çš„å‡½æ•°å°è£…ï¼Œå®ƒçš„å®ä¾‹å¯ä»¥å¯¹<code>ä»»ä½•å¯ä»¥è°ƒç”¨çš„ç›®æ ‡å®ä½“</code>è¿›è¡Œå­˜å‚¨ã€å¤åˆ¶å’Œè°ƒç”¨æ“ä½œï¼Œå®ƒä¹Ÿæ˜¯å¯¹ C++ ä¸­ç°æœ‰çš„å¯è°ƒç”¨å®ä½“çš„ä¸€ç§ç±»å‹å®‰å…¨çš„åŒ…è£¹(ç›¸å¯¹æ¥è¯´ï¼Œå‡½æ•°æŒ‡é’ˆçš„è°ƒç”¨ä¸æ˜¯ç±»å‹å®‰å…¨çš„)ï¼Œæ¢å¥è¯è¯´ï¼Œå°±æ˜¯<code>å‡½æ•°çš„å®¹å™¨</code>ã€‚å½“æˆ‘ä»¬æœ‰äº†å‡½æ•°çš„å®¹å™¨ä¹‹åä¾¿èƒ½å¤Ÿæ›´åŠ æ–¹ä¾¿ çš„å°†å‡½æ•°ã€å‡½æ•°æŒ‡é’ˆä½œä¸ºå¯¹è±¡è¿›è¡Œå¤„ç†ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> para)</span> </span>&#123; </span><br><span class="line">	<span class="keyword">return</span> para;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line"><span class="comment">//std::function åŒ…è£…äº†ä¸€ä¸ªè¿”å›å€¼ä¸º int, å‚æ•°ä¸º int çš„å‡½æ•°</span></span><br><span class="line">	std::function&lt;<span class="built_in"><span class="keyword">int</span></span>(<span class="keyword">int</span>)&gt; func = foo;</span><br><span class="line">	<span class="keyword">int</span> important = <span class="number">10</span>;</span><br><span class="line">	std::function&lt;<span class="built_in"><span class="keyword">int</span></span>(<span class="keyword">int</span>)&gt; func2 = [&amp;](<span class="keyword">int</span> value) -&gt; <span class="keyword">int</span> &#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>+value+important; </span><br><span class="line">	&#125;;</span><br><span class="line">	std::cout &lt;&lt; <span class="built_in">func</span>(<span class="number">10</span>) &lt;&lt; std::endl; </span><br><span class="line">	std::cout &lt;&lt; <span class="built_in">func2</span>(<span class="number">10</span>) &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="std-bind-å’Œ-std-placeholder"><a href="#std-bind-å’Œ-std-placeholder" class="headerlink" title="std::bind å’Œ std::placeholder"></a>std::bind å’Œ std::placeholder</h3><p>è€Œ std::bind åˆ™æ˜¯ç”¨æ¥ç»‘å®šå‡½æ•°è°ƒç”¨çš„å‚æ•°çš„ï¼Œå®ƒè§£å†³çš„éœ€æ±‚æ˜¯æˆ‘ä»¬æœ‰æ—¶å€™å¯èƒ½å¹¶ä¸ä¸€å®šèƒ½å¤Ÿä¸€æ¬¡ æ€§è·å¾—è°ƒç”¨æŸä¸ªå‡½æ•°çš„å…¨éƒ¨å‚æ•°ï¼Œé€šè¿‡è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å°†éƒ¨åˆ†è°ƒç”¨å‚æ•°æå‰ç»‘å®šåˆ°å‡½æ•°èº«ä¸Šæˆä¸ºä¸€ ä¸ªæ–°çš„å¯¹è±¡ï¼Œç„¶ååœ¨å‚æ•°é½å…¨åï¼Œå®Œæˆè°ƒç”¨ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b, <span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">    ; </span><br><span class="line">&#125;  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// å°†å‚æ•° 1,2 ç»‘å®šåˆ°å‡½æ•° foo ä¸Šï¼Œä½†æ˜¯ä½¿ç”¨ std::placeholders::_1 æ¥å¯¹ç¬¬ä¸€ä¸ªå‚æ•°è¿›è¡Œå ä½ </span></span><br><span class="line">	<span class="keyword">auto</span> bindFoo = std::<span class="built_in">bind</span>(foo, std::placeholders::_1, <span class="number">1</span>,<span class="number">2</span>);  </span><br><span class="line">	<span class="comment">// è¿™æ—¶è°ƒç”¨ bindFoo æ—¶ï¼Œåªéœ€è¦æä¾›ç¬¬ä¸€ä¸ªå‚æ•°å³å¯  </span></span><br><span class="line">	<span class="built_in">bindFoo</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å³å€¼å¼•ç”¨"><a href="#å³å€¼å¼•ç”¨" class="headerlink" title="å³å€¼å¼•ç”¨"></a>å³å€¼å¼•ç”¨</h2><ul>
<li><p>å·¦å€¼ (lvalue, left value)</p>
<ul>
<li> é¡¾åæ€ä¹‰å°±æ˜¯èµ‹å€¼ç¬¦å·å·¦è¾¹çš„å€¼ã€‚å‡†ç¡®æ¥è¯´ï¼Œå·¦å€¼æ˜¯è¡¨è¾¾å¼(ä¸ä¸€å®šæ˜¯ èµ‹å€¼è¡¨è¾¾å¼)åä¾ç„¶å­˜åœ¨çš„æŒä¹…å¯¹è±¡ã€‚</li>
</ul>
</li>
<li><p>å³å€¼ (rvalue, right value)</p>
<ul>
<li> å³è¾¹çš„å€¼ï¼Œæ˜¯æŒ‡è¡¨è¾¾å¼ç»“æŸåå°±ä¸å†å­˜åœ¨çš„ä¸´æ—¶å¯¹è±¡ã€‚<br>c++11å°†å³å€¼è¿›ä¸€æ­¥åˆ’åˆ†ä¸º<code>çº¯å³å€¼</code>å’Œ<code>å°†äº¡å€¼</code></li>
</ul>
</li>
<li><p>çº¯å³å€¼ (prvalue, pure rvalue)</p>
<ul>
<li> çº¯ç²¹çš„å³å€¼ï¼Œè¦ä¹ˆæ˜¯çº¯ç²¹çš„å­—é¢é‡ï¼Œä¾‹å¦‚ 10, true;è¦ä¹ˆæ˜¯æ±‚å€¼ ç»“æœç›¸å½“äºå­—é¢é‡æˆ–åŒ¿åä¸´æ—¶å¯¹è±¡ï¼Œä¾‹å¦‚ 1+2ã€‚éå¼•ç”¨è¿”å›çš„ä¸´æ—¶å˜é‡ã€è¿ç®—è¡¨è¾¾å¼äº§ç”Ÿçš„ä¸´æ—¶å˜é‡ã€åŸ å§‹å­—é¢é‡ã€Lambda è¡¨è¾¾å¼éƒ½å±äºçº¯å³å€¼ã€‚<br>ps :  å­—ç¬¦ä¸²å­—é¢é‡åªæœ‰åœ¨ç±»ä¸­æ‰æ˜¯å³å€¼ï¼Œå½“å…¶ä½äºæ™®é€šå‡½æ•°ä¸­æ˜¯å·¦å€¼</li>
</ul>
</li>
<li><p>å°†äº¡å€¼ (xvalue, expiring value)</p>
<ul>
<li> ä¹Ÿå°±æ˜¯å³å°†è¢«é”€æ¯ã€å´èƒ½å¤Ÿè¢«ç§»åŠ¨çš„å€¼ã€‚<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">std::vector&lt;<span class="keyword">int</span>&gt; <span class="title">foo</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">	std::vector&lt;<span class="keyword">int</span>&gt; temp = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;; <span class="keyword">return</span> temp;</span><br><span class="line">&#125;</span><br><span class="line">std::vector&lt;<span class="keyword">int</span>&gt; v = <span class="built_in">foo</span>();</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>åœ¨è¿™æ ·çš„ä»£ç ä¸­ï¼Œå°±ä¼ ç»Ÿçš„ç†è§£è€Œè¨€ï¼Œå‡½æ•° foo çš„è¿”å›å€¼ temp åœ¨å†…éƒ¨åˆ›å»ºç„¶åè¢«èµ‹å€¼ç»™ vï¼Œç„¶è€Œ v è·å¾—è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œä¼šå°†æ•´ä¸ª temp æ‹·è´ä¸€ä»½ï¼Œç„¶åæŠŠ temp é”€æ¯ï¼Œå¦‚æœè¿™ä¸ª temp éå¸¸å¤§ï¼Œè¿™å°†é€ æˆå¤§é‡ é¢å¤–çš„å¼€é”€</p>
<h3 id="å³å€¼å¼•ç”¨å’Œå·¦å€¼å¼•ç”¨"><a href="#å³å€¼å¼•ç”¨å’Œå·¦å€¼å¼•ç”¨" class="headerlink" title="å³å€¼å¼•ç”¨å’Œå·¦å€¼å¼•ç”¨"></a>å³å€¼å¼•ç”¨å’Œå·¦å€¼å¼•ç”¨</h3><p>è¦æ‹¿åˆ°ä¸€ä¸ªå°†äº¡å€¼ï¼Œå°±éœ€è¦ç”¨åˆ°å³å€¼å¼•ç”¨:T &amp;&amp;ï¼Œå…¶ä¸­ T æ˜¯ç±»å‹ã€‚å³å€¼å¼•ç”¨çš„å£°æ˜è®©è¿™ä¸ªä¸´æ—¶å€¼çš„ ç”Ÿå‘½å‘¨æœŸå¾—ä»¥å»¶é•¿ã€åªè¦å˜é‡è¿˜æ´»ç€ï¼Œé‚£ä¹ˆå°†äº¡å€¼å°†ç»§ç»­å­˜æ´»ã€‚</p>
<p>C++11 æä¾›äº† <code>std::move</code> è¿™ä¸ªæ–¹æ³•å°†å·¦å€¼å‚æ•°æ— æ¡ä»¶çš„è½¬æ¢ä¸ºå³å€¼ï¼Œæœ‰äº†å®ƒæˆ‘ä»¬å°±èƒ½å¤Ÿæ–¹ä¾¿çš„è· å¾—ä¸€ä¸ªå³å€¼ä¸´æ—¶å¯¹è±¡</p>
<h2 id="ç§»åŠ¨è¯­ä¹‰"><a href="#ç§»åŠ¨è¯­ä¹‰" class="headerlink" title="ç§»åŠ¨è¯­ä¹‰"></a>ç§»åŠ¨è¯­ä¹‰</h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">int</span> *pointer;</span><br><span class="line"><span class="built_in">A</span>():<span class="built_in">pointer</span>(<span class="keyword">new</span> <span class="built_in"><span class="keyword">int</span></span>(<span class="number">1</span>)) &#123;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot; æ„é€ &quot;</span> &lt;&lt; pointer &lt;&lt;std::endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">A</span>(A&amp; a):<span class="built_in">pointer</span>(<span class="keyword">new</span> <span class="built_in"><span class="keyword">int</span></span>(*a.pointer)) &#123;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot; æ‹·è´&quot;</span> &lt;&lt; pointer &lt;&lt; std::endl;</span><br><span class="line">&#125; <span class="comment">// æ— æ„ä¹‰çš„å¯¹è±¡æ‹·è´</span></span><br><span class="line"><span class="built_in">A</span>(A&amp;&amp; a):<span class="built_in">pointer</span>(a.pointer) &#123;</span><br><span class="line">	a.pointer = <span class="literal">nullptr</span>;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot; ç§»åŠ¨&quot;</span> &lt;&lt; pointer &lt;&lt;std::endl;</span><br><span class="line">&#125;</span><br><span class="line">~<span class="built_in">A</span>()&#123;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot; ææ„&quot;</span> &lt;&lt; pointer &lt;&lt;std::endl;</span><br><span class="line">	<span class="keyword">delete</span> pointer;</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–</span></span><br><span class="line"><span class="function">A <span class="title">return_rvalue</span><span class="params">(<span class="keyword">bool</span> test)</span> </span>&#123;</span><br><span class="line">	A a,b;</span><br><span class="line">	<span class="keyword">if</span>(test)</span><br><span class="line">		<span class="keyword">return</span> a; <span class="comment">// ç­‰ä»·äº static_cast&lt;A&amp;&amp;&gt;(a);</span></span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> b; <span class="comment">// ç­‰ä»·äº static_cast&lt;A&amp;&amp;&gt;(b);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// return_rvalueè¿”å›çš„æ˜¯ä¸€ä¸ªå³å€¼å¼•ç”¨</span></span><br><span class="line"><span class="comment">//å‡½æ•°è¿”å›åï¼Œäº§ç”Ÿä¸€ä¸ªå°†äº¡å€¼,è¢«Açš„ç§»åŠ¨æ„é€ (A(A&amp;&amp;))å¼•ç”¨ï¼Œä»è€Œå»¶é•¿ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶å°†è¿™</span></span><br><span class="line"><span class="comment">//ä¸ªå³å€¼ä¸­çš„æŒ‡é’ˆæ‹¿åˆ°ï¼Œä¿å­˜åˆ°äº†objä¸­ï¼Œ</span></span><br><span class="line">	A obj = <span class="built_in">return_rvalue</span>(<span class="literal">false</span>);</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;obj:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	std::cout &lt;&lt; obj.pointer &lt;&lt; std::endl;</span><br><span class="line">	std::cout &lt;&lt; *obj.pointer &lt;&lt; std::endl;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// æ„é€ 0x258ac20</span></span><br><span class="line"><span class="comment">// æ„é€ 0x258ac40</span></span><br><span class="line"><span class="comment">// ç§»åŠ¨0x258ac40</span></span><br><span class="line"><span class="comment">// ææ„0</span></span><br><span class="line"><span class="comment">// ææ„0x258ac20</span></span><br><span class="line"><span class="comment">// obj:</span></span><br><span class="line"><span class="comment">// 0x258ac40</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// ææ„0x258ac40</span></span><br></pre></td></tr></table></figure>

<h2 id="å®Œç¾è½¬å‘"><a href="#å®Œç¾è½¬å‘" class="headerlink" title="å®Œç¾è½¬å‘"></a>å®Œç¾è½¬å‘</h2><p><code>ä¸€ä¸ªå£°æ˜çš„å³å€¼å¼•ç”¨å…¶å®æ˜¯ä¸€ä¸ªå·¦å€¼ã€‚</code></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reference</span><span class="params">(<span class="keyword">int</span>&amp; v)</span> </span>&#123;  </span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot; å·¦å€¼&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reference</span><span class="params">(<span class="keyword">int</span>&amp;&amp; v)</span> </span>&#123; </span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot; å³å€¼&quot;</span> &lt;&lt; std::endl; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="keyword">void</span> <span class="title">pass</span><span class="params">(T&amp;&amp; v)</span> </span>&#123;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot; æ™®é€šä¼ å‚:&quot;</span>;</span><br><span class="line">	<span class="built_in">reference</span>(v); <span class="comment">// å§‹ç»ˆè°ƒç”¨ reference(int&amp;) </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot; ä¼ é€’å³å€¼:&quot;</span> &lt;&lt; std::endl; </span><br><span class="line">	<span class="built_in">pass</span>(<span class="number">1</span>); <span class="comment">// 1 æ˜¯å³å€¼, ä½†è¾“å‡ºæ˜¯å·¦å€¼</span></span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot; ä¼ é€’å·¦å€¼:&quot;</span> &lt;&lt; std::endl; </span><br><span class="line">	<span class="keyword">int</span> l = <span class="number">1</span>;  </span><br><span class="line">	<span class="built_in">pass</span>(l); <span class="comment">// l æ˜¯å·¦å€¼, è¾“å‡ºå·¦å€¼</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä¼ é€’å³å€¼:</span></span><br><span class="line"><span class="comment">// æ™®é€šä¼ å‚: å·¦å€¼</span></span><br><span class="line"><span class="comment">// ä¼ é€’å·¦å€¼:</span></span><br><span class="line"><span class="comment">// æ™®é€šä¼ å‚: å·¦å€¼</span></span><br></pre></td></tr></table></figure>
<p>å¯¹äº pass(1) æ¥è¯´ï¼Œè™½ç„¶ä¼ é€’çš„æ˜¯å³å€¼ï¼Œä½†ç”±äº v æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œæ‰€ä»¥åŒæ—¶ä¹Ÿæ˜¯å·¦å€¼ã€‚å› æ­¤ reference(v) ä¼šè°ƒç”¨ reference(int&amp;)ï¼Œè¾“å‡ºã€å·¦å€¼ã€ã€‚</p>
<ul>
<li><code>å¼•ç”¨åç¼©è§„åˆ™</code><ul>
<li> åœ¨ä¼ ç»Ÿ C++ ä¸­ï¼Œæˆ‘ä»¬ä¸èƒ½å¤Ÿå¯¹ä¸€ä¸ªå¼•ç”¨ç±»å‹ç»§ç»­è¿›è¡Œå¼•ç”¨ï¼Œä½† C++ ç”± äºå³å€¼å¼•ç”¨çš„å‡ºç°è€Œæ”¾å®½äº†è¿™ä¸€åšæ³•ï¼Œä»è€Œäº§ç”Ÿäº†å¼•ç”¨åç¼©è§„åˆ™</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">å‡½æ•°å½¢å‚ç±»å‹</th>
<th align="center">å®å‚å‚æ•°ç±»å‹</th>
<th align="center">æ¨å¯¼åå‡½æ•°å½¢å‚ç±»å‹</th>
</tr>
</thead>
<tbody><tr>
<td align="center">T&amp;</td>
<td align="center">å·¦å¼•ç”¨</td>
<td align="center">T&amp;</td>
</tr>
<tr>
<td align="center">T&amp;</td>
<td align="center">å³å¼•ç”¨</td>
<td align="center">T&amp;</td>
</tr>
<tr>
<td align="center">T&amp;&amp;</td>
<td align="center">å·¦å¼•ç”¨</td>
<td align="center">T&amp;</td>
</tr>
<tr>
<td align="center">T&amp;&amp;</td>
<td align="center">å³å¼•ç”¨</td>
<td align="center">T&amp;&amp;</td>
</tr>
<tr>
<td align="center"><code>è¡Œå‚å’Œå®å‚éƒ½æ˜¯å³å¼•ç”¨ï¼Œç»“æœæ‰ä¸ºå³å¼•ç”¨</code></td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody></table>
<p>å› æ­¤ï¼Œæ¨¡æ¿å‡½æ•°ä¸­ä½¿ç”¨ T&amp;&amp; ä¸ä¸€å®šèƒ½è¿›è¡Œå³å€¼å¼•ç”¨ï¼Œå½“ä¼ å…¥å·¦å€¼æ—¶ï¼Œæ­¤å‡½æ•°çš„å¼•ç”¨å°†è¢«æ¨å¯¼ä¸ºå·¦å€¼ã€‚ æ›´å‡†ç¡®çš„è®²ï¼Œæ— è®ºæ¨¡æ¿å‚æ•°æ˜¯ä»€ä¹ˆç±»å‹çš„å¼•ç”¨ï¼Œå½“ä¸”ä»…å½“å®å‚ç±»å‹ä¸ºå³å¼•ç”¨æ—¶ï¼Œæ¨¡æ¿å‚æ•°æ‰èƒ½è¢«æ¨å¯¼ä¸º å³å¼•ç”¨ç±»å‹</p>
<p>ä½¿ç”¨<code>std::forward</code>æ¥è¿›è¡Œå‚æ•°çš„è½¬å‘:</p>
<ul>
<li>åœ¨ä¼ é€’å‚æ•°çš„æ—¶å€™ï¼Œä¿æŒåŸæ¥ çš„å‚æ•°ç±»å‹(å·¦å¼•ç”¨ä¿æŒå·¦å¼•ç”¨ï¼Œå³å¼•ç”¨ä¿æŒå³å¼•ç”¨)</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reference</span><span class="params">(<span class="keyword">int</span>&amp; v)</span> </span>&#123;</span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot; å·¦å€¼å¼•ç”¨&quot;</span> &lt;&lt; std::endl; &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reference</span><span class="params">(<span class="keyword">int</span>&amp;&amp; v)</span> </span>&#123;</span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot; å³å€¼å¼•ç”¨&quot;</span> &lt;&lt; std::endl;&#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pass</span><span class="params">(T&amp;&amp; v)</span> </span>&#123;</span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;         æ™®é€šä¼ å‚: &quot;</span>;</span><br><span class="line">  <span class="built_in">reference</span>(v);</span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;       std::moveä¼ å‚: &quot;</span>;</span><br><span class="line">  <span class="built_in">reference</span>(std::<span class="built_in">move</span>(v));</span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot;   std::forward ä¼ å‚: &quot;</span>;</span><br><span class="line">  <span class="built_in">reference</span>(std::forward&lt;T&gt;(v));</span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot; static_cast&lt;T&amp;&amp;&gt; ä¼ å‚: &quot;</span>;</span><br><span class="line">  <span class="built_in">reference</span>(<span class="keyword">static_cast</span>&lt;T &amp;&amp;&gt;(v));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot; ä¼ é€’å³å€¼:&quot;</span> &lt;&lt; std::endl; </span><br><span class="line">  <span class="built_in">pass</span>(<span class="number">1</span>);</span><br><span class="line">  std::cout &lt;&lt; <span class="string">&quot; ä¼ é€’å·¦å€¼:&quot;</span> &lt;&lt; std::endl; </span><br><span class="line">  <span class="keyword">int</span> v = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">pass</span>(v);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> ä¼ é€’å³å€¼:</span><br><span class="line">         æ™®é€šä¼ å‚:  å·¦å€¼å¼•ç”¨</span><br><span class="line">       std::moveä¼ å‚:  å³å€¼å¼•ç”¨</span><br><span class="line">   std::forward ä¼ å‚:  å³å€¼å¼•ç”¨</span><br><span class="line"> <span class="keyword">static_cast</span>&lt;T&amp;&amp;&gt; ä¼ å‚:  å³å€¼å¼•ç”¨</span><br><span class="line"> ä¼ é€’å·¦å€¼:</span><br><span class="line">         æ™®é€šä¼ å‚:  å·¦å€¼å¼•ç”¨</span><br><span class="line">       std::moveä¼ å‚:  å³å€¼å¼•ç”¨</span><br><span class="line">   std::forward ä¼ å‚:  å·¦å€¼å¼•ç”¨</span><br><span class="line"> <span class="keyword">static_cast</span>&lt;T&amp;&amp;&gt; ä¼ å‚:  å·¦å€¼å¼•ç”¨</span><br></pre></td></tr></table></figure>
<p>é€šä¿—çš„è®²å°±æ˜¯ï¼Œå¦‚æœåŸæ¥çš„å€¼æ˜¯å·¦å€¼ï¼Œç»std::forwardå¤„ç†åè¯¥å€¼è¿˜æ˜¯å·¦å€¼ï¼›å¦‚æœåŸæ¥çš„å€¼æ˜¯å³å€¼ï¼Œç»std::forwardå¤„ç†åå®ƒè¿˜æ˜¯å³å€¼ã€‚<br>å½“ <code>std::forward</code> æ¥å—å·¦å€¼æ—¶ï¼Œ_Tp è¢«æ¨å¯¼ä¸ºå·¦å€¼ï¼Œè€Œæ‰€ä»¥è¿”å›å€¼ä¸ºå·¦å€¼;è€Œå½“å…¶æ¥å—å³å€¼æ—¶ï¼Œ_Tp è¢«æ¨å¯¼ä¸ºå³å€¼å¼•ç”¨ï¼Œåˆ™åŸºäºåç¼©è§„åˆ™ï¼Œè¿”å›å€¼ä¾¿æˆä¸ºäº† &amp;&amp; + &amp;&amp; çš„å³å€¼ã€‚</p>
]]></content>
      <categories>
        <category>è¯­è¨€å­¦ä¹ </category>
        <category>c++</category>
        <category>ç°ä»£c++</category>
      </categories>
      <tags>
        <tag>c++</tag>
      </tags>
  </entry>
  <entry>
    <title>dockerä¸‹æ­å»ºwordpressç«™ç‚¹</title>
    <url>/2022/01/17/docker%E4%B8%8B%E6%90%AD%E5%BB%BAwordpress%E7%AB%99%E7%82%B9/</url>
    <content><![CDATA[<hr>
<p>[toc]</p>
<h2 id="ä¸ºä»€ä¹ˆè¦æ­å»ºä¸€ä¸ªwordpressç«™ç‚¹"><a href="#ä¸ºä»€ä¹ˆè¦æ­å»ºä¸€ä¸ªwordpressç«™ç‚¹" class="headerlink" title="ä¸ºä»€ä¹ˆè¦æ­å»ºä¸€ä¸ªwordpressç«™ç‚¹"></a>ä¸ºä»€ä¹ˆè¦æ­å»ºä¸€ä¸ªwordpressç«™ç‚¹</h2><p>æƒ³å†™åšå®¢äº†ï¼Œè®°å½•è‡ªå·±æŠ€æœ¯ä¸Šçš„æˆé•¿(ğŸ˜Š)ã€‚wordpressæ˜¯ä¸€ä¸ªåŠ¨æ€ç«™ç‚¹ï¼ˆå¯¹æ¯”githubåŠ hexoæ­å»ºçš„ï¼‰ã€‚wordpressæœåŠ¡å™¨æ­å»ºçš„ç½‘ç«™ï¼Œä¼˜ç‚¹åœ¨äºäº’åŠ¨å¾ˆå®¹æ˜“æ¯”å¦‚è¯„è®ºï¼Œé¡µé¢è®¾è®¡æ¯”è¾ƒè‡ªç”±ç­‰ã€‚ä½†æ˜¯ç¼ºç‚¹æ˜¯éœ€è¦è‡ªå·±é…ç½®æ•°æ®åº“å­˜æ•°æ®ï¼Œè€Œä¸”å¾ˆå¤šé…ç½®æ–‡ä»¶å¹¶ä¸æ˜¯å­˜åˆ°æ•°æ®åº“ä¸­çš„ï¼Œç§»æ¤æ€§å¾ˆå·®ã€‚æ–‡ç« æ ¼å¼å¹¶ä¸æ˜¯åŸç”Ÿæ”¯æŒmarkdownæ ¼å¼ï¼Œéœ€è¦è£…æ’ä»¶ã€‚æœ€ç»ˆé€‰æ‹©äº†ä½¿ç”¨hexoåŠ githubé‚£ä¸€å¥—ï¼Œæ¯•ç«Ÿæ–‡ç« ç¬”è®°éƒ½æ˜¯mdæ ¼å¼æ–‡ä»¶ï¼Œç§»æ¤æ€§é«˜ï¼Œé…ç½®å’Œç¯å¢ƒæ–‡ä»¶è¿˜æœ‰githubå…œåº•ï¼Œä¸è‡³äºåé¢ä¼šå‡ºç°ä¸¢æ•°æ®æƒ…å†µã€‚</p>
<span id="more"></span>
<!-- toc -->


<h2 id="å¦‚ä½•æ­å»ºä¸€ä¸ªwordpress"><a href="#å¦‚ä½•æ­å»ºä¸€ä¸ªwordpress" class="headerlink" title="å¦‚ä½•æ­å»ºä¸€ä¸ªwordpress"></a>å¦‚ä½•æ­å»ºä¸€ä¸ªwordpress</h2><blockquote>
<p>å‡†å¤‡å·¥ä½œ</p>
</blockquote>
<ul>
<li><input disabled="" type="checkbox"> wordpressçš„dockeré•œåƒ</li>
<li><input disabled="" type="checkbox"> mysql8.0çš„dockeré•œåƒ</li>
</ul>
<p><code>dockeræŸ¥çœ‹å½“å‰æ‹¥æœ‰çš„é•œåƒ</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>

<img src="3894430218373.png" width="50%">


<blockquote>
<p>é•œåƒçš„è¿è¡Œ</p>
</blockquote>
<h3 id="å‰ç½®äº‹é¡¹-éœ€è¦åˆ›å»ºå±äºmysqlè‡ªå·±çš„é…ç½®æ–‡ä»¶-å› ä¸ºæŒ‚è½½äº†ç›®å½•çš„ç¼˜æ•…å§"><a href="#å‰ç½®äº‹é¡¹-éœ€è¦åˆ›å»ºå±äºmysqlè‡ªå·±çš„é…ç½®æ–‡ä»¶-å› ä¸ºæŒ‚è½½äº†ç›®å½•çš„ç¼˜æ•…å§" class="headerlink" title="å‰ç½®äº‹é¡¹: éœ€è¦åˆ›å»ºå±äºmysqlè‡ªå·±çš„é…ç½®æ–‡ä»¶(å› ä¸ºæŒ‚è½½äº†ç›®å½•çš„ç¼˜æ•…å§)"></a>å‰ç½®äº‹é¡¹: éœ€è¦åˆ›å»ºå±äºmysqlè‡ªå·±çš„é…ç½®æ–‡ä»¶(å› ä¸ºæŒ‚è½½äº†ç›®å½•çš„ç¼˜æ•…å§)</h3><p>åœ¨mysqlç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªmy.cnfæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹: </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">user=mysql</span><br><span class="line">character-set-server=utf8</span><br><span class="line">default_authentication_plugin=mysql_native_password</span><br><span class="line">secure_file_priv=/var/lib/mysql</span><br><span class="line">expire_logs_days=7</span><br><span class="line">sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION</span><br><span class="line">max_connections=1000</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">default-character-set=utf8</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default-character-set=utf8</span><br></pre></td></tr></table></figure>

<h3 id="é¦–å…ˆæˆ‘ä»¬çš„æœåŠ¡å™¨ä¸Šè¦å®‰è£…mysql8-0"><a href="#é¦–å…ˆæˆ‘ä»¬çš„æœåŠ¡å™¨ä¸Šè¦å®‰è£…mysql8-0" class="headerlink" title="é¦–å…ˆæˆ‘ä»¬çš„æœåŠ¡å™¨ä¸Šè¦å®‰è£…mysql8.0"></a>é¦–å…ˆæˆ‘ä»¬çš„æœåŠ¡å™¨ä¸Šè¦å®‰è£…mysql8.0</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker run \</span><br><span class="line">--restart=always \</span><br><span class="line">--privileged=true \</span><br><span class="line">-p 3306:3306 --name mysql \</span><br><span class="line">-v /home/ubuntu/mysql/log:/var/log/mysql \</span><br><span class="line">-v /home/ubuntu/mysql/data:/var/lib/mysql \</span><br><span class="line">-v /home/ubuntu/mysql/my.cnf:/etc/mysql/my.cnf \</span><br><span class="line">-v /home/ubuntu/mysql/conf.d:/etc/mysql/conf.d \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=123456 \</span><br><span class="line">-d mysql:8.0</span><br></pre></td></tr></table></figure>
<p><code>è¿™é‡Œéœ€è¦æ³¨æ„çš„äº‹</code>:</p>
<ul>
<li>â€“restart: é€‰é¡¹æ˜¯å½“mysqlè¿è¡Œåœæ­¢åï¼Œè‡ªåŠ¨é‡å¯çš„é€‰é¡¹</li>
<li>â€“p: ç«¯å£æ˜ å°„ï¼Œæœ¬æœºç«¯å£:dockeré•œåƒç«¯å£</li>
<li>â€“name: è¿è¡Œçš„å®¹å™¨åå­—</li>
<li>-v: ç›®å½•æŒ‚è½½(<strong>å¾ˆé‡è¦</strong>)ï¼Œå°†mysqlçš„æ•°æ®åœ¨æœ¬åœ°ä¿å­˜ä¸€ä»½</li>
<li>-e: è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œè¯¥å‘½ä»¤æ˜¯ä¸ºäº†äº§ç”Ÿä¸€ä¸ªmysqlçš„rootç”¨æˆ·ï¼Œå¯†ç æ˜¯123456</li>
<li>-d: åå°è¿è¡Œ</li>
</ul>
<p><code>è¿è¡Œmysqlå®¹å™¨æˆåŠŸ</code>:<br>é€šè¿‡pså‘½ä»¤æŸ¥çœ‹</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>

<img src="5470225775896.png" width="50%">



<h3 id="wordpresså®¹å™¨çš„å¯åŠ¨"><a href="#wordpresså®¹å™¨çš„å¯åŠ¨" class="headerlink" title="wordpresså®¹å™¨çš„å¯åŠ¨"></a>wordpresså®¹å™¨çš„å¯åŠ¨</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker run --name some-wordpress --network=host -d wordpress:beta-php8.1</span><br></pre></td></tr></table></figure>
<p><code>æ³¨æ„</code></p>
<ul>
<li>é€‰ç”¨â€“network=host ä¿è¯wordpressä¸ä¸»æœºç½‘ç»œç¯å¢ƒä¸€è‡´</li>
<li>â€“network = host å¯ä»¥é¿å…å®¹å™¨ä¹‹é—´é€šä¿¡çš„éº»çƒ¦ï¼Œæ¯”å¦‚wordpresséœ€è¦è®¿é—®mysql8.0çš„å®¹å™¨<br>å¯åŠ¨æˆåŠŸ<img src="4611744564988.png" width="50%"></li>
</ul>
<h2 id="wordpressç™»å½•"><a href="#wordpressç™»å½•" class="headerlink" title="wordpressç™»å½•"></a>wordpressç™»å½•</h2><p>ä½¿ç”¨é»˜è®¤ç«¯å£80ç™»å½•<br><img src="3180015900739.png" width="50%"></p>
<p><strong>ä¸ºäº†å¤ç”¨åŸå…ˆmysqlæ•°æ®åº“çš„è¡¨(wordpressçš„ç½‘é¡µä»£ç éƒ½æ˜¯å­˜åˆ°è¡¨é‡Œé¢çš„)</strong><br>æˆ‘ä»¬éœ€è¦ä½¿ç”¨åŒä¸€ä¸ªè¡¨å</p>
<p><code>ç”±äºä½¿ç”¨äº†åˆ«çš„æ¨¡ç‰ˆ</code><br>wordpressæ— æ³•è§£æï¼Œå› æ­¤éœ€è¦é‡æ–°å»ä¸‹è½½ä¸»é¢˜å’Œæ’ä»¶(æ‰€ä»¥è¿™é‡Œæˆ‘è®¤ä¸ºï¼Œæ¨¡ç‰ˆä¸»é¢˜å’Œæ’ä»¶æ˜¯å­˜åœ¨å®¹å™¨ä¸­çš„ï¼Œå½“åˆ é™¤é‡å¯ï¼Œè¿™äº›æ’ä»¶éƒ½éœ€è¦é‡æ–°ä¸‹è½½)<br><img src="3015483849143.png" width="50%"></p>
<p><code>é‡æ–°å®‰è£…å›mynoteä¸»é¢˜</code></p>
<img src="1038716535785.png" width="50%">
ä¸€åˆ‡æ­£å¸¸ï¼Œæ–‡ç« ä¹Ÿéƒ½è¿˜åœ¨ã€‚

<h2 id="WordPressçš„ä½¿ç”¨"><a href="#WordPressçš„ä½¿ç”¨" class="headerlink" title="WordPressçš„ä½¿ç”¨"></a>WordPressçš„ä½¿ç”¨</h2><h3 id="æ’ä»¶ç›¸å…³"><a href="#æ’ä»¶ç›¸å…³" class="headerlink" title="æ’ä»¶ç›¸å…³"></a>æ’ä»¶ç›¸å…³</h3><ul>
<li>WP Githuber MD â€“ WordPress Markdown è¯­æ³•ç¼–è¾‘å™¨: ä½¿ç”¨markdownå†™ç½‘é¡µ</li>
</ul>
<h3 id="èœå•ç›¸å…³"><a href="#èœå•ç›¸å…³" class="headerlink" title="èœå•ç›¸å…³"></a>èœå•ç›¸å…³</h3><img src="3172019082263.png" width="50%">
é€šè¿‡èœå•å°†æ–°å¢çš„é¡µé¢æ·»åŠ è¿›å»ï¼Œå°†åœ¨èœå•ä¸Šå¢åŠ å¯¼èˆª

<h3 id="å°å·¥å…·ç›¸å…³"><a href="#å°å·¥å…·ç›¸å…³" class="headerlink" title="å°å·¥å…·ç›¸å…³"></a>å°å·¥å…·ç›¸å…³</h3><p>è¯¥åŠŸèƒ½ç›¸å½“äºå¸ƒå±€æ•´ä¸ªé¡µé¢æ¨¡å—</p>
]]></content>
      <categories>
        <category>æœåŠ¡å™¨éƒ¨ç½²</category>
        <category>wordpress</category>
      </categories>
      <tags>
        <tag>å®¹å™¨</tag>
        <tag>docker</tag>
        <tag>åšå®¢</tag>
      </tags>
  </entry>
  <entry>
    <title>dockerç®€ä»‹</title>
    <url>/2022/03/19/docker%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<hr>
<p>Docker æ˜¯ä¸€ä¸ªåº”ç”¨æ‰“åŒ…ã€åˆ†å‘ã€éƒ¨ç½²çš„å·¥å…·<br>ä½ ä¹Ÿå¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ªè½»é‡çš„è™šæ‹Ÿæœºï¼Œå®ƒåªè™šæ‹Ÿä½ è½¯ä»¶éœ€è¦çš„è¿è¡Œç¯å¢ƒï¼Œå¤šä½™çš„ä¸€ç‚¹éƒ½ä¸è¦ï¼Œ  è€Œæ™®é€šè™šæ‹Ÿæœºåˆ™æ˜¯ä¸€ä¸ªå®Œæ•´è€Œåºå¤§çš„ç³»ç»Ÿï¼ŒåŒ…å«å„ç§ä¸ç®¡ä½ è¦ä¸è¦çš„è½¯ä»¶ã€‚</p>
<span id="more"></span>

<!-- toc -->

<p>[toc]</p>
<p><a href="docker.easydoc.net">æ•™ç¨‹æ¨è</a></p>
<h2 id="dockeræ˜¯ä»€ä¹ˆ"><a href="#dockeræ˜¯ä»€ä¹ˆ" class="headerlink" title="dockeræ˜¯ä»€ä¹ˆ"></a>dockeræ˜¯ä»€ä¹ˆ</h2><h2 id="æ‰“åŒ…ï¼Œåˆ†å‘ï¼Œéƒ¨ç½²"><a href="#æ‰“åŒ…ï¼Œåˆ†å‘ï¼Œéƒ¨ç½²" class="headerlink" title="æ‰“åŒ…ï¼Œåˆ†å‘ï¼Œéƒ¨ç½²"></a>æ‰“åŒ…ï¼Œåˆ†å‘ï¼Œéƒ¨ç½²</h2><ul>
<li><strong>æ‰“åŒ…</strong>ï¼šå°±æ˜¯æŠŠä½ è½¯ä»¶è¿è¡Œæ‰€éœ€çš„ä¾èµ–ã€ç¬¬ä¸‰æ–¹åº“ã€è½¯ä»¶æ‰“åŒ…åˆ°ä¸€èµ·ï¼Œå˜æˆä¸€ä¸ªå®‰è£…åŒ…  </li>
<li><strong>åˆ†å‘</strong>ï¼šä½ å¯ä»¥æŠŠä½ æ‰“åŒ…å¥½çš„â€œå®‰è£…åŒ…â€ä¸Šä¼ åˆ°ä¸€ä¸ªé•œåƒä»“åº“ï¼Œå…¶ä»–äººå¯ä»¥éå¸¸æ–¹ä¾¿çš„è·å–å’Œå®‰è£…  </li>
<li><strong>éƒ¨ç½²</strong>ï¼šæ‹¿ç€â€œå®‰è£…åŒ…â€å°±å¯ä»¥ä¸€ä¸ªå‘½ä»¤è¿è¡Œèµ·æ¥ä½ çš„åº”ç”¨ï¼Œè‡ªåŠ¨æ¨¡æ‹Ÿå‡ºä¸€æ‘¸ä¸€æ ·çš„è¿è¡Œç¯å¢ƒï¼Œä¸ç®¡æ˜¯åœ¨ Windows/Mac/Linuxã€‚</li>
</ul>
<h2 id="docker-runå¿«é€Ÿå®‰è£…"><a href="#docker-runå¿«é€Ÿå®‰è£…" class="headerlink" title="docker runå¿«é€Ÿå®‰è£…"></a>docker runå¿«é€Ÿå®‰è£…</h2><p><a href="https://docs.docker.com/engine/reference/commandline/run/">docker runå‘½ä»¤å‚è€ƒ</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -d -p 6379:6379 --name redis redis:latest</span><br></pre></td></tr></table></figure>
<ul>
<li><code>--detach</code> , <code>-d</code> : Run container in background and print container IDï¼ˆåå°è¿è¡Œï¼‰</li>
<li><code>--publish</code> , <code>-p</code> : Publish a containerâ€™s port(s) to the hostï¼ˆæŒ‡å®šç«¯å£æ˜ å°„ï¼‰</li>
<li><code>--name</code> : Assign a name to the containerï¼ˆæŒ‡å®šå®¹å™¨åå­—ï¼‰</li>
<li>-i: é€‰é¡¹æŒ‡ç¤º docker è¦åœ¨å®¹å™¨ä¸Šæ‰“å¼€ä¸€ä¸ªæ ‡å‡†çš„è¾“å…¥æ¥å£</li>
<li>-t: æŒ‡ç¤º docker è¦åˆ›å»ºä¸€ä¸ªä¼ª tty ç»ˆç«¯ï¼Œè¿æ¥å®¹å™¨çš„æ ‡å‡†è¾“å…¥æ¥å£ï¼Œä¹‹åç”¨æˆ·å°±å¯ä»¥é€šè¿‡ç»ˆç«¯è¿›è¡Œè¾“å…¥ã€‚</li>
</ul>
<h2 id="åˆ¶ä½œè‡ªå·±çš„é•œåƒ"><a href="#åˆ¶ä½œè‡ªå·±çš„é•œåƒ" class="headerlink" title="åˆ¶ä½œè‡ªå·±çš„é•œåƒ"></a>åˆ¶ä½œè‡ªå·±çš„é•œåƒ</h2><p><a href="https://github.com/HannoKishi/gin-docker-learning">é¡¹ç›®åœ°å€</a></p>
<h3 id="ç¼–å†™Dockerfile"><a href="#ç¼–å†™Dockerfile" class="headerlink" title="ç¼–å†™Dockerfile"></a>ç¼–å†™Dockerfile</h3><p>ps: è¿™é‡Œgowebæ˜¯æˆ‘ä½¿ç”¨golangçš„ginæ¡†æ¶ç¼–å†™çš„ç®€å•çš„webæœåŠ¡å™¨çš„äºŒè¿›åˆ¶ã€‚</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:latest  </span><br><span class="line"><span class="keyword">MAINTAINER</span> <span class="string">&quot;enming&quot;</span>  </span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> . /app  </span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app  </span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum -y install wget</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8081</span>  </span><br><span class="line"><span class="keyword">ENV</span> NODE_VERSION <span class="number">7.2</span>.<span class="number">0</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> <span class="string">&quot;./goweb&quot;</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>FROM: åŸºäºfromé•œåƒ</li>
<li>RUN: ç”¨äºæ‰§è¡Œåé¢è·Ÿç€çš„å‘½ä»¤è¡Œå‘½ä»¤ï¼ŒDockerfile çš„æŒ‡ä»¤æ¯æ‰§è¡Œä¸€æ¬¡éƒ½ä¼šåœ¨ docker ä¸Šæ–°å»ºä¸€å±‚ã€‚æ‰€ä»¥è¿‡å¤šæ— æ„ä¹‰çš„å±‚ï¼Œä¼šé€ æˆé•œåƒè†¨èƒ€è¿‡å¤§ã€‚</li>
<li>MAINTAINTER: åˆ¶ä½œäººåå­—</li>
<li>COPY: å¤åˆ¶æŒ‡ä»¤ï¼Œä»ä¸Šä¸‹æ–‡ç›®å½•ä¸­å¤åˆ¶æ–‡ä»¶æˆ–è€…ç›®å½•åˆ°å®¹å™¨é‡ŒæŒ‡å®šè·¯å¾„ã€‚</li>
<li>ADD: ADD æŒ‡ä»¤å’Œ COPY çš„ä½¿ç”¨æ ¼ç±»ä¼¼ï¼ˆåŒæ ·éœ€æ±‚ä¸‹ï¼Œå®˜æ–¹æ¨èä½¿ç”¨ COPYï¼‰ã€‚</li>
<li>CMD: ç±»ä¼¼äº RUN æŒ‡ä»¤ï¼Œç”¨äºè¿è¡Œç¨‹åº.<ul>
<li>CMD åœ¨docker run æ—¶è¿è¡Œã€‚</li>
<li>RUN æ˜¯åœ¨ docker buildã€‚</li>
</ul>
</li>
<li>ENV: è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå®šä¹‰äº†ç¯å¢ƒå˜é‡</li>
<li>EXPOSE: ä»…ä»…åªæ˜¯å£°æ˜ç«¯å£ã€‚</li>
<li>WORKDIR: æŒ‡å®šå·¥ä½œç›®å½•ã€‚ç”¨ WORKDIR æŒ‡å®šçš„å·¥ä½œç›®å½•ï¼Œä¼šåœ¨æ„å»ºé•œåƒçš„æ¯ä¸€å±‚ä¸­éƒ½å­˜åœ¨ã€‚</li>
</ul>
<h3 id="æ„å»ºå‘½ä»¤"><a href="#æ„å»ºå‘½ä»¤" class="headerlink" title="æ„å»ºå‘½ä»¤"></a>æ„å»ºå‘½ä»¤</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// åœ¨dockerfileçš„ç›®å½•ä¸‹</span><br><span class="line">// gin_test: é•œåƒåå­—</span><br><span class="line">// v1: ç‰ˆæœ¬å·</span><br><span class="line">docker build -t gin_test:v1 .</span><br></pre></td></tr></table></figure>

<h4 id="è¿™é‡Œæœ‰ä¸ªå‘"><a href="#è¿™é‡Œæœ‰ä¸ªå‘" class="headerlink" title="è¿™é‡Œæœ‰ä¸ªå‘"></a>è¿™é‡Œæœ‰ä¸ªå‘</h4><p><a href="https://docs.docker.com/desktop/multi-arch/">å¤šæ„æ¶é•œåƒ</a><br>å¯¹äºä¸åŒcpuæ„æ¶éœ€è¦ä¸åŒçš„é•œåƒç¼–è¯‘ï¼Œè¿™é‡Œæä¾›ä¸€ä¸ªå¤šæ„æ¶é•œåƒç¼–è¯‘</p>
<h3 id="å¯åŠ¨å‘½ä»¤"><a href="#å¯åŠ¨å‘½ä»¤" class="headerlink" title="å¯åŠ¨å‘½ä»¤"></a>å¯åŠ¨å‘½ä»¤</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -d -p 8081:8081 --name test-gin gin_test:v1</span><br></pre></td></tr></table></figure>
<h3 id="é€šè¿‡curlå‘½ä»¤æŸ¥çœ‹dockerçš„webæœåŠ¡å™¨éƒ¨ç½²"><a href="#é€šè¿‡curlå‘½ä»¤æŸ¥çœ‹dockerçš„webæœåŠ¡å™¨éƒ¨ç½²" class="headerlink" title="é€šè¿‡curlå‘½ä»¤æŸ¥çœ‹dockerçš„webæœåŠ¡å™¨éƒ¨ç½²"></a>é€šè¿‡curlå‘½ä»¤æŸ¥çœ‹dockerçš„webæœåŠ¡å™¨éƒ¨ç½²</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl -d &#x27;&#123;&quot;username&quot;:&quot;123&quot;&#125; -X POST&#x27; 127.0.0.1:8081</span><br><span class="line"></span><br><span class="line">&#123;&quot;elapsedTime/ms&quot;:6,&quot;method&quot;:&quot;POST&quot;,&quot;username&quot;:&quot;123&quot;&#125;%</span><br></pre></td></tr></table></figure>

<h2 id="ç›®å½•æŒ‚è½½"><a href="#ç›®å½•æŒ‚è½½" class="headerlink" title="ç›®å½•æŒ‚è½½"></a>ç›®å½•æŒ‚è½½</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -it -v /test:/soft centos /bin/bash</span><br><span class="line"></span><br><span class="line">è¿™æ ·åœ¨å®¹å™¨å¯åŠ¨åï¼Œå®¹å™¨å†…ä¼šè‡ªåŠ¨åˆ›å»º/softçš„ç›®å½•ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æ˜ç¡®ä¸€ç‚¹ï¼Œå³-vå‚æ•°ä¸­ï¼Œå†’å·&quot;:&quot;å‰é¢çš„ç›®å½•æ˜¯å®¿ä¸»æœºç›®å½•ï¼Œåé¢çš„ç›®å½•æ˜¯å®¹å™¨å†…ç›®å½•ã€‚</span><br></pre></td></tr></table></figure>
<p>ps: è¦ä½¿ç”¨ç›¸å¯¹ç›®å½•ï¼Œè‹¥å®¹å™¨åˆ é™¤ï¼Œæœ¬æœºç›®å½•ä»ä¼šä¿ç•™</p>
<h2 id="æ›´å¤šç›¸å…³å‘½ä»¤"><a href="#æ›´å¤šç›¸å…³å‘½ä»¤" class="headerlink" title="æ›´å¤šç›¸å…³å‘½ä»¤"></a>æ›´å¤šç›¸å…³å‘½ä»¤</h2><ul>
<li><code>docker ps</code> æŸ¥çœ‹å½“å‰è¿è¡Œä¸­çš„å®¹å™¨  </li>
<li><code>docker images</code> æŸ¥çœ‹é•œåƒåˆ—è¡¨  </li>
<li><code>docker rm container-id</code> åˆ é™¤æŒ‡å®š id çš„å®¹å™¨  </li>
<li><code>docker stop/start container-id</code> åœæ­¢/å¯åŠ¨æŒ‡å®š id çš„å®¹å™¨  </li>
<li><code>docker rmi image-id</code> åˆ é™¤æŒ‡å®š id çš„é•œåƒ  </li>
<li><code>docker volume ls</code> æŸ¥çœ‹ volume åˆ—è¡¨  </li>
<li><code>docker network ls</code> æŸ¥çœ‹ç½‘ç»œåˆ—è¡¨</li>
</ul>
<h2 id="å¤šå®¹å™¨é€šä¿¡"><a href="#å¤šå®¹å™¨é€šä¿¡" class="headerlink" title="å¤šå®¹å™¨é€šä¿¡"></a>å¤šå®¹å™¨é€šä¿¡</h2><h3 id="ä½¿ç”¨è™šæ‹Ÿç½‘ç»œ"><a href="#ä½¿ç”¨è™šæ‹Ÿç½‘ç»œ" class="headerlink" title="ä½¿ç”¨è™šæ‹Ÿç½‘ç»œ"></a>ä½¿ç”¨è™šæ‹Ÿç½‘ç»œ</h3><p>è¦æƒ³å¤šå®¹å™¨ä¹‹é—´äº’é€šï¼Œä» Web å®¹å™¨è®¿é—® Redis å®¹å™¨ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠä»–ä»¬æ”¾åˆ°åŒä¸ªç½‘ç»œä¸­å°±å¯ä»¥äº†ã€‚</p>
<h3 id="åˆ›å»ºç½‘ç»œ"><a href="#åˆ›å»ºç½‘ç»œ" class="headerlink" title="åˆ›å»ºç½‘ç»œ"></a>åˆ›å»ºç½‘ç»œ</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker network create test-net</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºä¸€ä¸ªåä¸º<code>test-net</code>çš„ç½‘ç»œ</p>
<h3 id="æŒ‡å®šredisç½‘ç»œè¿è¡Œå®¹å™¨"><a href="#æŒ‡å®šredisç½‘ç»œè¿è¡Œå®¹å™¨" class="headerlink" title="æŒ‡å®šredisç½‘ç»œè¿è¡Œå®¹å™¨"></a>æŒ‡å®šredisç½‘ç»œè¿è¡Œå®¹å™¨</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -d --name redis --network test-net --network-alias redis redis:latest`</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œ â€“network-aliasç›¸å½“äºæŒ‡å®šhostname</p>
<h3 id="æŒ‡å®šwebæœåŠ¡è¿è¡Œçš„network"><a href="#æŒ‡å®šwebæœåŠ¡è¿è¡Œçš„network" class="headerlink" title="æŒ‡å®šwebæœåŠ¡è¿è¡Œçš„network"></a>æŒ‡å®šwebæœåŠ¡è¿è¡Œçš„network</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -p 8081:8081 --name test --network test-net -d gin_test2:v1</span><br></pre></td></tr></table></figure>
<p>åœ¨æœåŠ¡å™¨çš„ä»£ç ä¸­ï¼Œredisçš„åœ°å€å¯ä»¥ä½¿ç”¨åˆ«å<code>redis</code></p>
<h3 id="example"><a href="#example" class="headerlink" title="example"></a>example</h3><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">   <span class="string">&quot;context&quot;</span>  </span><br><span class="line"> <span class="string">&quot;fmt&quot;</span> <span class="string">&quot;github.com/gin-gonic/gin&quot;</span> <span class="string">&quot;github.com/go-redis/redis/v8&quot;</span> <span class="string">&quot;net/http&quot;</span> <span class="string">&quot;os&quot;</span> <span class="string">&quot;strconv&quot;</span> <span class="string">&quot;time&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;  </span><br><span class="line">   Username <span class="keyword">string</span> <span class="string">`json:&quot;username&quot;`</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">   engine := gin.Default()  </span><br><span class="line">  </span><br><span class="line">   engine.GET(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;  </span><br><span class="line">      startTime := time.Now()  </span><br><span class="line">  </span><br><span class="line">      c.JSON(http.StatusOK, gin.H&#123;  </span><br><span class="line">         <span class="string">&quot;method&quot;</span>:         http.MethodGet,  </span><br><span class="line"> <span class="string">&quot;elapsedTime/ms&quot;</span>: time.Since(startTime).Milliseconds(),  </span><br><span class="line"> &#125;)  </span><br><span class="line">   &#125;)  </span><br><span class="line">  </span><br><span class="line">   engine.POST(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;  </span><br><span class="line">      startTime := time.Now()  </span><br><span class="line">  </span><br><span class="line">      <span class="keyword">var</span> u User  </span><br><span class="line"> err := c.BindJSON(&amp;u)  </span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">         c.JSON(http.StatusOK, gin.H&#123;  </span><br><span class="line">            <span class="string">&quot;error&quot;</span>: err.Error(),  </span><br><span class="line"> &#125;)  </span><br><span class="line">         <span class="keyword">return</span>  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">      c.JSON(http.StatusOK, gin.H&#123;  </span><br><span class="line">         <span class="string">&quot;method&quot;</span>:         http.MethodPost,  </span><br><span class="line"> <span class="string">&quot;elapsedTime/ms&quot;</span>: time.Since(startTime).Milliseconds(),  </span><br><span class="line"> <span class="string">&quot;username&quot;</span>:       u.Username,  </span><br><span class="line"> &#125;)  </span><br><span class="line">   &#125;)  </span><br><span class="line">  </span><br><span class="line">   <span class="comment">// å¢åŠ ä¸€ä¸ªredisè®¿é—®,è¿™é‡Œçš„hostnameé€‰ç”¨  --network-aliasè®¾ç½®çš„åˆ«å</span></span><br><span class="line"> rdb := redis.NewClient(&amp;redis.Options&#123;  </span><br><span class="line">      Addr:     <span class="string">&quot;redis:6379&quot;</span>,  </span><br><span class="line"> Password: <span class="string">&quot;&quot;</span>, <span class="comment">// no password set  </span></span><br><span class="line"> DB:       <span class="number">0</span>, <span class="comment">// use default DB  </span></span><br><span class="line"> &#125;)  </span><br><span class="line">   ctx:= context.Background()  </span><br><span class="line">   pong, err := rdb.Ping(ctx).Result()  </span><br><span class="line">   fmt.Println(pong, err)  </span><br><span class="line">   <span class="keyword">if</span> err!=<span class="literal">nil</span>&#123;  </span><br><span class="line">      os.Exit(<span class="number">-1</span>)  </span><br><span class="line">   &#125;  </span><br><span class="line">   _,err = rdb.Get(ctx,<span class="string">&quot;key&quot;</span>).Result()  </span><br><span class="line">   <span class="comment">// ä¸å­˜åœ¨keyåˆ™åˆ›å»º  </span></span><br><span class="line"> <span class="keyword">if</span> err==redis.Nil&#123;  </span><br><span class="line">      _,err = rdb.Set(ctx,<span class="string">&quot;key&quot;</span>,<span class="string">&quot;1&quot;</span>,<span class="number">0</span>).Result()  </span><br><span class="line">      <span class="keyword">if</span> err!=<span class="literal">nil</span>&#123;  </span><br><span class="line">         fmt.Println(err)  </span><br><span class="line">         os.Exit(<span class="number">-1</span>)  </span><br><span class="line">      &#125;  </span><br><span class="line">   &#125;  </span><br><span class="line">  </span><br><span class="line">   engine.GET(<span class="string">&quot;/redis&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;  </span><br><span class="line">      startTime := time.Now()  </span><br><span class="line">      val ,err:= rdb.Get(ctx,<span class="string">&quot;key&quot;</span>).Result()  </span><br><span class="line">      <span class="keyword">if</span> err!=<span class="literal">nil</span>&#123;  </span><br><span class="line">         c.JSON(http.StatusOK, gin.H&#123;  </span><br><span class="line">            <span class="string">&quot;method&quot;</span>:         http.MethodGet,  </span><br><span class="line"> <span class="string">&quot;elapsedTime/ms&quot;</span>: time.Since(startTime).Milliseconds(),  </span><br><span class="line"> <span class="string">&quot;err&quot;</span>:<span class="string">&quot;Redis Get Key Error&quot;</span>,  </span><br><span class="line"> &#125;)  </span><br><span class="line">         <span class="keyword">return</span>  </span><br><span class="line"> &#125;  </span><br><span class="line">      current,_ := strconv.Atoi(val)  </span><br><span class="line">      _,err = rdb.Set(ctx,<span class="string">&quot;key&quot;</span>,current+<span class="number">1</span>,<span class="number">0</span>).Result()  </span><br><span class="line">      <span class="keyword">if</span> err!=<span class="literal">nil</span>&#123;  </span><br><span class="line">         c.JSON(http.StatusOK, gin.H&#123;  </span><br><span class="line">            <span class="string">&quot;method&quot;</span>:         http.MethodGet,  </span><br><span class="line"> <span class="string">&quot;elapsedTime/ms&quot;</span>: time.Since(startTime).Milliseconds(),  </span><br><span class="line"> <span class="string">&quot;err&quot;</span>:<span class="string">&quot;Redis Set Key Error&quot;</span>,  </span><br><span class="line"> &#125;)  </span><br><span class="line">         <span class="keyword">return</span>  </span><br><span class="line"> &#125;  </span><br><span class="line">      c.JSON(http.StatusOK, gin.H&#123;  </span><br><span class="line">         <span class="string">&quot;method&quot;</span>:         http.MethodGet,  </span><br><span class="line"> <span class="string">&quot;elapsedTime/ms&quot;</span>: time.Since(startTime).Milliseconds(),  </span><br><span class="line"> <span class="string">&quot;redisKey&quot;</span>:current+<span class="number">1</span>,  </span><br><span class="line"> &#125;)  </span><br><span class="line">   &#125;)  </span><br><span class="line">  </span><br><span class="line">   engine.Run(<span class="string">&quot;:8081&quot;</span>)  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="curl-å‘½ä»¤"><a href="#curl-å‘½ä»¤" class="headerlink" title="curl å‘½ä»¤"></a>curl å‘½ä»¤</h3><ul>
<li>post<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl -d &#x27;&#123;&quot;username&quot;:&quot;123&quot;&#125; -X POST&#x27; 127.0.0.1:8081</span><br><span class="line">&#123;&quot;elapsedTime/ms&quot;:10,&quot;method&quot;:&quot;POST&quot;,&quot;username&quot;:&quot;123&quot;&#125;%</span><br></pre></td></tr></table></figure></li>
<li>get<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl  -X GET 127.0.0.1:8081/redis</span><br><span class="line">&#123;&quot;elapsedTime/ms&quot;:1,&quot;method&quot;:&quot;GET&quot;,&quot;redisKey&quot;:21&#125;%</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker-Compose"></a>Docker-Compose</h2><p>ä½¿ç”¨docker-composeå°†å¤šä¸ªæœåŠ¡é›†åˆåˆ°ä¸€èµ·ï¼Œä¸€é”®è¿è¡Œã€‚<br><a href="https://yeasy.gitbook.io/docker_practice/compose/compose_file">é…ç½®æ¨¡ç‰ˆä¸è¯¦ç»†å‚æ•°</a></p>
<h3 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.7&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="attr">services:</span>  </span><br><span class="line">  <span class="attr">app:</span>  </span><br><span class="line">    <span class="attr">build:</span> <span class="string">./</span>  </span><br><span class="line">    <span class="attr">ports:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="number">8082</span><span class="string">:8081</span>  </span><br><span class="line">    <span class="attr">volumes:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="string">./:/app</span>  </span><br><span class="line">    <span class="attr">environment:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span>  </span><br><span class="line">  <span class="attr">redis:</span>  </span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:latest</span>  </span><br><span class="line">    <span class="attr">volumes:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis:/data</span>  </span><br><span class="line">    <span class="attr">environment:</span>  </span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span>  </span><br><span class="line">  </span><br><span class="line"><span class="attr">volumes:</span>  </span><br><span class="line">  <span class="attr">redis:</span></span><br></pre></td></tr></table></figure>
<ul>
<li>services: å¼€å¯çš„æœåŠ¡ï¼Œå¯¹åº”ç›¸åº”å®¹å™¨</li>
<li>build: æ‰§è¡Œdockerfileçš„build</li>
<li>ports: ç«¯å£æ˜ å°„</li>
<li>volumes: å®¿ä¸»æœºä¸å®¹å™¨å¯¹åº”çš„æŒ‚è½½æ˜ å°„</li>
<li>environment: ç¯å¢ƒå˜é‡è®¾ç½®</li>
<li>image: é•œåƒåå­—,å¦‚æœæ²¡æœ‰åˆ™å°è¯•æ‹‰å»</li>
<li>volumes/redis: å®šä¹‰å®¿ä¸»æœºå™¨rediså˜é‡çš„ä½ç½®</li>
</ul>
<h3 id="docker-composeå‘½ä»¤"><a href="#docker-composeå‘½ä»¤" class="headerlink" title="docker-composeå‘½ä»¤"></a>docker-composeå‘½ä»¤</h3><p>åœ¨<code>docker-compose.yml</code> æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼Œæ‰§è¡Œï¼š<code>docker-compose up</code>å°±å¯ä»¥è·‘èµ·æ¥äº†ã€‚</p>
<ul>
<li>è¿è¡Œåº”ç”¨ç¨‹åºå †æ ˆåå°<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
åœ¨åå°è¿è¡Œåªéœ€è¦åŠ ä¸€ä¸ª -d å‚æ•°<code>docker-compose up -d</code><br>æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ï¼š<code>docker-compose ps</code><br>åœæ­¢è¿è¡Œï¼š<code>docker-compose stop</code><br>é‡å¯ï¼š<code>docker-compose restart</code><br>é‡å¯å•ä¸ªæœåŠ¡ï¼š<code>docker-compose restart service-name</code><br>è¿›å…¥å®¹å™¨å‘½ä»¤è¡Œï¼š<code>docker-compose exec service-name sh</code><br>æŸ¥çœ‹å®¹å™¨è¿è¡Œlogï¼š<code>docker-compose logs [service-name]</code></li>
</ul>
<h2 id="é•œåƒä¸Šä¼ "><a href="#é•œåƒä¸Šä¼ " class="headerlink" title="é•œåƒä¸Šä¼ "></a>é•œåƒä¸Šä¼ </h2><h3 id="é¦–å…ˆè¦ç™»é™†"><a href="#é¦–å…ˆè¦ç™»é™†" class="headerlink" title="é¦–å…ˆè¦ç™»é™†"></a>é¦–å…ˆè¦ç™»é™†</h3><ul>
<li>è¿™é‡Œæˆ‘ä½¿ç”¨çš„è…¾è®¯äº‘<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker login --username=100008323897 ccr.ccs.tencentyun.com/longdbtencentdocker/publongdb</span><br></pre></td></tr></table></figure>
<h3 id="æ‰“tag"><a href="#æ‰“tag" class="headerlink" title="æ‰“tag"></a>æ‰“tag</h3></li>
<li>è¦æå‰åœ¨è…¾è®¯äº‘åˆ›å»ºå‘½åç©ºé—´<ul>
<li>è¿™é‡Œæˆ‘æå‰åˆ›å»ºäº†ä¸€ä¸ªhannokishiçš„å‘½åç©ºé—´<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker tag XXXXXXX ccr.ccs.tencentyun.com/å‘½åç©ºé—´/åç§°:ç‰ˆæœ¬</span><br><span class="line"><span class="meta">#</span><span class="bash"> eg:</span></span><br><span class="line">docker tag gin-docker-learning_app ccr.ccs.tencentyun.com/hannokishi/k8s-test:v1</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="push"><a href="#push" class="headerlink" title="push"></a>push</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> pushå‘½ä»¤</span></span><br><span class="line">docker push ccr.ccs.tencentyun.com/hannokishi/k8s-test:v1</span><br><span class="line"><span class="meta">#</span><span class="bash"> pushç»“æœ</span></span><br><span class="line">The push refers to repository [ccr.ccs.tencentyun.com/hannokishi/k8s-test]</span><br><span class="line">5f70bf18a086: Pushed</span><br><span class="line">a4eb62abdd2f: Pushed</span><br><span class="line">534ef0372885: Pushed</span><br><span class="line">v1: digest: sha256:fdac2dacf32ba833df1076a93fe7d1500e4eabc8d1193670271f17b57f712a52 size: 946</span><br></pre></td></tr></table></figure>

<ul>
<li>å¾—åˆ°ä¸€ä¸ªé•œåƒåœ°å€<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ccr.ccs.tencentyun.com/hannokishi/k8s-test</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>å®¹å™¨</category>
        <category>docker</category>
      </categories>
      <tags>
        <tag>å®¹å™¨</tag>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>golangçš„å¤§å°å †heapå®ç°</title>
    <url>/2022/05/04/golang%E7%9A%84%E5%A4%A7%E5%B0%8F%E5%A0%86heap%E5%AE%9E%E7%8E%B0/</url>
    <content><![CDATA[<p>åœ¨leetcodeåˆ·é¢˜æ—¶å€™ï¼Œä¼šç”¨åˆ°å¤§å°å †çš„æ•°æ®ç»“æ„ã€‚åœ¨goè¯­è¨€ä¸­ï¼Œå¤§å°å †çš„å®ç°æ˜¯æœ‰ç°æˆçš„æ¥å£çš„ã€‚</p>
<span id="more"></span>

<!-- toc -->


<h2 id="container-heapåŒ…"><a href="#container-heapåŒ…" class="headerlink" title="container/heapåŒ…"></a>container/heapåŒ…</h2><p>åœ¨goè¯­è¨€ä¸­ï¼Œ<code>container/heap</code>åŒ…ä¸­å­˜åœ¨ä¸€ä¸ªæ¥å£ã€‚</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span> &#123;  </span><br><span class="line"> sort.Interface  </span><br><span class="line"> Push(x any) <span class="comment">// add x as element Len()  </span></span><br><span class="line"> Pop() any   <span class="comment">// remove and return element Len() - 1.  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¦å®ç°è¯¥æ¥å£éœ€è¦å®ç°å…·ä½“çš„æ–¹æ³•ã€‚</p>
<ul>
<li><code>sort.Interface</code>æ¥å£ï¼ˆsortåŒ…ä¸­ï¼‰</li>
</ul>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span> &#123;  </span><br><span class="line">	<span class="comment">// Len is the number of elements in the collection.</span></span><br><span class="line">	Len() <span class="keyword">int</span></span><br><span class="line">	<span class="comment">// See Float64Slice.Less for a correct implementation for floating-point values.</span></span><br><span class="line">	Less(i, j <span class="keyword">int</span>) <span class="keyword">bool</span></span><br><span class="line">	<span class="comment">// Swap swaps the elements with indexes i and j.</span></span><br><span class="line">	Swap(i, j <span class="keyword">int</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› æ­¤è¦å®ç°ä¸€ä¸ªæŒ‡å®šæ•°æ®ç»“æ„çš„å¤§å°å †éœ€è¦å®ç°ä¸€ä¸‹çš„æ–¹æ³•ï¼š</p>
<ul>
<li>Push(x any) : å¢åŠ ä¸€ä¸ªå…ƒç´ </li>
<li>Pop() any : è¿”å›ä¸€ä¸ªå…ƒç´ </li>
<li>Len() int : è¿”å›é•¿åº¦</li>
<li>Less(i, j int) bool : å…ƒç´ å¤§å°æ¯”è¾ƒæ–¹æ³•</li>
<li>Swap(i, j int) : äº¤æ¢å…ƒç´ æ–¹æ³•</li>
</ul>
<h2 id="ä»¥intç±»å‹ä¸¾ä¾‹å¤§å°å †"><a href="#ä»¥intç±»å‹ä¸¾ä¾‹å¤§å°å †" class="headerlink" title="ä»¥intç±»å‹ä¸¾ä¾‹å¤§å°å †"></a>ä»¥intç±»å‹ä¸¾ä¾‹å¤§å°å †</h2><h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ªåŸºäºintæ•°ç»„çš„å †</span></span><br><span class="line"><span class="keyword">type</span> minHeap []<span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡å†™ sortçš„ä¸‰ä¸ªæ–¹æ³•</span></span><br><span class="line"><span class="comment">// é•¿åº¦</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h minHeap)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(h)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¯”è¾ƒè§„åˆ™</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h minHeap)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="comment">// è¿™é‡Œå¦‚æœæ˜¯å°äºï¼Œé‚£ä¹ˆå®ç°çš„æ˜¯å°æ ¹å †ï¼Œå¦‚æœæ˜¯å¤§äºå®ç°çš„æ˜¯å¤§æ ¹å †</span></span><br><span class="line">	<span class="comment">// è¿™æ˜¯Swapçš„å‰ç½®äº¤æ¢æ¡ä»¶</span></span><br><span class="line">	<span class="keyword">return</span> h[i] &lt; h[j]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// äº¤æ¢è§„åˆ™</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h minHeap)</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	h[i], h[j] = h[j], h[i]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡å†™heapçš„pushå’Œpopæ–¹æ³•</span></span><br><span class="line"><span class="comment">// çœ‹æºç çŸ¥é“ï¼Œpushæ–¹æ³•åªéœ€è¦åœ¨æ•°æ®é›†æœ«å°¾å¢åŠ å€¼v</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *minHeap)</span> <span class="title">Push</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	*h = <span class="built_in">append</span>(*h, v.(<span class="keyword">int</span>))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// çœ‹æºç çŸ¥é“ï¼Œpopæ–¹æ³•æ˜¯å°†æœ€åä¸€ä¸ªå€¼åˆ é™¤å¹¶è¿”å›</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªä¸å¥½ç†è§£ï¼ŒæŒ‰æˆ‘ä»¬çš„ç†è§£ï¼Œpopåº”è¯¥æ˜¯å–æ ¹èŠ‚ç‚¹ ä¹Ÿå°±æ˜¯åˆ é™¤ç¬¬ä¸€ä¸ªå€¼</span></span><br><span class="line"><span class="comment">// å®é™…ä¸Šæ³¨æ„æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å·¥å…·åŒ…ï¼Œè¿™ä¸ªPopä¸æ˜¯çœŸæ­£çš„Pop</span></span><br><span class="line"><span class="comment">// å·¥å…·åŒ…çš„Popä¼šå°†æ ¹èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹å…ˆè¿›è¡Œäº¤æ¢ï¼Œæ‰€ä»¥æˆ‘ä»¬æ­¤æ—¶çš„Popåªéœ€è¦åˆ é™¤æœ€åä¸€ä¸ªå€¼è¿”å›å°±å¥½</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *minHeap)</span> <span class="title">Pop</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">	last := <span class="built_in">len</span>(*h) - <span class="number">1</span></span><br><span class="line">	v := (*h)[last]</span><br><span class="line">	*h = (*h)[:last]</span><br><span class="line">	<span class="keyword">return</span> v</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ps:</strong> è¿™é‡Œçš„popéœ€è¦æ³¨æ„ï¼Œæˆ‘ä»¬ç†è§£åº”è¯¥æ˜¯popæœ€å¤§æœ€å°å †çš„æ ¹èŠ‚ç‚¹ï¼Œä½†å®é™…ä¸Šæ˜¯æˆ‘ä»¬è°ƒç”¨<code>heap.Pop()</code>ç„¶åè¯¥å‡½æ•°é‡Œé¢åœ¨è°ƒç”¨æ¥å£çš„<code>Pop()</code>ï¼Œåœ¨è¿™ä¹‹å‰ï¼Œä¼šå°†æœ€åçš„å…ƒç´ å’Œç¬¬ä¸€ä¸ªå…ƒç´ äº¤æ¢ã€‚</p>
<h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">   <span class="string">&quot;container/heap&quot;</span>  </span><br><span class="line">   <span class="string">&quot;fmt&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">   h := minHeap&#123;<span class="number">5</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>&#125;  </span><br><span class="line">   <span class="comment">// æ‰“å°åŸæ¥çš„æ•°æ®é›†  </span></span><br><span class="line">   fmt.Println(h)  <span class="comment">// [5 4 3 2 1]</span></span><br><span class="line">   <span class="comment">// åˆå§‹åŒ–æ•°æ®é›†å˜æˆå †  </span></span><br><span class="line">   heap.Init(&amp;h)  </span><br><span class="line">   fmt.Println(h)  <span class="comment">// [1 2 3 5 4]</span></span><br><span class="line">   <span class="comment">// å¢åŠ ä¸€ä¸ªå€¼  </span></span><br><span class="line">   heap.Push(&amp;h, <span class="number">6</span>)</span><br><span class="line">   fmt.Println(h)  <span class="comment">// [1 2 3 5 4 6]  </span></span><br><span class="line">   <span class="comment">// æ ¹èŠ‚ç‚¹å‡ºå †  </span></span><br><span class="line">   heap.Pop(&amp;h)  </span><br><span class="line">   fmt.Println(h)  <span class="comment">// [2 4 3 5 6]</span></span><br><span class="line">   <span class="comment">// åˆ é™¤ç¬¬iä¸ªå€¼  </span></span><br><span class="line">   heap.Remove(&amp;h, <span class="number">2</span>)  </span><br><span class="line">   fmt.Println(h)  <span class="comment">// [2 4 6 5]</span></span><br><span class="line">   <span class="comment">// ä¿®æ”¹ç¬¬2ä¸ªå€¼ä¸ºv  </span></span><br><span class="line">   h[<span class="number">2</span>] = <span class="number">1</span>  </span><br><span class="line">   <span class="comment">// fixæ–¹æ³•æ˜¯åœ¨ç¬¬iä¸ªå€¼è¢«ä¿®æ”¹åï¼ŒåŸºäºä¿®æ”¹å€¼æ„å»ºå †  </span></span><br><span class="line">   heap.Fix(&amp;h, <span class="number">2</span>)  </span><br><span class="line">   fmt.Println(h)  <span class="comment">// [1 4 2 5]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä»¥ListNodeç±»å‹ä¸¾ä¾‹"><a href="#ä»¥ListNodeç±»å‹ä¸¾ä¾‹" class="headerlink" title="ä»¥ListNodeç±»å‹ä¸¾ä¾‹"></a>ä»¥ListNodeç±»å‹ä¸¾ä¾‹</h2><h3 id="ä»£ç å®ç°-1"><a href="#ä»£ç å®ç°-1" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Definition for singly-linked list.  </span></span><br><span class="line"><span class="keyword">type</span> ListNode <span class="keyword">struct</span> &#123;  </span><br><span class="line">  Val <span class="keyword">int</span>  </span><br><span class="line">  Next *ListNode  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> maxHeap []*ListNode  </span><br><span class="line"><span class="comment">// é•¿åº¦  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(h maxHeap)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123;  </span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">len</span>(h)  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">// æ¯”è¾ƒè§„åˆ™  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h maxHeap)</span> <span class="title">Less</span><span class="params">(i,j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;  </span><br><span class="line">   <span class="keyword">return</span> h[i].Val &gt; h[j].Val  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">// äº¤æ¢è§„åˆ™  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h maxHeap)</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span>&#123;  </span><br><span class="line">   h[i],h[j] = h[j],h[i]  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">// push  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(h *maxHeap)</span> <span class="title">Push</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;  </span><br><span class="line">   *h = <span class="built_in">append</span>(*h,v.(*ListNode))  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">// pop  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h * maxHeap)</span><span class="title">Pop</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;  </span><br><span class="line">   last := <span class="built_in">len</span>(*h) - <span class="number">1</span>  </span><br><span class="line">   v := (*h)[last]  </span><br><span class="line">   *h = (*h)[:last]  </span><br><span class="line">   <span class="keyword">return</span> v  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æµ‹è¯•-1"><a href="#æµ‹è¯•-1" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">   <span class="comment">// listè¡¨  </span></span><br><span class="line">   l1 := &amp;ListNode&#123;<span class="number">1</span>,<span class="literal">nil</span>&#125;  </span><br><span class="line">   l2 := &amp;ListNode&#123;<span class="number">2</span>,<span class="literal">nil</span>&#125;  </span><br><span class="line">   l3 := &amp;ListNode&#123;<span class="number">3</span>,<span class="literal">nil</span>&#125;  </span><br><span class="line">   l4 := &amp;ListNode&#123;<span class="number">4</span>,<span class="literal">nil</span>&#125;  </span><br><span class="line">   l5 := &amp;ListNode&#123;<span class="number">5</span>,<span class="literal">nil</span>&#125;  </span><br><span class="line">   part := maxHeap&#123;l1,l2,l3,l4,l5&#125;  </span><br><span class="line">   <span class="keyword">for</span> _,i := <span class="keyword">range</span> part&#123;  </span><br><span class="line">      fmt.Print(i.Val)  </span><br><span class="line">   &#125;  </span><br><span class="line">   fmt.Println() <span class="comment">// 12345  </span></span><br><span class="line">   <span class="comment">// åˆå§‹åŒ–   heap.Init(&amp;part)  </span></span><br><span class="line">   <span class="keyword">for</span> _,i := <span class="keyword">range</span> part&#123;  </span><br><span class="line">      fmt.Print(i.Val)  </span><br><span class="line">   &#125;  </span><br><span class="line">   fmt.Println() <span class="comment">// 54312  </span></span><br><span class="line">   <span class="comment">// å¢åŠ å€¼   heap.Push(&amp;part,&amp;ListNode&#123;7,nil&#125;)  </span></span><br><span class="line">   <span class="keyword">for</span> _,i := <span class="keyword">range</span> part&#123;  </span><br><span class="line">      fmt.Print(i.Val)  </span><br><span class="line">   &#125;  </span><br><span class="line">   fmt.Println() <span class="comment">// 745123  </span></span><br><span class="line">   <span class="comment">// ç§»é™¤å€¼   heap.Pop(&amp;part)  </span></span><br><span class="line">   <span class="keyword">for</span> _,i := <span class="keyword">range</span> part&#123;  </span><br><span class="line">      fmt.Print(i.Val)  </span><br><span class="line">   &#125;  </span><br><span class="line">   fmt.Println() <span class="comment">// 54312  </span></span><br><span class="line">   <span class="comment">// ä¿®æ”¹æŸä¸ªå€¼ä¹‹åé‡æ–°æ’åˆ—   part[3].Val = 7  </span></span><br><span class="line">   heap.Fix(&amp;part,<span class="number">3</span>)  </span><br><span class="line">   <span class="keyword">for</span> _,i := <span class="keyword">range</span> part&#123;  </span><br><span class="line">      fmt.Print(i.Val)  </span><br><span class="line">   &#125;  </span><br><span class="line">   fmt.Println() <span class="comment">// 75342  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2022/05/24/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>kafkaç®€ä»‹</title>
    <url>/2022/02/16/kafka%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<hr>
<p>Apache Kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼å‘å¸ƒ - è®¢é˜…æ¶ˆæ¯ç³»ç»Ÿå’Œä¸€ä¸ªå¼ºå¤§çš„é˜Ÿåˆ—ï¼Œå¯ä»¥å¤„ç†å¤§é‡çš„æ•°æ®ï¼Œå¹¶ä½¿ä½ èƒ½å¤Ÿå°†æ¶ˆæ¯ä»ä¸€ä¸ªç«¯ç‚¹ä¼ é€’åˆ°å¦ä¸€ä¸ªç«¯ç‚¹ã€‚ Kafka é€‚åˆç¦»çº¿å’Œåœ¨çº¿æ¶ˆæ¯æ¶ˆè´¹ã€‚ Kafka æ¶ˆæ¯ä¿ç•™åœ¨ç£ç›˜ä¸Šï¼Œå¹¶åœ¨ç¾¤é›†å†…å¤åˆ¶ä»¥é˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚ Kafka æ„å»ºåœ¨ ZooKeeper åŒæ­¥æœåŠ¡ä¹‹ä¸Šã€‚ å®ƒä¸ Apache Storm å’Œ Spark éå¸¸å¥½åœ°é›†æˆï¼Œç”¨äºå®æ—¶æµå¼æ•°æ®åˆ†æã€‚</p>
<p>ç”±äºé¡¹ç›®çš„æ—¥å¿—è¦é€šè¿‡filebeatå…¥kafkaï¼Œå› æ­¤åˆæ­¥ç®€å•çš„äº†è§£ä¸‹kafkaã€‚</p>
<span id="more"></span>
<!-- toc -->

<p>[toc]</p>
<p>Kafka æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå…·æœ‰é«˜æ€§èƒ½ã€æŒä¹…åŒ–ã€å¤šå‰¯æœ¬å¤‡ä»½ã€æ¨ªå‘æ‰©å±•èƒ½åŠ›ã€‚ç”Ÿäº§è€…å¾€é˜Ÿåˆ—é‡Œå†™æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ä»é˜Ÿåˆ—é‡Œå–æ¶ˆæ¯è¿›è¡Œä¸šåŠ¡é€»è¾‘ã€‚ä¸€èˆ¬åœ¨æ¶æ„è®¾è®¡ä¸­èµ·åˆ°è§£è€¦ã€å‰Šå³°ã€å¼‚æ­¥å¤„ç†çš„ä½œç”¨ã€‚</p>
<h2 id="åè¯è§£é‡Š"><a href="#åè¯è§£é‡Š" class="headerlink" title="åè¯è§£é‡Š"></a>åè¯è§£é‡Š</h2><ul>
<li><strong>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼ˆproducerå’Œconsumerï¼‰</strong>ï¼šæ¶ˆæ¯çš„å‘é€è€…å« Producerï¼Œæ¶ˆæ¯çš„ä½¿ç”¨è€…å’Œæ¥å—è€…æ˜¯ Consumerï¼Œç”Ÿäº§è€…å°†æ•°æ®ä¿å­˜åˆ° Kafka é›†ç¾¤ä¸­ï¼Œæ¶ˆè´¹è€…ä»ä¸­è·å–æ¶ˆæ¯è¿›è¡Œä¸šåŠ¡çš„å¤„ç†ã€‚</li>
<li><strong>broker</strong>ï¼šKafka é›†ç¾¤ä¸­æœ‰å¾ˆå¤šå° Serverï¼Œå…¶ä¸­æ¯ä¸€å° Server éƒ½å¯ä»¥å­˜å‚¨æ¶ˆæ¯ï¼Œå°†æ¯ä¸€å° Server ç§°ä¸ºä¸€ä¸ª kafka å®ä¾‹ï¼Œä¹Ÿå«åš brokerã€‚</li>
<li><strong>ä¸»é¢˜ï¼ˆtopicï¼‰</strong>ï¼šä¸€ä¸ª topic é‡Œä¿å­˜çš„æ˜¯åŒä¸€ç±»æ¶ˆæ¯ï¼Œç›¸å½“äºå¯¹æ¶ˆæ¯çš„åˆ†ç±»ï¼Œæ¯ä¸ª producer å°†æ¶ˆæ¯å‘é€åˆ° kafka ä¸­ï¼Œéƒ½éœ€è¦æŒ‡æ˜è¦å­˜çš„ topic æ˜¯å“ªä¸ªï¼Œä¹Ÿå°±æ˜¯æŒ‡æ˜è¿™ä¸ªæ¶ˆæ¯å±äºå“ªä¸€ç±»ã€‚</li>
<li><strong>åˆ†åŒºï¼ˆpartitionï¼‰</strong>ï¼šæ¯ä¸ª topic éƒ½å¯ä»¥åˆ†æˆå¤šä¸ª partitionï¼Œæ¯ä¸ª partition åœ¨å­˜å‚¨å±‚é¢æ˜¯ append log æ–‡ä»¶ã€‚ä»»ä½•å‘å¸ƒåˆ°æ­¤ partition çš„æ¶ˆæ¯éƒ½ä¼šè¢«ç›´æ¥è¿½åŠ åˆ° log æ–‡ä»¶çš„å°¾éƒ¨ã€‚ä¸ºä»€ä¹ˆè¦è¿›è¡Œåˆ†åŒºå‘¢ï¼Ÿæœ€æ ¹æœ¬çš„åŸå› å°±æ˜¯ï¼škafkaåŸºäºæ–‡ä»¶è¿›è¡Œå­˜å‚¨ï¼Œå½“æ–‡ä»¶å†…å®¹å¤§åˆ°ä¸€å®šç¨‹åº¦æ—¶ï¼Œå¾ˆå®¹æ˜“è¾¾åˆ°å•ä¸ªç£ç›˜çš„ä¸Šé™ï¼Œå› æ­¤ï¼Œé‡‡ç”¨åˆ†åŒºçš„åŠæ³•ï¼Œä¸€ä¸ªåˆ†åŒºå¯¹åº”ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™æ ·å°±å¯ä»¥å°†æ•°æ®åˆ†åˆ«å­˜å‚¨åˆ°ä¸åŒçš„serverä¸Šå»ï¼Œå¦å¤–è¿™æ ·åšä¹Ÿå¯ä»¥è´Ÿè½½å‡è¡¡ï¼Œå®¹çº³æ›´å¤šçš„æ¶ˆè´¹è€…ã€‚</li>
<li><strong>åç§»é‡ï¼ˆOffsetï¼‰</strong>ï¼šä¸€ä¸ªåˆ†åŒºå¯¹åº”ä¸€ä¸ªç£ç›˜ä¸Šçš„æ–‡ä»¶ï¼Œè€Œæ¶ˆæ¯åœ¨æ–‡ä»¶ä¸­çš„ä½ç½®å°±ç§°ä¸º offsetï¼ˆåç§»é‡ï¼‰ï¼Œoffset ä¸ºä¸€ä¸ª long å‹æ•°å­—ï¼Œå®ƒå¯ä»¥å”¯ä¸€æ ‡è®°ä¸€æ¡æ¶ˆæ¯ã€‚ç”±äºkafka å¹¶æ²¡æœ‰æä¾›å…¶ä»–é¢å¤–çš„ç´¢å¼•æœºåˆ¶æ¥å­˜å‚¨ offsetï¼Œæ–‡ä»¶åªèƒ½é¡ºåºçš„è¯»å†™ï¼Œæ‰€ä»¥åœ¨kafkaä¸­å‡ ä¹ä¸å…è®¸å¯¹æ¶ˆæ¯è¿›è¡Œâ€œéšæœºè¯»å†™â€ã€‚</li>
</ul>
<p>ç»¼ä¸Šï¼Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ Kafka çš„å‡ ä¸ªè¦ç‚¹:</p>
<ul>
<li>  kafka æ˜¯ä¸€ä¸ªåŸºäºå‘å¸ƒ-è®¢é˜…çš„åˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿ<strong>ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰</strong></li>
<li>  Kafka é¢å‘å¤§æ•°æ®ï¼Œæ¶ˆæ¯ä¿å­˜åœ¨ä¸»é¢˜ä¸­ï¼Œè€Œæ¯ä¸ª topic æœ‰åˆ†ä¸ºå¤šä¸ªåˆ†åŒº</li>
<li>  kafka çš„æ¶ˆæ¯æ•°æ®ä¿å­˜åœ¨ç£ç›˜ï¼Œ<code>æ¯ä¸ª partition å¯¹åº”ç£ç›˜ä¸Šçš„ä¸€ä¸ªæ–‡ä»¶</code>ï¼Œæ¶ˆæ¯å†™å…¥å°±æ˜¯ç®€å•çš„æ–‡ä»¶è¿½åŠ ï¼Œæ–‡ä»¶å¯ä»¥åœ¨é›†ç¾¤å†…å¤åˆ¶å¤‡ä»½ä»¥é˜²ä¸¢å¤±</li>
<li>  å³ä½¿æ¶ˆæ¯è¢«æ¶ˆè´¹ï¼Œkafka ä¹Ÿä¸ä¼šç«‹å³åˆ é™¤è¯¥æ¶ˆæ¯ï¼Œå¯ä»¥é€šè¿‡é…ç½®ä½¿å¾—è¿‡ä¸€æ®µæ—¶é—´åè‡ªåŠ¨åˆ é™¤ä»¥é‡Šæ”¾ç£ç›˜ç©ºé—´</li>
<li>  kafkaä¾èµ–åˆ†å¸ƒå¼åè°ƒæœåŠ¡Zookeeperï¼Œé€‚åˆç¦»çº¿/åœ¨çº¿ä¿¡æ¯çš„æ¶ˆè´¹ï¼Œä¸ storm å’Œ spark ç­‰å®æ—¶æµå¼æ•°æ®åˆ†æå¸¸å¸¸ç»“åˆä½¿ç”¨</li>
</ul>
<h2 id="kafkaåŸç†"><a href="#kafkaåŸç†" class="headerlink" title="kafkaåŸç†"></a>kafkaåŸç†</h2><h3 id="åˆ†å¸ƒå¼å’Œåˆ†åŒºï¼ˆdistributedã€partitionedï¼‰"><a href="#åˆ†å¸ƒå¼å’Œåˆ†åŒºï¼ˆdistributedã€partitionedï¼‰" class="headerlink" title="åˆ†å¸ƒå¼å’Œåˆ†åŒºï¼ˆdistributedã€partitionedï¼‰"></a>åˆ†å¸ƒå¼å’Œåˆ†åŒºï¼ˆdistributedã€partitionedï¼‰</h3><p>æ¶ˆæ¯ä¿å­˜åœ¨ Topic ä¸­ï¼Œè€Œä¸ºäº†èƒ½å¤Ÿå®ç°å¤§æ•°æ®çš„å­˜å‚¨ï¼Œä¸€ä¸ª topic åˆ’åˆ†ä¸ºå¤šä¸ªåˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºå¯¹åº”ä¸€ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥åˆ†åˆ«å­˜å‚¨åˆ°ä¸åŒçš„æœºå™¨ä¸Šï¼Œä»¥å®ç°åˆ†å¸ƒå¼çš„é›†ç¾¤å­˜å‚¨ã€‚å¦å¤–ï¼Œæ¯ä¸ª partition å¯ä»¥æœ‰ä¸€å®šçš„å‰¯æœ¬ï¼Œå¤‡ä»½åˆ°å¤šå°æœºå™¨ä¸Šï¼Œä»¥æé«˜å¯ç”¨æ€§ã€‚<br>æ€»ç»“èµ·æ¥å°±æ˜¯ï¼šä¸€ä¸ª topic å¯¹åº”çš„å¤šä¸ª partition åˆ†æ•£å­˜å‚¨åˆ°é›†ç¾¤ä¸­çš„å¤šä¸ª broker ä¸Šï¼Œå­˜å‚¨æ–¹å¼æ˜¯ä¸€ä¸ª partition å¯¹åº”ä¸€ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ª broker è´Ÿè´£å­˜å‚¨åœ¨è‡ªå·±æœºå™¨ä¸Šçš„ partition ä¸­çš„æ¶ˆæ¯è¯»å†™ã€‚</p>
<h3 id="å‰¯æœ¬ï¼ˆreplicated-ï¼‰"><a href="#å‰¯æœ¬ï¼ˆreplicated-ï¼‰" class="headerlink" title="å‰¯æœ¬ï¼ˆreplicated ï¼‰"></a>å‰¯æœ¬ï¼ˆreplicated ï¼‰</h3><p>è¿™ç§å†—ä½™å¤‡ä»½çš„æ–¹å¼åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ˜¯å¾ˆå¸¸è§çš„ï¼Œé‚£ä¹ˆæ—¢ç„¶æœ‰å‰¯æœ¬ï¼Œå°±æ¶‰åŠåˆ°å¯¹åŒä¸€ä¸ªæ–‡ä»¶çš„å¤šä¸ªå¤‡ä»½å¦‚ä½•è¿›è¡Œç®¡ç†å’Œè°ƒåº¦ã€‚kafka é‡‡å–çš„æ–¹æ¡ˆæ˜¯ï¼šæ¯ä¸ª partition é€‰ä¸¾ä¸€ä¸ª server ä½œä¸ºâ€œleaderâ€ï¼Œç”± leader è´Ÿè´£æ‰€æœ‰å¯¹è¯¥åˆ†åŒºçš„è¯»å†™ï¼Œå…¶ä»– server ä½œä¸º follower åªéœ€è¦ç®€å•çš„ä¸ leader åŒæ­¥ï¼Œä¿æŒè·Ÿè¿›å³å¯ã€‚å¦‚æœåŸæ¥çš„ leader å¤±æ•ˆï¼Œä¼šé‡æ–°é€‰ä¸¾ç”±å…¶ä»–çš„ follower æ¥æˆä¸ºæ–°çš„ leaderã€‚</p>
<p>è‡³äºå¦‚ä½•é€‰å– leaderï¼Œå®é™…ä¸Šå¦‚æœæˆ‘ä»¬äº†è§£ ZooKeeperï¼Œå°±ä¼šå‘ç°å…¶å®è¿™æ­£æ˜¯ Zookeeper æ‰€æ“…é•¿çš„ï¼ŒKafka ä½¿ç”¨ ZK åœ¨ Broker ä¸­é€‰å‡ºä¸€ä¸ª Controllerï¼Œç”¨äº Partition åˆ†é…å’Œ Leader é€‰ä¸¾ã€‚</p>
<p>å¦å¤–ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä¸Šä½œä¸º leader çš„ server æ‰¿æ‹…äº†è¯¥åˆ†åŒºæ‰€æœ‰çš„è¯»å†™è¯·æ±‚ï¼Œå› æ­¤å…¶å‹åŠ›æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œä»æ•´ä½“è€ƒè™‘ï¼Œæœ‰å¤šå°‘ä¸ª partition å°±æ„å‘³ç€ä¼šæœ‰å¤šå°‘ä¸ªleaderï¼Œkafka ä¼šå°† leader åˆ†æ•£åˆ°ä¸åŒçš„ broker ä¸Šï¼Œç¡®ä¿æ•´ä½“çš„è´Ÿè½½å‡è¡¡ã€‚</p>
<p><img src="/2022/02/16/kafka%E7%AE%80%E4%BB%8B/image20220214195320.png" title="kafkaæ•°æ®æµå›¾"></p>
<h3 id="æ•´ä½“çš„æ•°æ®æµ"><a href="#æ•´ä½“çš„æ•°æ®æµ" class="headerlink" title="æ•´ä½“çš„æ•°æ®æµ"></a>æ•´ä½“çš„æ•°æ®æµ</h3><h4 id="æ•°æ®çš„ç”Ÿäº§-produce"><a href="#æ•°æ®çš„ç”Ÿäº§-produce" class="headerlink" title="æ•°æ®çš„ç”Ÿäº§(produce)"></a>æ•°æ®çš„ç”Ÿäº§(produce)</h4><p>å¯¹äºç”Ÿäº§è€…è¦å†™å…¥çš„ä¸€æ¡è®°å½•ï¼Œå¯ä»¥æŒ‡å®šå››ä¸ªå‚æ•°ï¼šåˆ†åˆ«æ˜¯ topicã€partitionã€key å’Œ valueï¼Œå…¶ä¸­ topic å’Œ valueï¼ˆè¦å†™å…¥çš„æ•°æ®ï¼‰æ˜¯å¿…é¡»è¦æŒ‡å®šçš„ï¼Œè€Œ key å’Œ partition æ˜¯å¯é€‰çš„ã€‚</p>
<p>å¯¹äºä¸€æ¡è®°å½•ï¼Œå…ˆå¯¹å…¶è¿›è¡Œåºåˆ—åŒ–ï¼Œç„¶åæŒ‰ç…§ Topic å’Œ Partitionï¼Œæ”¾è¿›å¯¹åº”çš„å‘é€é˜Ÿåˆ—ä¸­ã€‚å¦‚æœ Partition æ²¡å¡«ï¼Œé‚£ä¹ˆæƒ…å†µä¼šæ˜¯è¿™æ ·çš„ï¼š</p>
<ol>
<li>Key æœ‰å¡«ã€‚æŒ‰ç…§ Key è¿›è¡Œå“ˆå¸Œï¼Œç›¸åŒ Key å»ä¸€ä¸ª Partitionã€‚</li>
<li>Key æ²¡å¡«ã€‚Round-Robin æ¥é€‰ Partitionã€‚</li>
</ol>
<p><img src="/2022/02/16/kafka%E7%AE%80%E4%BB%8B/image20220214195925.png" title="produceäº§ç”Ÿæ¶ˆæ¯"></p>
<p>producer å°†ä¼šå’ŒTopicä¸‹æ‰€æœ‰ partition leader ä¿æŒ socket è¿æ¥ï¼Œæ¶ˆæ¯ç”± producer ç›´æ¥é€šè¿‡ socket å‘é€åˆ° brokerã€‚å…¶ä¸­ partition leader çš„ä½ç½®( host : port )æ³¨å†Œåœ¨ zookeeper ä¸­ï¼Œproducer ä½œä¸º zookeeper client<strong>ï¼Œå·²ç»æ³¨å†Œäº† watch ç”¨æ¥ç›‘å¬ partition leader çš„å˜æ›´äº‹ä»¶ï¼Œ</strong>å› æ­¤ï¼Œå¯ä»¥å‡†ç¡®çš„çŸ¥é“è°æ˜¯å½“å‰çš„ leaderã€‚<br>ps: zookeeperåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çœŸæ˜¯ä¸å¯æˆ–ç¼ºçš„ç»„ä»¶</p>
<h4 id="æ•°æ®æ¶ˆè´¹è¿‡ç¨‹-consume"><a href="#æ•°æ®æ¶ˆè´¹è¿‡ç¨‹-consume" class="headerlink" title="æ•°æ®æ¶ˆè´¹è¿‡ç¨‹(consume)"></a>æ•°æ®æ¶ˆè´¹è¿‡ç¨‹(consume)</h4><p>å¯¹äºæ¶ˆè´¹è€…ï¼Œä¸æ˜¯ä»¥å•ç‹¬çš„å½¢å¼å­˜åœ¨çš„ï¼Œæ¯ä¸€ä¸ªæ¶ˆè´¹è€…å±äºä¸€ä¸ª consumer groupï¼Œä¸€ä¸ª group åŒ…å«å¤šä¸ª consumerã€‚ç‰¹åˆ«éœ€è¦æ³¨æ„çš„æ˜¯ï¼šè®¢é˜… Topic æ˜¯ä»¥ä¸€ä¸ªæ¶ˆè´¹ç»„æ¥è®¢é˜…çš„ï¼Œå‘é€åˆ° Topic çš„æ¶ˆæ¯ï¼Œåªä¼šè¢«è®¢é˜…æ­¤ Topic çš„æ¯ä¸ª group ä¸­çš„ä¸€ä¸ª consumer æ¶ˆè´¹<br>å…·ä½“è¯´æ¥ï¼Œè¿™å®é™…ä¸Šæ˜¯æ ¹æ® partition æ¥åˆ†çš„ï¼Œä¸€ä¸ª Partitionï¼Œåªèƒ½è¢«æ¶ˆè´¹ç»„é‡Œçš„ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œä½†æ˜¯å¯ä»¥åŒæ—¶è¢«å¤šä¸ªæ¶ˆè´¹ç»„æ¶ˆè´¹ï¼Œæ¶ˆè´¹ç»„é‡Œçš„æ¯ä¸ªæ¶ˆè´¹è€…æ˜¯å…³è”åˆ°ä¸€ä¸ª partition çš„ï¼Œå› æ­¤æœ‰è¿™æ ·çš„è¯´æ³•ï¼šå¯¹äºä¸€ä¸ª topic,åŒä¸€ä¸ª group ä¸­ä¸èƒ½æœ‰å¤šäº partitions ä¸ªæ•°çš„ consumer åŒæ—¶æ¶ˆè´¹,å¦åˆ™å°†æ„å‘³ç€æŸäº› consumer å°†æ— æ³•å¾—åˆ°æ¶ˆæ¯ã€‚<br>åŒä¸€ä¸ªæ¶ˆè´¹ç»„çš„ä¸¤ä¸ªæ¶ˆè´¹è€…ä¸ä¼šåŒæ—¶æ¶ˆè´¹ä¸€ä¸ª partitionã€‚</p>
<p><img src="/2022/02/16/kafka%E7%AE%80%E4%BB%8B/image20220214201946.png" title="kafkaæ¶ˆè´¹"></p>
<p>åœ¨ kafka ä¸­ï¼Œé‡‡ç”¨äº† pull æ–¹å¼ï¼Œå³ consumer åœ¨å’Œ broker å»ºç«‹è¿æ¥ä¹‹åï¼Œä¸»åŠ¨å» pull(æˆ–è€…è¯´ fetch )æ¶ˆæ¯ï¼Œé¦–å…ˆ consumer ç«¯å¯ä»¥æ ¹æ®è‡ªå·±çš„æ¶ˆè´¹èƒ½åŠ›é€‚æ—¶çš„å» fetch æ¶ˆæ¯å¹¶å¤„ç†ï¼Œä¸”å¯ä»¥æ§åˆ¶æ¶ˆæ¯æ¶ˆè´¹çš„è¿›åº¦(offset)ã€‚</p>
<p>partition ä¸­çš„æ¶ˆæ¯åªæœ‰ä¸€ä¸ª consumer åœ¨æ¶ˆè´¹ï¼Œä¸”ä¸å­˜åœ¨æ¶ˆæ¯çŠ¶æ€çš„æ§åˆ¶ï¼Œä¹Ÿæ²¡æœ‰å¤æ‚çš„æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼Œå¯è§ kafka broker ç«¯æ˜¯ç›¸å½“è½»é‡çº§çš„ã€‚å½“æ¶ˆæ¯è¢« consumer æ¥æ”¶ä¹‹åï¼Œéœ€è¦ä¿å­˜ Offset è®°å½•æ¶ˆè´¹åˆ°å“ªï¼Œä»¥å‰ä¿å­˜åœ¨ ZK ä¸­ï¼Œç”±äº ZK çš„å†™æ€§èƒ½ä¸å¥½ï¼Œä»¥å‰çš„è§£å†³æ–¹æ³•éƒ½æ˜¯ Consumer æ¯éš”ä¸€åˆ†é’Ÿä¸ŠæŠ¥ä¸€æ¬¡ï¼Œåœ¨ 0.10 ç‰ˆæœ¬åï¼ŒKafka æŠŠè¿™ä¸ª Offset çš„ä¿å­˜ï¼Œä» ZK ä¸­å‰¥ç¦»ï¼Œ<strong>ä¿å­˜åœ¨ä¸€ä¸ªåå« consumeroffsets topic çš„ Topic ä¸­</strong>ï¼Œç”±æ­¤å¯è§ï¼Œconsumer å®¢æˆ·ç«¯ä¹Ÿå¾ˆè½»é‡çº§ã€‚</p>
<h3 id="æ¶ˆæ¯ä¼ é€æœºåˆ¶"><a href="#æ¶ˆæ¯ä¼ é€æœºåˆ¶" class="headerlink" title="æ¶ˆæ¯ä¼ é€æœºåˆ¶"></a>æ¶ˆæ¯ä¼ é€æœºåˆ¶</h3><p>Kafka æ”¯æŒ 3 ç§æ¶ˆæ¯æŠ•é€’è¯­ä¹‰,åœ¨ä¸šåŠ¡ä¸­ï¼Œå¸¸å¸¸éƒ½æ˜¯ä½¿ç”¨ At least once çš„æ¨¡å‹ã€‚</p>
<ul>
<li>  At most onceï¼šæœ€å¤šä¸€æ¬¡ï¼Œæ¶ˆæ¯å¯èƒ½ä¼šä¸¢å¤±ï¼Œä½†ä¸ä¼šé‡å¤ã€‚</li>
<li>  At least onceï¼šæœ€å°‘ä¸€æ¬¡ï¼Œæ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Œå¯èƒ½ä¼šé‡å¤ã€‚</li>
<li>  Exactly onceï¼šåªä¸”ä¸€æ¬¡ï¼Œæ¶ˆæ¯ä¸ä¸¢å¤±ä¸é‡å¤ï¼Œåªä¸”æ¶ˆè´¹ä¸€æ¬¡ã€‚</li>
</ul>
<h2 id="kafkaé›†ç¾¤æ¡†æ¶"><a href="#kafkaé›†ç¾¤æ¡†æ¶" class="headerlink" title="kafkaé›†ç¾¤æ¡†æ¶"></a>kafkaé›†ç¾¤æ¡†æ¶</h2><p><img src="/2022/02/16/kafka%E7%AE%80%E4%BB%8B/image20220214202757.png" title="kafkaé›†ç¾¤æ¡†æ¶"></p>
<h2 id="kafka-API"><a href="#kafka-API" class="headerlink" title="kafka API"></a>kafka API</h2><p>ps: <strong>localhost:2181/kafka</strong>è¦å¢åŠ zkçš„æ ¹ç›®å½•<br><a href="https://www.jianshu.com/p/edf607eb0cb4">kafkaå„ç§é…ç½®å‚æ•°</a></p>
<h3 id="å¯åŠ¨zkå’Œkafka"><a href="#å¯åŠ¨zkå’Œkafka" class="headerlink" title="å¯åŠ¨zkå’Œkafka"></a>å¯åŠ¨zkå’Œkafka</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// å¼€å¯zk</span><br><span class="line">bin/zookeeper-server-start.sh config/zookeeper.properties</span><br><span class="line">// å¼€å¯kafka broker</span><br><span class="line">bin/kafka-server-start.sh config/server.properties</span><br></pre></td></tr></table></figure>

<ul>
<li>config/server.properties<br>kafkaé…ç½®æ–‡ä»¶,åŒ…å«zkä¿¡æ¯ç­‰</li>
</ul>
<h3 id="åˆ›å»ºä¸»é¢˜"><a href="#åˆ›å»ºä¸»é¢˜" class="headerlink" title="åˆ›å»ºä¸»é¢˜"></a>åˆ›å»ºä¸»é¢˜</h3><p><strong>åˆ›å»º <code>Kafka</code> ä¸»é¢˜</strong> - <code>Kafka</code> æä¾›äº†ä¸€ä¸ªåä¸º <code>kafka-topics.sh</code> çš„å‘½ä»¤è¡Œå®ç”¨ç¨‹åºï¼Œç”¨äºåœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºä¸»é¢˜ã€‚ æ‰“å¼€æ–°ç»ˆç«¯å¹¶é”®å…¥ä»¥ä¸‹ç¤ºä¾‹ã€‚</p>
<ul>
<li>è¯­æ³•<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">bin/kafka-topics.sh --create --zookeeper localhost:2181/kafka --replication-factor 1 --partitions 1 --topic topic-name</span><br></pre></td></tr></table></figure></li>
<li>ç¤ºä¾‹<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">bin/kafka-topics.sh --create --zookeeper localhost:2181/kafka --replication-factor 1 --partitions 1 --topic Hello-Kafka</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="ä¸»é¢˜åˆ—è¡¨"><a href="#ä¸»é¢˜åˆ—è¡¨" class="headerlink" title="ä¸»é¢˜åˆ—è¡¨"></a>ä¸»é¢˜åˆ—è¡¨</h3><ul>
<li>è¯­æ³•<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// æŸ¥çœ‹kafkaæœåŠ¡å™¨ä¸­çš„ä¸»é¢˜åˆ—è¡¨</span><br><span class="line">bin/kafka-topics.sh --list --zookeeper localhost:2181/kafka</span><br></pre></td></tr></table></figure></li>
<li>è¾“å‡º<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Hello-Kafka</span><br><span class="line">__consumer_offsets</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="ç”Ÿäº§è€…å‘é€æ¶ˆæ¯"><a href="#ç”Ÿäº§è€…å‘é€æ¶ˆæ¯" class="headerlink" title="ç”Ÿäº§è€…å‘é€æ¶ˆæ¯"></a>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯</h3><ul>
<li>è¯­æ³•<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">bin/kafka-console-producer.sh --broker-list localhost:9092 --topic topic-name</span><br></pre></td></tr></table></figure></li>
<li>ç¤ºä¾‹<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">bin/kafka-console-producer.sh --broker-list localhost:9092 --topic Hello-Kafka</span><br></pre></td></tr></table></figure>
ç”Ÿäº§è€…å°†ç­‰å¾…æ¥è‡ª <code>stdin</code> çš„è¾“å…¥å¹¶å‘å¸ƒåˆ° <code>Kafka</code> é›†ç¾¤ã€‚</li>
<li>è¾“å…¥<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">nihao</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">hello my love</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="å¯åŠ¨æ¶ˆè´¹è€…æ¥å—æ¶ˆæ¯"><a href="#å¯åŠ¨æ¶ˆè´¹è€…æ¥å—æ¶ˆæ¯" class="headerlink" title="å¯åŠ¨æ¶ˆè´¹è€…æ¥å—æ¶ˆæ¯"></a>å¯åŠ¨æ¶ˆè´¹è€…æ¥å—æ¶ˆæ¯</h3><ul>
<li>è¯­æ³•<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">bin/kafka-console-consumer.sh --zookeeper localhost:2181 â€”topic topic-name --from-beginning</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>ps:æ–°ç‰ˆæœ¬çš„kafkaå·²ç»ä¸æ”¯æŒè¯¥å‘½ä»¤äº†</strong></p>
<ul>
<li>æ–°è¯­æ³•<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test --from-beginning</span><br></pre></td></tr></table></figure></li>
<li>ç¤ºä¾‹<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic Hello-Kafka --from-beginning</span><br></pre></td></tr></table></figure></li>
<li>è¾“å‡º<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[tdsql@TENCENT64 /data/application/kafka]$ bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic Hello-Kafka --from-beginning</span><br><span class="line">nihao</span><br><span class="line">hello my love</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="ä¿®æ”¹ä¸»é¢˜topic"><a href="#ä¿®æ”¹ä¸»é¢˜topic" class="headerlink" title="ä¿®æ”¹ä¸»é¢˜topic"></a>ä¿®æ”¹ä¸»é¢˜topic</h3><ul>
<li>è¯­æ³•<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">bin/kafka-topics.sh </span><br><span class="line">â€”zookeeper localhost:2181 </span><br><span class="line">--alter </span><br><span class="line">--topic topic_name </span><br><span class="line">--partitions count</span><br></pre></td></tr></table></figure></li>
<li>ç¤ºä¾‹1<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">bin/kafka-topics.sh </span><br><span class="line">--zookeeper localhost:2181/kafka</span><br><span class="line">--alter </span><br><span class="line">--topic Hello-kafka </span><br><span class="line">--partitions 2</span><br></pre></td></tr></table></figure></li>
<li>ç¤ºä¾‹2<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">bin/kafka-topics.sh --zookeeper 192.168.162.52:2181,192.168.162.235:2181,192.168.162.239:2181 --alter --topic test0 --config max.message.bytes=128000</span><br><span class="line">bin/kafka-topics.sh --zookeeper 192.168.162.52:2181,192.168.162.235:2181,192.168.162.239:2181 --alter --topic test0 --delete-config max.message.bytes</span><br><span class="line">bin/kafka-topics.sh --zookeeper 192.168.162.52:2181,192.168.162.235:2181,192.168.162.239:2181 --alter --topic test0 --partitions 10 </span><br><span class="line">bin/kafka-topics.sh --zookeeper 192.168.162.52:2181,192.168.162.235:2181,192.168.162.239:2181 --alter --topic test0 --partitions 3 ## Kafkaåˆ†åŒºæ•°é‡åªå…è®¸å¢åŠ ï¼Œä¸å…è®¸å‡å°‘</span><br></pre></td></tr></table></figure></li>
<li>è¾“å‡º<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[tdsql@TENCENT64 /data/application/kafka]$ bin/kafka-topics.sh --zookeeper localhost:2181/kafka --alter --topic Hello-Kafka --partitions 2</span><br><span class="line">WARNING: If partitions are increased for a topic that has a key, the partition logic or ordering of the messages will be affected</span><br><span class="line">Adding partitions succeeded!</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="åˆ é™¤ä¸»é¢˜top"><a href="#åˆ é™¤ä¸»é¢˜top" class="headerlink" title="åˆ é™¤ä¸»é¢˜top"></a>åˆ é™¤ä¸»é¢˜top</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">é»˜è®¤æƒ…å†µä¸‹Kafkaçš„Topicä¸èƒ½ç›´æ¥åˆ é™¤çš„ï¼Œéœ€è¦è¿›è¡Œç›¸å…³å‚æ•°é…ç½®</span><br><span class="line">bin/kafka-topics.sh --delete --topic test0 --zookeeper 192.168.187.146:2181</span><br><span class="line"></span><br><span class="line">é»˜è®¤æƒ…å†µä¸‹ï¼Œåˆ é™¤æ˜¯æ ‡è®°åˆ é™¤ï¼Œæ²¡æœ‰å®é™…åˆ é™¤è¿™ä¸ªTopicï¼›å¦‚æœè¿è¡Œåˆ é™¤Topicï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹ä¸¤ç§æ–¹å¼ï¼š</span><br><span class="line">æ–¹å¼ä¸€ï¼šé€šè¿‡deleteå‘½ä»¤åˆ é™¤åï¼Œæ‰‹åŠ¨å°†æœ¬åœ°ç£ç›˜ä»¥åŠzkä¸Šçš„ç›¸å…³topicçš„ä¿¡æ¯åˆ é™¤å³å¯</span><br><span class="line">æ–¹å¼äºŒï¼šé…ç½®server.propertiesæ–‡ä»¶ï¼Œç»™å®šå‚æ•°delete.topic.enable=trueï¼Œé‡å¯kafkaæœåŠ¡ï¼Œæ­¤æ—¶æ‰§è¡Œdeleteå‘½ä»¤è¡¨ç¤ºå…è®¸è¿›è¡ŒTopicçš„åˆ é™¤</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>å¼€æºç»„ä»¶å­¦ä¹ </category>
        <category>kafka</category>
      </categories>
      <tags>
        <tag>kafka</tag>
        <tag>åˆ†å¸ƒå¼</tag>
      </tags>
  </entry>
  <entry>
    <title>golangçš„é”™è¯¯ç±»å‹</title>
    <url>/2022/02/14/golang%E7%9A%84%E9%94%99%E8%AF%AF%E7%B1%BB%E5%9E%8B/</url>
    <content><![CDATA[<hr>
<p>ä½œä¸ºgolangè¯­è¨€çš„åˆå¿ƒè€…ï¼Œå¾ˆå¤šgoçš„å¸¸ç”¨æ¥å£ç†Ÿæ‚‰ç»“æ„ä½“éƒ½éœ€è¦ä»”ç»†çœ‹çœ‹æºç ï¼Œé¿å…è¸©å‘ã€‚ç›®å‰é‡æ„ä»£ç ç”¨åˆ°äº†è‡ªå·±å†™çš„é”™è¯¯ç±»å’Œwrapç›¸å…³å‡½æ•°å¯¹åŸºå±‚é”™è¯¯è¿›è¡ŒåŒ…è£…å’Œunwrapå‡½æ•°å¯¹é”™è¯¯ç±»è¿›è¡Œé€’å½’æ‹†è§£ï¼Œä½†æ˜¯å†™èµ·æ¥å°±æ˜¯å¾ˆä¸ç¾è§‚ï¼Œå¼ºè¿«ç—‡ã€‚å­¦ä¹ ä¸‹ä¼˜é›…çš„å¤„ç†é”™è¯¯å§ã€‚</p>
<span id="more"></span>
<!-- toc -->

<p>[toc]</p>
<h2 id="golangçš„é”™è¯¯ç±»å‹error"><a href="#golangçš„é”™è¯¯ç±»å‹error" class="headerlink" title="golangçš„é”™è¯¯ç±»å‹error"></a>golangçš„é”™è¯¯ç±»å‹<strong>error</strong></h2><p><strong>Golang</strong> ä¸­çš„é”™è¯¯ä¹Ÿæ˜¯ä¸€ç§ç±»å‹ã€‚é”™è¯¯ç”¨å†…ç½®çš„ <code>error</code> ç±»å‹è¡¨ç¤ºã€‚å°±åƒå…¶ä»–ç±»å‹ï¼Œå¦‚ <code>int</code>ï¼Œ<code>float64</code> ç­‰ã€‚</p>
<p>é”™è¯¯å€¼å¯ä»¥å­˜å‚¨åœ¨å˜é‡ä¸­ï¼Œä¹Ÿå¯ä»¥ä»å‡½æ•°ä¸­è¿”å›ï¼Œç­‰ç­‰ã€‚</p>
<h2 id="errorç±»å‹æºç "><a href="#errorç±»å‹æºç " class="headerlink" title="errorç±»å‹æºç "></a>errorç±»å‹æºç </h2><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/builtin/builtin.go</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The error built-in interface type is the conventional interface for</span></span><br><span class="line"><span class="comment">// representing an error condition, with the nil value representing no error.</span></span><br><span class="line"><span class="keyword">type</span> error <span class="keyword">interface</span> &#123;</span><br><span class="line">    Error() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>error</code> æ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼Œå®ƒåŒ…å«ä¸€ä¸ª <code>Error()</code> æ–¹æ³•ï¼Œè¿”å›å€¼ä¸º <code>string</code>ã€‚ä»»ä½•å®ç°è¿™ä¸ªæ¥å£çš„ç±»å‹éƒ½å¯ä»¥ä½œä¸ºä¸€ä¸ªé”™è¯¯ä½¿ç”¨ï¼ŒError è¿™ä¸ªæ–¹æ³•æä¾›äº†å¯¹é”™è¯¯çš„æè¿°ã€‚<br>ps: <code>nil</code>ä»£è¡¨æ²¡æœ‰é”™è¯¯</p>
<ul>
<li>å®ä¾‹<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">f, err := os.Open(<span class="string">&quot;/test.txt&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;open failed, err:&quot;</span>, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;file is ï¼š&quot;</span>, f)</span><br></pre></td></tr></table></figure>
å½“æ‰§è¡Œæ‰“å°é”™è¯¯è¯­å¥æ—¶ï¼Œfmt åŒ…ä¼šè‡ªåŠ¨è°ƒç”¨ <code>err.Error()</code> å‡½æ•°æ¥æ‰“å°å­—ç¬¦ä¸²ã€‚</li>
</ul>
<h2 id="errorçš„åˆ›å»º"><a href="#errorçš„åˆ›å»º" class="headerlink" title="errorçš„åˆ›å»º"></a>errorçš„åˆ›å»º</h2><p>åˆ›å»ºæ–¹å¼æœ‰ä¸¤ç§</p>
<ul>
<li>  errors.New()</li>
<li>  fmt.Errorf()</li>
</ul>
<h3 id="errors-New-å‡½æ•°-errorStringç±»å‹"><a href="#errors-New-å‡½æ•°-errorStringç±»å‹" class="headerlink" title="errors.New()å‡½æ•° - errorStringç±»å‹"></a>errors.New()å‡½æ•° - errorStringç±»å‹</h3><ul>
<li>src/errors/errors.go</li>
<li>æºç <figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/errors/errors.go</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// New returns an error that formats as the given text.</span></span><br><span class="line"><span class="comment">// Each call to New returns a distinct error value even if the text is identical.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(text <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;errorString&#123;text&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// errorString is a trivial implementation of error.</span></span><br><span class="line"><span class="keyword">type</span> errorString <span class="keyword">struct</span> &#123;</span><br><span class="line">    s <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *errorString)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> e.s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
New () å‡½æ•°è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œè¯¥é”™è¯¯çš„æ ¼å¼ä¸ºç»™å®šçš„æ–‡æœ¬ã€‚<br>å³ä½¿æ–‡æœ¬ç›¸åŒï¼Œæ¯æ¬¡å¯¹ New çš„è°ƒç”¨ä¹Ÿä¼šè¿”å›ä¸€ä¸ªä¸åŒçš„é”™è¯¯å€¼ã€‚</li>
</ul>
<p>å…¶ä¸­ errorString æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œåªæœ‰ä¸€ä¸ª string ç±»å‹çš„å­—æ®µ sï¼Œå¹¶ä¸”å®ç°äº†å”¯ä¸€çš„æ–¹æ³•ï¼šError()</p>
<ul>
<li>ä¾‹å­<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1.errors.New() åˆ›å»ºä¸€ä¸ª error</span></span><br><span class="line">err1 := errors.New(<span class="string">&quot;è¿™æ˜¯ errors.New() åˆ›å»ºçš„é”™è¯¯&quot;</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;err1 é”™è¯¯ç±»å‹ï¼š%Tï¼Œé”™è¯¯ä¸ºï¼š%v\n&quot;</span>, err1, err1)</span><br><span class="line">err1 é”™è¯¯ç±»å‹ï¼š*errors.errorStringï¼Œé”™è¯¯ä¸ºï¼šè¿™æ˜¯ errors.New() åˆ›å»ºçš„é”™è¯¯</span><br></pre></td></tr></table></figure>
å¯ä»¥çœ‹åˆ°ï¼Œé”™è¯¯ç±»å‹æ˜¯ <code>errorString</code> æŒ‡é’ˆï¼Œå‰é¢çš„ <code>errors.</code> è¡¨æ˜äº†å…¶åœ¨ errors åŒ…ä¸‹ã€‚</li>
</ul>
<h3 id="fmt-Errorf-å‡½æ•°-errorStringç±»å‹å’ŒwrapErrorç±»å‹"><a href="#fmt-Errorf-å‡½æ•°-errorStringç±»å‹å’ŒwrapErrorç±»å‹" class="headerlink" title="fmt.Errorf()å‡½æ•° - errorStringç±»å‹å’ŒwrapErrorç±»å‹"></a>fmt.Errorf()å‡½æ•° - errorStringç±»å‹å’ŒwrapErrorç±»å‹</h3><ul>
<li><p>æºç </p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/fmt/errors.go</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Errorf</span><span class="params">(format <span class="keyword">string</span>, a ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    p := newPrinter()</span><br><span class="line">    p.wrapErrs = <span class="literal">true</span></span><br><span class="line">    p.doPrintf(format, a)</span><br><span class="line">    s := <span class="keyword">string</span>(p.buf)</span><br><span class="line">    <span class="keyword">var</span> err error</span><br><span class="line">    <span class="keyword">if</span> p.wrappedErr == <span class="literal">nil</span> &#123;</span><br><span class="line">        err = errors.New(s)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        err = &amp;wrapError&#123;s, p.wrappedErr&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    p.free()</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡æºç å¯ä»¥çœ‹åˆ°ï¼Œ<code>p.wrappedErr</code> ä¸º <code>nil</code> çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ <code>errors.New()</code> æ¥åˆ›å»ºé”™è¯¯ã€‚<br>æ‰€ä»¥fmt.Errorf()å‡½æ•°åˆ›å»ºçš„é”™è¯¯ç±»å‹ä¹Ÿä¸º<code>errors.errorString</code></p>
</li>
<li><p>ä¾‹å­</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 2.fmt.Errorf()</span></span><br><span class="line">err2 := fmt.Errorf(<span class="string">&quot;è¿™ä¸ª fmt.Errorf() åˆ›å»ºçš„é”™è¯¯,é”™è¯¯ç¼–ç ä¸ºï¼š%d&quot;</span>, <span class="number">404</span>)</span><br><span class="line">fmt.Printf(<span class="string">&quot;err2 é”™è¯¯ç±»å‹ï¼š%Tï¼Œé”™è¯¯ä¸ºï¼š%v\n&quot;</span>, err2, err2)</span><br><span class="line"><span class="comment">// è¾“å‡º</span></span><br><span class="line">err2 é”™è¯¯ç±»å‹ï¼š*errors.errorStringï¼Œé”™è¯¯ä¸ºï¼šè¿™ä¸ª fmt.Errorf() åˆ›å»ºçš„é”™è¯¯,é”™è¯¯ç¼–ç ä¸ºï¼š<span class="number">404</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="fmt-wrapError"><a href="#fmt-wrapError" class="headerlink" title="fmt.wrapError"></a>fmt.wrapError</h4><ul>
<li>ä¾‹å­<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 3. go 1.13 æ–°å¢åŠ çš„é”™è¯¯å¤„ç†ç‰¹æ€§  %w</span></span><br><span class="line">err3 := fmt.Errorf(<span class="string">&quot;err3: %w&quot;</span>, err2)  <span class="comment">// err3åŒ…è£¹err2é”™è¯¯</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;err3 é”™è¯¯ç±»å‹ï¼š%Tï¼Œé”™è¯¯ä¸ºï¼š%v\n&quot;</span>, err3, err3)</span><br><span class="line"><span class="comment">// è¾“å‡º</span></span><br><span class="line">err3 é”™è¯¯ç±»å‹ï¼š*fmt.wrapErrorï¼Œé”™è¯¯ä¸ºï¼šerr3: è¿™ä¸ª fmt.Errorf() åˆ›å»ºçš„é”™è¯¯,é”™è¯¯ç¼–ç ä¸ºï¼š<span class="number">404</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="newPrinterç»“æ„ä½“"><a href="#newPrinterç»“æ„ä½“" class="headerlink" title="newPrinterç»“æ„ä½“"></a>newPrinterç»“æ„ä½“</h4><ul>
<li>æºç <figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/fmt/print.go</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// newPrinter allocates a new pp struct or grabs a cached one.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newPrinter</span><span class="params">()</span> *<span class="title">pp</span></span> &#123;</span><br><span class="line">    p := ppFree.Get().(*pp)</span><br><span class="line">    p.panicking = <span class="literal">false</span></span><br><span class="line">    p.erroring = <span class="literal">false</span></span><br><span class="line">    p.wrapErrs = <span class="literal">false</span></span><br><span class="line">    p.fmt.init(&amp;p.buf)</span><br><span class="line">    <span class="keyword">return</span> p</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// src/fmt/print.go</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// pp is used to store a printer&#x27;s state and is reused with sync.Pool to avoid allocations.</span></span><br><span class="line"><span class="keyword">type</span> pp <span class="keyword">struct</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// wrapErrs is set when the format string may contain a %w verb.</span></span><br><span class="line">    wrapErrs <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// wrappedErr records the target of the %w verb.</span></span><br><span class="line">    wrappedErr error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<code>newPrinter()</code>ç”Ÿæˆä¸€ä¸ªppç»“æ„ä½“ï¼Œppç»“æ„ä½“æœ‰wrapErrså’ŒwrappedErrä¸¤ä¸ªæˆå‘˜ã€‚</li>
<li><code>wrapErrs</code><ul>
<li>bool ç±»å‹ï¼Œå½“æ ¼å¼å­—ç¬¦ä¸²åŒ…å«<code>ï¼…w</code> åŠ¨è¯æ—¶ï¼Œå°†èµ‹å€¼ä¸º true</li>
</ul>
</li>
<li><code>wrappedErr</code><ul>
<li>error ç±»å‹ï¼Œè®°å½•<code>ï¼…w</code> åŠ¨è¯çš„ç›®æ ‡ï¼Œå³ä¾‹å­çš„ <code>err2</code></li>
</ul>
</li>
</ul>
<p>åœ¨å‡½æ•°fmt.Errorf()ä¸­<code>p.wrappedErr</code>ä¸ä¸ºç©ºåˆ™ä¼šè°ƒç”¨ç”Ÿæˆä¸€ä¸ª<code>wrapErrors</code>ç»“æ„ä½“</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">err = &amp;wrapError&#123;s, p.wrappedErr&#125;</span><br></pre></td></tr></table></figure>

<h3 id="fmt-wrapErroråˆ†æ"><a href="#fmt-wrapErroråˆ†æ" class="headerlink" title="fmt.wrapErroråˆ†æ"></a>fmt.wrapErroråˆ†æ</h3><ul>
<li>æºç <figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/fmt/errors.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> wrapError <span class="keyword">struct</span> &#123;</span><br><span class="line">    msg <span class="keyword">string</span></span><br><span class="line">    err error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *wrapError)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> e.msg</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *wrapError)</span> <span class="title">Unwrap</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> e.err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>msg, <code>string</code>ç±»å‹</li>
<li>err <code>error</code>ç±»å‹</li>
</ul>
<p>å®ç°äº†ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<p>Error ()ï¼Œä¹Ÿè¯´æ˜ wrapError ç»“æ„ä½“å®ç°äº† error æ¥å£ï¼Œæ˜¯ä¸€ä¸ª error ç±»å‹<br>Unwrap ()ï¼Œä½œç”¨æ˜¯è¿”å›åŸé”™è¯¯å€¼ï¼Œæ²¡æœ‰è‡ªå®šä¹‰çš„ msg äº†ã€‚ä¹Ÿå°±æ˜¯è¯´æ‹†å¼€äº†ä¸€ä¸ªè¢«åŒ…è£…çš„ errorã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ€»ç»“ä¸€ä¸‹å§ï¼ŒGolang ä¸­åˆ›å»ºé”™è¯¯æœ‰ä¸¤ç§æ–¹å¼ï¼š<br>ç¬¬ä¸€ç§ï¼šerrors.New() å‡½æ•°ï¼Œå…¶è¿”å›å€¼ç±»å‹ä¸º *errors.errorStringã€‚</p>
<p>ç¬¬äºŒç§ï¼šfmt.Errorf() å‡½æ•°<br>å½“ä½¿ç”¨ fmt.Errorf() æ¥åˆ›å»ºé”™è¯¯æ—¶ï¼Œæ ¸å¿ƒæœ‰ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p>
<p>é”™è¯¯æè¿°ä¸­ä¸åŒ…å« %w æ—¶ï¼Œp.wrappedErr ä¸º nilï¼Œæ‰€ä»¥åº•å±‚ä¹Ÿæ˜¯è°ƒç”¨ errors.New() åˆ›å»ºé”™è¯¯ã€‚å› æ­¤é”™è¯¯ç±»å‹å°±æ˜¯ *errors.errorStringã€‚</p>
<p>é”™è¯¯æè¿°ä¸­åŒ…å«%w æ—¶ï¼Œp.wrappedErr ä¸ä¸º nilï¼Œæ‰€ä»¥åº•å±‚å®ä¾‹åŒ– wrapError ç»“æ„ä½“æŒ‡é’ˆã€‚ å› æ­¤é”™è¯¯ç±»å‹æ˜¯ *fmt.wrapErrorï¼Œå¯ä»¥ç†è§£ä¸ºåŒ…è£¹é”™è¯¯ç±»å‹ã€‚</p>
]]></content>
      <categories>
        <category>è¯­è¨€å­¦ä¹ </category>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
        <tag>æºç é˜…è¯»</tag>
      </tags>
  </entry>
  <entry>
    <title>libeventåº“å­¦ä¹ ç¬”è®°</title>
    <url>/2022/01/18/libevent%E5%BA%93%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<hr>
<p>libeventæ˜¯ä¸€ä¸ªCè¯­è¨€ç¼–å†™çš„è½»é‡çº§çš„è·¨å¹³å°çš„é«˜æ€§èƒ½ç½‘ç»œåº“ï¼Œå®ƒåŸºäºäº‹ä»¶é©±åŠ¨çš„Reactoræ¨¡å¼ï¼Œæ”¯æŒå¤šç§I/Oå¤ç”¨æŠ€æœ¯ï¼Œç›®å‰å·²è¢«å¹¿æ³›ä½¿ç”¨ã€‚äº†è§£å…¶åŸç†ã€ç ”ç©¶å…¶æºç æ˜¯éå¸¸æœ‰æ„ä¹‰å’Œä»·å€¼çš„ï¼Œæœ¬æ–‡é¦–å…ˆä»‹ç»å‡ ç§å¸¸è§çš„I/Oæ¨¡å‹ï¼Œç”±æ­¤å¼•å‡ºlibeventå¹¶å‰–æå…¶æºç ,å¸Œæœ›èƒ½å’Œè¯»è€…ä¸€èµ·æå‡ç½‘ç»œç›¸å…³çš„æŠ€èƒ½ã€‚</p>
<span id="more"></span>
<!-- toc -->
<p>[toc]</p>
<p><a href="https://aceld.gitbooks.io/libevent/content/">å‚è€ƒæ–‡ç« </a></p>
<h2 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h2><h3 id="I-Oå¤šè·¯å¤ç”¨"><a href="#I-Oå¤šè·¯å¤ç”¨" class="headerlink" title="I/Oå¤šè·¯å¤ç”¨"></a>I/Oå¤šè·¯å¤ç”¨</h3><p>è¿›ç¨‹éœ€è¦ä¸€ç§é¢„å…ˆå‘ŠçŸ¥å†…æ ¸çš„èƒ½åŠ›ï¼Œä½¿å¾—å†…æ ¸ä¸€æ—¦å‘ç°è¿›ç¨‹æŒ‡å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªI/Oæ¡ä»¶å°±ç»ª(ä¹Ÿå°±æ˜¯è¯´è¾“å…¥å·²å‡†å¤‡å¥½ï¼Œæˆ–è€…æè¿°ç¬¦å·²ç»æ‰¿æ¥æ›´å¤šçš„è¾“å‡º)ï¼Œå®ƒå°±é€šçŸ¥è¿›ç¨‹ï¼Œè¿™ç§èƒ½åŠ›ç§°ä¸ºI/Oå¤ç”¨ã€‚IOå¤šè·¯å¤ç”¨æ˜¯ä¸€ç§åŒæ­¥IOæ¨¡å‹ï¼Œå®ç°ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ç›‘è§†å¤šä¸ªæ–‡ä»¶å¥æŸ„ï¼›ä¸€æ—¦æŸä¸ªæ–‡ä»¶å¥æŸ„å°±ç»ªï¼Œå°±èƒ½å¤Ÿé€šçŸ¥åº”ç”¨ç¨‹åºè¿›è¡Œç›¸åº”çš„è¯»å†™æ“ä½œï¼›æ²¡æœ‰æ–‡ä»¶å¥æŸ„å°±ç»ªæ—¶ä¼šé˜»å¡åº”ç”¨ç¨‹åºï¼Œäº¤å‡ºcpuã€‚<code>å¤šè·¯æ˜¯æŒ‡ç½‘ç»œè¿æ¥ï¼Œå¤ç”¨æŒ‡çš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹</code>ã€‚</p>
<h3 id="ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´"><a href="#ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´" class="headerlink" title="ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´"></a>ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´</h3><p>ç°åœ¨æ“ä½œç³»ç»Ÿéƒ½æ˜¯é‡‡ç”¨è™šæ‹Ÿå­˜å‚¨å™¨ï¼Œé‚£ä¹ˆå¯¹32ä½æ“ä½œç³»ç»Ÿè€Œè¨€ï¼Œå®ƒçš„å¯»å€ç©ºé—´ï¼ˆè™šæ‹Ÿå­˜å‚¨ç©ºé—´ï¼‰ä¸º4Gï¼ˆ2çš„32æ¬¡æ–¹ï¼‰ã€‚æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒæ˜¯å†…æ ¸ï¼Œç‹¬ç«‹äºæ™®é€šçš„åº”ç”¨ç¨‹åºï¼Œå¯ä»¥è®¿é—®å—ä¿æŠ¤çš„å†…å­˜ç©ºé—´ï¼Œä¹Ÿæœ‰è®¿é—®åº•å±‚ç¡¬ä»¶è®¾å¤‡çš„æ‰€æœ‰æƒé™ã€‚ä¸ºäº†ä¿è¯ç”¨æˆ·è¿›ç¨‹ä¸èƒ½ç›´æ¥æ“ä½œå†…æ ¸ï¼ˆkernelï¼‰ï¼Œä¿è¯å†…æ ¸çš„å®‰å…¨ï¼Œæ“å¿ƒç³»ç»Ÿå°†è™šæ‹Ÿç©ºé—´åˆ’åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†ä¸º<code>å†…æ ¸ç©ºé—´</code>ï¼Œä¸€éƒ¨åˆ†ä¸º<code>ç”¨æˆ·ç©ºé—´</code>ã€‚é’ˆå¯¹linuxæ“ä½œç³»ç»Ÿè€Œè¨€ï¼Œå°†æœ€é«˜çš„1Gå­—èŠ‚ï¼ˆä»è™šæ‹Ÿåœ°å€0xC0000000åˆ°0xFFFFFFFFï¼‰ï¼Œä¾›å†…æ ¸ä½¿ç”¨ï¼Œç§°ä¸ºå†…æ ¸ç©ºé—´ï¼Œè€Œå°†è¾ƒä½çš„3Gå­—èŠ‚ï¼ˆä»è™šæ‹Ÿåœ°å€0x00000000åˆ°0xBFFFFFFFï¼‰ï¼Œä¾›å„ä¸ªè¿›ç¨‹ä½¿ç”¨ï¼Œç§°ä¸ºç”¨æˆ·ç©ºé—´ï¼Œå¦‚å›¾2æ‰€ç¤ºã€‚è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ¦‚å¿µï¼Œå«DMAï¼ˆDirect Memory Accessç›´æ¥å­˜å‚¨å™¨è®¿é—®ï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¤„ç†å„ç§I/Oï¼ŒåŒ…æ‹¬ç½‘ç»œI/Oå’Œç£ç›˜I/Oã€‚CPUæ˜¯ä¸ä¼šç›´æ¥å¤„ç†I/Oçš„ï¼Œè¿™æ˜¯å› ä¸ºCPUéå¸¸å®è´µï¼Œè€ŒI/Oæ˜¯æ¯”è¾ƒè€—æ—¶çš„ï¼Œå¦‚æœCPUä¸€ç›´ç­‰å¾…æŸä¸€æ¬¡I/Oäº‹ä»¶å®Œæˆï¼Œä¼šå¸¦æ¥æå¤§çš„æµªè´¹ï¼Œä¸”æ€§èƒ½ä¼šæ€¥å‰§ä¸‹é™ï¼Œå› æ­¤<code>éœ€è¦ä¸€ç§æœºåˆ¶èƒ½å¤Ÿå®ŒæˆI/Oï¼Œå¹¶é€šçŸ¥CPUï¼ŒDMAå³æ˜¯è¿™ä¸ªè§’è‰²ã€‚</code></p>
<img src="image-20220107155339868.png" alt="ç”¨æˆ·æ€å’Œå†…æ ¸æ€" style="zoom: 25%;" />



<ol>
<li>ç­‰å¾…æ•°æ®å‡†å¤‡</li>
<li>å°†æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°è¿›ç¨‹ä¸­</li>
</ol>
<h3 id="Linuxä¸¤å¤§ç±»ç½‘ç»œæ¨¡å‹"><a href="#Linuxä¸¤å¤§ç±»ç½‘ç»œæ¨¡å‹" class="headerlink" title="Linuxä¸¤å¤§ç±»ç½‘ç»œæ¨¡å‹"></a>Linuxä¸¤å¤§ç±»ç½‘ç»œæ¨¡å‹</h3><ul>
<li>åŒæ­¥I/O</li>
</ul>
<blockquote>
<blockquote>
<p>é˜»å¡I/O</p>
<p>éé˜»å¡I/O</p>
<p>I/Oå¤šè·¯å¤ç”¨</p>
<p>ä¿¡å·é©±åŠ¨I/O</p>
</blockquote>
</blockquote>
<ul>
<li>å¼‚æ­¥I/O</li>
</ul>
<p>åŒæ­¥I/Oå’Œå¼‚æ­¥I/Oä¸»è¦åŒºåˆ«åœ¨äºï¼š ç”¨æˆ·è¿›ç¨‹åœ¨å‘èµ·I/Oæ“ä½œä¹‹åå¯ä»¥ç«‹åˆ»å»åšå…¶ä»–äº‹æƒ…ï¼Œæ•°æ®æ‹·è´ç”±ç¡¬ä»¶æ‹·è´åˆ°å†…æ ¸ç©ºé—´ã€ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´éƒ½ä¸é˜»å¡ï¼Œè¿™ç§å°±æ˜¯å¼‚æ­¥I/Oï¼›ä¸¤ä¸ªæ­¥éª¤ä¸­æœ‰ä»»ä½•ä¸€æ­¥å‘ç”Ÿé˜»å¡ï¼Œå°±æ˜¯åŒæ­¥I/Oã€‚</p>
<h2 id="I-Oå¤šè·¯å¤ç”¨-1"><a href="#I-Oå¤šè·¯å¤ç”¨-1" class="headerlink" title="I/Oå¤šè·¯å¤ç”¨"></a>I/Oå¤šè·¯å¤ç”¨</h2><h3 id="select"><a href="#select" class="headerlink" title="select"></a>select</h3><ul>
<li><p>å‡½æ•°åŸå‹</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">select</span> <span class="params">(<span class="keyword">int</span> nfds, fd_set * readfds,</span></span></span><br><span class="line"><span class="params"><span class="function">                  fd_set * writefds,</span></span></span><br><span class="line"><span class="params"><span class="function">                  fd_set *exceptfds,</span></span></span><br><span class="line"><span class="params"><span class="function">                  struct timeval *timeout)</span></span>;</span><br></pre></td></tr></table></figure></li>
<li><p>å‚æ•°ä»‹ç»</p>
<table>
<thead>
<tr>
<th align="left">å‚æ•°åç§°</th>
<th align="left">ç±»å‹</th>
<th align="left">å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td align="left">nfds</td>
<td align="left">int</td>
<td align="left">æ–‡ä»¶æè¿°ç¬¦æœ€å¤§å€¼+1</td>
</tr>
<tr>
<td align="left">readfds</td>
<td align="left">fd_set *</td>
<td align="left">è¯»äº‹ä»¶æ–‡ä»¶æè¿°ç¬¦é›†åˆ</td>
</tr>
<tr>
<td align="left">writefds</td>
<td align="left">fd_set *</td>
<td align="left">å†™äº‹ä»¶æ–‡ä»¶æè¿°ç¬¦é›†åˆ</td>
</tr>
<tr>
<td align="left">exceptfds</td>
<td align="left">fd_set *</td>
<td align="left">å¼‚å¸¸äº‹ä»¶æ–‡ä»¶æè¿°ç¬¦é›†åˆ</td>
</tr>
<tr>
<td align="left">timeout</td>
<td align="left">timeval *</td>
<td align="left">è¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡è¯¥æ—¶é—´å³ä½¿æ²¡æœ‰äº‹ä»¶åˆ°è¾¾ï¼Œselectä¹Ÿä¼šè¿”å›ï¼Œé¿å…æ— ä¼‘æ­¢åœ°ç­‰å¾…</td>
</tr>
</tbody></table>
</li>
<li><p>readäº‹ä»¶ä»£ç </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">sockfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span> (addr));</span><br><span class="line">  addr.sin_family = AF_INET;</span><br><span class="line">  addr.sin_port = <span class="built_in">htons</span>(<span class="number">2000</span>);</span><br><span class="line">  addr.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">  <span class="built_in">bind</span>(sockfd,(struct sockaddr*)&amp;addr ,<span class="built_in"><span class="keyword">sizeof</span></span>(addr));</span><br><span class="line">  <span class="built_in">listen</span> (sockfd, <span class="number">5</span>); </span><br><span class="line">  <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++) </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;client, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span> (client));</span><br><span class="line">    addrlen = <span class="built_in"><span class="keyword">sizeof</span></span>(client);</span><br><span class="line">    fds[i] = <span class="built_in">accept</span>(sockfd,(struct sockaddr*)&amp;client, &amp;addrlen);</span><br><span class="line">    <span class="keyword">if</span>(fds[i] &gt; max)</span><br><span class="line">    	max = fds[i];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ####################################################################</span></span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">	<span class="built_in">FD_ZERO</span>(&amp;rset);     <span class="comment">// 1. åˆå§‹åŒ–/é‡ç½®rset</span></span><br><span class="line">  	<span class="keyword">for</span> (i = <span class="number">0</span>; i&lt; <span class="number">5</span>; i++ ) &#123;</span><br><span class="line">  		<span class="built_in">FD_SET</span>(fds[i],&amp;rset); <span class="comment">// 2. ä¸ºrsetèµ‹å€¼</span></span><br><span class="line">  	&#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">// ä¼ å…¥æœ€å¤§æè¿°ç¬¦æ•°é‡åŠ 1</span></span><br><span class="line">	<span class="built_in">select</span>(max+<span class="number">1</span>, &amp;rset, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>); <span class="comment">// 3. selecté˜»å¡</span></span><br><span class="line"> </span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">FD_ISSET</span>(fds[i], &amp;rset))&#123;</span><br><span class="line">			<span class="built_in">memset</span>(buffer,<span class="number">0</span>,MAXBUF);</span><br><span class="line">			<span class="built_in">read</span>(fds[i], buffer, MAXBUF);</span><br><span class="line">			<span class="built_in">puts</span>(buffer);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;	</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>select åº•å±‚æœºåˆ¶<br>å†…æ ¸ä¼šå°†ä¼ å…¥çš„rsetç”±ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼Œç„¶ååœ¨å†…æ ¸ä¸­åˆ¤æ–­æ¯ä¸€ä¸ªç½®ä½çš„rsetæ˜¯å¦æœ‰æ•°æ®åˆ°è¾¾ï¼ˆå°†rsetæ‹·è´åˆ°å†…æ ¸æ€æ˜¯å› ä¸ºåœ¨å†…æ ¸ä¸­åˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®åˆ°è¾¾æ¯”åœ¨ç”¨æˆ·æ€åˆ¤æ–­æ•ˆç‡é«˜å¾ˆå¤šï¼‰ï¼Œå¦‚æœæœ‰ï¼Œåˆ™æ ‡è®°è¿™ä¸€ä½ï¼Œå¦‚æœæ²¡æœ‰ï¼Œç»§ç»­å¾€ååˆ¤æ–­ï¼Œé™¤éåˆ°è¾¾selectçš„è¶…æ—¶æ—¶é—´ï¼Œæ‰€ä»¥selectæ˜¯ä¸€ä¸ªé˜»å¡çš„å‡½æ•°ã€‚selectå‡½æ•°ä¸­ç¬¬ä¸€ä¸ªå‚æ•°nfdsæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿselectåœ¨å¯¹rsetéå†æ—¶ï¼Œä¼šæˆªå–0~nfdsï¼Œå› ä¸ºå¤§äºnfdsæ˜¯ä¸ä¼šæœ‰æ–‡ä»¶æè¿°ç¬¦çš„ï¼›å½“selectå‡½æ•°è¿”å›æ—¶ï¼Œå¾ªç¯éå†è¿™5ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œç„¶åæ£€æµ‹æ¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦è¢«æ ‡è®°ï¼Œå¦‚æœæ ‡è®°äº†ï¼Œè¯´æ˜æœ‰readäº‹ä»¶å‘ç”Ÿï¼Œåˆ™è¯»å–ç¼“å­˜ä¸­çš„æ•°æ®ã€‚è¿™é‡Œéœ€è¦æ³¨æ„æŸä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦æœ‰æ•°æ®æ˜¯éšæœºçš„ï¼Œå¯èƒ½æœ‰å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦åŒæ—¶æœ‰æ•°æ®åˆ°è¾¾ï¼Œå› æ­¤éœ€è¦æ‰§è¡Œforéå†æ¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚</p>
</li>
</ul>
<ul>
<li>selectå­˜åœ¨çš„é—®é¢˜</li>
</ul>
<ol>
<li>len(rset)=1024,æ‰€ä»¥æœ€å¤šåªèƒ½ç›‘å¬1024ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚è¿™ä¸ªæ˜¯æ“ä½œç³»ç»Ÿè¿›è¡Œçš„é™åˆ¶ï¼Œè™½ç„¶å¯ä»¥æ›´æ”¹ï¼Œä½†æ˜¯æœ‰ä¸Šé™ï¼›</li>
<li>rsetä¸å¯é‡ç”¨ã€‚ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ¯æ¬¡å¾ªç¯æ—¶ï¼Œéƒ½éœ€è¦è°ƒç”¨FD_ZERO(&amp;rest)ï¼Œé‡ç½®rsetï¼Œè¿™æ˜¯å› ä¸ºå†…æ ¸æ£€æµ‹æ˜¯å¦æœ‰æ•°æ®æ—¶ä¼šæ›´æ”¹rsetï¼Œå¦‚æœä¸é‡ç½®ï¼Œä¸Šä¸€æ¬¡selectè¿”å›çš„ç»“æœä¼šå¯¹ä¸‹ä¸€æ¬¡å†…æ ¸åˆ¤æ–­æŸä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦æœ‰æ•°æ®äº§ç”Ÿå½±å“ï¼›</li>
<li>è§£é™¤selecté˜»å¡åéœ€éå†æ¯ä¸€ä¸ªfdã€‚è¿™æ˜¯å› ä¸ºå†…æ ¸åˆ¤æ–­æ˜¯å¦æœ‰æ•°æ®åä¼šç›´æ¥è¿”å›ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è¿”å›ç©¶ç«Ÿæ˜¯å“ªä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æœ‰æ•°æ®ã€‚</li>
</ol>
<h3 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h3><ul>
<li><p>å‡½æ•°åŸå‹</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">poll</span> <span class="params">(struct pollfd *fds, <span class="keyword">unsigned</span> <span class="keyword">int</span> nfds, <span class="keyword">int</span> timeout)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> &#123;</span></span><br><span class="line">      <span class="keyword">int</span> fd;</span><br><span class="line">      <span class="keyword">short</span> events;  <span class="comment">// ç”¨æˆ·æ„Ÿå…´è¶£çš„äº‹ä»¶</span></span><br><span class="line">      <span class="keyword">short</span> revents; <span class="comment">// ç³»ç»Ÿè§¦å‘çš„äº‹ä»¶</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li><p>å‚æ•°ä»‹ç»</p>
<table>
<thead>
<tr>
<th align="left">å‚æ•°åç§°</th>
<th align="left">ç±»å‹</th>
<th align="left">å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td align="left">fds</td>
<td align="left">pollfd *</td>
<td align="left">æ–‡ä»¶æè¿°ç¬¦æ•°ç»„ï¼Œå’Œselectä¸åŒï¼Œfdsä¸­æ¯ä¸€ä¸ªå…ƒç´ ä¸æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œè€Œæ˜¯pollfdç±»å‹</td>
</tr>
<tr>
<td align="left">nfds</td>
<td align="left">unsigned int</td>
<td align="left">ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡</td>
</tr>
<tr>
<td align="left">timeout</td>
<td align="left">int</td>
<td align="left">è¶…æ—¶æ—¶é—´ï¼Œå«ä¹‰å’Œselectä¸­timeoutç±»ä¼¼</td>
</tr>
</tbody></table>
</li>
<li><p>pollä½¿ç”¨ä»£ç </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++) </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;client, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span> (client));</span><br><span class="line">    addrlen = <span class="built_in"><span class="keyword">sizeof</span></span>(client);</span><br><span class="line">    pollfds[i].fd = <span class="built_in">accept</span>(sockfd,(struct sockaddr*)&amp;client, &amp;addrlen);</span><br><span class="line">    pollfds[i].events = POLLIN;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="comment">// ######################################################################</span></span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">	<span class="built_in">poll</span>(pollfds, <span class="number">5</span>, <span class="number">50000</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (pollfds[i].revents &amp; POLLIN)&#123;</span><br><span class="line">			pollfds[i].revents = <span class="number">0</span>;</span><br><span class="line">			<span class="built_in">memset</span>(buffer,<span class="number">0</span>,MAXBUF);</span><br><span class="line">			<span class="built_in">read</span>(pollfds[i].fd, buffer, MAXBUF);</span><br><span class="line">			<span class="built_in">puts</span>(buffer);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>pollåŸç†<br>pollçš„åŸç†å’Œselectéå¸¸ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å°†pollfdsæ‹·è´åˆ°å†…æ ¸ç©ºé—´ã€‚ä¸åŒçš„æ˜¯ï¼Œå½“å†…æ ¸åˆ¤æ–­æŸä¸ªpollfdæœ‰æ•°æ®æ—¶ï¼Œä¼šå°†pollfd.reventsç½®ä½ï¼Œç„¶åè§£é™¤pollçš„é˜»å¡ã€‚å› æ­¤ï¼Œ<code>forä¸­éå†æ¯ä¸€ä¸ªpollfdå…ˆæ£€æµ‹è¯¥æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦è¢«ç½®ä½</code>ï¼Œå¦‚æœæ˜¯è¯´æ˜æœ‰æ•°æ®ï¼Œåˆ™å°†ç½®ä½çš„reventsæ¢å¤æˆé»˜è®¤ï¼Œéšåè¯»å–è¯¥æ•°æ®ã€‚</p>
</li>
<li><p>pollå­˜åœ¨çš„é—®é¢˜<br>pollè§£å†³äº†selectä¸­rsetæ— æ³•é‡ç”¨çš„é—®é¢˜ï¼Œé€šè¿‡è‡ªå®šä¹‰çš„pollfdç»“æ„ï¼Œå·§å¦™åœ°å®Œæˆäº†â€ç½®ä½-æ¢å¤â€çš„æ“ä½œï¼›è€Œä¸”ï¼Œpollä¸­æ–‡ä»¶æè¿°ç¬¦ä¸æ˜¯ä¸€ä¸ªæ•°å­—è€Œæ˜¯pollfdç»“æ„ï¼Œå¯ä»¥ç›‘å¬æ›´å¤šçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿå°±<code>çªç ´äº†selectä¸­len(rst)=1024çš„é™åˆ¶</code>ï¼Œ<br>ä½†æ˜¯ä¹Ÿå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼špollè§£é™¤é˜»å¡åä¾æ—§éœ€è¦å¾ªç¯éå†æ‰€æœ‰çš„pollfdsï¼Œç„¶åæ‰çŸ¥é“å…·ä½“å“ªä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æœ‰æ•°æ®</p>
</li>
</ul>
<h3 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h3><p>epollåœ¨pollçš„åŸºç¡€ä¸Šï¼Œé€šè¿‡åŒå‘é“¾è¡¨çš„ç»“æ„ï¼Œè§£å†³äº†pollä¸­å­˜åœ¨çš„é—®é¢˜ï¼Œæ¥ä¸‹æ¥çœ‹epollçš„å…·ä½“å®ç°</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">events</span>[4];</span></span><br><span class="line">  <span class="keyword">int</span> epfd = <span class="built_in">epoll_create</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">4</span>;i++) </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">ev</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;client, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span> (client));</span><br><span class="line">    addrlen = <span class="built_in"><span class="keyword">sizeof</span></span>(client);</span><br><span class="line">    ev.data.fd = <span class="built_in">accept</span>(sockfd,(struct sockaddr*)&amp;client, &amp;addrlen);</span><br><span class="line">    ev.events = EPOLLIN;</span><br><span class="line">    <span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_ADD, ev.data.fd, &amp;ev); </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ###################################</span></span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">  	<span class="built_in">puts</span>(<span class="string">&quot;round again&quot;</span>);</span><br><span class="line">  	nfds = <span class="built_in">epoll_wait</span>(epfd, events, <span class="number">4</span>, <span class="number">10000</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;nfds;i++) &#123;</span><br><span class="line">			<span class="built_in">memset</span>(buffer,<span class="number">0</span>,MAXBUF);</span><br><span class="line">			<span class="built_in">read</span>(events[i].data.fd, buffer, MAXBUF);</span><br><span class="line">			<span class="built_in">puts</span>(buffer);</span><br><span class="line">	&#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>epollçš„ä¸‰ä¸ªä¸»è¦å‡½æ•°<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> epfd = <span class="built_in">epoll_create</span>(<span class="number">10</span>); <span class="comment">// è¿™é‡Œçš„å‚æ•°10æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œäº‹å®ä¸Šï¼Œé€šè¿‡æºç å¯ä»¥çŸ¥é“è¿™é‡Œåªè¦ä¼ å…¥ä¸€ä¸ªæ­£æ•°å°±OK</span></span><br><span class="line"><span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_ADD, ev.data.fd, &amp;ev);</span><br><span class="line">nfds = <span class="built_in">epoll_wait</span>(epfd, events, <span class="number">4</span>, <span class="number">10000</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä¸‰ä¸ªå‡½æ•°å¯¹åº”çš„æ­¥éª¤:</p>
</blockquote>
</li>
</ul>
<ol>
<li>ç”Ÿæˆepollé¢æ¿epfdï¼ˆepoll_createå‡½æ•°çš„åŠŸèƒ½ï¼Œå¯¹åº”å›¾5ä¸­çš„æ©™é»„è‰²éƒ¨åˆ†ï¼‰</li>
<li>åœ¨ epfdä¸­å°†æ–‡ä»¶æè¿°ç¬¦å’Œäº‹ä»¶ç»‘å®šï¼ˆepoll_ctlå‡½æ•°çš„åŠŸèƒ½ï¼Œå¯¹åº”å›¾ä¸­çš„fd[x]â€“&gt;eventsï¼‰</li>
<li>é˜»å¡å¹¶ç›‘å¬æ–‡ä»¶æè¿°ç¬¦ï¼ˆepoll_waitå‡½æ•°çš„åŠŸèƒ½ï¼‰</li>
</ol>
<img src="image-20220110102301197.png" alt="" style="zoom:60%;"  />


<p>å†…æ ¸ç©ºé—´éƒ¨åˆ†æ˜¯å¦‚ä½•å¤„ç†çš„ï¼Œå½“æŸä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æœ‰æ•°æ®åˆ°è¾¾æ—¶ï¼Œå†…æ ¸ç©ºé—´ä¼šå°†è¯¥æ–‡ä»¶æè¿°ç¬¦è°ƒæ•´åˆ°æœ€å‰é¢ï¼Œä¸”nfds+1ï¼Œå¯¹åº”å›¾ä¸­ç»¿è‰²éƒ¨åˆ†ï¼Œè¡¨ç¤ºfd3å’Œfd2æœ‰æ•°æ®ï¼Œæ­¤æ—¶nfds=2ï¼Œè§£é™¤epoll_waitå‡½æ•°çš„é˜»å¡å¹¶è¿”å›nfdsçš„å€¼ã€‚åœ¨forè¿›è¡Œéå†æ—¶ï¼Œåªéœ€è¦éå†0~nfdså³å¯ï¼Œä¹Ÿå°±è§£å†³äº†selectå’Œpollä¸­éœ€è¦éå†æ•´ä¸ªæ–‡ä»¶æè¿°ç¬¦æ•°ç»„çš„é—®é¢˜ã€‚</p>
<ul>
<li>epollçš„è§¦å‘æœºåˆ¶</li>
</ul>
<ol>
<li>è¾¹ç¼˜è§¦å‘ï¼ˆedge triggered ETï¼‰<blockquote>
<p>å¯¹äºè¾¹ç¼˜è§¦å‘ï¼Œ<code>epoll_wait()åªè¿”å›ä¸€æ¬¡</code>ï¼Œå³åªåœ¨è¯¥è¯»å†™äº‹ä»¶å‘ç”Ÿæ—¶è¿”å›ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœäº‹ä»¶å¤„ç†å‡½æ•°åªè¯»å–äº†è¯¥æ–‡ä»¶æè¿°ç¼“å†²åŒºçš„éƒ¨åˆ†å†…å®¹æ—¶è¿”å›ï¼Œå†æ¬¡è°ƒç”¨epoll_wait()ï¼Œè™½ç„¶æ­¤æ—¶è¯¥æè¿°ç¬¦å¯¹åº”ç¼“å†²åŒºä¸­è¿˜æœ‰æ•°æ®ï¼Œä½†epoll_wait()å‡½æ•°ä¸ä¼šè¿”å›ã€‚</p>
</blockquote>
</li>
<li>æ°´å¹³è§¦å‘ï¼ˆlevel triggered LTï¼‰<blockquote>
<p>å¯¹äºæ°´å¹³è§¦å‘ï¼Œå®ƒä¸ç®¡æ˜¯å¦æœ‰äº‹ä»¶åç”Ÿï¼Œåªè¦æ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„ç¼“å†²åŒºä¸­æœ‰æ•°æ®å¯è¯»å†™ï¼Œepoll_wait()å°±ä¼šè¿”å›ã€‚</p>
</blockquote>
</li>
</ol>
<h2 id="Reactoræ¨¡å¼"><a href="#Reactoræ¨¡å¼" class="headerlink" title="Reactoræ¨¡å¼"></a>Reactoræ¨¡å¼</h2><p>æœ¬èŠ‚å°†ä»‹ç»Reactoræ¨¡å¼ï¼Œå®ƒæ˜¯libeventçš„æ ¸å¿ƒï¼Œå› æ­¤æœ‰å¿…è¦å¯¹å…¶è¿›è¡Œä»‹ç»ï¼Œæœ‰äº†ä¸Šæ–‡ä¸­selectã€pollã€epollçš„åŸºç¡€ï¼ŒReactoræ¨¡å¼å°±æ¯”è¾ƒå¥½ç†è§£äº†ã€‚ Reactoré‡Šä¹‰â€ååº”å †â€ï¼ˆä¸­æ–‡ç¿»è¯‘çš„åç§°å’Œå®ƒçš„åŠŸèƒ½å‡ ä¹æ²¡æœ‰ä»€ä¹ˆè”ç³»ï¼Œå› æ­¤ä¸‹æ–‡è¿˜æ˜¯é‡‡ç”¨è‹±æ–‡åï¼‰ï¼ŒReactoræ¨¡å¼çš„æ˜¯ä¸€ç§åŸºäºäº‹ä»¶é©±åŠ¨çš„å¼‚æ­¥å›è°ƒæœºåˆ¶ã€‚ä¸€èˆ¬çš„å‡½æ•°è°ƒç”¨æ˜¯å‹æ ˆå¼è°ƒç”¨ï¼Œå‡½æ•°ä¹‹é—´è°ƒç”¨éœ€è¦åŒæ­¥ç­‰å¾…ï¼Œè€ŒReactoræ¨¡å¼ä¸åŒï¼Œåº”ç”¨ç¨‹åºæä¾›ç›¸åº”çš„æ¥å£å¹¶æ³¨å†Œåˆ°Reactorä¸Šï¼Œ<code>å¦‚æœç›¸åº”çš„äº‹ä»¶å‘ç”Ÿï¼ŒReactorå°†ä¸»åŠ¨è°ƒç”¨åº”ç”¨ç¨‹åºæ³¨å†Œçš„æ¥å£ï¼ˆä¹Ÿå°±æ˜¯å›è°ƒå‡½æ•°ï¼‰</code>ã€‚æ‰€ä»¥ï¼Œä¸Šæ–‡ä¸­çš„selectã€pollã€epollå…¶å®éƒ½æ˜¯Reactoræ¨¡å¼ã€‚</p>
<img src="image-20220110151551749.png" alt="" style="zoom:50%;" />

<ul>
<li>ä»£ç æ¡†æ¶<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Reactor</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">register_handler</span><span class="params">(Event_Handler *pHandler, <span class="keyword">int</span> event)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">remove_handler</span><span class="params">(Event_Handler *pHeadler, <span class="keyword">int</span> event)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handle_event</span><span class="params">(timeval *ptv)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Event_Handler</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// events maybe read/write/tiomeout .etc</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">handle_events</span><span class="params">(<span class="keyword">int</span> events)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> HANDLE <span class="title">get_handle</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>Reactorç»„ä»¶</li>
</ul>
<ol>
<li>äº‹ä»¶æº(å›¾ä¸­çš„handle)<blockquote>
<p>åœ¨linuxç³»ç»Ÿä¸­æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œåœ¨windowä¸Šæ˜¯socketæˆ–Handleï¼Œä¸‹æ–‡ç»Ÿç§°ä¸ºâ€å¥æŸ„â€</p>
</blockquote>
</li>
<li>äº‹ä»¶å¤šè·¯åˆ†å‘æœºåˆ¶(å›¾ä¸­çš„Event Demultiplexer)<blockquote>
<p>ç”±æ“ä½œç³»ç»Ÿæä¾›çš„I/Oå¤šè·¯åˆ†å‘æœºåˆ¶ï¼Œæ¯”å¦‚ä¸Šæ–‡æ‰€è¿°çš„selectã€pollã€epoll</p>
</blockquote>
</li>
<li>ååº”å™¨(å›¾ä¸­çš„Reactor)<blockquote>
<p>Reactoræ¨¡å¼ä¸­çš„äº‹ä»¶ç®¡ç†æ¥å£ï¼Œæä¾›æ³¨å†Œã€æ³¨é”€äº‹ä»¶å’Œäº‹ä»¶å¾ªç¯ï¼Œå®ƒçš„å£°æ˜å‚è§ä»£ç ä¸­çš„class Reactor</p>
</blockquote>
</li>
<li>äº‹ä»¶å¤„ç†ç¨‹åº(å›¾ä¸­çš„Event_Handlerå’ŒConcrete_Event_Handler)<blockquote>
<p>åŒ…æ‹¬æŠ½è±¡å¤„ç†ç¨‹åºå’Œå…·ä½“å¤„ç†ç¨‹åºï¼Œä¸»è¦æ˜¯è€ƒè™‘æ‰©å±•æ€§ï¼Œå®ƒçš„å£°æ˜å‚è§class Event_Handler</p>
</blockquote>
</li>
</ol>
<h2 id="Libevent"><a href="#Libevent" class="headerlink" title="Libevent"></a>Libevent</h2><h3 id="libeventå®šæ—¶å™¨å®ç°"><a href="#libeventå®šæ—¶å™¨å®ç°" class="headerlink" title="libeventå®šæ—¶å™¨å®ç°"></a>libeventå®šæ—¶å™¨å®ç°</h3><ul>
<li>ä»£ç å®ä¾‹<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">event</span> <span class="title">ev</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">time_cb</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">short</span> event, <span class="keyword">void</span> *args)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;timer wakeup\n&quot;</span>);</span><br><span class="line">    <span class="built_in">event_add</span>(&amp;ev, &amp;tv); <span class="comment">// reschedule timer</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. åˆå§‹åŒ–libevent,ç›¸å½“äºåˆå§‹åŒ–Reactorå®ä¾‹</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> *<span class="title">base</span> =</span> <span class="built_in">event_init</span>();</span><br><span class="line">    tv.tv_sec = <span class="number">10</span>; <span class="comment">// 10s period</span></span><br><span class="line">    tv.tv_usec = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// #define evtimer_set(ev, cb, arg)	event_set(ev, -1, 0, cb, arg)</span></span><br><span class="line">    <span class="comment">// evtimer_set ä¹Ÿæ˜¯event_set</span></span><br><span class="line">    <span class="comment">// 2. åˆå§‹åŒ–æ—¶é—´event,è®¾ç½®å›è°ƒå‡½æ•°å’Œå…³æ³¨çš„äº‹ä»¶</span></span><br><span class="line">    <span class="built_in">evtimer_set</span>(&amp;ev, time_cb, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. è®¾ç½®eventä»å±çš„event_base</span></span><br><span class="line">    <span class="built_in">event_base_set</span>(base, &amp;ev);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. æ­£å¼æ·»åŠ äº‹ä»¶</span></span><br><span class="line">    <span class="built_in">event_add</span>(&amp;ev, &amp;tv);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ç­‰å¾…äº‹ä»¶å°±ç»ª,é˜»å¡</span></span><br><span class="line">    <span class="built_in">event_base_dispatch</span>(base);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="libeventæºç åˆ†æ"><a href="#libeventæºç åˆ†æ" class="headerlink" title="libeventæºç åˆ†æ"></a>libeventæºç åˆ†æ</h3><p>äº‹ä»¶eventç»“æ„</p>
<img src="image-20220110154957576.png" alt="" style="zoom:40%;" />
- åŒå‘é“¾è¡¨äº‹ä»¶ï¼ˆä½¿ç”¨åŒå‘é“¾è¡¨ç»“æ„ä¿å­˜äº†eventçš„æ‰€æœ‰äº‹ä»¶ï¼‰
-- event_nextï¼ˆä¿å­˜æ‰€æœ‰å·²æ³¨å†Œçš„I/Oäº‹ä»¶ï¼‰
-- ev_signal_nextï¼ˆä¿å­˜æ‰€æœ‰å·²æ³¨å†Œçš„ä¿¡å·äº‹ä»¶ï¼‰
-- ev_active_nextï¼ˆä¿å­˜æ‰€æœ‰å·²æ¿€æ´»çš„äº‹ä»¶ï¼Œæ¿€æ´»çš„å«ä¹‰å°±æ˜¯æ–‡ä»¶æè¿°ç¬¦æœ‰æ•°æ®ï¼‰
- ev_baseï¼ˆè¯¥äº‹ä»¶æ‰€å±çš„Reactorå®ä¾‹ï¼Œæ˜¯ä¸€ä¸ªevent_baseçš„æŒ‡é’ˆï¼Œå…³äºevent_baseï¼Œåé¢å°†è¯¦ç»†ä»‹ç»ï¼‰
- ev_eventsï¼ˆå®ƒæ˜¯eventå…³æ³¨çš„äº‹ä»¶ç±»å‹ï¼Œæœ‰å¤šç§å–å€¼ï¼Œä¸”å¯ä»¥"|"ç»„åˆï¼Œæ¯”å¦‚"EV_ERAD|EV_PERSIST",å½“ç„¶ï¼Œå®šæ—¶å™¨äº‹ä»¶ä¸èƒ½å’ŒI/Oäº‹ä»¶ç»„åˆåœ¨ä¸€èµ·ï¼Œå¯ä»¥è€ƒè™‘ä¸‹è¿™æ˜¯ä¸ºä»€ä¹ˆï¼‰

<img src="image-20220110155617337.png" alt="" style="zoom:50%;" />
libeventäº‹ä»¶ç®¡ç†çš„ç»“æ„ï¼Œå·¦ä¾§çº¢è‰²éƒ¨åˆ†è¡¨ç¤ºI/Oäº‹ä»¶å’Œsignalçš„ç»“æ„ï¼Œå®ƒä»¬éƒ½æ˜¯ç”±è‹¥å¹²äº‹ä»¶ç»„æˆçš„åŒå‘é“¾è¡¨ï¼Œå›¾ä¸­æŠŠå®ƒä»¬ç”»åœ¨ä¸€èµ·æ˜¯å› ä¸ºå®ƒä»¬ç»“æ„ç›¸åŒï¼Œä½†å®é™…ä¸Šå®ƒä»¬æ˜¯ä¸¤ä¸ªåŒå‘é“¾è¡¨ï¼›ä¸­é—´è“è‰²éƒ¨åˆ†è¡¨ç¤ºæ—¶é—´äº‹ä»¶ï¼Œæ—¶é—´äº‹ä»¶åœ¨åº•å±‚æ˜¯ä¸€ä¸ªä»¥è¶…æ—¶æ—¶é—´ä¸ºkeyçš„å°æ ¹å †ï¼Œç”±äºlibeventéœ€è¦é¢‘ç¹è·å–æœ€è¿‘çš„æ—¶é—´äº‹ä»¶ï¼Œå› æ­¤é‡‡ç”¨å°æ ¹å †å­˜å‚¨ï¼Œå°æ ¹å †åœ¨åº•å±‚æ˜¯ç”¨æ•°ç»„å®ç°çš„ï¼›å³è¾¹ç»¿è‰²éƒ¨åˆ†è¡¨ç¤ºæ¿€æ´»äº‹ä»¶çš„ç»“æ„ï¼Œå®ƒçš„åº•å±‚ä¹Ÿæ˜¯åŒå‘é“¾è¡¨ï¼Œä½†å®ƒä¸I/Oäº‹ä»¶çš„åŒå‘é“¾è¡¨ä¸åŒï¼Œå®ƒæ˜¯æ ¹æ®äº‹ä»¶çš„priorityè¿›è¡Œæ’åºçš„ï¼Œä¼˜å…ˆçº§é«˜çš„åœ¨å‰é¢ï¼Œä¼˜å…ˆè¢«æ‰§è¡Œã€‚å› æ­¤ï¼Œæœ‰å¯èƒ½å‡ºç°ä¼˜å…ˆçº§æ¯”è¾ƒä½çš„äº‹ä»¶ä¸€ç›´å¾—ä¸åˆ°æ‰§è¡Œã€‚libeventæä¾›äº†è®¾ç½®äº‹ä»¶ä¼˜å…ˆçº§çš„apiï¼Œå¦‚æœä¸è®¾ç½®ï¼Œä¼šç»™ä¸€ä¸ªé»˜è®¤çš„ä¼˜å…ˆçº§ã€‚



<h3 id="äº‹ä»¶æ¥å£å‡½æ•°"><a href="#äº‹ä»¶æ¥å£å‡½æ•°" class="headerlink" title="äº‹ä»¶æ¥å£å‡½æ•°"></a>äº‹ä»¶æ¥å£å‡½æ•°</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// äº‹ä»¶è®¾ç½®æ¥å£å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">event_set</span><span class="params">(struct event *ev, <span class="keyword">int</span> fd, <span class="keyword">short</span> events,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">void</span> (*callback)(<span class="keyword">int</span>,<span class="keyword">short</span>,<span class="keyword">void</span> *), <span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// fd:äº‹ä»¶evç»‘å®šçš„æ–‡ä»¶æè¿°ç¬¦æˆ–ä¿¡å·,å¦‚æœæ˜¯è¶…æ—¶äº‹ä»¶,fd=-1</span></span></span><br><span class="line"><span class="function"><span class="comment">// events:è®¾ç½®äº‹ä»¶çš„ç±»å‹ EV_READ|EV_PERSIST, EV_WRITE</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_base_set</span><span class="params">(struct event_base *base, struct event *ev)</span></span></span><br><span class="line"><span class="function"><span class="comment">// è®¾ç½®eventçš„evåˆ°event_baseä¸Š</span></span></span><br><span class="line"><span class="function"><span class="comment">// libevent æœ‰ä¸€ä¸ªå…¨å±€çš„event_baseæŒ‡é’ˆ,</span></span></span><br><span class="line"><span class="function"><span class="comment">// ä½¿ç”¨è¯¥å‡½æ•°å¯ä»¥å°†evæ³¨å†Œåˆ°è‡ªå®šä¹‰çš„event_baseä¸Š</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_priority_set</span><span class="params">(struct event *ev, <span class="keyword">int</span> pri)</span></span></span><br><span class="line"><span class="function"><span class="comment">// è®¾ç½®evçš„ä¼˜å…ˆçº§</span></span></span><br></pre></td></tr></table></figure>

<h3 id="äº‹ä»¶å¤„ç†æ¡†æ¶"><a href="#äº‹ä»¶å¤„ç†æ¡†æ¶" class="headerlink" title="äº‹ä»¶å¤„ç†æ¡†æ¶"></a>äº‹ä»¶å¤„ç†æ¡†æ¶</h3><ul>
<li>event_baseæ¡†æ¶</li>
</ul>
<img src="image-20220110160543388.png" alt="" style="zoom:20%;" />
- æ ¸å¿ƒå˜é‡
> æ ¸å¿ƒå˜é‡åŒ…æ‹¬evselå’Œevbaseã€‚æ·»åŠ äº‹ä»¶çš„è°ƒç”¨å…³ç³»ä¸ºevsel->add(evbase, ev)ï¼Œevselåªè´Ÿè´£è°ƒç”¨ï¼Œå°†å…·ä½“çš„äº‹ä»¶evæ³¨å†Œåˆ°evbaseä¸­ã€‚
- äº‹ä»¶æŒ‡é’ˆ
> ä¸»è¦åŒ…æ‹¬activequeueså’Œevent_queueï¼Œåˆ†åˆ«ä¿å­˜å¸¦æœ‰ä¼˜å…ˆçº§çš„æ¿€æ´»äº‹ä»¶å’Œæ‰€æœ‰æ³¨å†Œæ—¶é—´çš„eventæŒ‡é’ˆã€‚activequeues[priority]æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹æŒ‡å‘ä¸€ä¸ªä¼˜å…ˆçº§ä¸ºpriorityçš„æ¿€æ´»äº‹ä»¶eventã€‚
- æ—¶é—´ç®¡ç†å˜é‡
> åŒ…æ‹¬æ—¶é—´ç¼“å­˜tv_cacheå’Œevent_tvï¼Œä¸‹æ–‡ä¼šç»§ç»­ä»‹ç»
- å…¶ä»–å˜é‡
> ä¸»è¦æ˜¯å„ä¸ªç»“æ„æ•°é‡çš„ç»Ÿè®¡å˜é‡ï¼Œæ¯”å¦‚event_countæ˜¯æ³¨å†Œäº‹ä»¶çš„æ€»å’Œï¼Œnactivequeuesæ˜¯æ¿€æ´»äº‹ä»¶çš„æ€»é‡ã€‚

<h3 id="æ¥å£å‡½æ•°"><a href="#æ¥å£å‡½æ•°" class="headerlink" title="æ¥å£å‡½æ•°"></a>æ¥å£å‡½æ•°</h3><p>libeventæä¾›çš„å¯¹äºäº‹ä»¶çš„æ³¨å†Œã€æ³¨é”€ä»¥åŠå½“äº‹ä»¶å¤„äºæ¿€æ´»çŠ¶æ€æ—¶è°ƒç”¨å›åˆ°æ¥å£çš„apiå¦‚ä¸‹ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_add</span><span class="params">(struct event *ev, <span class="keyword">const</span> struct timeval *timeout)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_del</span><span class="params">(struct event *ev)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_base_loop</span><span class="params">(struct event_base *base, <span class="keyword">int</span> loops)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">event_active</span><span class="params">(struct event *event, <span class="keyword">int</span> res, <span class="keyword">short</span> events)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">event_process_active</span><span class="params">(struct event_base *base)</span></span>;</span><br></pre></td></tr></table></figure>
<p>event_add å‡½æ•°ä»‹ç»:</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_add</span><span class="params">(struct event *ev, <span class="keyword">const</span> struct timeval *tv)</span></span>&#123;</span><br><span class="line">    <span class="comment">// ev:æŒ‡å‘è¦æ³¨å†Œçš„äº‹ä»¶;tv:è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">event_base</span> *<span class="title">base</span> =</span> ev-&gt;base;</span><br><span class="line">    <span class="comment">// event_baseä½¿ç”¨çš„ç³»ç»ŸIOç­–ç•¥</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">eventop</span> *<span class="title">evsel</span> =</span> base-&gt;evsel; </span><br><span class="line">    <span class="keyword">void</span> *evbase = base-&gt;evbase;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ–°çš„timeräº‹ä»¶ï¼Œåœ¨å°æ ¹å †ä¸Šé¢„ç•™ä¸€ä¸ªä½ç½®</span></span><br><span class="line">    <span class="keyword">if</span> (tv != <span class="literal">NULL</span> &amp;&amp; !(ev-&gt;ev_flags &amp; EVLIST_TIMEOUT)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">min_heap_reserve</span>(&amp;base-&gt;timeheap,</span><br><span class="line">			<span class="number">1</span> + <span class="built_in">min_heap_size</span>(&amp;base-&gt;timeheap)) == <span class="number">-1</span>)</span><br><span class="line">			<span class="keyword">return</span> (<span class="number">-1</span>);  <span class="comment">/* ENOMEM == errno */</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((ev-&gt;ev_events &amp; (EV_READ|EV_WRITE|EV_SIGNAL)) &amp;&amp;</span><br><span class="line">	    !(ev-&gt;ev_flags &amp; (EVLIST_INSERTED|EVLIST_ACTIVE))) &#123;</span><br><span class="line">		res = evsel-&gt;<span class="built_in">add</span>(evbase, ev);</span><br><span class="line">		<span class="keyword">if</span> (res != <span class="number">-1</span>) <span class="comment">// å¦‚æœäº‹ä»¶æ·»åŠ æˆåŠŸåˆ™æ’å…¥åˆ°eventqueueä¸­</span></span><br><span class="line">			<span class="built_in">event_queue_insert</span>(base, ev, EVLIST_INSERTED);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (res != <span class="number">-1</span> &amp;&amp; tv != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">now</span>;</span></span><br><span class="line">		<span class="keyword">if</span> (ev-&gt;ev_flags &amp; EVLIST_TIMEOUT) <span class="comment">// EVLIST_TIMEOUTè¡¨ç¤ºè¯¥äº‹ä»¶å·²ç»å­˜åœ¨ä¸å®šæ—¶å™¨å †ä¸­ï¼Œåˆ™åˆ é™¤æ—§çš„</span></span><br><span class="line">			<span class="built_in">event_queue_remove</span>(base, ev, EVLIST_TIMEOUT);</span><br><span class="line">			</span><br><span class="line">        <span class="built_in">gettime</span>(base, &amp;now);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ((ev-&gt;ev_flags &amp; EVLIST_ACTIVE) &amp;&amp;</span><br><span class="line">		    (ev-&gt;ev_res &amp; EV_TIMEOUT)) &#123; <span class="comment">// å¦‚æœäº‹ä»¶å·²ç»å°±ç»ªåˆ™ä»æ¿€æ´»é“¾è¡¨ä¸­åˆ é™¤</span></span><br><span class="line">			<span class="built_in">event_queue_remove</span>(base, ev, EVLIST_ACTIVE);</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="comment">// æ’å…¥å®šæ—¶å™¨äº‹ä»¶</span></span><br><span class="line">        <span class="built_in">event_queue_insert</span>(base, ev, EVLIST_TIMEOUT);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> (res);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="äº‹ä»¶å¾ªç¯"><a href="#äº‹ä»¶å¾ªç¯" class="headerlink" title="äº‹ä»¶å¾ªç¯"></a>äº‹ä»¶å¾ªç¯</h3><p>äº‹ä»¶å¾ªç¯æ˜¯libeventéå¸¸é‡è¦çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒçš„ä¸»è¦èŒè´£å°±æ˜¯é˜»å¡ç­‰å¾…äº‹ä»¶åˆ°æ¥å¹¶è°ƒç”¨äº‹ä»¶ç»‘å®šçš„å›åˆ°å‡½æ•°ã€‚</p>
<ul>
<li>äº‹ä»¶å¾ªç¯çš„é€»è¾‘ç»“æ„</li>
</ul>
<img src="image-20220110162619843.png" alt="" style="zoom:26%;" />
* äº‹ä»¶å¾ªç¯å®ç°
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">event_base_loop</span><span class="params">(struct event_base *base, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">eventop</span> *<span class="title">evsel</span> =</span> base-&gt;evsel;</span><br><span class="line"><span class="keyword">void</span> *evbase = base-&gt;evbase;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> *<span class="title">tv_p</span>;</span></span><br><span class="line"><span class="keyword">int</span> res, done;</span><br><span class="line"><span class="comment">// æ¸…ç©ºæ—¶é—´ç¼“å­˜</span></span><br><span class="line">base-&gt;tv_cache.tv_sec = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// evsignal_baseæ˜¯å…¨å±€å˜é‡ï¼Œåœ¨å¤„ç†signalæ—¶ï¼Œç”¨äºæŒ‡åsignalæ‰€å±çš„event_baseå®ä¾‹</span></span><br><span class="line"><span class="keyword">if</span> (base-&gt;sig.ev_signal_added)</span><br><span class="line">	evsignal_base = base;</span><br><span class="line">done = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (!done) &#123; <span class="comment">// äº‹ä»¶ä¸»å¾ªç¯</span></span><br><span class="line">	<span class="comment">// æ ¡æ­£ç³»ç»Ÿæ—¶é—´</span></span><br><span class="line">	<span class="built_in">timeout_correct</span>(base, &amp;tv);</span><br><span class="line">	<span class="comment">// æ ¹æ®timer heapä¸­äº‹ä»¶çš„æœ€å°è¶…æ—¶æ—¶é—´ï¼Œè®¡ç®—ç³»ç»ŸI/O demultiplexerçš„æœ€å¤§ç­‰å¾…æ—¶é—´</span></span><br><span class="line">	tv_p = &amp;tv;</span><br><span class="line">	<span class="keyword">if</span> (!base-&gt;event_count_active &amp;&amp; !(flags &amp; EVLOOP_NONBLOCK)) &#123;</span><br><span class="line">		<span class="built_in">timeout_next</span>(base, &amp;tv_p);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// ä¾ç„¶æœ‰æœªå¤„ç†çš„å°±ç»ªæ—¶é—´ï¼Œå°±è®©I/O demultiplexerç«‹å³è¿”å›ï¼Œä¸å¿…ç­‰å¾…</span></span><br><span class="line">			<span class="comment">// ä¸‹é¢ä¼šæåˆ°ï¼Œåœ¨libeventä¸­ï¼Œä½ä¼˜å…ˆçº§çš„å°±ç»ªäº‹ä»¶å¯èƒ½ä¸èƒ½ç«‹å³è¢«å¤„ç†</span></span><br><span class="line">			<span class="built_in">evutil_timerclear</span>(&amp;tv);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// å¦‚æœå½“å‰æ²¡æœ‰æ³¨å†Œäº‹ä»¶ï¼Œå°±é€€å‡º</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">event_haveevents</span>(base)) &#123;</span><br><span class="line">		<span class="built_in">event_debug</span>((<span class="string">&quot;%s: no events registered.&quot;</span>, __func__));</span><br><span class="line">		<span class="keyword">return</span> (<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// æ›´æ–°last wait timeï¼Œå¹¶æ¸…ç©ºtime cache</span></span><br><span class="line">	<span class="built_in">gettime</span>(base, &amp;base-&gt;event_tv);</span><br><span class="line">	base-&gt;tv_cache.tv_sec = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// è°ƒç”¨ç³»ç»ŸI/O demultiplexerç­‰å¾…å°±ç»ªI/O eventsï¼Œå¯èƒ½æ˜¯epoll_waitï¼Œæˆ–è€…selectç­‰ï¼›</span></span><br><span class="line">	<span class="comment">// åœ¨evsel-&gt;dispatch()ä¸­ï¼Œä¼šæŠŠå°±ç»ªsignal eventã€I/O eventæ’å…¥åˆ°æ¿€æ´»é“¾è¡¨ä¸­</span></span><br><span class="line">	res = evsel-&gt;<span class="built_in">dispatch</span>(base, evbase, tv_p);</span><br><span class="line">	<span class="keyword">if</span> (res == <span class="number">-1</span>)</span><br><span class="line">		<span class="keyword">return</span> (<span class="number">-1</span>);</span><br><span class="line">	<span class="comment">// å°†time cacheèµ‹å€¼ä¸ºå½“å‰ç³»ç»Ÿæ—¶é—´</span></span><br><span class="line">	<span class="built_in">gettime</span>(base, &amp;base-&gt;tv_cache);</span><br><span class="line">	<span class="comment">// æ£€æŸ¥heapä¸­çš„timer eventsï¼Œå°†å°±ç»ªçš„timer eventä»heapä¸Šåˆ é™¤ï¼Œå¹¶æ’å…¥åˆ°æ¿€æ´»é“¾è¡¨ä¸­</span></span><br><span class="line">	<span class="built_in">timeout_process</span>(base);</span><br><span class="line">	<span class="comment">// è°ƒç”¨event_process_active()å¤„ç†æ¿€æ´»é“¾è¡¨ä¸­çš„å°±ç»ªeventï¼Œè°ƒç”¨å…¶å›è°ƒå‡½æ•°æ‰§è¡Œäº‹ä»¶å¤„ç†</span></span><br><span class="line">	<span class="comment">// è¯¥å‡½æ•°ä¼šå¯»æ‰¾æœ€é«˜ä¼˜å…ˆçº§ï¼ˆpriorityå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰çš„æ¿€æ´»äº‹ä»¶é“¾è¡¨ï¼Œ</span></span><br><span class="line">	<span class="comment">// ç„¶åå¤„ç†é“¾è¡¨ä¸­çš„æ‰€æœ‰å°±ç»ªäº‹ä»¶ï¼›</span></span><br><span class="line">	<span class="comment">// å› æ­¤ä½ä¼˜å…ˆçº§çš„å°±ç»ªäº‹ä»¶å¯èƒ½å¾—ä¸åˆ°åŠæ—¶å¤„ç†ï¼›</span></span><br><span class="line">	<span class="keyword">if</span> (base-&gt;event_count_active) &#123;</span><br><span class="line">		<span class="built_in">event_process_active</span>(base);</span><br><span class="line">		<span class="keyword">if</span> (!base-&gt;event_count_active &amp;&amp; (flags &amp; EVLOOP_ONCE))</span><br><span class="line">			done = <span class="number">1</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (flags &amp; EVLOOP_NONBLOCK)</span><br><span class="line">		done = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¾ªç¯ç»“æŸï¼Œæ¸…ç©ºæ—¶é—´ç¼“å­˜</span></span><br><span class="line">base-&gt;tv_cache.tv_sec = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">event_debug</span>((<span class="string">&quot;%s: asked to terminate loop.&quot;</span>, __func__));</span><br><span class="line"><span class="keyword">return</span> (<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>libeventå‡½æ•°çš„ä¸€å¤§äº®ç‚¹å°±æ˜¯å°†I/Oå’Œtimeräº‹ä»¶ç»Ÿä¸€èµ·æ¥äº†ï¼Œè¿™é‡Œå°±æœ‰ä¸ªç–‘é—®ï¼Œä¸ºä»€ä¹ˆå°†IOäº‹ä»¶çš„timeoutè®¾ç½®ä¸ºæ‰€æœ‰å®šæ—¶å™¨äº‹ä»¶çš„æœ€å°æ—¶é—´ï¼Œå°±èƒ½å°†timeräº‹ä»¶å®Œç¾èåˆåˆ°ç³»ç»ŸIOæœºåˆ¶ä¸­ï¼ŸåŸå› æ˜¯timeräº‹ä»¶ä¸»è¦ç›®æ ‡æ˜¯å®šæ—¶å™¨åˆ°æœŸåéœ€è¦è§¦å‘ä¸€ä¸ªå›è°ƒï¼ŒIOæœºåˆ¶æ˜¯å·²ç»æ¿€æ´»çš„eventæ‰ä¼šè§¦å‘å›è°ƒå‡½æ•°ï¼Œæ‰€ä»¥ï¼Œåªè¦æœ‰ä¸€ç§æœºåˆ¶å¯ä»¥å°†åˆ°æœŸçš„timeræ”¾åˆ°æ¿€æ´»é“¾è¡¨ä¸­å°±å¯ä»¥ã€‚libeventå°†IOäº‹ä»¶çš„timeoutè®¾ç½®ä¸ºå®šæ—¶å™¨äº‹ä»¶çš„æœ€å°æ—¶é—´ï¼Œé‚£ä¹ˆå½“IOäº‹ä»¶æ¿€æ´»æ—¶ï¼Œä»timerå †ä¸­å–å‡ºæœ€å°çš„timeråˆ¤æ–­æ˜¯å¦åˆ°æœŸï¼Œå¦‚æœåˆ°æœŸå°†å…¶ä¹Ÿæ”¾å…¥æ¿€æ´»é“¾è¡¨ä¸­ï¼›å¦‚æœIOæ—¶é—´åœ¨timeoutå†…æ²¡æœ‰æ¿€æ´»,åˆ™ä¼šè§¦å‘è¶…æ—¶ï¼Œæ­¤æ—¶ä¹Ÿæ£€æŸ¥æœ€å°çš„timeræ˜¯å¦åˆ°æœŸï¼Œè¿™æ ·å°±èƒ½å°†timeräº‹ä»¶å¾ˆå¥½åœ°æ”¾åˆ°æ¿€æ´»äº‹ä»¶ä¸­ã€‚ä¹Ÿå°±å®ç°äº†å°†I/Oå’Œtimeräº‹ä»¶ç»Ÿä¸€èµ·æ¥ã€‚</p>
]]></content>
      <categories>
        <category>æ¡†æ¶å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>Reactor</tag>
        <tag>libevent</tag>
      </tags>
  </entry>
  <entry>
    <title>linuxæ¡ä»¶å˜é‡pthread_cond_wait</title>
    <url>/2022/01/21/linux%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8Fpthread-cond-wait/</url>
    <content><![CDATA[<hr>
<p>linuxæ¡ä»¶å˜é‡çš„ä½¿ç”¨ï¼Œä»¥åŠä¸ºä»€ä¹ˆpthread_cond_waitè¦ä¼ å…¥ä¸€ä¸ªäº’æ–¥é‡ï¼Œå¹¶ä¸”è¦è§£é”äº’æ–¥é‡ï¼Œå†waitã€‚é€šè¿‡ä¸€ä¸ªå¸¸ç”¨çš„pthread_cond_waitä½¿ç”¨æ–¹æ³•æ¥è®²è§£ã€‚c++11çš„æ¡ä»¶å˜é‡ä¹Ÿæ˜¯åŒç†ä½¿ç”¨ã€‚</p>
<span id="more"></span>
<!-- toc -->

<h2 id="linuxæ¡ä»¶å˜é‡pthread-cond-waitç†è§£"><a href="#linuxæ¡ä»¶å˜é‡pthread-cond-waitç†è§£" class="headerlink" title="linuxæ¡ä»¶å˜é‡pthread_cond_waitç†è§£"></a>linuxæ¡ä»¶å˜é‡pthread_cond_waitç†è§£</h2><ul>
<li><p>æ­£ç¡®çš„ä½¿ç”¨</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// çº¿ç¨‹Aï¼Œæ¡ä»¶æµ‹è¯•</span></span><br><span class="line"><span class="built_in">pthread_mutex_lock</span>(mtx);        <span class="comment">// a1</span></span><br><span class="line"><span class="keyword">while</span>(pass == <span class="number">0</span>) &#123;              <span class="comment">// a2 </span></span><br><span class="line">    <span class="built_in">pthread_cond_wait</span>(cv, mtx); <span class="comment">// a3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">pthread_mutex_unlock</span>(mtx);      <span class="comment">// a4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹Bï¼Œæ¡ä»¶å‘ç”Ÿä¿®æ”¹ï¼Œå¯¹åº”çš„signalä»£ç </span></span><br><span class="line"><span class="built_in">pthread_mutex_lock</span>(mtx);   <span class="comment">// b1</span></span><br><span class="line">pass = <span class="number">1</span>;                  <span class="comment">// b2</span></span><br><span class="line"><span class="built_in">pthread_mutex_unlock</span>(mtx); <span class="comment">// b3</span></span><br><span class="line"><span class="built_in">pthread_cond_signal</span>(cv);   <span class="comment">// b4</span></span><br></pre></td></tr></table></figure></li>
<li><p>æ­¥éª¤æ‹†è§£</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// çº¿ç¨‹Aï¼Œæ¡ä»¶æµ‹è¯•</span></span><br><span class="line"><span class="built_in">pthread_mutex_lock</span>(mtx);        <span class="comment">// a1</span></span><br><span class="line"><span class="keyword">while</span>(pass == <span class="number">0</span>) &#123;              <span class="comment">// a2 </span></span><br><span class="line">    <span class="built_in">pthread_mutex_unlock</span>(mtx);  <span class="comment">// a3</span></span><br><span class="line">    <span class="built_in">pthread_cond_just_wait</span>(cv); <span class="comment">// a4</span></span><br><span class="line">    <span class="built_in">pthread_mutex_lock</span>(mtx);    <span class="comment">// a5</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">pthread_mutex_unlock</span>(mtx);</span><br><span class="line"></span><br><span class="line"><span class="comment">// çº¿ç¨‹Bï¼Œæ¡ä»¶å‘ç”Ÿä¿®æ”¹ï¼Œå¯¹åº”çš„signalä»£ç </span></span><br><span class="line"><span class="built_in">pthread_mutex_lock</span>(mtx);   <span class="comment">// b1</span></span><br><span class="line">pass = <span class="number">1</span>;                  <span class="comment">// b2</span></span><br><span class="line"><span class="built_in">pthread_mutex_unlock</span>(mtx); <span class="comment">// b3</span></span><br><span class="line"><span class="built_in">pthread_cond_signal</span>(cv);   <span class="comment">// b4</span></span><br></pre></td></tr></table></figure>
<p>å­˜åœ¨é—®é¢˜ï¼Œè‹¥æ­¥éª¤æ˜¯a1ï¼Œa2ï¼Œa3ï¼Œb1ï¼Œb2ï¼Œb3ï¼Œb4ï¼Œa5<br>è¿™æ ·çš„è¯ï¼Œçº¿ç¨‹aæ˜¯ä¸ä¼šè¢«å”¤é†’çš„ã€‚å› æ­¤pthread_cond_waitæ˜¯å¿…é¡»æ˜¯ä¸€ä¸ªåŸå­æ€§æ“ä½œã€‚</p>
</li>
<li><p>æ¡ä»¶å˜é‡ä¼ å…¥çš„äº’æ–¥é”<br>è¿™ä¸ªäº’æ–¥é”ï¼Œä¸æ˜¯ç”¨æ¥ä¿æŠ¤æ¡ä»¶å˜é‡çš„å†…éƒ¨çŠ¶æ€ã€‚è€Œæ˜¯ç”¨æ¥ä¿æŠ¤å¤–éƒ¨â€æ¡ä»¶â€(å°±æ˜¯é‚£ä¸ª while å¾ªç¯ä¸­çš„åˆ¤æ–­ï¼‰ã€‚å‡å¦‚æ¡ä»¶å˜é‡çš„å†…éƒ¨çŠ¶æ€éœ€è¦é”å®šï¼Œå®Œå…¨å¯ä»¥åœ¨å†…éƒ¨å®ç°ä¸­ç»´æŠ¤ä¸€ä¸ªé”ï¼Œæ²¡æœ‰å¿…è¦ä»å¤–éƒ¨ä¼ è¿›æ¥ã€‚<br>ç”¨äºåˆ¤æ–­æ˜¯å¦ç­‰å¾…çš„â€œæ¡ä»¶â€œï¼Œé€šå¸¸å°±æ˜¯çº¿ç¨‹ä¹‹é—´å…±äº«çš„æŸä¸ªå˜é‡å€¼ã€‚A çº¿ç¨‹åˆ¤æ–­â€æ¡ä»¶â€œç­‰å¾…ï¼Œä¼šè¯»å–å…±äº«å˜é‡ã€‚B çº¿ç¨‹è®©â€æ¡ä»¶â€œæ»¡è¶³ï¼Œä¼šä¿®æ”¹å˜é‡ã€‚<code>è¿™ä¸ªé”ï¼Œå°±æ˜¯ä¿æŠ¤çº¿ç¨‹é—´çš„å…±äº«å˜é‡ï¼ˆâ€æ¡ä»¶â€œï¼‰</code>ï¼Œè®©â€æ¡ä»¶â€œä¸ä¼šä¸€è¾¹ä¿®æ”¹ï¼Œä¸€è¾¹è¯»å–ã€‚è¿™æŠŠé”è¿˜æœ‰ä¸ªé¢å¤–çš„ä½œç”¨ã€‚wait å‡½æ•°ä¼šé˜»å¡ï¼Œå°†çº¿ç¨‹ A æ”¾åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ã€‚wait å‡½æ•°æ”¾åœ¨é”çš„ lockï¼Œunlock å†…éƒ¨ï¼Œä¹Ÿä¿è¯äº†çº¿ç¨‹è¿˜æ²¡æœ‰çœŸæ­£æ”¾åˆ°é˜»å¡é˜Ÿåˆ—æ—¶ï¼Œçº¿ç¨‹ B ä¸èƒ½ä¿®æ”¹â€œæ¡ä»¶â€åè¿›è¡Œå”¤é†’ã€‚è¿™æ®µè¯åº”è¯¥æš‚æ—¶è¯»ä¸æ‡‚ï¼Œå¯å›å¤´å†çœ‹ï¼Œå…ˆæ”¾åœ¨è¿™é‡Œï¼Œä¸ç„¶æè¿°å°±ä¸å¤Ÿå‡†ç¡®ã€‚</p>
</li>
</ul>
]]></content>
      <categories>
        <category>linux</category>
        <category>å¹¶å‘ç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>c++</tag>
        <tag>linux</tag>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>libgoæºç é˜…è¯»</title>
    <url>/2022/02/10/libgo%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/</url>
    <content><![CDATA[<hr>
<p>ç›®å‰å·¥ä½œä¸Šéœ€è¦é™åŸå…ˆçš„çº¿ç¨‹æ”¹ä¸ºåç¨‹æ¡†æ¶ï¼Œæ¥è§£å†³ä¸šåŠ¡ä¸Šè¯·æ±‚é‡å¤§å’ŒæŸäº›æ¥å£è¯·æ±‚æ—¶é—´é•¿çš„é—®é¢˜ã€‚å› æ­¤ï¼Œæ…¢æ…¢é˜…è¯»ä¸‹æºç ï¼Œé¿å…åç»­è¸©å‘ã€‚</p>
<span id="more"></span>
<!-- toc -->

<p>[toc]</p>
<h2 id="åç¨‹æœ€ä¸»è¦çš„äº‹æƒ…"><a href="#åç¨‹æœ€ä¸»è¦çš„äº‹æƒ…" class="headerlink" title="åç¨‹æœ€ä¸»è¦çš„äº‹æƒ…"></a>åç¨‹æœ€ä¸»è¦çš„äº‹æƒ…</h2><ul>
<li>å®ç°ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
<li>ç³»ç»Ÿå‡½æ•°hook</li>
<li>åç¨‹è°ƒåº¦</li>
<li>æ—¶é—´ç®¡ç†</li>
</ul>
<h3 id="libgoç›®å½•ç»“æ„"><a href="#libgoç›®å½•ç»“æ„" class="headerlink" title="libgoç›®å½•ç»“æ„"></a>libgoç›®å½•ç»“æ„</h3><ul>
<li>taskï¼šåç¨‹çš„ç›¸å…³å®ç°ï¼›</li>
<li>schedulerï¼šåç¨‹è°ƒåº¦çš„å®ç°ï¼›</li>
<li>debugï¼šlibgo è‡ªå¸¦çš„è°ƒè¯•åŠŸèƒ½ï¼ˆç”¨äºåç¨‹çŠ¶æ€çš„å®šä½ç­‰ï¼‰ï¼›</li>
<li>coroutine.hï¼šå¯¹ä¸€äº›å¸¸ç”¨å¯¹æ–¹æ³•è¿›è¡Œäº†é‡å®šä¹‰ã€‚</li>
<li>netioï¼šhookçš„ç³»ç»Ÿè°ƒç”¨ï¼›</li>
<li>contextï¼šä¸Šä¸‹æ–‡çš„åˆ‡æ¢ï¼›</li>
<li>poolï¼šlibgo å®ç°çš„è¿æ¥æ± </li>
</ul>
<h2 id="libgoçš„ä¸‰å¤§ç»“æ„ä½“"><a href="#libgoçš„ä¸‰å¤§ç»“æ„ä½“" class="headerlink" title="libgoçš„ä¸‰å¤§ç»“æ„ä½“"></a>libgoçš„ä¸‰å¤§ç»“æ„ä½“</h2><ul>
<li>è°ƒåº¦å™¨(Scheduler)</li>
<li>æ‰§è¡Œå™¨(Processer)</li>
<li>åç¨‹(Task)    </li>
</ul>
<p><img src="/2022/02/10/libgo%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/20220209171247.png" alt="libgoä¸‰å¤§ç»“æ„ä½“å…³ç³»" title="ä¸»è¦ç»“æ„ä½“å…³ç³»"></p>
<h3 id="è°ƒåº¦å™¨-Scheduler"><a href="#è°ƒåº¦å™¨-Scheduler" class="headerlink" title="è°ƒåº¦å™¨ Scheduler"></a>è°ƒåº¦å™¨ <strong>Scheduler</strong></h3><ul>
<li>libgo/scheduler/scheduler.h</li>
</ul>
<ul>
<li><p>æºç </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åç¨‹è°ƒåº¦å™¨</span></span><br><span class="line"><span class="comment">// è´Ÿè´£ç®¡ç†1åˆ°Nä¸ªè°ƒåº¦çº¿ç¨‹, è°ƒåº¦ä»å±åç¨‹.</span></span><br><span class="line"><span class="comment">// å¯ä»¥è°ƒç”¨Createæ¥å£åˆ›å»ºæ›´å¤šé¢å¤–çš„è°ƒåº¦å™¨</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scheduler</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">Processer</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">ALWAYS_INLINE <span class="keyword">static</span> Scheduler&amp; <span class="title">getInstance</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// åˆ›å»ºä¸€ä¸ªè°ƒåº¦å™¨ï¼Œåˆå§‹åŒ– libgo</span></span><br><span class="line">	<span class="comment">// åˆ›å»ºä¸»çº¿ç¨‹çš„æ‰§è¡Œå™¨ï¼Œå¦‚æœåç»­ STart çš„æ—¶å€™æ²¡æœ‰å‚æ•°ï¼Œé»˜è®¤åªæœ‰ä¸€ä¸ªæ‰§è¡Œå™¨å»åš</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Scheduler* <span class="title">Create</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªåç¨‹</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">CreateTask</span><span class="params">(TaskF <span class="keyword">const</span>&amp; fn, TaskOpt <span class="keyword">const</span>&amp; opt)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å‰æ˜¯å¦å¤„äºåç¨‹ä¸­</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">IsCoroutine</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦æ²¡æœ‰åç¨‹å¯æ‰§è¡Œ</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">IsEmpty</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨è°ƒåº¦å™¨</span></span><br><span class="line">    <span class="comment">// @minThreadNumber : æœ€å°è°ƒåº¦çº¿ç¨‹æ•°, ä¸º0æ—¶, è®¾ç½®ä¸ºcpuæ ¸å¿ƒæ•°.</span></span><br><span class="line">    <span class="comment">// @maxThreadNumber : æœ€å¤§è°ƒåº¦çº¿ç¨‹æ•°, ä¸º0æ—¶, è®¾ç½®ä¸ºminThreadNumber.</span></span><br><span class="line">    <span class="comment">//          å¦‚æœmaxThreadNumberå¤§äºminThreadNumber, åˆ™å½“åç¨‹äº§ç”Ÿé•¿æ—¶é—´é˜»å¡æ—¶,</span></span><br><span class="line">    <span class="comment">//          å¯ä»¥è‡ªåŠ¨æ‰©å±•è°ƒåº¦çº¿ç¨‹æ•°.</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span><span class="params">(<span class="keyword">int</span> minThreadNumber = <span class="number">1</span>, <span class="keyword">int</span> maxThreadNumber = <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">goStart</span><span class="params">(<span class="keyword">int</span> minThreadNumber = <span class="number">1</span>, <span class="keyword">int</span> maxThreadNumber = <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> s_ulimitedMaxThreadNumber = <span class="number">40960</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœæ­¢è°ƒåº¦ </span></span><br><span class="line">    <span class="comment">// æ³¨æ„: åœæ­¢åæ— æ³•æ¢å¤, ä»…ç”¨äºå®‰å…¨é€€å‡ºmainå‡½æ•°, ä¸ä¿è¯ç»ˆæ­¢æ‰€æœ‰çº¿ç¨‹.</span></span><br><span class="line">    <span class="comment">//       å¦‚æœæŸä¸ªè°ƒåº¦çº¿ç¨‹è¢«åç¨‹é˜»å¡, å¿…é¡»ç­‰å¾…é˜»å¡ç»“æŸæ‰èƒ½é€€å‡º.</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Stop</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ç‹¬ç«‹çš„å®šæ—¶å™¨çº¿ç¨‹</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">UseAloneTimerThread</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å‰è°ƒåº¦å™¨ä¸­çš„åç¨‹æ•°é‡</span></span><br><span class="line">    <span class="function"><span class="keyword">uint32_t</span> <span class="title">TaskCount</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å‰åç¨‹ID, IDä»1å¼€å§‹ï¼ˆä¸åœ¨åç¨‹ä¸­åˆ™è¿”å›0ï¼‰</span></span><br><span class="line">    <span class="function"><span class="keyword">uint64_t</span> <span class="title">GetCurrentTaskID</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å‰åç¨‹åˆ‡æ¢çš„æ¬¡æ•°</span></span><br><span class="line">    <span class="function"><span class="keyword">uint64_t</span> <span class="title">GetCurrentTaskYieldCount</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®å½“å‰åç¨‹è°ƒè¯•ä¿¡æ¯, æ‰“å°è°ƒè¯•ä¿¡æ¯æ—¶å°†å›æ˜¾</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">SetCurrentTaskDebugInfo</span><span class="params">(std::string <span class="keyword">const</span>&amp; info)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">typedef</span> Timer&lt;std::function&lt;<span class="built_in"><span class="keyword">void</span></span>()&gt;&gt; TimerType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">inline</span> TimerType &amp; <span class="title">GetTimer</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> timer_ ? *timer_ : <span class="built_in">StaticGetTimer</span>(); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">IsStop</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> stop_; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span>&amp; <span class="title">IsExiting</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">idx_t</span>     = std::<span class="keyword">size_t</span>;</span><br><span class="line">    <span class="keyword">using</span> ActiveMap = std::multimap&lt;std::<span class="keyword">size_t</span>, <span class="keyword">idx_t</span>&gt;;</span><br><span class="line">    <span class="keyword">using</span> BlockMap  = std::map&lt;<span class="keyword">idx_t</span>, std::<span class="keyword">size_t</span>&gt;;</span><br><span class="line">    <span class="built_in">Scheduler</span>();</span><br><span class="line">    ~<span class="built_in">Scheduler</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Scheduler</span>(Scheduler <span class="keyword">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="built_in">Scheduler</span>(Scheduler &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    Scheduler&amp; <span class="keyword">operator</span>=(Scheduler <span class="keyword">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    Scheduler&amp; <span class="keyword">operator</span>=(Scheduler &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DeleteTask</span><span class="params">(RefObject* tk, <span class="keyword">void</span>* arg)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†ä¸€ä¸ªåç¨‹åŠ å…¥å¯æ‰§è¡Œé˜Ÿåˆ—ä¸­</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">AddTask</span><span class="params">(Task* tk)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// dispatcherçº¿ç¨‹å‡½æ•°</span></span><br><span class="line">    <span class="comment">// 1.æ ¹æ®å¾…æ‰§è¡Œåç¨‹è®¡ç®—è´Ÿè½½, å°†é«˜è´Ÿè½½çš„Pä¸­çš„åç¨‹stealä¸€äº›ç»™ç©ºè½½çš„P</span></span><br><span class="line">    <span class="comment">// 2.ä¾¦æµ‹åˆ°é˜»å¡çš„P(å•ä¸ªåç¨‹è¿è¡Œæ—¶é—´è¶…è¿‡é˜€å€¼), å°†Pä¸­çš„å…¶ä»–åç¨‹stealç»™å…¶ä»–P</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">DispatcherThread</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">NewProcessThread</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">DispatchBlocks</span><span class="params">(BlockMap &amp;blockings,ActiveMap &amp;actives)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">LoadBalance</span><span class="params">(ActiveMap &amp;actives,std::<span class="keyword">size_t</span> activeTasks)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function">TimerType &amp; <span class="title">StaticGetTimer</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// deque of Processer, write by start or dispatch thread</span></span><br><span class="line">    Deque&lt;Processer*&gt; processers_;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// libgoçš„è‡ªæ—‹é”</span></span><br><span class="line">    LFLock started_;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// åç¨‹æ•°é‡</span></span><br><span class="line">    <span class="keyword">atomic_t</span>&lt;<span class="keyword">uint32_t</span>&gt; taskCount_&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">uint32_t</span> lastActive_ = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    TimerType *timer_ = <span class="literal">nullptr</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> minThreadNumber_ = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> maxThreadNumber_ = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    std::thread dispatchThread_;</span><br><span class="line"></span><br><span class="line">    std::thread timerThread_;</span><br><span class="line"></span><br><span class="line">    std::mutex stopMtx_;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> stop_ = <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>è°ƒåº¦å™¨çš„ä½¿ç”¨</p>
<ul>
<li>ç³»ç»Ÿé»˜è®¤çš„è°ƒåº¦å™¨è°ƒåº¦å™¨<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> g_Scheduler ::co::Scheduler::getInstance()</span></span><br><span class="line"><span class="comment">// co_sched</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> co_sched g_Scheduler</span></span><br></pre></td></tr></table></figure></li>
<li>ç”¨æˆ·ä¹Ÿå¯ä»¥åˆ›å»ºè‡ªå·±çš„åç¨‹è°ƒåº¦å™¨<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">co::Scheduler* my_sched = co::Scheduler::<span class="built_in">Create</span>();</span><br></pre></td></tr></table></figure></li>
<li>å¯åŠ¨è°ƒåº¦<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">std::thread <span class="title">t</span><span class="params">([my_sched]&#123;mysched-&gt;Start();&#125;)</span></span>;</span><br><span class="line">t.<span class="built_in">detach</span>();</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>è°ƒåº¦å™¨åŸç†</p>
</li>
</ul>
<ol>
<li><p>schedule è´Ÿè´£æ•´ä¸ªç³»ç»Ÿçš„åç¨‹è°ƒåº¦ï¼Œåç¨‹çš„è¿è¡Œä¾èµ–äº<code>æ‰§è¡Œå™¨</code> Processerï¼ˆç®€ç§° Pï¼‰ï¼Œå› æ­¤åœ¨è°ƒåº¦å™¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šé€‰æ‹©åˆ›å»º P çš„æ•°é‡ï¼ˆæ”¯æŒåŠ¨æ€å¢é•¿ï¼‰ï¼Œæ‰€æœ‰çš„æ‰§è¡Œå™¨ä¼šæ·»åŠ åˆ°åŒç«¯é˜Ÿåˆ—ä¸­ã€‚ä¸»çº¿ç¨‹ä¹Ÿä½œä¸ºä¸€ä¸ª<code>æ‰§è¡Œå™¨</code>ï¼Œåœ¨åˆ›å»º Scheduler å¯¹è±¡çš„æ—¶å€™åˆ›å»ºï¼Œä½äºåŒç«¯é˜Ÿåˆ—ä¸‹æ ‡ä¸º 0 çš„ä½ç½®ï¼ˆæ³¨æ„ï¼šåªæ˜¯åˆ›å»ºå¯¹è±¡ï¼Œå¹¶æ²¡æœ‰å¼€å§‹è¿è¡Œï¼‰ï¼›</p>
</li>
<li><p>å½“è°ƒç”¨äº† Start() å‡½æ•°åï¼Œä¼šæ­£å¼å¼€å§‹è¿è¡Œã€‚åœ¨ Start å‡½æ•°å†…éƒ¨ï¼Œä¼šåˆ›å»ºæŒ‡å®šæ•°é‡çš„æ‰§è¡Œå™¨ Pï¼Œå…·ä½“æ•°é‡å–å†³äºå‚æ•°ï¼Œé»˜è®¤ä¼šåˆ›å»º minThreadNumber ä¸ªï¼Œå½“å…¨éƒ¨æ‰§è¡Œå™¨éƒ½é˜»å¡ä¹‹åï¼Œä¼šåŠ¨æ€æ‰©å±•ï¼Œæœ€å¤š maxThreadNumber ä¸ªæ‰§è¡Œå™¨ã€‚æ¯ä¸ªæ‰§è¡Œå™¨éƒ½ä¼šè¿è¡Œäºä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ï¼Œæ‰§è¡Œå™¨è´Ÿè´£è¯¥çº¿ç¨‹å†…éƒ¨åç¨‹çš„åˆ‡æ¢å’Œæ‰§è¡Œï¼›</p>
</li>
<li><p>å½“åˆ›å»ºåç¨‹æ—¶ï¼Œä¼šå°†åç¨‹æ·»åŠ åˆ°æŸä¸€ä¸ªå¤„äºæ´»è·ƒçŠ¶æ€çš„æ‰§è¡Œå™¨ï¼Œå¦‚æœæ°å¥½éƒ½ä¸æ´»è·ƒï¼Œä¹Ÿä¼šæ·»åŠ åˆ°æŸä¸€ä¸ª P ä¸­ï¼Œè¿™å¹¶ä¸å½±å“æ‰§è¡Œå™¨çš„æ­£å¸¸å·¥ä½œï¼Œå› ä¸ºè°ƒåº¦å™¨çš„è°ƒåº¦çº¿ç¨‹ä¼šå»å¤„ç†å®ƒï¼›</p>
</li>
<li><p>Start å‡½æ•°å†…éƒ¨ï¼Œé™¤äº†ä¸Šè¿°æ‰§è¡Œå™¨æ‰€åœ¨çº¿ç¨‹ï¼Œè¿˜ä¼šå¼€å¯è°ƒåº¦çº¿ç¨‹ <code>DispatcherThread</code>ï¼Œè°ƒåº¦çº¿ç¨‹ä¼šå¹³è¡¡å„ä¸ª P çš„åç¨‹æ•°é‡å’Œè´Ÿè½½ï¼Œè¿›è¡Œ stealï¼Œå¦‚æœæ‰€æœ‰ P éƒ½é˜»å¡ï¼Œä¼šæ ¹æ® maxThreadNumber åŠ¨æ€å¢åŠ  P çš„æ•°é‡ï¼Œå¦‚æœä»…ä»…éƒ¨åˆ† P é˜»å¡ï¼Œä¼šå°†é˜»å¡çš„ P ä¸­çš„åç¨‹å…¨éƒ¨æ‹¿å‡ºï¼ˆstealï¼‰ï¼Œå‡æ‘Šåˆ°è´Ÿè½½æœ€å°çš„ P ä¸­ï¼›</p>
 <figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åœ¨startå‡½æ•°ä¸­å¦èµ·ä¸€ä¸ªè°ƒåº¦çº¿ç¨‹ï¼Œè¿è¡ŒDispatcherThreadè°ƒåº¦å‡½æ•°</span></span><br><span class="line"><span class="comment">// è°ƒåº¦çº¿ç¨‹</span></span><br><span class="line">   <span class="keyword">if</span> (maxThreadNumber_ &gt; <span class="number">1</span>) &#123;</span><br><span class="line">       <span class="built_in">DebugPrint</span>(dbg_scheduler, <span class="string">&quot;---&gt; Create DispatcherThread&quot;</span>);</span><br><span class="line">       <span class="function">std::thread <span class="title">t</span><span class="params">([<span class="keyword">this</span>]&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">               DebugPrint(dbg_thread, <span class="string">&quot;Start dispatcher(sched=%p) thread id: %lu&quot;</span>, (<span class="keyword">void</span>*)<span class="keyword">this</span>, NativeThreadID());</span></span></span><br><span class="line"><span class="params"><span class="function">               <span class="keyword">this</span>-&gt;DispatcherThread();</span></span></span><br><span class="line"><span class="params"><span class="function">               &#125;)</span></span>;</span><br><span class="line">       dispatchThread_.<span class="built_in">swap</span>(t);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>Schedule ä¹Ÿä¼šé€‰æ‹©æ€§å¼€å¯åç¨‹çš„å®šæ—¶å™¨çº¿ç¨‹ï¼›</p>
</li>
<li><p>å¼€å¯ FastSteadyClock çº¿ç¨‹ã€‚</p>
</li>
</ol>
<h3 id="æ‰§è¡Œå™¨-Processor"><a href="#æ‰§è¡Œå™¨-Processor" class="headerlink" title="æ‰§è¡Œå™¨ Processor"></a>æ‰§è¡Œå™¨ <strong>Processor</strong></h3><ul>
<li><p>libgo/scheduler/processer.h</p>
</li>
<li><p>æºç </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åç¨‹æ‰§è¡Œå™¨</span></span><br><span class="line"><span class="comment">// å¯¹åº”ä¸€ä¸ªçº¿ç¨‹, è´Ÿè´£æœ¬çº¿ç¨‹çš„åç¨‹è°ƒåº¦, éçº¿ç¨‹å®‰å…¨.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Processer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">Scheduler</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">// æ”¹æ‰§è¡Œå™¨ä¾èµ–çš„è°ƒåº¦å™¨</span></span><br><span class="line">    Scheduler * scheduler_;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çº¿ç¨‹ID</span></span><br><span class="line">    <span class="keyword">int</span> id_;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¿€æ´»æ€</span></span><br><span class="line">    <span class="comment">// éæ¿€æ´»çš„Pä»…ä»…æ˜¯ä¸èƒ½æ¥å—æ–°çš„åç¨‹åŠ å…¥, ä»ç„¶å¯ä»¥å¼ºè¡ŒAddTaskå¹¶æ­£å¸¸å¤„ç†.</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">bool</span> active_ = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å‰æ­£åœ¨è¿è¡Œçš„åç¨‹</span></span><br><span class="line">    Task* runningTask_&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">    Task* nextTask_&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¯è½®è°ƒåº¦åªåŠ æœ‰é™æ¬¡æ•°æ–°åç¨‹, é˜²æ­¢æ–°åç¨‹åˆ›å»ºæ–°åç¨‹äº§ç”Ÿæ­»å¾ªç¯</span></span><br><span class="line">    <span class="keyword">int</span> addNewQuota_ = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å‰æ­£åœ¨è¿è¡Œçš„åç¨‹æœ¬æ¬¡è°ƒåº¦å¼€å§‹çš„æ—¶é—´æˆ³(Dispatchçº¿ç¨‹ä¸“ç”¨)</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int64_t</span> markTick_ = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">uint64_t</span> markSwitch_ = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åç¨‹è°ƒåº¦æ¬¡æ•°</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">uint64_t</span> switchCount_ = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åç¨‹é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">typedef</span> TSQueue&lt;Task, <span class="literal">true</span>&gt; TaskQueue;</span><br><span class="line">    TaskQueue runnableQueue_;</span><br><span class="line">    TaskQueue waitQueue_;</span><br><span class="line">    TSQueue&lt;Task, <span class="literal">false</span>&gt; gcQueue_;</span><br><span class="line"></span><br><span class="line">    TaskQueue newQueue_;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…çš„æ¡ä»¶å˜é‡</span></span><br><span class="line">    std::condition_variable_any cv_;</span><br><span class="line">    std::<span class="keyword">atomic_bool</span> waiting_&#123;<span class="literal">false</span>&#125;;</span><br><span class="line">    <span class="keyword">bool</span> notified_ = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> s_check_;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">ALWAYS_INLINE <span class="keyword">int</span> <span class="title">Id</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> id_; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Processer* &amp; <span class="title">GetCurrentProcesser</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Scheduler* <span class="title">GetCurrentScheduler</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">inline</span> Scheduler* <span class="title">GetScheduler</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> scheduler_; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„åç¨‹</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Task* <span class="title">GetCurrentTask</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦åœ¨åç¨‹ä¸­</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsCoroutine</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åç¨‹åˆ‡å‡º</span></span><br><span class="line">    <span class="function">ALWAYS_INLINE <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">StaticCoYield</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‚èµ·æ ‡è¯†ï¼Œç”¨äºåç»­æŒ‚èµ·å’Œè¶…æ—¶åˆ¤æ–­</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">SuspendEntry</span> &#123;</span></span><br><span class="line">        WeakPtr&lt;Task&gt; tk_;</span><br><span class="line">        <span class="keyword">uint64_t</span> id_;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">explicit</span> <span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> !!tk_; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">friend</span> <span class="keyword">bool</span> <span class="keyword">operator</span>==(SuspendEntry <span class="keyword">const</span>&amp; lhs, SuspendEntry <span class="keyword">const</span>&amp; rhs) &#123;</span><br><span class="line">            <span class="keyword">return</span> lhs.tk_ == rhs.tk_ &amp;&amp; lhs.id_ == rhs.id_;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">friend</span> <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(SuspendEntry <span class="keyword">const</span>&amp; lhs, SuspendEntry <span class="keyword">const</span>&amp; rhs) &#123;</span><br><span class="line">            <span class="keyword">if</span> (lhs.id_ == rhs.id_)</span><br><span class="line">                <span class="keyword">return</span> lhs.tk_ &lt; rhs.tk_;</span><br><span class="line">            <span class="keyword">return</span> lhs.id_ &lt; rhs.id_;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">IsExpire</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Processer::<span class="built_in">IsExpire</span>(*<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‚èµ·å½“å‰åç¨‹</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> SuspendEntry <span class="title">Suspend</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‚èµ·å½“å‰åç¨‹, å¹¶åœ¨æŒ‡å®šæ—¶é—´åè‡ªåŠ¨å”¤é†’</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> SuspendEntry <span class="title">Suspend</span><span class="params">(FastSteadyClock::duration dur)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> SuspendEntry <span class="title">Suspend</span><span class="params">(FastSteadyClock::time_point timepoint)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å”¤é†’åç¨‹</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">Wakeup</span><span class="params">(SuspendEntry <span class="keyword">const</span>&amp; entry, std::function&lt;<span class="keyword">void</span>()&gt; <span class="keyword">const</span>&amp; functor = <span class="literal">NULL</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æµ‹è¯•ä¸€ä¸ªSuspendEntryæ˜¯å¦è¿˜å¯èƒ½æœ‰æ•ˆ</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">IsExpire</span><span class="params">(SuspendEntry <span class="keyword">const</span>&amp; entry)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// --------------------------------------</span></span><br><span class="line">    <span class="comment">// for friend class Scheduler</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">Processer</span><span class="params">(Scheduler * scheduler, <span class="keyword">int</span> id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾…æ‰§è¡Œçš„åç¨‹æ•°é‡</span></span><br><span class="line">    <span class="comment">// æš‚å…¼ç”¨äºè´Ÿè½½æŒ‡æ•°</span></span><br><span class="line">    <span class="function">std::<span class="keyword">size_t</span> <span class="title">RunnableSize</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">ALWAYS_INLINE <span class="keyword">void</span> <span class="title">CoYield</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–°åˆ›å»ºã€é˜»å¡åè§¦å‘çš„åç¨‹addè¿›æ¥</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">AddTask</span><span class="params">(Task *tk)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒåº¦</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Process</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å·æ¥çš„åç¨‹addè¿›æ¥</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">AddTask</span><span class="params">(SList&lt;Task&gt; &amp;&amp; slist)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">NotifyCondition</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦å¤„äºç­‰å¾…çŠ¶æ€(æ— runnableåç¨‹)</span></span><br><span class="line">    <span class="comment">// è°ƒåº¦çº¿ç¨‹ä¼šå°½é‡åˆ†é…åç¨‹è¿‡æ¥</span></span><br><span class="line">    <span class="function">ALWAYS_INLINE <span class="keyword">bool</span> <span class="title">IsWaiting</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> waiting_; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å•ä¸ªåç¨‹æ‰§è¡Œæ—¶é•¿è¶…è¿‡é¢„è®¾å€¼, åˆ™åˆ¤å®šä¸ºé˜»å¡çŠ¶æ€</span></span><br><span class="line">    <span class="comment">// é˜»å¡çŠ¶æ€ä¸å†åŠ å…¥æ–°çš„åç¨‹, å¹¶ç”±è°ƒåº¦çº¿ç¨‹stealèµ°æ‰€æœ‰åç¨‹(æ­£åœ¨æ‰§è¡Œçš„é™¤å¤–)</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">IsBlocking</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å·åç¨‹</span></span><br><span class="line">    <span class="function">SList&lt;Task&gt; <span class="title">Steal</span><span class="params">(std::<span class="keyword">size_t</span> n)</span></span>;</span><br><span class="line">    <span class="comment">/// --------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">WaitCondition</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">GC</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">AddNewTasks</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒåº¦çº¿ç¨‹æ‰“æ ‡è®°, ç”¨äºæ£€æµ‹é˜»å¡</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Mark</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int64_t</span> <span class="title">NowMicrosecond</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">SuspendEntry <span class="title">SuspendBySelf</span><span class="params">(Task* tk)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">WakeupBySelf</span><span class="params">(IncursivePtr&lt;Task&gt; <span class="keyword">const</span>&amp; tkPtr, <span class="keyword">uint64_t</span> id, std::function&lt;<span class="keyword">void</span>()&gt; <span class="keyword">const</span>&amp; functor)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="æ‰§è¡Œå™¨å¯¹çº¿ç¨‹çš„è°ƒåº¦"><a href="#æ‰§è¡Œå™¨å¯¹çº¿ç¨‹çš„è°ƒåº¦" class="headerlink" title="æ‰§è¡Œå™¨å¯¹çº¿ç¨‹çš„è°ƒåº¦"></a>æ‰§è¡Œå™¨å¯¹çº¿ç¨‹çš„è°ƒåº¦</h4><p>ä½¿ç”¨å‡½æ•°process()</p>
<ul>
<li>æ‰§è¡Œå™¨ç»´æŠ¤äº†è®¸å¤šåç¨‹é˜Ÿåˆ—<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">   <span class="comment">// åç¨‹é˜Ÿåˆ—</span></span><br><span class="line">   <span class="keyword">typedef</span> TSQueue&lt;Task, <span class="literal">true</span>&gt; TaskQueue;</span><br><span class="line"><span class="comment">// å¯è¿è¡Œåç¨‹é˜Ÿåˆ—</span></span><br><span class="line">   TaskQueue runnableQueue_;</span><br><span class="line"><span class="comment">// å­˜æ”¾æŒ‚èµ·çš„åç¨‹</span></span><br><span class="line">   TaskQueue waitQueue_;</span><br><span class="line">   TSQueue&lt;Task, <span class="literal">false</span>&gt; gcQueue_;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯¥é˜Ÿåˆ—ä¸­å­˜æ”¾çš„æ˜¯æ–°åŠ å…¥çš„åç¨‹ï¼ŒåŒ…æ‹¬æ–°åˆ›å»ºçš„åç¨‹ï¼Œå”¤é†’æŒ‚èµ·çš„åç¨‹ï¼Œè¿˜æœ‰ steal æ¥çš„åç¨‹</span></span><br><span class="line">   TaskQueue newQueue_;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="process-å‡½æ•°å¤„ç†æµç¨‹"><a href="#process-å‡½æ•°å¤„ç†æµç¨‹" class="headerlink" title="process()å‡½æ•°å¤„ç†æµç¨‹"></a>process()å‡½æ•°å¤„ç†æµç¨‹</h4><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Processer::Process</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">GetCurrentProcesser</span>() = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(LIBGO_SYS_Windows)</span></span><br><span class="line">    FiberScopedGuard sg;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!scheduler_-&gt;<span class="built_in">IsStop</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        runnableQueue_.<span class="built_in">front</span>(runningTask_);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!runningTask_) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">AddNewTasks</span>())</span><br><span class="line">                runnableQueue_.<span class="built_in">front</span>(runningTask_);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!runningTask_) &#123;</span><br><span class="line">				<span class="comment">// æ²¡æœ‰å¯ä»¥è¿è¡Œçš„åç¨‹åˆ™wait</span></span><br><span class="line">                <span class="built_in">WaitCondition</span>();</span><br><span class="line">                <span class="built_in">AddNewTasks</span>();</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ENABLE_DEBUGGER</span></span><br><span class="line">        <span class="built_in">DebugPrint</span>(dbg_scheduler, <span class="string">&quot;Run [Proc(%d) QueueSize:%lu] --------------------------&quot;</span>, id_, <span class="built_in">RunnableSize</span>());</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        addNewQuota_ = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (runningTask_ &amp;&amp; !scheduler_-&gt;<span class="built_in">IsStop</span>()) &#123;</span><br><span class="line">            runningTask_-&gt;state_ = TaskState::runnable;</span><br><span class="line">            runningTask_-&gt;proc_ = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ENABLE_DEBUGGER</span></span><br><span class="line">            <span class="built_in">DebugPrint</span>(dbg_switch, <span class="string">&quot;enter task(%s)&quot;</span>, runningTask_-&gt;<span class="built_in">DebugInfo</span>());</span><br><span class="line">            <span class="keyword">if</span> (Listener::<span class="built_in">GetTaskListener</span>())</span><br><span class="line">                Listener::<span class="built_in">GetTaskListener</span>()-&gt;<span class="built_in">onSwapIn</span>(runningTask_-&gt;id_);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            ++switchCount_;</span><br><span class="line"></span><br><span class="line">            runningTask_-&gt;<span class="built_in">SwapIn</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ENABLE_DEBUGGER</span></span><br><span class="line">            <span class="built_in">DebugPrint</span>(dbg_switch, <span class="string">&quot;leave task(%s) state=%d&quot;</span>, runningTask_-&gt;<span class="built_in">DebugInfo</span>(), (<span class="keyword">int</span>)runningTask_-&gt;state_);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            <span class="built_in"><span class="keyword">switch</span></span> (runningTask_-&gt;state_) &#123;</span><br><span class="line">                <span class="keyword">case</span> TaskState::runnable:</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="function">std::unique_lock&lt;TaskQueue::<span class="keyword">lock_t</span>&gt; <span class="title">lock</span><span class="params">(runnableQueue_.LockRef())</span></span>;</span><br><span class="line">                        <span class="keyword">auto</span> next = (Task*)runningTask_-&gt;next;</span><br><span class="line">                        <span class="keyword">if</span> (next) &#123;</span><br><span class="line">                            runningTask_ = next;</span><br><span class="line">                            runningTask_-&gt;check_ = runnableQueue_.check_;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (addNewQuota_ &lt; <span class="number">1</span> || newQueue_.<span class="built_in">emptyUnsafe</span>()) &#123;</span><br><span class="line">                            runningTask_ = <span class="literal">nullptr</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            lock.<span class="built_in">unlock</span>();</span><br><span class="line">                            <span class="keyword">if</span> (<span class="built_in">AddNewTasks</span>()) &#123;</span><br><span class="line">                                runnableQueue_.<span class="built_in">next</span>(runningTask_, runningTask_);</span><br><span class="line">                                -- addNewQuota_;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                std::unique_lock&lt;TaskQueue::<span class="keyword">lock_t</span>&gt; <span class="built_in">lock2</span>(runnableQueue_.<span class="built_in">LockRef</span>());</span><br><span class="line">                                runningTask_ = <span class="literal">nullptr</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> TaskState::block:</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="function">std::unique_lock&lt;TaskQueue::<span class="keyword">lock_t</span>&gt; <span class="title">lock</span><span class="params">(runnableQueue_.LockRef())</span></span>;</span><br><span class="line">                        runningTask_ = nextTask_;</span><br><span class="line">                        nextTask_ = <span class="literal">nullptr</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> TaskState::done:</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    &#123;</span><br><span class="line">                        runnableQueue_.<span class="built_in">next</span>(runningTask_, nextTask_);</span><br><span class="line">                        <span class="keyword">if</span> (!nextTask_ &amp;&amp; addNewQuota_ &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (<span class="built_in">AddNewTasks</span>()) &#123;</span><br><span class="line">                                runnableQueue_.<span class="built_in">next</span>(runningTask_, nextTask_);</span><br><span class="line">                                -- addNewQuota_;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="built_in">DebugPrint</span>(dbg_task, <span class="string">&quot;task(%s) done.&quot;</span>, runningTask_-&gt;<span class="built_in">DebugInfo</span>());</span><br><span class="line">                        runnableQueue_.<span class="built_in">erase</span>(runningTask_);</span><br><span class="line">						<span class="comment">// æ‰§è¡Œå®Œå›æ”¶</span></span><br><span class="line">                        <span class="keyword">if</span> (gcQueue_.<span class="built_in">size</span>() &gt; <span class="number">16</span>)</span><br><span class="line">                            <span class="built_in">GC</span>();</span><br><span class="line">                        gcQueue_.<span class="built_in">push</span>(runningTask_);</span><br><span class="line">                        <span class="keyword">if</span> (runningTask_-&gt;eptr_) &#123;</span><br><span class="line">                            std::exception_ptr ep = runningTask_-&gt;eptr_;</span><br><span class="line">                            std::<span class="built_in">rethrow_exception</span>(ep);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="function">std::unique_lock&lt;TaskQueue::<span class="keyword">lock_t</span>&gt; <span class="title">lock</span><span class="params">(runnableQueue_.LockRef())</span></span>;</span><br><span class="line">                        runningTask_ = nextTask_;</span><br><span class="line">                        nextTask_ = <span class="literal">nullptr</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>åœ¨è°ƒåº¦å™¨ Schedule æ‰§è¡Œ Stop() å‡½æ•°ä¹‹å‰ï¼Œæ‰§è¡Œå™¨ P ä¼šä¸€ç›´å¤„äºè°ƒåº¦åç¨‹é˜¶æ®µ Process()ã€‚åœ¨æœŸé—´ï¼Œæ‰§è¡Œå™¨ P ä¼šå°†è¿è¡Œé˜Ÿåˆ— runnableQueue_ ä¸­çš„ç¬¬ä¸€ä¸ªåç¨‹è·å–è¿›è¡Œæ‰§è¡Œï¼Œå¦‚æœå¯è¿è¡Œé˜Ÿåˆ—ä¸ºç©ºï¼Œæ‰§è¡Œå™¨ä¼šå°è¯•å°†å¤„äº newQueue_ ä¸­çš„åç¨‹æ·»åŠ åˆ°å¯è¿è¡Œé˜Ÿåˆ—ä¸­å»ï¼Œå¦‚æœ newQueue_ ä¸ºç©ºï¼Œè¯´æ˜æ­¤æ—¶è¯¥æ‰§è¡Œå™¨å¤„äºæ— åç¨‹å¯è°ƒåº¦çŠ¶æ€ï¼Œé€šè¿‡è®¾ç½®æ¡ä»¶å˜é‡ï¼Œå°†æ‰§è¡Œå™¨è®¾ç½®ä¸ºç­‰å¾…çŠ¶æ€ï¼›</p>
</li>
<li><p>å½“è·å–åˆ°ä¸€ä¸ªå¯æ‰§è¡Œåç¨‹ä¹‹åï¼Œä¼šæ‰§è¡Œè¯¥åç¨‹çš„ä»»åŠ¡ã€‚åç¨‹çš„æ‰§è¡Œæµç¨‹æ˜¯é€šè¿‡çŠ¶æ€æœºæ¥å®ç°çš„ã€‚ï¼ˆåç¨‹æœ‰ä¸‰ä¸ªçŠ¶æ€ï¼šè¿è¡Œä¸­ï¼Œé˜»å¡ï¼Œæ‰§è¡Œå®Œæ¯•ï¼‰</p>
</li>
<li><p>å¯¹äºè¿è¡Œä¸­çš„åç¨‹ï¼Œæˆ‘ä»¬åªéœ€è¦ç¡®å®šä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„åç¨‹å¯¹è±¡å³å¯ï¼›</p>
</li>
<li><p>å¯¹äºé˜»å¡çš„åç¨‹ï¼Œåªæœ‰å½“åç¨‹æŒ‚èµ·æ—¶ï¼ˆè°ƒç”¨äº† Suspend æ–¹æ³•ï¼‰ï¼ŒçŠ¶æ€æ‰ä¼šåˆ‡æ¢åˆ°è¿™é‡Œï¼Œå› æ­¤ï¼Œè¿™æ—¶å€™åªéœ€è¦å»æ‰§è¡Œ nextTask å³å¯ï¼›</p>
</li>
<li><p>å¯¹äºè¿è¡Œå®Œæ¯•çš„åç¨‹ï¼Œåªæœ‰å½“ Task å¤„ç†å‡½æ•°æ‰§è¡Œå®Œæˆä¹‹åï¼ŒçŠ¶æ€æ‰ä¼šåˆ‡æ¢åˆ°è¿™é‡Œï¼Œå› æ­¤ï¼Œéœ€è¦è€ƒè™‘å¯¹è¯¥åç¨‹èµ„æºè¿›è¡Œå›æ”¶ï¼›</p>
</li>
</ol>
<h4 id="ä½¿ç”¨æ¡ä»¶å˜é‡å”¤é†’"><a href="#ä½¿ç”¨æ¡ä»¶å˜é‡å”¤é†’" class="headerlink" title="ä½¿ç”¨æ¡ä»¶å˜é‡å”¤é†’"></a>ä½¿ç”¨æ¡ä»¶å˜é‡å”¤é†’</h4><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Processer::WaitCondition</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">GC</span>();</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(cvMutex_)</span></span>;</span><br><span class="line">    waiting_ = <span class="literal">true</span>;</span><br><span class="line">    cv_.<span class="built_in">wait_for</span>(lock, std::chrono::<span class="built_in">milliseconds</span>(<span class="number">100</span>));</span><br><span class="line">    waiting_ = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Processer::NotifyCondition</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cv_.<span class="built_in">notify_all</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ps: è¿™é‡Œä½¿ç”¨çš„æ˜¯å¸¦è¶…æ—¶æ—¶é—´çš„è¿”å›ï¼ŒåŸå› åœ¨äºï¼Œåœ¨ç­‰å¾…æ–°åç¨‹çš„åŒæ—¶ï¼Œå¯ä»¥å®šæ—¶è·³å‡ºåšä¸€äº›æ£€æŸ¥ã€‚</p>
<h4 id="ä»è¯¥æ‰§è¡Œå™¨ä¸­å·å–æŒ‡å®šæ•°é‡çš„åç¨‹"><a href="#ä»è¯¥æ‰§è¡Œå™¨ä¸­å·å–æŒ‡å®šæ•°é‡çš„åç¨‹" class="headerlink" title="ä»è¯¥æ‰§è¡Œå™¨ä¸­å·å–æŒ‡å®šæ•°é‡çš„åç¨‹"></a>ä»è¯¥æ‰§è¡Œå™¨ä¸­å·å–æŒ‡å®šæ•°é‡çš„åç¨‹</h4><pre><code>-    steal()
</code></pre>
<p>ä»è¯¥æ‰§è¡Œå™¨çš„åŒç«¯é˜Ÿåˆ—é‡Œé¢è·å–æŒ‡å®šæ•°é‡çš„åç¨‹</p>
<ul>
<li><p>æºç </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">SList&lt;Task&gt; <span class="title">Processer::Steal</span><span class="params">(std::<span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// steal some</span></span><br><span class="line">        newQueue_.<span class="built_in">AssertLink</span>();</span><br><span class="line">        <span class="keyword">auto</span> slist = newQueue_.<span class="built_in">pop_back</span>(n);</span><br><span class="line">        newQueue_.<span class="built_in">AssertLink</span>();</span><br><span class="line">        <span class="keyword">if</span> (slist.<span class="built_in">size</span>() &gt;= n)</span><br><span class="line">            <span class="keyword">return</span> slist;</span><br><span class="line"></span><br><span class="line">        <span class="function">std::unique_lock&lt;TaskQueue::<span class="keyword">lock_t</span>&gt; <span class="title">lock</span><span class="params">(runnableQueue_.LockRef())</span></span>;</span><br><span class="line">        <span class="keyword">bool</span> pushRunningTask = <span class="literal">false</span>, pushNextTask = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (runningTask_)</span><br><span class="line">            pushRunningTask = runnableQueue_.<span class="built_in">eraseWithoutLock</span>(runningTask_, <span class="literal">true</span>) || slist.<span class="built_in">erase</span>(runningTask_, newQueue_.check_);</span><br><span class="line">        <span class="keyword">if</span> (nextTask_)</span><br><span class="line">            pushNextTask = runnableQueue_.<span class="built_in">eraseWithoutLock</span>(nextTask_, <span class="literal">true</span>) || slist.<span class="built_in">erase</span>(nextTask_, newQueue_.check_);</span><br><span class="line">        <span class="keyword">auto</span> slist2 = runnableQueue_.<span class="built_in">pop_backWithoutLock</span>(n - slist.<span class="built_in">size</span>());</span><br><span class="line">        <span class="keyword">if</span> (pushRunningTask)</span><br><span class="line">            runnableQueue_.<span class="built_in">pushWithoutLock</span>(runningTask_);</span><br><span class="line">        <span class="keyword">if</span> (pushNextTask)</span><br><span class="line">            runnableQueue_.<span class="built_in">pushWithoutLock</span>(nextTask_);</span><br><span class="line">        lock.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">        slist2.<span class="built_in">append</span>(std::<span class="built_in">move</span>(slist));</span><br><span class="line">        <span class="keyword">if</span> (!slist2.<span class="built_in">empty</span>())</span><br><span class="line">            <span class="built_in">DebugPrint</span>(dbg_scheduler, <span class="string">&quot;Proc(%d).Stealed = %d&quot;</span>, id_, (<span class="keyword">int</span>)slist2.<span class="built_in">size</span>());</span><br><span class="line">        <span class="keyword">return</span> slist2;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// steal all</span></span><br><span class="line">        newQueue_.<span class="built_in">AssertLink</span>();</span><br><span class="line">        <span class="keyword">auto</span> slist = newQueue_.<span class="built_in">pop_all</span>();</span><br><span class="line">        newQueue_.<span class="built_in">AssertLink</span>();</span><br><span class="line"></span><br><span class="line">        <span class="function">std::unique_lock&lt;TaskQueue::<span class="keyword">lock_t</span>&gt; <span class="title">lock</span><span class="params">(runnableQueue_.LockRef())</span></span>;</span><br><span class="line">        <span class="keyword">bool</span> pushRunningTask = <span class="literal">false</span>, pushNextTask = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (runningTask_)</span><br><span class="line">            pushRunningTask = runnableQueue_.<span class="built_in">eraseWithoutLock</span>(runningTask_, <span class="literal">true</span>) || slist.<span class="built_in">erase</span>(runningTask_, newQueue_.check_);</span><br><span class="line">        <span class="keyword">if</span> (nextTask_)</span><br><span class="line">            pushNextTask = runnableQueue_.<span class="built_in">eraseWithoutLock</span>(nextTask_, <span class="literal">true</span>) || slist.<span class="built_in">erase</span>(nextTask_, newQueue_.check_);</span><br><span class="line">        <span class="keyword">auto</span> slist2 = runnableQueue_.<span class="built_in">pop_allWithoutLock</span>();</span><br><span class="line">        <span class="keyword">if</span> (pushRunningTask)</span><br><span class="line">            runnableQueue_.<span class="built_in">pushWithoutLock</span>(runningTask_);</span><br><span class="line">        <span class="keyword">if</span> (pushNextTask)</span><br><span class="line">            runnableQueue_.<span class="built_in">pushWithoutLock</span>(nextTask_);</span><br><span class="line">        lock.<span class="built_in">unlock</span>();</span><br><span class="line"></span><br><span class="line">        slist2.<span class="built_in">append</span>(std::<span class="built_in">move</span>(slist));</span><br><span class="line">        <span class="keyword">if</span> (!slist2.<span class="built_in">empty</span>())</span><br><span class="line">            <span class="built_in">DebugPrint</span>(dbg_scheduler, <span class="string">&quot;Proc(%d).Stealed all = %d&quot;</span>, id_, (<span class="keyword">int</span>)slist2.<span class="built_in">size</span>());</span><br><span class="line">        <span class="keyword">return</span> slist2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>çªƒå–çš„æµç¨‹</p>
</li>
</ul>
<ol>
<li><p>é¦–å…ˆï¼Œä¼šä» newQueue_ é˜Ÿåˆ—ä¸­è·å–åç¨‹ç»“ç‚¹ï¼Œå› ä¸º newQueue_ ä¸­çš„ç»“ç‚¹è¿˜æ²¡æœ‰æ·»åŠ åˆ°è¿è¡Œé˜Ÿåˆ—ä¸­ï¼Œå› æ­¤å¯ä»¥ç›´æ¥å–å‡ºï¼›å¦‚æœ newQueue_ ä¸­åç¨‹æ•°é‡ä¸è¶³ï¼Œä¼šä» runnableQueue_ é˜Ÿåˆ—å°¾éƒ¨ä¸­ç»§ç»­è·å–ç»“ç‚¹ã€‚ç”±äº runnableQueue_ é˜Ÿåˆ—ä¸­æˆ‘ä»¬è®°å½•äº†æ­£åœ¨æ‰§è¡Œçš„åç¨‹å’Œä¸‹ä¸€æ¬¡å°†æ‰§è¡Œçš„åç¨‹ï¼ˆrunningTask_ &amp; nextTask_ï¼‰ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ã€‚åœ¨ä» runnableQueue_ å·åç¨‹ä¹‹å‰ï¼Œä¼šå°† runningTask_ &amp; nextTask_ ä»é˜Ÿåˆ—åˆ é™¤ï¼Œå¾…å·å®Œç»“ç‚¹ä¹‹åå†æ¬¡æ·»åŠ åˆ°å½“å‰ runnableQueue_ é˜Ÿåˆ—ä¸­ã€‚</p>
</li>
<li><p>ç®€å•è¯´ï¼Œå·åç¨‹çš„å·¥ä½œï¼Œä¸ä¼šä»é˜Ÿåˆ—ä¸­è·å–åˆ° runningTask_ &amp; nextTask_ æ ‡è¯†çš„åç¨‹ã€‚</p>
</li>
</ol>
<h4 id="é˜»å¡åˆ¤æ–­"><a href="#é˜»å¡åˆ¤æ–­" class="headerlink" title="é˜»å¡åˆ¤æ–­"></a>é˜»å¡åˆ¤æ–­</h4><ul>
<li>æºç <figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Processer::IsBlocking</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!markSwitch_ || markSwitch_ != switchCount_) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">NowMicrosecond</span>() &gt; markTick_ + CoroutineOptions::<span class="built_in">getInstance</span>().cycle_timeout_us;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Processer::Mark</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (runningTask_ &amp;&amp; markSwitch_ != switchCount_) &#123;</span><br><span class="line">        markSwitch_ = switchCount_;</span><br><span class="line">        markTick_ = <span class="built_in">NowMicrosecond</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å•åç¨‹æ‰§è¡Œè¶…æ—¶æ—¶é•¿(å•ä½ï¼šå¾®ç§’) (è¶…è¿‡æ—¶é•¿ä¼šå¼ºåˆ¶stealå‰©ä½™ä»»åŠ¡, æ´¾å‘åˆ°å…¶ä»–çº¿ç¨‹)</span></span><br><span class="line"><span class="keyword">uint32_t</span> cycle_timeout_us = <span class="number">100</span> * <span class="number">1000</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<ol>
<li><p>Mark å‡½æ•°ä¼šåœ¨è°ƒåº¦å™¨çš„è°ƒåº¦å‡½æ•°ä¸­è¢«è°ƒç”¨ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåªæœ‰æ‰§è¡Œå™¨å¤„äºæ´»è·ƒçŠ¶æ€æ—¶æ‰ä¼šè°ƒç”¨ã€‚Mark é¡¾åæ€ä¹‰ï¼Œæ˜¯ç»™è¯¥æ‰§è¡Œæ‰“æ ‡è®°ï¼Œä¼šè®°å½•markçš„æ—¶é—´æˆ³ï¼Œå¹¶è®°å½•ä¸‹æ˜¯åœ¨ç¬¬å¤šå°‘æ¬¡åç¨‹è°ƒåº¦çš„è¿‡ç¨‹ä¸­åšäº†æ ‡è®°ï¼ŒMark çš„ä½œç”¨æ˜¯ç”¨æ¥è¿›è¡Œæ‰§è¡Œå™¨çš„é˜»å¡æ£€æµ‹ã€‚</p>
</li>
<li><p>å¤„äºæ´»è·ƒçŠ¶æ€çš„æ‰§è¡Œå™¨ï¼Œæ€»æ˜¯åœ¨æ‰§è¡Œç€åç¨‹çš„åˆ‡æ¢ï¼Œå› æ­¤ï¼Œä¼šä¸æ–­è‡ªå¢ switchCount_ çš„å€¼ï¼Œæ ¹æ® IsBlocking å‡½æ•°å¾—çŸ¥ï¼Œå½“æˆ‘ä»¬æ­¤æ—¶æ ‡ç­¾è®°å½•çš„åç¨‹è°ƒåº¦æ¬¡æ•°è¶…è¿‡100msæ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼Œæˆ‘ä»¬è®¤ä¸ºè¯¥æ‰§è¡Œå™¨å‘ç”Ÿé˜»å¡ï¼ŒScheduler ä¼šè¿›è¡Œ Steal æ“ä½œã€‚</p>
</li>
</ol>
<h4 id="åç¨‹æŒ‚èµ·-suspend"><a href="#åç¨‹æŒ‚èµ·-suspend" class="headerlink" title="åç¨‹æŒ‚èµ· suspend"></a>åç¨‹æŒ‚èµ· suspend</h4><ul>
<li>æºç <figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æŒ‚èµ·å½“å‰åç¨‹</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> SuspendEntry <span class="title">Suspend</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŒ‚èµ·å½“å‰åç¨‹, å¹¶åœ¨æŒ‡å®šæ—¶é—´åè‡ªåŠ¨å”¤é†’</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> SuspendEntry <span class="title">Suspend</span><span class="params">(FastSteadyClock::duration dur)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> SuspendEntry <span class="title">Suspend</span><span class="params">(FastSteadyClock::time_point timepoint)</span></span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<ol>
<li><p>ä¸€ç§æ–¹å¼æ˜¯ç›´æ¥æŒ‚èµ·ï¼Œä¼šå°†è¯¥åç¨‹çŠ¶æ€è½¬æ¢ä¸º TaskState::blockï¼Œç„¶åå°†è¯¥åç¨‹ä» runnableQueue_ ä¸­åˆ é™¤ï¼Œå†æ·»åŠ åˆ° waitQueue_ ä¸­ï¼›</p>
</li>
<li><p>å¦å¤–ä¸€ç§æ–¹å¼æ˜¯æŒ‚èµ·ä¹‹åï¼ˆç¬¬ä¸€ç§æ–¹å¼æ‰§è¡Œå®Œæ¯•ä¹‹åï¼‰ï¼Œå…è®¸é…ç½®ä¸€ä¸ªæ—¶é—´æ®µä¹‹åå»è‡ªåŠ¨å”¤é†’è¯¥åç¨‹ã€‚</p>
</li>
</ol>
<h4 id="åç¨‹çš„å”¤èµ·"><a href="#åç¨‹çš„å”¤èµ·" class="headerlink" title="åç¨‹çš„å”¤èµ·"></a>åç¨‹çš„å”¤èµ·</h4><ul>
<li>wakeup<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å”¤é†’åç¨‹</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">Wakeup</span><span class="params">(SuspendEntry <span class="keyword">const</span>&amp; entry, std::function&lt;<span class="keyword">void</span>()&gt; <span class="keyword">const</span>&amp; functor = <span class="literal">NULL</span>)</span></span>;</span><br></pre></td></tr></table></figure>
ç”¨äºå”¤é†’åç¨‹<br>å”¤é†’åç¨‹è¦åšçš„ï¼Œå°±æ˜¯è®²å¾…å”¤é†’çš„åç¨‹ä» waitQueue_ ä¸­åˆ é™¤å¹¶é‡æ–°æ·»åŠ åˆ° newQueue_ä¸­å»ã€‚</li>
</ul>
<h4 id="åç¨‹çš„åˆ‡å‡º"><a href="#åç¨‹çš„åˆ‡å‡º" class="headerlink" title="åç¨‹çš„åˆ‡å‡º"></a>åç¨‹çš„åˆ‡å‡º</h4><ul>
<li>æºç <figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åç¨‹åˆ‡å‡º</span></span><br><span class="line"><span class="function">ALWAYS_INLINE <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">StaticCoYield</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ALWAYS_INLINE <span class="keyword">void</span> <span class="title">Processer::StaticCoYield</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> proc = <span class="built_in">GetCurrentProcesser</span>();</span><br><span class="line">    <span class="keyword">if</span> (proc) proc-&gt;<span class="built_in">CoYield</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ALWAYS_INLINE <span class="keyword">void</span> <span class="title">Processer::CoYield</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Task *tk = <span class="built_in">GetCurrentTask</span>();</span><br><span class="line">    <span class="built_in">assert</span>(tk);</span><br><span class="line"></span><br><span class="line">    ++ tk-&gt;yieldCount_;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ENABLE_DEBUGGER</span></span><br><span class="line">    <span class="built_in">DebugPrint</span>(dbg_yield, <span class="string">&quot;yield task(%s) state = %s&quot;</span>, tk-&gt;<span class="built_in">DebugInfo</span>(), <span class="built_in">GetTaskStateName</span>(tk-&gt;state_));</span><br><span class="line">    <span class="keyword">if</span> (Listener::<span class="built_in">GetTaskListener</span>())</span><br><span class="line">        Listener::<span class="built_in">GetTaskListener</span>()-&gt;<span class="built_in">onSwapOut</span>(tk-&gt;id_);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    tk-&gt;<span class="built_in">SwapOut</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
ç”¨äºåœ¨ä¸€ä¸ªæ‰§è¡Œå™¨ä¸­åˆ‡å‡ºå½“å‰åç¨‹<br>æœ‰ä¸¤ç§å¯èƒ½:</li>
</ul>
<ol>
<li>ä¸€ç§æ˜¯åç¨‹è¢«é˜»å¡éœ€è¦æŒ‚èµ·ï¼›</li>
<li>å¦å¤–ä¸€ç§æ˜¯åç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œä¸»åŠ¨åˆ‡å‡ºã€‚å…·ä½“å®ç°æ˜¯é€šè¿‡è·å–å½“å‰æ‰§è¡Œå™¨æ­£åœ¨æ‰§è¡Œçš„åç¨‹ Taskï¼Œè°ƒç”¨ SwapOut() æ–¹æ³•å®ç°ã€‚</li>
</ol>
<ul>
<li>ä»€ä¹ˆæ—¶å€™ä¼šåˆ‡å‡ºï¼š<ul>
<li>åç¨‹è¢«æŒ‚èµ·</li>
<li>åç¨‹æ‰§è¡Œå®Œæ¯•</li>
<li>ç”¨æˆ·ä¸»åŠ¨ä½¿ç”¨co_yieldåˆ‡å‡º<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> co_yield do &#123; ::co::Processer::StaticCoYield(); &#125; while (0)</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="åç¨‹-TASK"><a href="#åç¨‹-TASK" class="headerlink" title="åç¨‹ TASK"></a>åç¨‹ <strong>TASK</strong></h3><ul>
<li>libgo/task/task.h</li>
<li>æºç <figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åç¨‹çŠ¶æ€</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">TaskState</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    runnable, <span class="comment">// å¯è¿è¡Œ</span></span><br><span class="line">    block, <span class="comment">// é˜»å¡</span></span><br><span class="line">    done, <span class="comment">// å®Œæˆ</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åç¨‹ç»“æ„ä½“</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Task</span></span></span><br><span class="line"><span class="class">    :</span> <span class="keyword">public</span> TSQueueHook, <span class="keyword">public</span> SharedRefObject, <span class="keyword">public</span> CoDebugger::DebuggerBase&lt;Task&gt;</span><br><span class="line">&#123;</span><br><span class="line">    TaskState state_ = TaskState::runnable;</span><br><span class="line">    <span class="keyword">uint64_t</span> id_;</span><br><span class="line">    Processer* proc_ = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="comment">// ä¸Šä¸‹æ–‡</span></span><br><span class="line">    Context ctx_;</span><br><span class="line">    TaskF fn_;</span><br><span class="line">    std::exception_ptr eptr_;           <span class="comment">// ä¿å­˜exceptionçš„æŒ‡é’ˆ</span></span><br><span class="line">    TaskAnys anys_;</span><br><span class="line">    <span class="keyword">void</span>* extern_switcher_ &#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> yieldCount_ = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">atomic_t</span>&lt;<span class="keyword">uint64_t</span>&gt; suspendId_ &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Task</span>(TaskF <span class="keyword">const</span>&amp; fn, std::<span class="keyword">size_t</span> stack_size);</span><br><span class="line">    ~<span class="built_in">Task</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function">ALWAYS_INLINE <span class="keyword">void</span> <span class="title">SwapIn</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ctx_.<span class="built_in">SwapIn</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ALWAYS_INLINE void SwapTo(Task* other)</span></span><br><span class="line">    <span class="comment">//&#123;</span></span><br><span class="line">    <span class="comment">//    ctx_.SwapTo(other-&gt;ctx_);</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">    <span class="function">ALWAYS_INLINE <span class="keyword">void</span> <span class="title">SwapOut</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ctx_.<span class="built_in">SwapOut</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">DebugInfo</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Run</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> FCONTEXT_CALL <span class="title">StaticRun</span><span class="params">(<span class="keyword">intptr_t</span> vp)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Task</span>(Task <span class="keyword">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="built_in">Task</span>(Task &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    Task&amp; <span class="keyword">operator</span>=(Task <span class="keyword">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    Task&amp; <span class="keyword">operator</span>=(Task &amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
æ¯ä¸ª Task å¯¹è±¡æ˜¯ä¸€ä¸ªåç¨‹ï¼Œåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªåç¨‹å®é™…å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ª Task å¯¹è±¡ï¼Œå†æ·»åŠ åˆ°å¯¹åº”çš„æ‰§è¡Œå™¨ P ä¸­ã€‚ä¹‹å‰æåˆ°è¿‡ï¼Œæ‰§è¡Œå™¨è¿›è¡Œåç¨‹è°ƒåº¦æ˜¯é€šè¿‡ä¸€ä¸ªçŠ¶æ€æœºæ¥å®ç°çš„ï¼Œè¿™é‡Œçš„ TaskState å°±æ˜¯åç¨‹çŠ¶æ€ï¼Œåç¨‹å‡½æ•° fn_ ä¼šåœ¨ StaticRun é™æ€æ–¹æ³•ä¸­è°ƒç”¨ï¼Œè¯¥é™æ€æ–¹æ³•æ³¨å†Œåˆ°äº†åç¨‹ä¸Šä¸‹æ–‡ _ctx ä¸­ã€‚</li>
</ul>
<p>é™¤æ­¤ä¹‹å¤–ï¼ŒTask ç±»å†…éƒ¨ï¼Œä¹Ÿæä¾›äº†åç¨‹çš„åˆ‡å…¥åˆ‡å‡ºæ–¹æ³•ï¼Œæœ¬è´¨ä¹Ÿæ˜¯è°ƒç”¨äº†ä¸Šä¸‹æ–‡çš„åˆ‡æ¢ã€‚</p>
<h4 id="åç¨‹çš„è¿è¡Œ"><a href="#åç¨‹çš„è¿è¡Œ" class="headerlink" title="åç¨‹çš„è¿è¡Œ"></a>åç¨‹çš„è¿è¡Œ</h4><ul>
<li>StaticRun<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é€šè¿‡staticrunè°ƒç”¨run</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> FCONTEXT_CALL <span class="title">Task::StaticRun</span><span class="params">(<span class="keyword">intptr_t</span> vp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Task* tk = (Task*)vp;</span><br><span class="line">    tk-&gt;<span class="built_in">Run</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Task::Run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> call_fn = [<span class="keyword">this</span>]() &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ENABLE_DEBUGGER</span></span><br><span class="line">        <span class="keyword">if</span> (Listener::<span class="built_in">GetTaskListener</span>()) &#123;</span><br><span class="line">            Listener::<span class="built_in">GetTaskListener</span>()-&gt;<span class="built_in">onStart</span>(<span class="keyword">this</span>-&gt;id_);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">fn_</span>();</span><br><span class="line">        <span class="keyword">this</span>-&gt;fn_ = <span class="built_in">TaskF</span>(); <span class="comment">//è®©åç¨‹functionå¯¹è±¡çš„ææ„ä¹Ÿåœ¨åç¨‹ä¸­æ‰§è¡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ENABLE_DEBUGGER</span></span><br><span class="line">        <span class="keyword">if</span> (Listener::<span class="built_in">GetTaskListener</span>()) &#123;</span><br><span class="line">            Listener::<span class="built_in">GetTaskListener</span>()-&gt;<span class="built_in">onCompleted</span>(<span class="keyword">this</span>-&gt;id_);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (CoroutineOptions::<span class="built_in">getInstance</span>().exception_handle == eCoExHandle::immedaitely_throw) &#123;</span><br><span class="line">        <span class="built_in">call_fn</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">call_fn</span>();</span><br><span class="line">        &#125; <span class="built_in"><span class="keyword">catch</span></span> (...) &#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;fn_ = <span class="built_in">TaskF</span>();</span><br><span class="line"></span><br><span class="line">            std::exception_ptr eptr = std::<span class="built_in">current_exception</span>();</span><br><span class="line">            <span class="built_in">DebugPrint</span>(dbg_exception, <span class="string">&quot;task(%s) catched exception.&quot;</span>, <span class="built_in">DebugInfo</span>());</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ENABLE_DEBUGGER</span></span><br><span class="line">            <span class="keyword">if</span> (Listener::<span class="built_in">GetTaskListener</span>()) &#123;</span><br><span class="line">                Listener::<span class="built_in">GetTaskListener</span>()-&gt;<span class="built_in">onException</span>(<span class="keyword">this</span>-&gt;id_, eptr);</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ENABLE_DEBUGGER</span></span><br><span class="line">    <span class="keyword">if</span> (Listener::<span class="built_in">GetTaskListener</span>()) &#123;</span><br><span class="line">        Listener::<span class="built_in">GetTaskListener</span>()-&gt;<span class="built_in">onFinished</span>(<span class="keyword">this</span>-&gt;id_);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">// å®Œæˆåˆ™çŠ¶æ€æ”¹å˜åŠ åˆ‡å‡º</span></span><br><span class="line">    state_ = TaskState::done;</span><br><span class="line">    Processer::<span class="built_in">StaticCoYield</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="hookç³»ç»Ÿè°ƒç”¨åŸç†"><a href="#hookç³»ç»Ÿè°ƒç”¨åŸç†" class="headerlink" title="hookç³»ç»Ÿè°ƒç”¨åŸç†"></a>hookç³»ç»Ÿè°ƒç”¨åŸç†</h2><ul>
<li><p>libgo/netio/unix/hook.cpp</p>
</li>
<li><p>æºç </p>
<ul>
<li>ä»¥å‡ ä¸ªhookçš„ç³»ç»Ÿå‡½æ•°ä¸ºä¾‹</li>
</ul>
</li>
<li><p>sleep</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// sleepå‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">sleep</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> seconds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sleep_f) <span class="built_in">initHook</span>();</span><br><span class="line"></span><br><span class="line">    Task* tk = Processer::<span class="built_in">GetCurrentTask</span>();</span><br><span class="line">    <span class="built_in">DebugPrint</span>(dbg_hook, <span class="string">&quot;task(%s) hook sleep(seconds=%u). %s coroutine.&quot;</span>,</span><br><span class="line">            tk-&gt;<span class="built_in">DebugInfo</span>(), seconds,</span><br><span class="line">            Processer::<span class="built_in">IsCoroutine</span>() ? <span class="string">&quot;In&quot;</span> : <span class="string">&quot;Not in&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!tk)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sleep_f</span>(seconds);</span><br><span class="line"></span><br><span class="line">    Processer::<span class="built_in">Suspend</span>(std::chrono::<span class="built_in">seconds</span>(seconds));</span><br><span class="line">    Processer::<span class="built_in">StaticCoYield</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ¬è´¨ä¸Šæ˜¯æ¥ç®¡åŸå…ˆçš„ç³»ç»Ÿå‡½æ•°ï¼Œä½¿ç”¨libgoçš„å‡½æ•°ã€‚sleepè¿™é‡Œç›´æ¥æ‰äº†æ‰§è¡Œå™¨æŒ‚èµ·æŒ‡å®šæ—¶é—´</p>
</li>
<li><p>read</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// read</span></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!read_f) <span class="built_in">initHook</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">read_write_mode</span>(fd, read_f, <span class="string">&quot;read&quot;</span>, POLLIN, SO_RCVTIMEO, count, buf, count);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> OriginF, <span class="keyword">typename</span> ... Args&gt;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">read_write_mode</span><span class="params">(<span class="keyword">int</span> fd, OriginF fn, <span class="keyword">const</span> <span class="keyword">char</span>* hook_fn_name,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">short</span> <span class="keyword">int</span> event, <span class="keyword">int</span> timeout_so, <span class="keyword">ssize_t</span> buflen, Args &amp;&amp; ... args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Task* tk = Processer::<span class="built_in">GetCurrentTask</span>();</span><br><span class="line">    <span class="built_in">DebugPrint</span>(dbg_hook, <span class="string">&quot;task(%s) hook %s(fd=%d, buflen=%d). %s coroutine.&quot;</span>,</span><br><span class="line">            tk-&gt;<span class="built_in">DebugInfo</span>(), hook_fn_name, fd, (<span class="keyword">int</span>)buflen,</span><br><span class="line">            Processer::<span class="built_in">IsCoroutine</span>() ? <span class="string">&quot;In&quot;</span> : <span class="string">&quot;Not in&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!tk)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">fn</span>(fd, std::forward&lt;Args&gt;(args)...);</span><br><span class="line"></span><br><span class="line">    FdContextPtr ctx = HookHelper::<span class="built_in">getInstance</span>().<span class="built_in">GetFdContext</span>(fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ctx || ctx-&gt;<span class="built_in">IsNonBlocking</span>())</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">fn</span>(fd, std::forward&lt;Args&gt;(args)...);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> socketTimeout = ctx-&gt;<span class="built_in">GetSocketTimeoutMicroSeconds</span>(timeout_so);</span><br><span class="line">    <span class="keyword">int</span> pollTimeout = (socketTimeout == <span class="number">0</span>) ? <span class="number">-1</span> : (socketTimeout &lt; <span class="number">1000</span> ? <span class="number">1</span> : socketTimeout / <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">fds</span>;</span></span><br><span class="line">    fds.fd = fd;</span><br><span class="line">    fds.events = event;</span><br><span class="line">    fds.revents = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">eintr:</span><br><span class="line">    <span class="keyword">int</span> triggers = <span class="built_in">libgo_poll</span>(&amp;fds, <span class="number">1</span>, pollTimeout, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == triggers) &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == EINTR) <span class="keyword">goto</span> eintr;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span> == triggers) &#123;  <span class="comment">// pollç­‰å¾…è¶…æ—¶</span></span><br><span class="line">        errno = EAGAIN;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">retry_intr_fn:</span><br><span class="line">    <span class="keyword">ssize_t</span> res = <span class="built_in">fn</span>(fd, std::forward&lt;Args&gt;(args)...);</span><br><span class="line">    <span class="keyword">if</span> (res == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">            <span class="keyword">goto</span> retry_intr_fn;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>readå˜æˆäº†ä¸€ä¸ªåŠ å…¥libgo_pollçš„äº‹ä»¶ï¼Œç­‰å¾…è§¦å‘ï¼Œä»è€Œè¢«hookæ‰</p>
</li>
</ul>
]]></content>
      <categories>
        <category>æ¡†æ¶å­¦ä¹ </category>
        <category>libgo</category>
      </categories>
      <tags>
        <tag>åç¨‹</tag>
        <tag>c++</tag>
      </tags>
  </entry>
  <entry>
    <title>makefileè¯­æ³•</title>
    <url>/2022/04/07/makefile%E8%AF%AD%E6%B3%95/</url>
    <content><![CDATA[<p>ä¸€èˆ¬æ¥è¯´ï¼Œæ— è®ºæ˜¯Cè¿˜æ˜¯C++ï¼Œé¦–å…ˆè¦æŠŠæºæ–‡ä»¶ç¼–è¯‘æˆä¸­é—´ä»£ç æ–‡ä»¶ï¼Œåœ¨Windowsä¸‹ä¹Ÿå°±æ˜¯ .obj æ–‡ä»¶ï¼ŒUNIXä¸‹æ˜¯ .o æ–‡ä»¶ï¼Œå³Object Fileï¼Œè¿™ä¸ªåŠ¨ä½œå«åšç¼–è¯‘ï¼ˆcompileï¼‰ã€‚ç„¶åå†æŠŠå¤§é‡çš„Object Fileåˆæˆæ‰§è¡Œæ–‡ä»¶ï¼Œè¿™ä¸ªåŠ¨ä½œå«ä½œé“¾æ¥ï¼ˆlinkï¼‰ã€‚</p>
<p>åœ¨å¤§å¤šæ•°æ—¶å€™ï¼Œç”±äºæºæ–‡ä»¶å¤ªå¤šï¼Œç¼–è¯‘ç”Ÿæˆçš„ä¸­é—´ç›®æ ‡æ–‡ä»¶å¤ªå¤šï¼Œè€Œåœ¨é“¾æ¥æ—¶éœ€è¦æ˜æ˜¾åœ°æŒ‡å‡ºä¸­é—´ç›®æ ‡æ–‡ä»¶åï¼Œè¿™å¯¹äºç¼–è¯‘å¾ˆä¸æ–¹ä¾¿ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦ç»™ä¸­é—´ç›®æ ‡æ–‡ä»¶æ‰“ä¸ªåŒ…ï¼Œåœ¨Windowsä¸‹è¿™ç§åŒ…å«â€œåº“æ–‡ä»¶â€ï¼ˆLibrary Fileï¼‰ï¼Œä¹Ÿå°±æ˜¯ .lib æ–‡ä»¶ï¼Œåœ¨UNIXä¸‹ï¼Œæ˜¯Archive Fileï¼Œä¹Ÿå°±æ˜¯ .a æ–‡ä»¶ã€‚</p>
<p>makefileå¸¦æ¥çš„å¥½å¤„å°±æ˜¯â€”â€”â€œè‡ªåŠ¨åŒ–ç¼–è¯‘â€ï¼Œä¸€æ—¦å†™å¥½ï¼Œåªéœ€è¦ä¸€ä¸ªmakeå‘½ä»¤ï¼Œæ•´ä¸ªå·¥ç¨‹å®Œå…¨è‡ªåŠ¨ç¼–è¯‘ï¼Œæå¤§çš„æé«˜äº†è½¯ä»¶å¼€å‘çš„æ•ˆç‡ã€‚ </p>
<span id="more"></span>

<!-- toc -->
<p><a href="https://seisman.github.io/how-to-write-makefile/">å‚è€ƒæ–‡ç« </a></p>
<h2 id="makefileçš„è§„åˆ™"><a href="#makefileçš„è§„åˆ™" class="headerlink" title="makefileçš„è§„åˆ™"></a>makefileçš„è§„åˆ™</h2><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">target ... : prerequisites ...</span><br><span class="line">    command</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>target</strong><br>  å¯ä»¥æ˜¯ä¸€ä¸ªobject fileï¼ˆç›®æ ‡æ–‡ä»¶ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ‰§è¡Œæ–‡ä»¶ï¼Œè¿˜å¯ä»¥æ˜¯ä¸€ä¸ªæ ‡ç­¾ï¼ˆlabelï¼‰ã€‚å¯¹äºæ ‡ç­¾è¿™ç§ç‰¹æ€§ï¼Œåœ¨åç»­çš„â€œä¼ªç›®æ ‡â€ç« èŠ‚ä¸­ä¼šæœ‰å™è¿°ã€‚</p>
</li>
<li><p><strong>prerequisites</strong><br>  ç”Ÿæˆè¯¥targetæ‰€ä¾èµ–çš„æ–‡ä»¶å’Œ/æˆ–target</p>
</li>
<li><p><strong>command</strong><br>  è¯¥targetè¦æ‰§è¡Œçš„å‘½ä»¤ï¼ˆä»»æ„çš„shellå‘½ä»¤ï¼‰</p>
</li>
</ul>
<p>è¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶çš„ä¾èµ–å…³ç³»ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œtargetè¿™ä¸€ä¸ªæˆ–å¤šä¸ªçš„ç›®æ ‡æ–‡ä»¶ä¾èµ–äºprerequisitesä¸­çš„æ–‡ä»¶ï¼Œå…¶ç”Ÿæˆè§„åˆ™å®šä¹‰åœ¨commandä¸­ã€‚<br><em><strong>prerequisitesä¸­å¦‚æœæœ‰ä¸€ä¸ªä»¥ä¸Šçš„æ–‡ä»¶æ¯”targetæ–‡ä»¶è¦æ–°çš„è¯ï¼Œcommandæ‰€å®šä¹‰çš„å‘½ä»¤å°±ä¼šè¢«æ‰§è¡Œã€‚</strong></em></p>
<h2 id="ä½¿ç”¨å˜é‡"><a href="#ä½¿ç”¨å˜é‡" class="headerlink" title="ä½¿ç”¨å˜é‡"></a>ä½¿ç”¨å˜é‡</h2><ul>
<li>ç”³æ˜å˜é‡<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">objects = main.o kbd.o command.o display.o \</span><br><span class="line">    insert.o search.o files.o utils.o</span><br></pre></td></tr></table></figure></li>
<li>ä½¿ç”¨å˜é‡<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">edit : <span class="variable">$(objects)</span></span><br><span class="line">    cc -o edit <span class="variable">$(objects)</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="makeè‡ªåŠ¨æ¨å¯¼"><a href="#makeè‡ªåŠ¨æ¨å¯¼" class="headerlink" title="makeè‡ªåŠ¨æ¨å¯¼"></a>makeè‡ªåŠ¨æ¨å¯¼</h2><p>åªè¦makeçœ‹åˆ°ä¸€ä¸ª <code>.o</code> æ–‡ä»¶ï¼Œå®ƒå°±ä¼šè‡ªåŠ¨çš„æŠŠ <code>.c</code> æ–‡ä»¶åŠ åœ¨ä¾èµ–å…³ç³»ä¸­ï¼Œå¦‚æœmakeæ‰¾åˆ°ä¸€ä¸ª <code>whatever.o</code> ï¼Œé‚£ä¹ˆ <code>whatever.c</code> å°±ä¼šæ˜¯ <code>whatever.o</code> çš„ä¾èµ–æ–‡ä»¶ã€‚å¹¶ä¸” <code>cc -c whatever.c</code> ä¹Ÿä¼šè¢«æ¨å¯¼å‡ºæ¥ã€‚</p>
<h2 id="æ¸…ç©ºç›®æ ‡æ–‡ä»¶çš„è§„åˆ™"><a href="#æ¸…ç©ºç›®æ ‡æ–‡ä»¶çš„è§„åˆ™" class="headerlink" title="æ¸…ç©ºç›®æ ‡æ–‡ä»¶çš„è§„åˆ™"></a>æ¸…ç©ºç›®æ ‡æ–‡ä»¶çš„è§„åˆ™</h2><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">.PHONY : clean</span><br><span class="line">clean :</span><br><span class="line">    -rm edit <span class="variable">$(objects)</span></span><br></pre></td></tr></table></figure>
<p> <code>.PHONY</code> è¡¨ç¤º <code>clean</code> æ˜¯ä¸€ä¸ªâ€œä¼ªç›®æ ‡â€ã€‚è€Œåœ¨ <code>rm</code> å‘½ä»¤å‰é¢åŠ äº†ä¸€ä¸ªå°å‡å·çš„æ„æ€å°±æ˜¯ï¼Œä¹Ÿè®¸æŸäº›æ–‡ä»¶å‡ºç°é—®é¢˜ï¼Œä½†ä¸è¦ç®¡ï¼Œç»§ç»­åšåé¢çš„äº‹ã€‚</p>
<h2 id="MakefileåŒ…å«"><a href="#MakefileåŒ…å«" class="headerlink" title="MakefileåŒ…å«"></a>MakefileåŒ…å«</h2><ul>
<li>æ˜¾å¼è§„åˆ™ã€‚æ˜¾å¼è§„åˆ™è¯´æ˜äº†å¦‚ä½•ç”Ÿæˆä¸€ä¸ªæˆ–å¤šä¸ªç›®æ ‡æ–‡ä»¶ã€‚</li>
<li>éšæ™¦è§„åˆ™ã€‚ç”±äºæˆ‘ä»¬çš„makeæœ‰è‡ªåŠ¨æ¨å¯¼çš„åŠŸèƒ½ï¼Œæ‰€ä»¥éšæ™¦çš„è§„åˆ™å¯ä»¥è®©æˆ‘ä»¬æ¯”è¾ƒç®€ç•¥åœ°ä¹¦å†™ Makefileï¼Œè¿™æ˜¯ç”±makeæ‰€æ”¯æŒçš„ã€‚</li>
<li>å˜é‡çš„å®šä¹‰ã€‚åœ¨Makefileä¸­æˆ‘ä»¬è¦å®šä¹‰ä¸€ç³»åˆ—çš„å˜é‡ï¼Œå˜é‡ä¸€èˆ¬éƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œè¿™ä¸ªæœ‰ç‚¹åƒä½ Cè¯­è¨€ä¸­çš„å®ã€‚</li>
<li>æ–‡ä»¶æŒ‡ç¤ºã€‚å…¶åŒ…æ‹¬äº†ä¸‰ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯åœ¨ä¸€ä¸ªMakefileä¸­å¼•ç”¨å¦ä¸€ä¸ªMakefileï¼Œå°±åƒCè¯­è¨€ä¸­çš„includeä¸€æ ·ï¼›å¦ä¸€ä¸ªæ˜¯æŒ‡æ ¹æ®æŸäº›æƒ…å†µæŒ‡å®šMakefileä¸­çš„æœ‰æ•ˆéƒ¨åˆ†ï¼Œå°±åƒCè¯­è¨€ä¸­çš„é¢„ç¼–è¯‘#ifä¸€æ ·ï¼›è¿˜æœ‰å°±æ˜¯å®šä¹‰ä¸€ä¸ªå¤šè¡Œçš„å‘½ä»¤ã€‚</li>
<li>æ³¨é‡Š</li>
</ul>
<h2 id="å¼•ç”¨å…¶å®ƒçš„Makefile"><a href="#å¼•ç”¨å…¶å®ƒçš„Makefile" class="headerlink" title="å¼•ç”¨å…¶å®ƒçš„Makefile"></a>å¼•ç”¨å…¶å®ƒçš„Makefile</h2><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">include</span> foo.make *.mk <span class="variable">$(bar)</span></span><br></pre></td></tr></table></figure>

<h2 id="ä¹¦å†™è§„åˆ™"><a href="#ä¹¦å†™è§„åˆ™" class="headerlink" title="ä¹¦å†™è§„åˆ™"></a>ä¹¦å†™è§„åˆ™</h2><h3 id="åŸºæœ¬è§„åˆ™"><a href="#åŸºæœ¬è§„åˆ™" class="headerlink" title="åŸºæœ¬è§„åˆ™"></a>åŸºæœ¬è§„åˆ™</h3><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">targets : prerequisites</span><br><span class="line">    command</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<h3 id="Makefileé€šé…ç¬¦"><a href="#Makefileé€šé…ç¬¦" class="headerlink" title="Makefileé€šé…ç¬¦"></a>Makefileé€šé…ç¬¦</h3><p>makeæ”¯æŒä¸‰ä¸ªé€šé…ç¬¦ï¼š <code>*</code> ï¼Œ <code>?</code> å’Œ <code>~</code> ã€‚<br>å¦‚æœæ˜¯ <code>~/test</code> ï¼Œè¿™å°±è¡¨ç¤ºå½“å‰ç”¨æˆ·çš„ <code>$HOME</code> ç›®å½•ä¸‹çš„testç›®å½•ã€‚<br>é€šé…ç¬¦ä»£æ›¿äº†ä½ ä¸€ç³»åˆ—çš„æ–‡ä»¶ï¼Œå¦‚ <code>*.c</code> è¡¨ç¤ºæ‰€æœ‰åç¼€ä¸ºcçš„æ–‡ä»¶ã€‚ä¸€ä¸ªéœ€è¦æˆ‘ä»¬æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬çš„æ–‡ä»¶åä¸­æœ‰é€šé…ç¬¦ï¼Œå¦‚ï¼š <code>*</code> ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨è½¬ä¹‰å­—ç¬¦ <code>\</code> ï¼Œå¦‚ <code>\*</code> æ¥è¡¨ç¤ºçœŸå®çš„ <code>*</code> å­—ç¬¦ï¼Œè€Œä¸æ˜¯ä»»æ„é•¿åº¦çš„å­—ç¬¦ä¸²ã€‚</p>
<h2 id="æ–‡ä»¶æœå¯»"><a href="#æ–‡ä»¶æœå¯»" class="headerlink" title="æ–‡ä»¶æœå¯»"></a>æ–‡ä»¶æœå¯»</h2><p>Makefileæ–‡ä»¶ä¸­çš„ç‰¹æ®Šå˜é‡ <code>VPATH</code> å°±æ˜¯å®Œæˆè¿™ä¸ªåŠŸèƒ½çš„ï¼Œå¦‚æœæ²¡æœ‰æŒ‡æ˜è¿™ä¸ªå˜é‡ï¼Œmakeåªä¼šåœ¨å½“å‰çš„ç›®å½•ä¸­å»æ‰¾å¯»ä¾èµ–æ–‡ä»¶å’Œç›®æ ‡æ–‡ä»¶ã€‚å¦‚æœå®šä¹‰äº†è¿™ä¸ªå˜é‡ï¼Œé‚£ä¹ˆï¼Œmakeå°±ä¼šåœ¨å½“å‰ç›®å½•æ‰¾ä¸åˆ°çš„æƒ…å†µä¸‹ï¼Œåˆ°æ‰€æŒ‡å®šçš„ç›®å½•ä¸­å»æ‰¾å¯»æ–‡ä»¶äº†ã€‚</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">VPATH = src:../headers</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„å®šä¹‰æŒ‡å®šä¸¤ä¸ªç›®å½•ï¼Œâ€œsrcâ€å’Œâ€œ../headersâ€ï¼Œmakeä¼šæŒ‰ç…§è¿™ä¸ªé¡ºåºè¿›è¡Œæœç´¢ã€‚ç›®å½•ç”±â€œå†’å·â€åˆ†éš”ã€‚ï¼ˆå½“ç„¶ï¼Œå½“å‰ç›®å½•æ°¸è¿œæ˜¯æœ€é«˜ä¼˜å…ˆæœç´¢çš„åœ°æ–¹ï¼‰</p>
<h3 id="å¦ä¸€ä¸ªæ–¹æ³•"><a href="#å¦ä¸€ä¸ªæ–¹æ³•" class="headerlink" title="å¦ä¸€ä¸ªæ–¹æ³•"></a>å¦ä¸€ä¸ªæ–¹æ³•</h3><p><code>vpath &lt;pattern&gt; &lt;directories&gt;</code><br>ä¸ºç¬¦åˆæ¨¡å¼<pattern>çš„æ–‡ä»¶æŒ‡å®šæœç´¢ç›®å½•<directories>ã€‚</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">vpath</span> %.h ../headers</span><br></pre></td></tr></table></figure>
<p>è¯¥è¯­å¥è¡¨ç¤ºï¼Œè¦æ±‚makeåœ¨â€œ../headersâ€ç›®å½•ä¸‹æœç´¢æ‰€æœ‰ä»¥ <code>.h</code> ç»“å°¾çš„æ–‡ä»¶ã€‚ï¼ˆå¦‚æœæŸæ–‡ä»¶åœ¨å½“å‰ç›®å½•æ²¡æœ‰æ‰¾åˆ°çš„è¯ï¼‰</p>
<h2 id="ä¼ªç›®æ ‡"><a href="#ä¼ªç›®æ ‡" class="headerlink" title="ä¼ªç›®æ ‡"></a>ä¼ªç›®æ ‡</h2><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">.PHONY : clean</span><br><span class="line">clean :</span><br><span class="line">    rm *.o temp</span><br></pre></td></tr></table></figure>
<p>â€œ.PHONYâ€æ¥æ˜¾å¼åœ°æŒ‡æ˜ä¸€ä¸ªç›®æ ‡æ˜¯â€œä¼ªç›®æ ‡â€ï¼Œå‘makeè¯´æ˜ï¼Œä¸ç®¡æ˜¯å¦æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œè¿™ä¸ªç›®æ ‡å°±æ˜¯â€œä¼ªç›®æ ‡â€ã€‚</p>
<h2 id="é™æ€æ¨¡å¼"><a href="#é™æ€æ¨¡å¼" class="headerlink" title="é™æ€æ¨¡å¼"></a>é™æ€æ¨¡å¼</h2><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">&lt;targets ...&gt; : &lt;target-pattern&gt; : &lt;prereq-patterns ...&gt;</span><br><span class="line">    &lt;commands&gt;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<ul>
<li><p>targetså®šä¹‰äº†ä¸€ç³»åˆ—çš„ç›®æ ‡æ–‡ä»¶ï¼Œå¯ä»¥æœ‰é€šé…ç¬¦ã€‚æ˜¯ç›®æ ‡çš„ä¸€ä¸ªé›†åˆã€‚</p>
</li>
<li><p>target-patternæ˜¯æŒ‡æ˜äº†targetsçš„æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯çš„ç›®æ ‡é›†æ¨¡å¼ã€‚</p>
</li>
<li><p>prereq-patternsæ˜¯ç›®æ ‡çš„ä¾èµ–æ¨¡å¼ï¼Œå®ƒå¯¹target-patternå½¢æˆçš„æ¨¡å¼å†è¿›è¡Œä¸€æ¬¡ä¾èµ–ç›®æ ‡çš„å®šä¹‰ã€‚</p>
</li>
</ul>
<h3 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">objects = foo.o bar.o</span><br><span class="line"></span><br><span class="line"><span class="section">all: <span class="variable">$(objects)</span></span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(objects)</span>: %.o: %.c</span><br><span class="line">    <span class="variable">$(CC)</span> -c <span class="variable">$(CFLAGS)</span> <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br><span class="line"><span class="comment">##############							</span></span><br><span class="line">ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒæŒ‡æ˜äº†æˆ‘ä»¬çš„ç›®æ ‡ä»$objectä¸­è·å–ï¼Œ `%.o` è¡¨æ˜è¦æ‰€æœ‰ä»¥ `.o` ç»“å°¾çš„ç›®æ ‡ï¼Œä¹Ÿå°±æ˜¯ `foo.o bar.o` ï¼Œä¹Ÿå°±æ˜¯å˜é‡ `$object` é›†åˆçš„æ¨¡å¼ï¼Œè€Œä¾èµ–æ¨¡å¼ `%.c` åˆ™å–æ¨¡å¼ `%.o` çš„ `%` ï¼Œä¹Ÿå°±æ˜¯ `foo bar` ï¼Œå¹¶ä¸ºå…¶åŠ ä¸‹ `.c` çš„åç¼€ï¼Œäºæ˜¯ï¼Œæˆ‘ä»¬çš„ä¾èµ–ç›®æ ‡å°±æ˜¯ `foo.c bar.c` ã€‚è€Œå‘½ä»¤ä¸­çš„ `<span class="variable">$&lt;</span>` å’Œ `<span class="variable">$@</span>` åˆ™æ˜¯è‡ªåŠ¨åŒ–å˜é‡ï¼Œ `<span class="variable">$&lt;</span>` è¡¨ç¤ºç¬¬ä¸€ä¸ªä¾èµ–æ–‡ä»¶ï¼Œ `<span class="variable">$@</span>` è¡¨ç¤ºç›®æ ‡é›†ï¼ˆä¹Ÿå°±æ˜¯â€œfoo.o bar.oâ€ï¼‰ã€‚äºæ˜¯ï¼Œä¸Šé¢çš„è§„åˆ™å±•å¼€åç­‰ä»·äºä¸‹é¢çš„è§„åˆ™ï¼š</span><br><span class="line">foo.o : foo.c</span><br><span class="line">    <span class="variable">$(CC)</span> -c <span class="variable">$(CFLAGS)</span> foo.c -o foo.o</span><br><span class="line">bar.o : bar.c</span><br><span class="line">    <span class="variable">$(CC)</span> -c <span class="variable">$(CFLAGS)</span> bar.c -o bar.o</span><br></pre></td></tr></table></figure>

<h2 id="å‘½ä»¤"><a href="#å‘½ä»¤" class="headerlink" title="å‘½ä»¤"></a>å‘½ä»¤</h2><h3 id="ä¹¦å†™å‘½ä»¤"><a href="#ä¹¦å†™å‘½ä»¤" class="headerlink" title="ä¹¦å†™å‘½ä»¤"></a>ä¹¦å†™å‘½ä»¤</h3><p>æ¯æ¡è§„åˆ™ä¸­çš„å‘½ä»¤å’Œæ“ä½œç³»ç»ŸShellçš„å‘½ä»¤è¡Œæ˜¯ä¸€è‡´çš„ã€‚makeä¼šä¸€æŒ‰é¡ºåºä¸€æ¡ä¸€æ¡çš„æ‰§è¡Œå‘½ä»¤ï¼Œæ¯æ¡å‘½ä»¤çš„å¼€å¤´å¿…é¡»ä»¥ <code>Tab</code> é”®å¼€å¤´ï¼Œé™¤éï¼Œå‘½ä»¤æ˜¯ç´§è·Ÿåœ¨ä¾èµ–è§„åˆ™åé¢çš„åˆ†å·åçš„ã€‚åœ¨å‘½ä»¤è¡Œä¹‹é—´ä¸­çš„ç©ºæ ¼æˆ–æ˜¯ç©ºè¡Œä¼šè¢«å¿½ç•¥ï¼Œä½†æ˜¯å¦‚æœè¯¥ç©ºæ ¼æˆ–ç©ºè¡Œæ˜¯ä»¥Tabé”®å¼€å¤´çš„ï¼Œé‚£ä¹ˆmakeä¼šè®¤ä¸ºå…¶æ˜¯ä¸€ä¸ªç©ºå‘½ä»¤ã€‚</p>
<h3 id="æ˜¾ç¤ºå‘½ä»¤"><a href="#æ˜¾ç¤ºå‘½ä»¤" class="headerlink" title="æ˜¾ç¤ºå‘½ä»¤"></a>æ˜¾ç¤ºå‘½ä»¤</h3><p>å½“æˆ‘ä»¬ç”¨ <code>@</code> å­—ç¬¦åœ¨å‘½ä»¤è¡Œå‰ï¼Œé‚£ä¹ˆï¼Œè¿™ä¸ªå‘½ä»¤å°†ä¸è¢«makeæ˜¾ç¤ºå‡ºæ¥ï¼Œæœ€å…·ä»£è¡¨æ€§çš„ä¾‹å­æ˜¯ï¼Œæˆ‘ä»¬ç”¨è¿™ä¸ªåŠŸèƒ½æ¥å‘å±å¹•æ˜¾ç¤ºä¸€äº›ä¿¡æ¯ã€‚å¦‚:</p>
<p>@echo æ­£åœ¨ç¼–è¯‘XXXæ¨¡å—â€¦â€¦<br>å½“makeæ‰§è¡Œæ—¶ï¼Œä¼šè¾“å‡ºâ€œæ­£åœ¨ç¼–è¯‘XXXæ¨¡å—â€¦â€¦â€å­—ä¸²ï¼Œä½†ä¸ä¼šè¾“å‡ºå‘½ä»¤</p>
<ul>
<li>makeå‚æ•° <code>-n</code> æˆ– <code>--just-print</code> ï¼Œé‚£ä¹ˆå…¶åªæ˜¯æ˜¾ç¤ºå‘½ä»¤ï¼Œä½†ä¸ä¼šæ‰§è¡Œå‘½ä»¤</li>
<li>makeå‚æ•° <code>-s</code> æˆ– <code>--silent</code> æˆ– <code>--quiet</code> åˆ™æ˜¯å…¨é¢ç¦æ­¢å‘½ä»¤çš„æ˜¾ç¤ºã€‚</li>
</ul>
<h3 id="å‘½ä»¤æ‰§è¡Œ"><a href="#å‘½ä»¤æ‰§è¡Œ" class="headerlink" title="å‘½ä»¤æ‰§è¡Œ"></a>å‘½ä»¤æ‰§è¡Œ</h3><p>æ¯”å¦‚ä½ çš„ç¬¬ä¸€æ¡å‘½ä»¤æ˜¯cdå‘½ä»¤ï¼Œä½ å¸Œæœ›ç¬¬äºŒæ¡å‘½ä»¤å¾—åœ¨cdä¹‹åçš„åŸºç¡€ä¸Šè¿è¡Œï¼Œé‚£ä¹ˆä½ å°±ä¸èƒ½æŠŠè¿™ä¸¤æ¡å‘½ä»¤å†™åœ¨ä¸¤è¡Œä¸Šï¼Œè€Œåº”è¯¥æŠŠè¿™ä¸¤æ¡å‘½ä»¤å†™åœ¨ä¸€è¡Œä¸Šï¼Œç”¨åˆ†å·åˆ†éš”ã€‚</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="section">exec:</span></span><br><span class="line">    cd /home/hchen; pwd</span><br></pre></td></tr></table></figure>

<h3 id="å‘½ä»¤çš„å‡ºé”™"><a href="#å‘½ä»¤çš„å‡ºé”™" class="headerlink" title="å‘½ä»¤çš„å‡ºé”™"></a>å‘½ä»¤çš„å‡ºé”™</h3><p>å¿½ç•¥å‘½ä»¤çš„å‡ºé”™ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Makefileçš„å‘½ä»¤è¡Œå‰åŠ ä¸€ä¸ªå‡å· - ï¼ˆåœ¨Tabé”®ä¹‹åï¼‰ï¼Œæ ‡è®°ä¸ºä¸ç®¡å‘½ä»¤å‡ºä¸å‡ºé”™éƒ½è®¤ä¸ºæ˜¯æˆåŠŸçš„ã€‚å¦‚ï¼š</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="section">clean:</span></span><br><span class="line">    -rm -f *.o</span><br></pre></td></tr></table></figure>
<p>è¿˜æœ‰ä¸€ä¸ªå…¨å±€çš„åŠæ³•æ˜¯ï¼Œç»™makeåŠ ä¸Š -i æˆ–æ˜¯ â€“ignore-errors å‚æ•°ï¼Œé‚£ä¹ˆï¼ŒMakefileä¸­æ‰€æœ‰å‘½ä»¤éƒ½ä¼šå¿½ç•¥é”™è¯¯ã€‚<br>è¿˜æœ‰ä¸€ä¸ªè¦æä¸€ä¸‹çš„makeçš„å‚æ•°çš„æ˜¯ -k æˆ–æ˜¯ â€“keep-going ï¼Œè¿™ä¸ªå‚æ•°çš„æ„æ€æ˜¯ï¼Œå¦‚æœæŸè§„åˆ™ä¸­çš„å‘½ä»¤å‡ºé”™äº†ï¼Œé‚£ä¹ˆå°±ç»ˆæ­¢è¯¥è§„åˆ™çš„æ‰§è¡Œï¼Œä½†ç»§ç»­æ‰§è¡Œå…¶å®ƒè§„åˆ™ã€‚</p>
<h3 id="åµŒå¥—æ‰§è¡Œmake"><a href="#åµŒå¥—æ‰§è¡Œmake" class="headerlink" title="åµŒå¥—æ‰§è¡Œmake"></a>åµŒå¥—æ‰§è¡Œmake</h3><p>å®šä¹‰$(MAKE)å®å˜é‡çš„æ„æ€æ˜¯ï¼Œä¹Ÿè®¸æˆ‘ä»¬çš„makeéœ€è¦ä¸€äº›å‚æ•°ï¼Œæ‰€ä»¥å®šä¹‰æˆä¸€ä¸ªå˜é‡æ¯”è¾ƒåˆ©äºç»´æŠ¤ã€‚è¿™ä¸¤ä¸ªä¾‹å­çš„æ„æ€éƒ½æ˜¯å…ˆè¿›å…¥â€œsubdirâ€ç›®å½•ï¼Œç„¶åæ‰§è¡Œmakeå‘½ä»¤ã€‚</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="section">subsystem:</span></span><br><span class="line">    cd subdir &amp;&amp; <span class="variable">$(MAKE)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>å¦‚æœä½ è¦ä¼ é€’å˜é‡åˆ°ä¸‹çº§Makefileä¸­ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨è¿™æ ·çš„å£°æ˜:</li>
</ul>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> &lt;variable ...&gt;;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¦‚æœä½ ä¸æƒ³è®©æŸäº›å˜é‡ä¼ é€’åˆ°ä¸‹çº§Makefileä¸­ï¼Œé‚£ä¹ˆä½ å¯ä»¥è¿™æ ·å£°æ˜:</li>
</ul>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">unexport</span> &lt;variable ...&gt;;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¦‚æœä½ è¦ä¼ é€’æ‰€æœ‰çš„å˜é‡ï¼Œé‚£ä¹ˆï¼Œåªè¦ä¸€ä¸ªexportå°±è¡Œäº†ã€‚åé¢ä»€ä¹ˆä¹Ÿä¸ç”¨è·Ÿï¼Œè¡¨ç¤ºä¼ é€’æ‰€æœ‰çš„å˜é‡ã€‚</li>
</ul>
<h3 id="å®šä¹‰å‘½ä»¤åŒ…"><a href="#å®šä¹‰å‘½ä»¤åŒ…" class="headerlink" title="å®šä¹‰å‘½ä»¤åŒ…"></a>å®šä¹‰å‘½ä»¤åŒ…</h3><p>å¦‚æœMakefileä¸­å‡ºç°ä¸€äº›ç›¸åŒå‘½ä»¤åºåˆ—ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä¸ºè¿™äº›ç›¸åŒçš„å‘½ä»¤åºåˆ—å®šä¹‰ä¸€ä¸ªå˜é‡ã€‚å®šä¹‰è¿™ç§å‘½ä»¤åºåˆ—çš„è¯­æ³•ä»¥ define å¼€å§‹ï¼Œä»¥ endef ç»“æŸï¼Œå¦‚:</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">define</span> run-yacc</span><br><span class="line">yacc <span class="variable">$(<span class="built_in">firstword</span> <span class="variable">$^</span>)</span></span><br><span class="line">mv y.tab.c <span class="variable">$@</span></span><br><span class="line"><span class="keyword">endef</span></span><br></pre></td></tr></table></figure>
<ul>
<li>ä½¿ç”¨<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">foo.c : foo.y</span><br><span class="line">    $(run-yacc)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="å˜é‡"><a href="#å˜é‡" class="headerlink" title="å˜é‡"></a>å˜é‡</h2><p>å˜é‡çš„å‘½åå­—å¯ä»¥åŒ…å«å­—ç¬¦ã€æ•°å­—ï¼Œä¸‹åˆ’çº¿ï¼ˆå¯ä»¥æ˜¯æ•°å­—å¼€å¤´ï¼‰ï¼Œä½†ä¸åº”è¯¥å«æœ‰ : ã€ # ã€ = æˆ–æ˜¯ç©ºå­—ç¬¦ï¼ˆç©ºæ ¼ã€å›è½¦ç­‰ï¼‰ã€‚å˜é‡æ˜¯å¤§å°å†™æ•æ„Ÿçš„ã€‚</p>
<h3 id="å˜é‡åŸºç¡€"><a href="#å˜é‡åŸºç¡€" class="headerlink" title="å˜é‡åŸºç¡€"></a>å˜é‡åŸºç¡€</h3><p>å˜é‡åœ¨å£°æ˜æ—¶éœ€è¦ç»™äºˆåˆå€¼ï¼Œè€Œåœ¨ä½¿ç”¨æ—¶ï¼Œéœ€è¦ç»™åœ¨å˜é‡åå‰åŠ ä¸Š <code>$</code> ç¬¦å·ï¼Œä½†æœ€å¥½ç”¨å°æ‹¬å· <code>()</code> æˆ–æ˜¯å¤§æ‹¬å· <code>&#123;&#125;</code> æŠŠå˜é‡ç»™åŒ…æ‹¬èµ·æ¥ã€‚å¦‚æœä½ è¦ä½¿ç”¨çœŸå®çš„ <code>$</code> å­—ç¬¦ï¼Œé‚£ä¹ˆä½ éœ€è¦ç”¨ <code>$$</code> æ¥è¡¨ç¤ºã€‚<br>å˜é‡ä¼šåœ¨ä½¿ç”¨å®ƒçš„åœ°æ–¹ç²¾ç¡®åœ°å±•å¼€ï¼Œå°±åƒC/C++ä¸­çš„å®ä¸€æ ·ã€‚</p>
<h3 id="å˜é‡çš„å®šä¹‰"><a href="#å˜é‡çš„å®šä¹‰" class="headerlink" title="å˜é‡çš„å®šä¹‰"></a>å˜é‡çš„å®šä¹‰</h3><ul>
<li><p>æ–¹æ³•1:è¿è¡Œä½¿ç”¨çš„å˜é‡åé¢åœ¨å®šä¹‰</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">foo = <span class="variable">$(bar)</span></span><br><span class="line">bar = <span class="variable">$(ugh)</span></span><br><span class="line">ugh = Huh?</span><br><span class="line"></span><br><span class="line"><span class="section">all:</span></span><br><span class="line">    echo <span class="variable">$(foo)</span></span><br></pre></td></tr></table></figure></li>
<li><p>æ–¹æ³•2:è¿™ç§æ–¹æ³•ï¼Œå‰é¢çš„å˜é‡ä¸èƒ½ä½¿ç”¨åé¢çš„å˜é‡ï¼Œé¿å…é€’å½’</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">y := <span class="variable">$(x)</span> bar</span><br><span class="line">x := foo</span><br></pre></td></tr></table></figure>
<h4 id="æ³¨æ„äº‹é¡¹ï¼š"><a href="#æ³¨æ„äº‹é¡¹ï¼š" class="headerlink" title="æ³¨æ„äº‹é¡¹ï¼š"></a>æ³¨æ„äº‹é¡¹ï¼š</h4></li>
<li><p>å®šä¹‰ä¸€ä¸ªç©ºæ ¼</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">nullstring :=</span><br><span class="line">space := <span class="variable">$(nullstring)</span> <span class="comment"># end of the line</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>é”™è¯¯ä½¿ç”¨</strong></p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">dir := /foo/bar    <span class="comment"># directory to put the frobs in</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œdiråé¢ä¼šè·Ÿç€4ä¸ªç©ºæ ¼</p>
<ul>
<li><code>?=</code>çš„ä½¿ç”¨<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">FOO ?= bar</span><br></pre></td></tr></table></figure>
å¦‚æœFOOæ²¡æœ‰è¢«å®šä¹‰è¿‡ï¼Œé‚£ä¹ˆå˜é‡FOOçš„å€¼å°±æ˜¯â€œbarâ€ï¼Œå¦‚æœFOOå…ˆå‰è¢«å®šä¹‰è¿‡ï¼Œé‚£ä¹ˆè¿™æ¡è¯­å°†ä»€ä¹ˆä¹Ÿä¸åšã€‚</li>
</ul>
<h3 id="å˜é‡é«˜çº§ç”¨æ³•"><a href="#å˜é‡é«˜çº§ç”¨æ³•" class="headerlink" title="å˜é‡é«˜çº§ç”¨æ³•"></a>å˜é‡é«˜çº§ç”¨æ³•</h3><h4 id="å˜é‡å­—ç¬¦æ›¿æ¢"><a href="#å˜é‡å­—ç¬¦æ›¿æ¢" class="headerlink" title="å˜é‡å­—ç¬¦æ›¿æ¢"></a>å˜é‡å­—ç¬¦æ›¿æ¢</h4><p>æˆ‘ä»¬å¯ä»¥æ›¿æ¢å˜é‡ä¸­çš„å…±æœ‰çš„éƒ¨åˆ†ï¼Œå…¶æ ¼å¼æ˜¯ <code>$(var:a=b)</code> æˆ–æ˜¯ <code>$&#123;var:a=b&#125;</code> ï¼Œå…¶æ„æ€æ˜¯ï¼ŒæŠŠå˜é‡â€œvarâ€ä¸­æ‰€æœ‰ä»¥â€œaâ€å­—ä¸²â€œç»“å°¾â€çš„â€œaâ€æ›¿æ¢æˆâ€œbâ€å­—ä¸²ã€‚</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">foo := a.o b.o c.o</span><br><span class="line">bar := $(foo:.o=.c)</span><br><span class="line"><span class="comment">### ç­‰ä»·ï¼ˆé™æ€æ¨¡å¼ï¼‰</span></span><br><span class="line">foo := a.o b.o c.o</span><br><span class="line">bar := $(foo:%.o=%.c)</span><br></pre></td></tr></table></figure>
<p>æŠŠ $(foo) ä¸­æ‰€æœ‰ä»¥ .o å­—ä¸²â€œç»“å°¾â€å…¨éƒ¨æ›¿æ¢æˆ .c ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ $(bar) çš„å€¼å°±æ˜¯â€œa.c b.c c.câ€ã€‚</p>
<h4 id="æŠŠå˜é‡çš„å€¼å†å½“æˆå˜é‡"><a href="#æŠŠå˜é‡çš„å€¼å†å½“æˆå˜é‡" class="headerlink" title="æŠŠå˜é‡çš„å€¼å†å½“æˆå˜é‡"></a>æŠŠå˜é‡çš„å€¼å†å½“æˆå˜é‡</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">x = y</span><br><span class="line">y = z</span><br><span class="line">a := $(<span class="variable">$(x)</span>)</span><br></pre></td></tr></table></figure>

<h3 id="è¿½åŠ å˜é‡å€¼"><a href="#è¿½åŠ å˜é‡å€¼" class="headerlink" title="è¿½åŠ å˜é‡å€¼"></a>è¿½åŠ å˜é‡å€¼</h3><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>+=</code> æ“ä½œç¬¦ç»™å˜é‡è¿½åŠ å€¼</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">objects = main.o foo.o bar.o utils.o</span><br><span class="line">objects += another.o</span><br><span class="line"><span class="comment">## ç­‰ä»·äº</span></span><br><span class="line">objects = main.o foo.o bar.o utils.o</span><br><span class="line">objects := <span class="variable">$(objects)</span> another.o</span><br></pre></td></tr></table></figure>

<h3 id="override-æŒ‡ç¤ºç¬¦"><a href="#override-æŒ‡ç¤ºç¬¦" class="headerlink" title="override æŒ‡ç¤ºç¬¦"></a>override æŒ‡ç¤ºç¬¦</h3><p>é€šå¸¸åœ¨æ‰§è¡Œ make æ—¶,å¦‚æœé€šè¿‡å‘½ä»¤è¡Œå®šä¹‰äº†ä¸€ä¸ªå˜é‡,é‚£ä¹ˆå®ƒå°†æ›¿ä»£åœ¨ Makefileä¸­å‡ºç°çš„åŒåå˜é‡çš„å®šä¹‰ã€‚<br>å°±æ˜¯è¯´,å¯¹äºä¸€ä¸ªåœ¨ Makefile ä¸­ä½¿ç”¨å¸¸è§„æ–¹å¼(ä½¿ç”¨â€œ=â€ã€â€œ:=â€æˆ–è€…â€œdefineâ€)å®šä¹‰çš„å˜é‡,æˆ‘ä»¬å¯ä»¥åœ¨æ‰§è¡Œ make æ—¶é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼é‡æ–°æŒ‡å®šè¿™ä¸ªå˜é‡çš„å€¼,å‘½ä»¤è¡ŒæŒ‡å®šçš„å€¼å°†æ›¿ä»£å‡ºç°åœ¨ Makefile ä¸­æ­¤å˜é‡çš„å€¼ã€‚<br>overrideä½œç”¨:</p>
<ul>
<li>ä¿æŠ¤makefileä¸­å®šä¹‰çš„å˜é‡çš„å€¼;</li>
<li>æä¾›ä¸€ç§åœ¨makefileä¸­å¢åŠ æˆ–è€…ä¿®æ”¹å‘½ä»¤è¡Œå‚æ•°çš„æ–¹å¼;</li>
</ul>
<h3 id="å¤šè¡Œå˜é‡"><a href="#å¤šè¡Œå˜é‡" class="headerlink" title="å¤šè¡Œå˜é‡"></a>å¤šè¡Œå˜é‡</h3><p>è¿˜æœ‰ä¸€ç§è®¾ç½®å˜é‡å€¼çš„æ–¹æ³•æ˜¯ä½¿ç”¨defineå…³é”®å­—ã€‚ä½¿ç”¨defineå…³é”®å­—è®¾ç½®å˜é‡çš„å€¼å¯ä»¥æœ‰æ¢è¡Œï¼Œè¿™æœ‰åˆ©äºå®šä¹‰ä¸€ç³»åˆ—çš„å‘½ä»¤ã€‚</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">define</span> two-lines</span><br><span class="line">echo foo</span><br><span class="line">echo <span class="variable">$(bar)</span></span><br><span class="line"><span class="keyword">endef</span></span><br></pre></td></tr></table></figure>
<p>å˜é‡çš„å€¼å¯ä»¥åŒ…å«å‡½æ•°ã€å‘½ä»¤ã€æ–‡å­—ï¼Œæˆ–æ˜¯å…¶å®ƒå˜é‡ã€‚å› ä¸ºå‘½ä»¤éœ€è¦ä»¥<code>[Tab]</code>é”®å¼€å¤´ï¼Œæ‰€ä»¥å¦‚æœä½ ç”¨defineå®šä¹‰çš„å‘½ä»¤å˜é‡ä¸­æ²¡æœ‰ä»¥ <code>Tab</code> é”®å¼€å¤´ï¼Œé‚£ä¹ˆmakeå°±ä¸ä¼šæŠŠå…¶è®¤ä¸ºæ˜¯å‘½ä»¤ã€‚</p>
<h3 id="ç¯å¢ƒå˜é‡"><a href="#ç¯å¢ƒå˜é‡" class="headerlink" title="ç¯å¢ƒå˜é‡"></a>ç¯å¢ƒå˜é‡</h3><p>å½“makeåµŒå¥—è°ƒç”¨æ—¶ï¼ˆå‚è§å‰é¢çš„â€œåµŒå¥—è°ƒç”¨â€ç« èŠ‚ï¼‰ï¼Œä¸Šå±‚Makefileä¸­å®šä¹‰çš„å˜é‡ä¼šä»¥ç³»ç»Ÿç¯å¢ƒå˜é‡çš„æ–¹å¼ä¼ é€’åˆ°ä¸‹å±‚çš„Makefile ä¸­ã€‚å½“ç„¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰é€šè¿‡å‘½ä»¤è¡Œè®¾ç½®çš„å˜é‡ä¼šè¢«ä¼ é€’ã€‚è€Œå®šä¹‰åœ¨æ–‡ä»¶ä¸­çš„å˜é‡ï¼Œå¦‚æœè¦å‘ä¸‹å±‚Makefileä¼ é€’ï¼Œåˆ™éœ€è¦ä½¿ç”¨exportå…³é”®å­—æ¥å£°æ˜ã€‚</p>
<h3 id="ç›®æ ‡å˜é‡"><a href="#ç›®æ ‡å˜é‡" class="headerlink" title="ç›®æ ‡å˜é‡"></a>ç›®æ ‡å˜é‡</h3><p>å› ä¸ºå®ƒçš„ä½œç”¨èŒƒå›´åªåœ¨è¿™æ¡è§„åˆ™ä»¥åŠè¿å¸¦è§„åˆ™ä¸­ï¼Œæ‰€ä»¥å…¶å€¼ä¹Ÿåªåœ¨ä½œç”¨èŒƒå›´å†…æœ‰æ•ˆã€‚è€Œä¸ä¼šå½±å“è§„åˆ™é“¾ä»¥å¤–çš„å…¨å±€å˜é‡çš„å€¼ã€‚</p>
<ul>
<li>æ ¼å¼<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">&lt;target ...&gt; : &lt;variable-assignment&gt;;</span><br><span class="line">&lt;target ...&gt; : overide &lt;variable-assignment&gt;</span><br></pre></td></tr></table></figure></li>
<li>ä¾‹å­<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">prog : CFLAGS = -g</span><br><span class="line">prog : prog.o foo.o bar.o</span><br><span class="line">    <span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> prog.o foo.o bar.o</span><br><span class="line"></span><br><span class="line">prog.o : prog.c</span><br><span class="line">    <span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> prog.c</span><br><span class="line"></span><br><span class="line">foo.o : foo.c</span><br><span class="line">    <span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> foo.c</span><br><span class="line"></span><br><span class="line">bar.o : bar.c</span><br><span class="line">    <span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> bar.c</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œä¸ç®¡å…¨å±€çš„ $(CFLAGS) çš„å€¼æ˜¯ä»€ä¹ˆï¼Œåœ¨progç›®æ ‡ï¼Œä»¥åŠå…¶æ‰€å¼•å‘çš„æ‰€æœ‰è§„åˆ™ä¸­ï¼ˆprog.o foo.o bar.oçš„è§„åˆ™ï¼‰ï¼Œ $(CFLAGS) çš„å€¼éƒ½æ˜¯ -g</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="æ¨¡å¼å˜é‡"><a href="#æ¨¡å¼å˜é‡" class="headerlink" title="æ¨¡å¼å˜é‡"></a>æ¨¡å¼å˜é‡</h3><p>æˆ‘ä»¬å¯ä»¥ä»¥å¦‚ä¸‹æ–¹å¼ç»™æ‰€æœ‰ä»¥ .o ç»“å°¾çš„ç›®æ ‡å®šä¹‰ç›®æ ‡å˜é‡ï¼š</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">%.o : CFLAGS = -O</span><br></pre></td></tr></table></figure>

<h3 id="è‡ªåŠ¨åŒ–å˜é‡"><a href="#è‡ªåŠ¨åŒ–å˜é‡" class="headerlink" title="è‡ªåŠ¨åŒ–å˜é‡"></a>è‡ªåŠ¨åŒ–å˜é‡</h3><p>è‡ªåŠ¨åŒ–å˜é‡çš„å–å€¼æ ¹æ®æ‰§è¡Œçš„è§„åˆ™æ¥å†³å®šï¼Œå–å†³äºæ‰§è¡Œè§„åˆ™çš„ç›®æ ‡æ–‡ä»¶å’Œä¾èµ–æ–‡ä»¶ã€‚</p>
<h2 id="ä½¿ç”¨æ¡ä»¶å˜é‡"><a href="#ä½¿ç”¨æ¡ä»¶å˜é‡" class="headerlink" title="ä½¿ç”¨æ¡ä»¶å˜é‡"></a>ä½¿ç”¨æ¡ä»¶å˜é‡</h2><ul>
<li><p>ä¾‹å­</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="section">foo: <span class="variable">$(objects)</span></span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(CC)</span>,gcc)</span><br><span class="line">    <span class="variable">$(CC)</span> -o foo <span class="variable">$(objects)</span> <span class="variable">$(libs_for_gcc)</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="variable">$(CC)</span> -o foo <span class="variable">$(objects)</span> <span class="variable">$(normal_libs)</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure></li>
<li><p>è¯­æ³•</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">&lt;conditional-directive&gt;</span><br><span class="line">&lt;text-if-true&gt;</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">&lt;conditional-directive&gt;</span><br><span class="line">&lt;text-if-true&gt;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&lt;text-if-false&gt;</span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure></li>
<li><p>ä¸‰ç§å…³é”®å­—</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ifeq</span> (&lt;arg1&gt;, &lt;arg2&gt;)</span><br><span class="line"><span class="keyword">ifneq</span> (&lt;arg1&gt;, &lt;arg2&gt;)</span><br><span class="line"><span class="keyword">ifdef</span> &lt;variable-name&gt;</span><br><span class="line"><span class="keyword">ifndef</span> &lt;variable-name&gt;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>&lt;conditional-directive&gt;</code> è¿™ä¸€è¡Œä¸Šï¼Œå¤šä½™çš„ç©ºæ ¼æ˜¯è¢«å…è®¸çš„ï¼Œä½†æ˜¯ä¸èƒ½ä»¥ <code>Tab</code> é”®ä½œä¸ºå¼€å§‹ï¼ˆä¸ç„¶å°±è¢«è®¤ä¸ºæ˜¯å‘½ä»¤ï¼‰ã€‚è€Œæ³¨é‡Šç¬¦ <code>#</code> åŒæ ·ä¹Ÿæ˜¯å®‰å…¨çš„ã€‚ <code>else</code> å’Œ <code>endif</code> ä¹Ÿä¸€æ ·ï¼Œåªè¦ä¸æ˜¯ä»¥ <code>Tab</code> é”®å¼€å§‹å°±è¡Œäº†ã€‚</p>
</li>
</ul>
<h2 id="ä½¿ç”¨å‡½æ•°"><a href="#ä½¿ç”¨å‡½æ•°" class="headerlink" title="ä½¿ç”¨å‡½æ•°"></a>ä½¿ç”¨å‡½æ•°</h2><h3 id="å‡½æ•°çš„è°ƒç”¨è¯­æ³•"><a href="#å‡½æ•°çš„è°ƒç”¨è¯­æ³•" class="headerlink" title="å‡½æ•°çš„è°ƒç”¨è¯­æ³•"></a>å‡½æ•°çš„è°ƒç”¨è¯­æ³•</h3><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">$(&lt;function&gt; &lt;arguments&gt;)</span><br><span class="line">$&#123;&lt;function&gt; &lt;arguments&gt;&#125;</span><br></pre></td></tr></table></figure>

<p><code> &lt;function&gt;</code> å°±æ˜¯å‡½æ•°å,<code>&lt;arguments&gt;</code> ä¸ºå‡½æ•°çš„å‚æ•°ã€‚å‚æ•°é—´ä»¥é€—å· , åˆ†éš”ï¼Œè€Œå‡½æ•°åå’Œå‚æ•°ä¹‹é—´ä»¥â€œç©ºæ ¼â€åˆ†éš”ã€‚</p>
<h3 id="å­—ç¬¦ä¸²å¤„ç†å‡½æ•°"><a href="#å­—ç¬¦ä¸²å¤„ç†å‡½æ•°" class="headerlink" title="å­—ç¬¦ä¸²å¤„ç†å‡½æ•°"></a>å­—ç¬¦ä¸²å¤„ç†å‡½æ•°</h3><ul>
<li><p>subst</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">subst</span> &lt;from&gt;,&lt;to&gt;,&lt;text&gt;)</span></span><br><span class="line"><span class="comment"># æŠŠå­—ä¸² &lt;text&gt; ä¸­çš„ &lt;from&gt; å­—ç¬¦ä¸²æ›¿æ¢æˆ &lt;to&gt; ã€‚</span></span><br></pre></td></tr></table></figure></li>
<li><p>patsubst</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">patsubst</span> &lt;pattern&gt;,&lt;replacement&gt;,&lt;text&gt;)</span></span><br><span class="line"><span class="comment"># æŸ¥æ‰¾ &lt;text&gt; ä¸­çš„å•è¯ï¼ˆå•è¯ä»¥â€œç©ºæ ¼â€ã€â€œTabâ€æˆ–â€œå›è½¦â€â€œæ¢è¡Œâ€åˆ†éš”ï¼‰æ˜¯å¦ç¬¦åˆæ¨¡å¼ &lt;pattern&gt; ï¼Œå¦‚æœåŒ¹é…çš„è¯ï¼Œåˆ™ä»¥ &lt;replacement&gt; æ›¿æ¢ã€‚</span></span><br></pre></td></tr></table></figure></li>
<li><p>strip</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">strip</span> &lt;string&gt;)</span></span><br><span class="line"><span class="comment"># å»æ‰ &lt;string&gt; å­—ä¸²ä¸­å¼€å¤´å’Œç»“å°¾çš„ç©ºå­—ç¬¦ã€‚</span></span><br></pre></td></tr></table></figure></li>
<li><p>findstring</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">findstring</span> &lt;find&gt;,&lt;in&gt;)</span></span><br><span class="line"><span class="comment"># å¦‚æœæ‰¾åˆ°ï¼Œé‚£ä¹ˆè¿”å› &lt;find&gt; ï¼Œå¦åˆ™è¿”å›ç©ºå­—ç¬¦ä¸²ã€‚</span></span><br></pre></td></tr></table></figure></li>
<li><p>filter</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">filter</span> &lt;pattern...&gt;,&lt;text&gt;)</span></span><br><span class="line"><span class="comment"># åŠŸèƒ½ï¼šä»¥ &lt;pattern&gt; æ¨¡å¼è¿‡æ»¤ &lt;text&gt; å­—ç¬¦ä¸²ä¸­çš„å•è¯ï¼Œä¿ç•™ç¬¦åˆæ¨¡å¼ &lt;pattern&gt; çš„å•è¯ã€‚å¯ä»¥æœ‰å¤šä¸ªæ¨¡å¼ã€‚</span></span><br></pre></td></tr></table></figure></li>
<li><p>filter-out</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">filter</span>-out &lt;pattern...&gt;,&lt;text&gt;)</span></span><br><span class="line"><span class="comment"># ä»¥ &lt;pattern&gt; æ¨¡å¼è¿‡æ»¤ &lt;text&gt; å­—ç¬¦ä¸²ä¸­çš„å•è¯ï¼Œå»é™¤ç¬¦åˆæ¨¡å¼ &lt;pattern&gt; çš„å•è¯ã€‚å¯ä»¥æœ‰å¤šä¸ªæ¨¡å¼ã€‚</span></span><br></pre></td></tr></table></figure></li>
<li><p>sort</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">sort</span> &lt;list&gt;)</span></span><br><span class="line"><span class="comment"># ç»™å­—ç¬¦ä¸² &lt;list&gt; ä¸­çš„å•è¯æ’åºï¼ˆå‡åºï¼‰</span></span><br></pre></td></tr></table></figure></li>
<li><p>word</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">word</span> &lt;n&gt;,&lt;text&gt;)</span></span><br><span class="line"><span class="comment"># å–å­—ç¬¦ä¸² &lt;text&gt; ä¸­ç¬¬ &lt;n&gt; ä¸ªå•è¯ã€‚ï¼ˆä»ä¸€å¼€å§‹ï¼‰</span></span><br></pre></td></tr></table></figure></li>
<li><p>wordlist</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">wordlist</span> &lt;ss&gt;,&lt;e&gt;,&lt;text&gt;)</span></span><br><span class="line"><span class="comment"># ä»å­—ç¬¦ä¸² &lt;text&gt; ä¸­å–ä» &lt;ss&gt; å¼€å§‹åˆ° &lt;e&gt; çš„å•è¯ä¸²ã€‚ &lt;ss&gt; å’Œ &lt;e&gt; æ˜¯ä¸€ä¸ªæ•°å­—ã€‚</span></span><br></pre></td></tr></table></figure></li>
<li><p>words</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(words &lt;text&gt;)</span></span><br><span class="line"><span class="comment"># è¿”å› &lt;text&gt; ä¸­çš„å•è¯æ•°</span></span><br></pre></td></tr></table></figure></li>
<li><p>firstword</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">firstword</span> &lt;text&gt;)</span></span><br><span class="line"><span class="comment"># è¿”å›å­—ç¬¦ä¸² &lt;text&gt; çš„ç¬¬ä¸€ä¸ªå•è¯ã€‚</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="æ–‡ä»¶åæ“ä½œå‡½æ•°"><a href="#æ–‡ä»¶åæ“ä½œå‡½æ•°" class="headerlink" title="æ–‡ä»¶åæ“ä½œå‡½æ•°"></a>æ–‡ä»¶åæ“ä½œå‡½æ•°</h3><ul>
<li><p>dir</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">dir</span> &lt;names...&gt;)</span></span><br><span class="line"><span class="comment"># ä»æ–‡ä»¶ååºåˆ— &lt;names&gt; ä¸­å–å‡ºç›®å½•éƒ¨åˆ†ã€‚ç›®å½•éƒ¨åˆ†æ˜¯æŒ‡æœ€åä¸€ä¸ªåæ–œæ ï¼ˆ / ï¼‰ä¹‹å‰çš„éƒ¨åˆ†ã€‚å¦‚æœæ²¡æœ‰åæ–œæ ï¼Œé‚£ä¹ˆè¿”å› ./ ã€‚</span></span><br></pre></td></tr></table></figure></li>
<li><p>notdir</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">notdir</span> &lt;names...&gt;)</span></span><br><span class="line"><span class="comment"># ä»æ–‡ä»¶ååºåˆ— &lt;names&gt; ä¸­å–å‡ºéç›®å½•éƒ¨åˆ†ã€‚éç›®å½•éƒ¨åˆ†æ˜¯æŒ‡æœ€å¾Œä¸€ä¸ªåæ–œæ ï¼ˆ / ï¼‰ä¹‹åçš„éƒ¨åˆ†ã€‚</span></span><br></pre></td></tr></table></figure></li>
<li><p>suffix</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">suffix</span> &lt;names...&gt;)</span></span><br><span class="line"><span class="comment"># ä»æ–‡ä»¶ååºåˆ— &lt;names&gt; ä¸­å–å‡ºå„ä¸ªæ–‡ä»¶åçš„åç¼€ã€‚</span></span><br></pre></td></tr></table></figure></li>
<li><p>basename</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">basename</span> &lt;names...&gt;)</span></span><br><span class="line"><span class="comment"># è¿”å›æ–‡ä»¶ååºåˆ— &lt;names&gt; çš„å‰ç¼€åºåˆ—ï¼Œå¦‚æœæ–‡ä»¶æ²¡æœ‰å‰ç¼€ï¼Œåˆ™è¿”å›ç©ºå­—ä¸²ã€‚</span></span><br></pre></td></tr></table></figure></li>
<li><p>addsuffix</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">addsuffix</span> &lt;<span class="built_in">suffix</span>&gt;,&lt;names...&gt;)</span></span><br><span class="line"><span class="comment"># æŠŠåç¼€ &lt;suffix&gt; åŠ åˆ° &lt;names&gt; ä¸­çš„æ¯ä¸ªå•è¯åé¢ã€‚</span></span><br></pre></td></tr></table></figure></li>
<li><p>addprefix</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">addprefix</span> &lt;prefix&gt;,&lt;names...&gt;)</span></span><br><span class="line"><span class="comment"># æŠŠå‰ç¼€ &lt;prefix&gt; åŠ åˆ° &lt;names&gt; ä¸­çš„æ¯ä¸ªå•è¯å‰é¢ã€‚</span></span><br></pre></td></tr></table></figure></li>
<li><p>join</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">join</span> &lt;list1&gt;,&lt;list2&gt;)</span></span><br><span class="line"><span class="comment"># æŠŠ &lt;list2&gt; ä¸­çš„å•è¯å¯¹åº”åœ°åŠ åˆ° &lt;list1&gt; çš„å•è¯åé¢ã€‚</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="foreachå‡½æ•°"><a href="#foreachå‡½æ•°" class="headerlink" title="foreachå‡½æ•°"></a>foreachå‡½æ•°</h3><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">foreach</span> &lt;var&gt;,&lt;list&gt;,&lt;text&gt;)</span></span><br><span class="line"><span class="comment"># è¿™ä¸ªå‡½æ•°çš„æ„æ€æ˜¯ï¼ŒæŠŠå‚æ•° &lt;list&gt; ä¸­çš„å•è¯é€ä¸€å–å‡ºæ”¾åˆ°å‚æ•° &lt;var&gt; æ‰€æŒ‡å®šçš„å˜é‡ä¸­ï¼Œç„¶åå†æ‰§è¡Œ &lt;text&gt; æ‰€åŒ…å«çš„è¡¨è¾¾å¼ã€‚æ¯ä¸€æ¬¡ &lt;text&gt; ä¼šè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¾ªç¯è¿‡ç¨‹ä¸­ï¼Œ &lt;text&gt; çš„æ‰€è¿”å›çš„æ¯ä¸ªå­—ç¬¦ä¸²ä¼šä»¥ç©ºæ ¼åˆ†éš”ï¼Œæœ€åå½“æ•´ä¸ªå¾ªç¯ç»“æŸæ—¶ï¼Œ &lt;text&gt; æ‰€è¿”å›çš„æ¯ä¸ªå­—ç¬¦ä¸²æ‰€ç»„æˆçš„æ•´ä¸ªå­—ç¬¦ä¸²ï¼ˆä»¥ç©ºæ ¼åˆ†éš”ï¼‰å°†ä¼šæ˜¯foreachå‡½æ•°çš„è¿”å›å€¼ã€‚</span></span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼Œforeachä¸­çš„ <code>&lt;var&gt;</code> å‚æ•°æ˜¯ä¸€ä¸ªä¸´æ—¶çš„å±€éƒ¨å˜é‡ï¼Œforeachå‡½æ•°æ‰§è¡Œå®Œåï¼Œå‚æ•° <code>&lt;var&gt;</code> çš„å˜é‡å°†ä¸åœ¨ä½œç”¨ï¼Œå…¶ä½œç”¨åŸŸåªåœ¨foreachå‡½æ•°å½“ä¸­ã€‚</p>
<h3 id="ifå‡½æ•°"><a href="#ifå‡½æ•°" class="headerlink" title="ifå‡½æ•°"></a>ifå‡½æ•°</h3><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">if</span> &lt;condition&gt;,&lt;then-part&gt;)</span></span><br><span class="line"><span class="variable">$(<span class="built_in">if</span> &lt;condition&gt;,&lt;then-part&gt;,&lt;else-part&gt;)</span></span><br><span class="line"><span class="comment"># å¦‚æœ &lt;condition&gt; ä¸ºçœŸï¼ˆéç©ºå­—ç¬¦ä¸²ï¼‰ï¼Œé‚£ä¸ª &lt;then-part&gt; ä¼šæ˜¯æ•´ä¸ªå‡½æ•°çš„è¿”å›å€¼ï¼Œå¦‚æœ &lt;condition&gt; ä¸ºå‡ï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰ï¼Œé‚£ä¹ˆ &lt;else-part&gt; ä¼šæ˜¯æ•´ä¸ªå‡½æ•°çš„è¿”å›å€¼ï¼Œæ­¤æ—¶å¦‚æœ &lt;else-part&gt; æ²¡æœ‰è¢«å®šä¹‰ï¼Œé‚£ä¹ˆï¼Œæ•´ä¸ªå‡½æ•°è¿”å›ç©ºå­—ä¸²ã€‚</span></span><br></pre></td></tr></table></figure>

<h3 id="callå‡½æ•°"><a href="#callå‡½æ•°" class="headerlink" title="callå‡½æ•°"></a>callå‡½æ•°</h3><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">call</span> &lt;expression&gt;,&lt;parm1&gt;,&lt;parm2&gt;,...,&lt;parmn&gt;)</span></span><br><span class="line"><span class="comment"># å½“makeæ‰§è¡Œè¿™ä¸ªå‡½æ•°æ—¶ï¼Œ &lt;expression&gt; å‚æ•°ä¸­çš„å˜é‡ï¼Œå¦‚ $(1) ã€ $(2) ç­‰ï¼Œä¼šè¢«å‚æ•° &lt;parm1&gt; ã€ &lt;parm2&gt; ã€ &lt;parm3&gt; ä¾æ¬¡å–ä»£ã€‚è€Œ &lt;expression&gt; çš„è¿”å›å€¼å°±æ˜¯ call å‡½æ•°çš„è¿”å›å€¼ã€‚</span></span><br><span class="line">reverse =  $(1) $(2)</span><br><span class="line">foo = <span class="variable">$(<span class="built_in">call</span> reverse,a,b)</span></span><br></pre></td></tr></table></figure>

<h3 id="originå‡½æ•°"><a href="#originå‡½æ•°" class="headerlink" title="originå‡½æ•°"></a>originå‡½æ•°</h3><p>originå‡½æ•°ä¸åƒå…¶å®ƒçš„å‡½æ•°ï¼Œä»–å¹¶ä¸æ“ä½œå˜é‡çš„å€¼ï¼Œä»–åªæ˜¯å‘Šè¯‰ä½ ä½ çš„è¿™ä¸ªå˜é‡æ˜¯å“ªé‡Œæ¥çš„</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">origin</span> &lt;variable&gt;)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>å¦‚æœ <code>&lt;variable&gt;</code> ä»æ¥æ²¡æœ‰å®šä¹‰è¿‡ï¼Œoriginå‡½æ•°è¿”å›è¿™ä¸ªå€¼ <code>undefined</code></li>
<li>å¦‚æœ <code>&lt;variable&gt;</code> æ˜¯ä¸€ä¸ªé»˜è®¤çš„å®šä¹‰ï¼Œæ¯”å¦‚â€œCCâ€è¿™ä¸ªå˜é‡ï¼Œè¿”å›<code>default</code></li>
<li>å¦‚æœ <code>&lt;variable&gt;</code> æ˜¯ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œè¿”å›<code>environment</code></li>
<li>å¦‚æœ <code>&lt;variable&gt;</code> è¿™ä¸ªå˜é‡è¢«å®šä¹‰åœ¨Makefileä¸­ã€‚è¿”å›<code>file</code></li>
<li>å¦‚æœ <code>&lt;variable&gt;</code> è¿™ä¸ªå˜é‡æ˜¯è¢«å‘½ä»¤è¡Œå®šä¹‰çš„ã€‚è¿”å›<code>command line</code></li>
<li>å¦‚æœ <code>&lt;variable&gt;</code> æ˜¯è¢«overrideæŒ‡ç¤ºç¬¦é‡æ–°å®šä¹‰çš„ã€‚<code>override</code></li>
<li>å¦‚æœ <code>&lt;variable&gt;</code> æ˜¯ä¸€ä¸ªå‘½ä»¤è¿è¡Œä¸­çš„è‡ªåŠ¨åŒ–å˜é‡ã€‚<code>automatic</code></li>
</ul>
<h3 id="shellå‡½æ•°"><a href="#shellå‡½æ•°" class="headerlink" title="shellå‡½æ•°"></a>shellå‡½æ•°</h3><p>shellå‡½æ•°ä¹Ÿä¸åƒå…¶å®ƒçš„å‡½æ•°ã€‚é¡¾åæ€ä¹‰ï¼Œå®ƒçš„å‚æ•°åº”è¯¥å°±æ˜¯æ“ä½œç³»ç»ŸShellçš„å‘½ä»¤ã€‚å®ƒå’Œåå¼•å·â€œ`â€æ˜¯ç›¸åŒçš„åŠŸèƒ½ã€‚è¿™å°±æ˜¯è¯´ï¼Œshellå‡½æ•°æŠŠæ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤åçš„è¾“å‡ºä½œä¸ºå‡½æ•°è¿”å›ã€‚</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">contents := <span class="variable">$(<span class="built_in">shell</span> cat foo)</span></span><br><span class="line">files := <span class="variable">$(<span class="built_in">shell</span> echo *.c)</span></span><br></pre></td></tr></table></figure>

<h3 id="æ§åˆ¶makeçš„å‡½æ•°"><a href="#æ§åˆ¶makeçš„å‡½æ•°" class="headerlink" title="æ§åˆ¶makeçš„å‡½æ•°"></a>æ§åˆ¶makeçš„å‡½æ•°</h3><p>makeæä¾›äº†ä¸€äº›å‡½æ•°æ¥æ§åˆ¶makeçš„è¿è¡Œã€‚é€šå¸¸ï¼Œä½ éœ€è¦æ£€æµ‹ä¸€äº›è¿è¡ŒMakefileæ—¶çš„è¿è¡Œæ—¶ä¿¡æ¯ï¼Œå¹¶ä¸”æ ¹æ®è¿™äº›ä¿¡æ¯æ¥å†³å®šï¼Œä½ æ˜¯è®©makeç»§ç»­æ‰§è¡Œï¼Œè¿˜æ˜¯åœæ­¢ã€‚</p>
<ul>
<li>äº§ç”Ÿé”™è¯¯<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">error</span> &lt;text ...&gt;)</span></span><br></pre></td></tr></table></figure></li>
<li>äº§ç”Ÿwarning<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">warning</span> &lt;text ...&gt;)</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="makeçš„è¿è¡Œ"><a href="#makeçš„è¿è¡Œ" class="headerlink" title="makeçš„è¿è¡Œ"></a>makeçš„è¿è¡Œ</h2><h3 id="makeçš„é€€å‡ºç "><a href="#makeçš„é€€å‡ºç " class="headerlink" title="makeçš„é€€å‡ºç "></a>makeçš„é€€å‡ºç </h3><p>makefileæ‰§è¡Œå‘½ä»¤åæœ‰ä¸‰ä¸ªé”™è¯¯ç </p>
<ul>
<li>0:<ul>
<li>è¡¨ç¤ºæˆåŠŸæ‰§è¡Œ</li>
</ul>
</li>
<li>1:<ul>
<li>å¦‚æœmakeè¿è¡Œæ—¶å‡ºç°ä»»ä½•é”™è¯¯ï¼Œå…¶è¿”å›1ã€‚</li>
</ul>
</li>
<li>2:<ul>
<li>å¦‚æœä½ ä½¿ç”¨äº†makeçš„â€œ-qâ€é€‰é¡¹ï¼Œå¹¶ä¸”makeä½¿å¾—ä¸€äº›ç›®æ ‡ä¸éœ€è¦æ›´æ–°ï¼Œé‚£ä¹ˆè¿”å›2ã€‚</li>
</ul>
</li>
</ul>
<h3 id="æŒ‡å®šmakefileæ–‡ä»¶"><a href="#æŒ‡å®šmakefileæ–‡ä»¶" class="headerlink" title="æŒ‡å®šmakefileæ–‡ä»¶"></a>æŒ‡å®šmakefileæ–‡ä»¶</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make â€“f hchen.mk</span><br></pre></td></tr></table></figure>
<h3 id="æŒ‡å®šç›®æ ‡"><a href="#æŒ‡å®šç›®æ ‡" class="headerlink" title="æŒ‡å®šç›®æ ‡"></a>æŒ‡å®šç›®æ ‡</h3><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: all</span></span><br><span class="line"><span class="section">all: prog1 prog2 prog3 prog4</span></span><br><span class="line"><span class="comment"># æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ â€œmake prog2â€æ¥å•ç‹¬ç¼–è¯‘ç›®æ ‡â€œprog2â€ã€‚</span></span><br></pre></td></tr></table></figure>

<h3 id="æ£€æŸ¥è§„åˆ™"><a href="#æ£€æŸ¥è§„åˆ™" class="headerlink" title="æ£€æŸ¥è§„åˆ™"></a>æ£€æŸ¥è§„åˆ™</h3><ul>
<li>-n, â€“just-print, â€“dry-run, â€“recon<br>ä¸æ‰§è¡Œå‚æ•°ï¼Œè¿™äº›å‚æ•°åªæ˜¯æ‰“å°å‘½ä»¤ï¼Œä¸ç®¡ç›®æ ‡æ˜¯å¦æ›´æ–°ï¼ŒæŠŠè§„åˆ™å’Œè¿å¸¦è§„åˆ™ä¸‹çš„å‘½ä»¤æ‰“å°å‡ºæ¥ï¼Œä½†ä¸æ‰§è¡Œã€‚</li>
<li>-t, â€“touch<br>è¿™ä¸ªå‚æ•°çš„æ„æ€å°±æ˜¯æŠŠç›®æ ‡æ–‡ä»¶çš„æ—¶é—´æ›´æ–°ï¼Œä½†ä¸æ›´æ”¹ç›®æ ‡æ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œmakeå‡è£…ç¼–è¯‘ç›®æ ‡ï¼Œä½†ä¸æ˜¯çœŸæ­£çš„ç¼–è¯‘ç›®æ ‡ï¼Œåªæ˜¯æŠŠç›®æ ‡å˜æˆå·²ç¼–è¯‘è¿‡çš„çŠ¶æ€ã€‚</li>
<li>-q, â€“question<br>è¿™ä¸ªå‚æ•°çš„è¡Œä¸ºæ˜¯æ‰¾ç›®æ ‡çš„æ„æ€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœç›®æ ‡å­˜åœ¨ï¼Œé‚£ä¹ˆå…¶ä»€ä¹ˆä¹Ÿä¸ä¼šè¾“å‡ºï¼Œå½“ç„¶ä¹Ÿä¸ä¼šæ‰§è¡Œç¼–è¯‘ï¼Œå¦‚æœç›®æ ‡ä¸å­˜åœ¨ï¼Œå…¶ä¼šæ‰“å°å‡ºä¸€æ¡å‡ºé”™ä¿¡æ¯ã€‚</li>
<li>-W&lt;file&gt;, â€“what-if=&lt;file&gt;, â€“assume-new=&lt;file&gt;, â€“new-file=&lt;file&gt;<br>è¿™ä¸ªå‚æ•°éœ€è¦æŒ‡å®šä¸€ä¸ªæ–‡ä»¶ã€‚ä¸€èˆ¬æ˜¯æ˜¯æºæ–‡ä»¶ï¼ˆæˆ–ä¾èµ–æ–‡ä»¶ï¼‰ï¼ŒMakeä¼šæ ¹æ®è§„åˆ™æ¨å¯¼æ¥è¿è¡Œä¾èµ–äºè¿™ä¸ªæ–‡ä»¶çš„å‘½ä»¤ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå¯ä»¥å’Œâ€œ-nâ€å‚æ•°ä¸€åŒä½¿ç”¨ï¼Œæ¥æŸ¥çœ‹è¿™ä¸ªä¾èµ–æ–‡ä»¶æ‰€å‘ç”Ÿçš„è§„åˆ™å‘½ä»¤ã€‚</li>
</ul>
<h2 id="éšå«è§„åˆ™"><a href="#éšå«è§„åˆ™" class="headerlink" title="éšå«è§„åˆ™"></a>éšå«è§„åˆ™</h2><p>â€œéšå«è§„åˆ™â€ä¹Ÿå°±æ˜¯ä¸€ç§æƒ¯ä¾‹ï¼Œmakeä¼šæŒ‰ç…§è¿™ç§â€œæƒ¯ä¾‹â€å¿ƒç…§ä¸å–§åœ°æ¥è¿è¡Œï¼Œé‚£æ€•æˆ‘ä»¬çš„Makefileä¸­æ²¡æœ‰ä¹¦å†™è¿™æ ·çš„è§„åˆ™ã€‚ä¾‹å¦‚ï¼ŒæŠŠ .c æ–‡ä»¶ç¼–è¯‘æˆ .o æ–‡ä»¶è¿™ä¸€è§„åˆ™ï¼Œä½ æ ¹æœ¬å°±ä¸ç”¨å†™å‡ºæ¥ï¼Œmakeä¼šè‡ªåŠ¨æ¨å¯¼å‡ºè¿™ç§è§„åˆ™ï¼Œå¹¶ç”Ÿæˆæˆ‘ä»¬éœ€è¦çš„ .o æ–‡ä»¶ã€‚</p>
<h3 id="ä½¿ç”¨éšå«è§„åˆ™"><a href="#ä½¿ç”¨éšå«è§„åˆ™" class="headerlink" title="ä½¿ç”¨éšå«è§„åˆ™"></a>ä½¿ç”¨éšå«è§„åˆ™</h3><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">foo : foo.o bar.o</span><br><span class="line">    cc â€“o foo foo.o bar.o <span class="variable">$(CFLAGS)</span> <span class="variable">$(LDFLAGS)</span></span><br><span class="line"><span class="comment"># å› ä¸ºmakeçš„â€œéšå«è§„åˆ™â€åŠŸèƒ½ä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬è‡ªåŠ¨å»æ¨å¯¼è¿™ä¸¤ä¸ªç›®æ ‡çš„ä¾èµ–ç›®æ ‡å’Œç”Ÿæˆå‘½ä»¤ã€‚</span></span><br><span class="line">foo.o : foo.c</span><br><span class="line">    cc â€“c foo.c <span class="variable">$(CFLAGS)</span></span><br><span class="line">bar.o : bar.c</span><br><span class="line">    cc â€“c bar.c <span class="variable">$(CFLAGS)</span></span><br></pre></td></tr></table></figure>
<h3 id="éšå«è§„åˆ™ä½¿ç”¨çš„å˜é‡"><a href="#éšå«è§„åˆ™ä½¿ç”¨çš„å˜é‡" class="headerlink" title="éšå«è§„åˆ™ä½¿ç”¨çš„å˜é‡"></a>éšå«è§„åˆ™ä½¿ç”¨çš„å˜é‡</h3><p>æˆ‘ä»¬å¯ä»¥æŠŠéšå«è§„åˆ™ä¸­ä½¿ç”¨çš„å˜é‡åˆ†æˆä¸¤ç§ï¼šä¸€ç§æ˜¯å‘½ä»¤ç›¸å…³çš„ï¼Œå¦‚ <code>CC</code> ï¼›ä¸€ç§æ˜¯å‚æ•°ç›¸çš„å…³ï¼Œå¦‚ <code>CFLAGS</code> ã€‚<br>ä¸‹é¢æ˜¯æ‰€æœ‰éšå«è§„åˆ™ä¸­ä¼šç”¨åˆ°çš„å˜é‡ï¼š</p>
<ul>
<li>å‘½ä»¤çš„å˜é‡<ul>
<li>CC : Cè¯­è¨€ç¼–è¯‘ç¨‹åºã€‚é»˜è®¤å‘½ä»¤æ˜¯ cc</li>
<li>CXX : C++è¯­è¨€ç¼–è¯‘ç¨‹åºã€‚é»˜è®¤å‘½ä»¤æ˜¯ g++</li>
<li>ç­‰ç­‰</li>
</ul>
</li>
<li>å‘½ä»¤å‚æ•°çš„å˜é‡<ul>
<li>CFLAGS : Cè¯­è¨€ç¼–è¯‘å™¨å‚æ•°ã€‚</li>
<li>CXXFLAGS : C++è¯­è¨€ç¼–è¯‘å™¨å‚æ•°</li>
<li>ç­‰ç­‰</li>
</ul>
</li>
</ul>
<h3 id="éšå«è§„åˆ™é“¾"><a href="#éšå«è§„åˆ™é“¾" class="headerlink" title="éšå«è§„åˆ™é“¾"></a>éšå«è§„åˆ™é“¾</h3><p>æœ‰äº›æ—¶å€™ï¼Œä¸€ä¸ªç›®æ ‡å¯èƒ½è¢«ä¸€ç³»åˆ—çš„éšå«è§„åˆ™æ‰€ä½œç”¨ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª .o çš„æ–‡ä»¶ç”Ÿæˆï¼Œå¯èƒ½ä¼šæ˜¯å…ˆè¢« Yaccçš„[.y]æ–‡ä»¶å…ˆæˆ .c ï¼Œç„¶åå†è¢«Cçš„ç¼–è¯‘å™¨ç”Ÿæˆã€‚æˆ‘ä»¬æŠŠè¿™ä¸€ç³»åˆ—çš„éšå«è§„åˆ™å«åšâ€œéšå«è§„åˆ™é“¾â€ã€‚</p>
<h3 id="å®šä¹‰æ¨¡å¼è§„åˆ™"><a href="#å®šä¹‰æ¨¡å¼è§„åˆ™" class="headerlink" title="å®šä¹‰æ¨¡å¼è§„åˆ™"></a>å®šä¹‰æ¨¡å¼è§„åˆ™</h3><p>ä½ å¯ä»¥ä½¿ç”¨æ¨¡å¼è§„åˆ™æ¥å®šä¹‰ä¸€ä¸ªéšå«è§„åˆ™ã€‚ä¸€ä¸ªæ¨¡å¼è§„åˆ™å°±å¥½åƒä¸€ä¸ªä¸€èˆ¬çš„è§„åˆ™ï¼Œåªæ˜¯åœ¨è§„åˆ™ä¸­ï¼Œç›®æ ‡çš„å®šä¹‰éœ€è¦æœ‰ % å­—ç¬¦ã€‚ % çš„æ„æ€æ˜¯è¡¨ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªä»»æ„å­—ç¬¦ã€‚<br>æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ % çš„å±•å¼€å‘ç”Ÿåœ¨å˜é‡å’Œå‡½æ•°çš„å±•å¼€ä¹‹åï¼Œå˜é‡å’Œå‡½æ•°çš„å±•å¼€å‘ç”Ÿåœ¨makeè½½å…¥ Makefileæ—¶ï¼Œè€Œæ¨¡å¼è§„åˆ™ä¸­çš„ % åˆ™å‘ç”Ÿåœ¨è¿è¡Œæ—¶ã€‚</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">%.o : %.c ; &lt;command ......&gt;;</span><br><span class="line"><span class="comment"># å…¶å«ä¹‰æ˜¯ï¼ŒæŒ‡å‡ºäº†æ€ä¹ˆä»æ‰€æœ‰çš„ .c æ–‡ä»¶ç”Ÿæˆç›¸åº”çš„ .o æ–‡ä»¶çš„è§„åˆ™ã€‚å¦‚æœè¦ç”Ÿæˆçš„ç›®æ ‡æ˜¯ a.o b.o ï¼Œé‚£ä¹ˆ %c å°±æ˜¯ a.c b.c ã€‚</span></span><br></pre></td></tr></table></figure>
<h4 id="æ¨¡å¼è§„åˆ™ç¤ºä¾‹"><a href="#æ¨¡å¼è§„åˆ™ç¤ºä¾‹" class="headerlink" title="æ¨¡å¼è§„åˆ™ç¤ºä¾‹"></a>æ¨¡å¼è§„åˆ™ç¤ºä¾‹</h4><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">%.o : %.c</span><br><span class="line">    <span class="variable">$(CC)</span> -c <span class="variable">$(CFLAGS)</span> <span class="variable">$(CPPFLAGS)</span> <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>$@</code> : è¡¨ç¤ºæ‰€æœ‰çš„ç›®æ ‡çš„æŒ¨ä¸ªå€¼</li>
<li><code>$&lt;</code> : è¡¨ç¤ºäº†æ‰€æœ‰ä¾èµ–ç›®æ ‡çš„æŒ¨ä¸ªå€¼</li>
</ul>
<h4 id="è‡ªåŠ¨åŒ–å˜é‡-1"><a href="#è‡ªåŠ¨åŒ–å˜é‡-1" class="headerlink" title="è‡ªåŠ¨åŒ–å˜é‡"></a>è‡ªåŠ¨åŒ–å˜é‡</h4><p>å¦‚ä½•ä¹¦å†™ä¸€ä¸ªå‘½ä»¤æ¥å®Œæˆä»ä¸åŒçš„ä¾èµ–æ–‡ä»¶ç”Ÿæˆç›¸åº”çš„ç›®æ ‡ï¼Ÿå› ä¸ºåœ¨æ¯ä¸€æ¬¡çš„å¯¹æ¨¡å¼è§„åˆ™çš„è§£ææ—¶ï¼Œéƒ½ä¼šæ˜¯ä¸åŒçš„ç›®æ ‡å’Œä¾èµ–æ–‡ä»¶ã€‚è‡ªåŠ¨åŒ–å˜é‡å°±æ˜¯å®Œæˆè¿™ä¸ªåŠŸèƒ½çš„ã€‚</p>
<ul>
<li><code>$@</code> : è¡¨ç¤ºè§„åˆ™ä¸­çš„ç›®æ ‡æ–‡ä»¶é›†ã€‚åœ¨æ¨¡å¼è§„åˆ™ä¸­ï¼Œå¦‚æœæœ‰å¤šä¸ªç›®æ ‡ï¼Œé‚£ä¹ˆï¼Œ <code>$@</code> å°±æ˜¯åŒ¹é…äºç›®æ ‡ä¸­æ¨¡å¼å®šä¹‰çš„é›†åˆã€‚</li>
<li><code>$%</code> : ä»…å½“ç›®æ ‡æ˜¯å‡½æ•°åº“æ–‡ä»¶ä¸­ï¼Œè¡¨ç¤ºè§„åˆ™ä¸­çš„ç›®æ ‡æˆå‘˜åã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªç›®æ ‡æ˜¯ <code>foo.a(bar.o)</code> ï¼Œé‚£ä¹ˆï¼Œ <code>$%</code> å°±æ˜¯ bar.o ï¼Œ <code>$@</code> å°±æ˜¯ foo.a ã€‚</li>
<li><code>$&lt;</code> : ä¾èµ–ç›®æ ‡ä¸­çš„ç¬¬ä¸€ä¸ªç›®æ ‡åå­—ã€‚å¦‚æœä¾èµ–ç›®æ ‡æ˜¯ä»¥æ¨¡å¼ï¼ˆå³ % ï¼‰å®šä¹‰çš„ï¼Œé‚£ä¹ˆ <code>$&lt;</code> å°†æ˜¯ç¬¦åˆæ¨¡å¼çš„ä¸€ç³»åˆ—çš„æ–‡ä»¶é›†ã€‚</li>
<li><code>$?</code> : æ‰€æœ‰æ¯”ç›®æ ‡æ–°çš„ä¾èµ–ç›®æ ‡çš„é›†åˆã€‚ä»¥ç©ºæ ¼åˆ†éš”ã€‚</li>
<li><code>$^</code> : æ‰€æœ‰çš„ä¾èµ–ç›®æ ‡çš„é›†åˆã€‚ä»¥ç©ºæ ¼åˆ†éš”ã€‚é‚£ä¹ˆè¿™ä¸ªå˜é‡ä¼šå»é™¤é‡å¤çš„ä¾èµ–ç›®æ ‡ï¼Œåªä¿ç•™ä¸€ä»½ã€‚</li>
<li><code>$+</code> : è¿™ä¸ªå˜é‡å¾ˆåƒ <code>$^</code> ï¼Œä¹Ÿæ˜¯æ‰€æœ‰ä¾èµ–ç›®æ ‡çš„é›†åˆã€‚åªæ˜¯å®ƒä¸å»é™¤é‡å¤çš„ä¾èµ–ç›®æ ‡ã€‚</li>
<li><code>$*</code> : è¿™ä¸ªå˜é‡è¡¨ç¤ºç›®æ ‡æ¨¡å¼ä¸­ <code>%</code> åŠå…¶ä¹‹å‰çš„éƒ¨åˆ†ã€‚å¦‚æœç›®æ ‡ä¸­æ²¡æœ‰æ¨¡å¼çš„å®šä¹‰ï¼Œé‚£ä¹ˆ $* ä¹Ÿå°±ä¸èƒ½è¢«æ¨å¯¼å‡ºï¼Œä½†æ˜¯ï¼Œå¦‚æœç›®æ ‡æ–‡ä»¶çš„åç¼€æ˜¯makeæ‰€è¯†åˆ«çš„ï¼Œé‚£ä¹ˆ $* å°±æ˜¯é™¤äº†åç¼€çš„é‚£ä¸€éƒ¨åˆ†ã€‚</li>
</ul>
<p>ä¸‹é¢æ˜¯å¯¹äºä¸Šé¢çš„ä¸ƒä¸ªå˜é‡åˆ†åˆ«åŠ ä¸Š D æˆ–æ˜¯ F çš„å«ä¹‰ï¼š</p>
<ul>
<li><code>$(@D)</code><br>è¡¨ç¤º <code>$@</code> çš„ç›®å½•éƒ¨åˆ†ï¼ˆä¸ä»¥æ–œæ ä½œä¸ºç»“å°¾ï¼‰ï¼Œå¦‚æœ <code>$@</code> å€¼æ˜¯ dir/foo.o ï¼Œé‚£ä¹ˆ <code>$(@D)</code> å°±æ˜¯ dir ï¼Œè€Œå¦‚æœ <code>$@</code> ä¸­æ²¡æœ‰åŒ…å«æ–œæ çš„è¯ï¼Œå…¶å€¼å°±æ˜¯ . ï¼ˆå½“å‰ç›®å½•ï¼‰ã€‚</li>
<li><code>$(@F)</code><br>è¡¨ç¤º <code>$@</code> çš„æ–‡ä»¶éƒ¨åˆ†ï¼Œå¦‚æœ <code>$@</code> å€¼æ˜¯ dir/foo.o ï¼Œé‚£ä¹ˆ <code>$(@F)</code> å°±æ˜¯ foo.o ï¼Œ <code>$(@F)</code> ç›¸å½“äºå‡½æ•° <code>$(notdir $@)</code> ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>makefile</category>
      </categories>
      <tags>
        <tag>makefile</tag>
      </tags>
  </entry>
  <entry>
    <title>obsidian_markdown</title>
    <url>/2022/02/09/obsidian-markdown/</url>
    <content><![CDATA[<hr>
<p>ç”±äºtyporaæ”¶è´¹äº†ï¼Œæ”¹ç”¨obsidianã€‚obisidiançš„markdownè¯­æ³•ç¨å¾®æœ‰äº›ä¸ä¸€æ ·ï¼Œç‰¹åˆ«æ˜¯å›¾ç‰‡çš„æ’å…¥ï¼Œå› æ­¤åŸå…ˆçš„ä¸€å¥—åšå®¢ç³»ç»Ÿçš„å›¾ç‰‡ç®¡ç†æ–¹å¼éœ€è¦å˜åŒ–ã€‚å› æ­¤è¯¥æ–‡ç« ä¸»è¦ç”¨æ¥æµ‹è¯•å›¾ç‰‡æ’å…¥ä¸ç°åœ¨çš„åšå®¢ç³»ç»Ÿå¦‚ä½•å…¼å®¹ï¼Œé¡ºé“ç³»ç»Ÿå­¦ä¹ ä¸‹markdownè¯­æ³•ã€‚</p>
<span id="more"></span>
<!-- toc -->

<p>[toc]</p>
<h2 id="æ ‡é¢˜"><a href="#æ ‡é¢˜" class="headerlink" title="æ ‡é¢˜"></a>æ ‡é¢˜</h2><h3 id="æ ‡é¢˜åˆ†ä¸º6çº§"><a href="#æ ‡é¢˜åˆ†ä¸º6çº§" class="headerlink" title="æ ‡é¢˜åˆ†ä¸º6çº§"></a>æ ‡é¢˜åˆ†ä¸º6çº§</h3><ul>
<li>ä½¿ç”¨<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># ä¸€çº§</span><br><span class="line">## äºŒçº§</span><br><span class="line">###</span><br><span class="line">...</span><br><span class="line">######</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h2><ul>
<li>ä½¿ç”¨æ ¼å¼<br><code>[toc]</code><br>ä½†æ˜¯ä¸æ˜¯æ‰€æœ‰markdownéƒ½æ”¯æŒ</li>
</ul>
<h2 id="æ–œä½“-amp-ç²—ä½“"><a href="#æ–œä½“-amp-ç²—ä½“" class="headerlink" title="æ–œä½“&amp;ç²—ä½“"></a>æ–œä½“&amp;ç²—ä½“</h2><h3 id="æ–œä½“ä½¿ç”¨æ ¼å¼ï¼š"><a href="#æ–œä½“ä½¿ç”¨æ ¼å¼ï¼š" class="headerlink" title="æ–œä½“ä½¿ç”¨æ ¼å¼ï¼š"></a><em>æ–œä½“</em>ä½¿ç”¨æ ¼å¼ï¼š</h3><ol>
<li><code>*æ–‡æœ¬å†…å®¹*</code></li>
<li><code>_æ–‡æœ¬å†…å®¹_</code></li>
</ol>
<h3 id="ç²—ä½“-ä½¿ç”¨æ ¼å¼ï¼š"><a href="#ç²—ä½“-ä½¿ç”¨æ ¼å¼ï¼š" class="headerlink" title="__ç²—ä½“__ä½¿ç”¨æ ¼å¼ï¼š"></a>__ç²—ä½“__ä½¿ç”¨æ ¼å¼ï¼š</h3><ol>
<li><code>**æ–‡æœ¬å†…å®¹**</code></li>
<li><code>__æ–‡æœ¬å†…å®¹__</code></li>
</ol>
<h3 id="ç²—æ–œä½“"><a href="#ç²—æ–œä½“" class="headerlink" title="ç²—æ–œä½“"></a><em><strong>ç²—æ–œä½“</strong></em></h3><p>ä¸‰ä¸ª</p>
<h2 id="çº¿-æ°´å¹³åˆ†å‰²çº¿"><a href="#çº¿-æ°´å¹³åˆ†å‰²çº¿" class="headerlink" title="çº¿-æ°´å¹³åˆ†å‰²çº¿"></a>çº¿-æ°´å¹³åˆ†å‰²çº¿</h2><h3 id="æ°´å¹³åˆ†å‰²çº¿"><a href="#æ°´å¹³åˆ†å‰²çº¿" class="headerlink" title="æ°´å¹³åˆ†å‰²çº¿"></a>æ°´å¹³åˆ†å‰²çº¿</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">***</span><br></pre></td></tr></table></figure>
<p>å®ä¾‹ï¼š</p>
<hr>
<h3 id="æ–‡æœ¬åˆ é™¤çº¿"><a href="#æ–‡æœ¬åˆ é™¤çº¿" class="headerlink" title="æ–‡æœ¬åˆ é™¤çº¿"></a>æ–‡æœ¬åˆ é™¤çº¿</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">~~æ–‡ç« å†…å®¹~~</span><br></pre></td></tr></table></figure>
<p><del>æ–‡ç« å†…å®¹</del></p>
<h3 id="æ–‡æœ¬ä¸‹åˆ’çº¿"><a href="#æ–‡æœ¬ä¸‹åˆ’çº¿" class="headerlink" title="æ–‡æœ¬ä¸‹åˆ’çº¿"></a>æ–‡æœ¬ä¸‹åˆ’çº¿</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;u&gt;æ–‡æœ¬å†…å®¹&lt;/u&gt;</span><br></pre></td></tr></table></figure>
<p>ç¤ºèŒƒ:<br><u>æ–‡æœ¬å†…å®¹</u></p>
<h2 id="åˆ—è¡¨-amp-å¼•ç”¨"><a href="#åˆ—è¡¨-amp-å¼•ç”¨" class="headerlink" title="åˆ—è¡¨&amp;å¼•ç”¨"></a>åˆ—è¡¨&amp;å¼•ç”¨</h2><h3 id="æœ‰åºåˆ—è¡¨"><a href="#æœ‰åºåˆ—è¡¨" class="headerlink" title="æœ‰åºåˆ—è¡¨"></a>æœ‰åºåˆ—è¡¨</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.+ç©ºæ ¼+æ–‡æœ¬å†…å®¹</span><br><span class="line"></span><br><span class="line">1. è¿™æ˜¯ç¬¬ä¸€ä¸ªæœ‰åºåˆ—è¡¨ &lt;!-- (Enter) --&gt;</span><br><span class="line">2. è¿™æ˜¯ç¬¬äºŒä¸ªæœ‰åºåˆ—è¡¨ &lt;!-- (Enter) --&gt;</span><br><span class="line">3. è¿™æ˜¯ç¬¬ä¸‰ä¸ªæœ‰åºåˆ—è¡¨ </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1. è¿™æ˜¯ç¬¬ä¸€ä¸ªæœ‰åºåˆ—è¡¨ &lt;!-- (Shift + Enter) --&gt;</span><br><span class="line">   è¿™æ˜¯åŒä¸ªåˆ—è¡¨ä¸‹ï¼Œå¦èµ·ä¸€è¡Œçš„æ–‡æœ¬å†…å®¹ &lt;!-- (Enter) --&gt;</span><br><span class="line">2. è¿™æ˜¯ç¬¬äºŒä¸ªæœ‰åºåˆ—è¡¨ &lt;!-- (Shift + Enter) --&gt;</span><br><span class="line">   è¿™æ˜¯åŒä¸ªåˆ—è¡¨ä¸‹ï¼Œå¦èµ·ä¸€è¡Œçš„æ–‡æœ¬å†…å®¹ </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="æ— åºåˆ—è¡¨"><a href="#æ— åºåˆ—è¡¨" class="headerlink" title="æ— åºåˆ—è¡¨"></a>æ— åºåˆ—è¡¨</h3><p>æ ¼å¼ï¼š<br><code>- + ç©ºæ ¼ + æ–‡æœ¬å†…å®¹</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- è¿™æ˜¯ç¬¬1ä¸ªæ— åºåˆ—è¡¨ &lt;!-- (Enter) --&gt;</span><br><span class="line">- è¿™æ˜¯ç¬¬2ä¸ªæ— åºåˆ—è¡¨ &lt;!-- (Enter) --&gt;</span><br><span class="line">- è¿™æ˜¯ç¬¬3ä¸ªæ— åºåˆ—è¡¨</span><br><span class="line"></span><br><span class="line">- è¿™æ˜¯ç¬¬ä¸€ä¸ªæ— åºåˆ—è¡¨ &lt;!-- (Shift + Enter) --&gt;</span><br><span class="line">  è¿™æ˜¯åŒä¸ªåˆ—è¡¨ä¸‹ï¼Œå¦èµ·ä¸€è¡Œçš„æ–‡æœ¬å†…å®¹</span><br><span class="line">- è¿™æ˜¯ç¬¬äºŒä¸ªæ— åºåˆ—è¡¨ &lt;!-- (Shift + Enter) --&gt;</span><br><span class="line">  è¿™æ˜¯åŒä¸ªåˆ—è¡¨ä¸‹ï¼Œå¦èµ·ä¸€è¡Œçš„æ–‡æœ¬å†…å®¹ </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>ç¬¬ä¸€ä¸ª</li>
<li>ç¬¬äºŒä¸ª</li>
<li>ç¬¬ä¸‰ä¸ª</li>
</ul>
<h3 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h3><p>æ ¼å¼ï¼š<br><code>&gt;+æ–‡æœ¬å†…å®¹ ä¸éœ€è¦ç©ºæ ¼</code></p>
<blockquote>
<p>nima </p>
</blockquote>
<h3 id="ç¼©ç´§å’Œé€€æ ¼"><a href="#ç¼©ç´§å’Œé€€æ ¼" class="headerlink" title="ç¼©ç´§å’Œé€€æ ¼"></a>ç¼©ç´§å’Œé€€æ ¼</h3><p>æ ¼å¼:</p>
<ul>
<li><p>ç¼©è¿›ï¼š</p>
<ol>
<li><code>tab</code></li>
<li><code>ctrl</code> + <code>[</code></li>
</ol>
</li>
<li><p>é€€æ ¼ï¼š</p>
<ol>
<li><code>shift</code> + <code>tab</code></li>
<li><code>shift</code> + <code>]</code></li>
</ol>
</li>
</ul>
<h4 id="æœ‰åºåˆ—è¡¨çš„ç¼©å’Œé€€"><a href="#æœ‰åºåˆ—è¡¨çš„ç¼©å’Œé€€" class="headerlink" title="æœ‰åºåˆ—è¡¨çš„ç¼©å’Œé€€"></a>æœ‰åºåˆ—è¡¨çš„ç¼©å’Œé€€</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1. ç¬¬ä¸€çº§æœ‰åºåˆ—è¡¨1 &lt;!-- (Enter) --&gt;</span><br><span class="line">	1. ç¬¬äºŒçº§æœ‰åºåˆ—è¡¨1    &lt;!-- å†™æ–‡æœ¬ä¹‹å‰ï¼Œå…ˆ( Tab æˆ– Ctrl + ] ) ï¼›å†™å®Œæ–‡æœ¬åï¼Œå†(Enter) --&gt;</span><br><span class="line">	2. ç¬¬äºŒçº§æœ‰åºåˆ—è¡¨2 &lt;!-- (Enter) --&gt;</span><br><span class="line">2. ç¬¬ä¸€çº§æœ‰åºåˆ—è¡¨2    &lt;!-- å†™æ–‡æœ¬å‰ï¼Œå…ˆ ( Shift + Tab æˆ– Ctrl + [ ) --&gt; </span><br></pre></td></tr></table></figure>
<ol>
<li>ç¬¬ä¸€çº§åˆ—è¡¨<ol>
<li>tabå</li>
<li>2</li>
</ol>
</li>
<li>ç¬¬äºŒçº§åˆ—è¡¨</li>
</ol>
<h4 id="æ— åºåˆ—è¡¨ç±»ä¼¼å•Š"><a href="#æ— åºåˆ—è¡¨ç±»ä¼¼å•Š" class="headerlink" title="æ— åºåˆ—è¡¨ç±»ä¼¼å•Š"></a>æ— åºåˆ—è¡¨ç±»ä¼¼å•Š</h4><ul>
<li>ç¬¬ä¸€çº§<ul>
<li>ç¬¬ä¸€çº§ä¸‹çš„tab</li>
</ul>
</li>
<li>ç¬¬äºŒçº§</li>
</ul>
<h4 id="å¼•ç”¨çš„ç¼©-amp-é€€"><a href="#å¼•ç”¨çš„ç¼©-amp-é€€" class="headerlink" title="å¼•ç”¨çš„ç¼©&amp;é€€"></a>å¼•ç”¨çš„ç¼©&amp;é€€</h4><p>åªéœ€è¦å¤šæ‰“ä¸€ä¸ª&gt;</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt;ç¬¬ä¸€çº§å¼•ç”¨1 &lt;!-- (enter) --&gt;</span><br><span class="line">&gt;&gt;ç¬¬äºŒçº§å¼•ç”¨1 &lt;!-- å…ˆæ‰“1ä¸ª &gt; (è¿™é‡Œçš„ç¬¬ä¸€ä¸ª &gt; æ˜¯ä¼šè‡ªåŠ¨è¡¥å……çš„ï¼Œåªéœ€é¢å¤–å¢è¡¥1ä¸ªå³å¯) ï¼Œå†(enter) --&gt;</span><br><span class="line">&gt;&gt;ç¬¬äºŒçº§å¼•ç”¨2 &lt;!-- (enter) --&gt;</span><br><span class="line">&gt;ç¬¬ä¸€çº§å¼•ç”¨2   &lt;!-- å†™æ–‡æœ¬å‰ï¼Œå…ˆ ( Shift + Tab æˆ– Ctrl + [ ) --&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>1</p>
<blockquote>
<p>1.1</p>
<blockquote>
<p>1.1.11</p>
</blockquote>
<p>2.1</p>
</blockquote>
<p>2</p>
</blockquote>
<p>ps: obsidiançš„è¿™ä¸ªç¼©è¿›çœŸçš„å¥‡æ€ª</p>
<h2 id="ç½‘é¡µé“¾æ¥ä¸å›¾åƒ"><a href="#ç½‘é¡µé“¾æ¥ä¸å›¾åƒ" class="headerlink" title="ç½‘é¡µé“¾æ¥ä¸å›¾åƒ"></a>ç½‘é¡µé“¾æ¥ä¸å›¾åƒ</h2><h3 id="ç½‘é¡µé“¾æ¥"><a href="#ç½‘é¡µé“¾æ¥" class="headerlink" title="ç½‘é¡µé“¾æ¥"></a>ç½‘é¡µé“¾æ¥</h3><ul>
<li>æ ¼å¼ï¼š<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[æ˜¾ç¤ºæ–‡æœ¬çš„å†…å®¹]+(é“¾æ¥åœ°å€ + &quot;æç¤ºæ–‡æœ¬ä¿¡æ¯&quot;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[æ˜¾ç¤ºæ–‡æœ¬å†…å®¹](é“¾æ¥åœ°å€ &quot;æç¤ºä¿¡æ¯æ–‡æœ¬&quot;)</span><br><span class="line"></span><br><span class="line">[ç™¾åº¦ä¸€ä¸‹ï¼Œä½ å°±çŸ¥é“](http://www.baidu.com &quot;æŒ‰ä½Ctrlç‚¹å‡»è·³è½¬ç™¾åº¦&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<a href="http://www.baidu.com/" title="æŒ‰ä½Ctrlç‚¹å‡»è·³è½¬ç™¾åº¦">ç™¾åº¦ä¸€ä¸‹ï¼Œä½ å°±çŸ¥é“</a></li>
</ul>
<h3 id="å›¾åƒ"><a href="#å›¾åƒ" class="headerlink" title="å›¾åƒ"></a>å›¾åƒ</h3><ul>
<li><p>å›¾åƒæ ¼å¼:</p>
<ul>
<li>å›¾åƒæ ¼å¼ï¼Œç½‘é¡µå‰é¢åŠ ä¸ª!</li>
<li>æç¤ºä¿¡æ¯ å†™åœ¨â€â€</li>
<li>[]æ–¹æ‹¬å·é‡Œçš„æ–‡å­—ä¿¡æ¯åœ¨ Markdown æ²¡å•¥å®è´¨çš„ä½œç”¨ï¼Œåªæ˜¯æ–¹ä¾¿åœ¨æºä»£ç æ¨¡å¼ä¸‹ï¼ŒçŸ¥é“è¿™ä¸ªå›¾ç‰‡æ˜¯ä»€ä¹ˆï¼Œåœ¨æ¸²æŸ“ç•Œé¢æ˜¯ä¸ä¼šæ˜¾ç¤ºçš„ã€‚æœ‰ç‚¹ç±»ä¼¼äºHTML imgæ ‡ç­¾ é‡Œçš„ altå±æ€§ã€‚<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">![æ–‡å­—ä¿¡æ¯](å›¾ç‰‡é“¾æ¥ &quot;æç¤ºæ–‡æœ¬ä¿¡æ¯&quot;)	</span><br><span class="line"></span><br><span class="line">![æ¹˜æ¹–1](upload://Ad5F9UZAOlZkz4iRuGeEuRugdZ.jpeg &quot;æ¹˜æ¹–ä¸€è§’&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>obsidianåµŒå¥—å›¾ç‰‡<br>![[20220208173252.png|100]]<br>æ˜æ˜¾åœ¨åšå®¢ä¸­ä¼šå¤±æ•ˆ</p>
</li>
<li><p>markdownæ ¼å¼å›¾ç‰‡<br><img src="/2022/02/09/obsidian-markdown/20220208173252.png" alt="åå­—|100x100" title="ç—›ã„ã‚ˆ"><br>å›¾ç‰‡å¤§å°è®¾ç½®æ— æ³•æˆåŠŸï¼ˆmarkdownè¯­æ³•çš„å›¾ç‰‡å¤§å°è®¾ç½®ä¸ç¼–è¾‘å™¨æœ‰å…³ï¼‰ï¼Œè·¯å¾„å’Œhexoåšå®¢å…¼å®¹</p>
</li>
<li><p>htmlæ ¼å¼å›¾ç‰‡ä¿®æ”¹å¤§å°</p>
<img src="20220208173252.png" alt="20220208173252.png" style="zoom:60%;" align="center"  /></li>
<li><p>htmlæ ¼å¼å›¾ç‰‡å¤§å°æ— ä¿®æ”¹</p>
<img src="20220208173252.png" />
è€æ¿çš„htmlæ ¼å¼å›¾ç‰‡è·¯å¾„æ˜¯å¯ä»¥åœ¨åšå®¢ä¸Šæ­£ç¡®æ˜¾ç¤ºçš„ï¼Œä½†æ˜¯obsidianå°±æ— æ³•æ˜¾ç¤ºæœ¬åœ°æ ¼å¼çš„</li>
</ul>
<ul>
<li>ç½‘ç»œå›¾ç‰‡<img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg.jj20.com%2Fup%2Fallimg%2F1114%2F022221105922%2F210222105922-7-1200.jpg&refer=http%3A%2F%2Fimg.jj20.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1646962404&t=d8e3455fdc34efb4153e5780430e3981" /></li>
</ul>
<h2 id="è¡¨æ ¼"><a href="#è¡¨æ ¼" class="headerlink" title="è¡¨æ ¼"></a>è¡¨æ ¼</h2><ul>
<li><p>æ ¼å¼</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">|è¿™é‡Œæ˜¯è¡¨å¤´1|è¿™é‡Œæ˜¯è¡¨å¤´2|è¿™é‡Œæ˜¯è¡¨å¤´3|</span><br><span class="line">|:-|:-:|-:|    &lt;!--åŒºåˆ†è¡¨å¤´å’Œè¡¨æ ¼ä¸»ä½“ï¼Œ:ä»£è¡¨æ–‡æœ¬å¯¹é½æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯å·¦å¯¹é½ï¼Œå±…ä¸­å¯¹é½ï¼Œå³å¯¹é½--&gt;</span><br><span class="line">|å•å…ƒæ ¼æ•°æ®1|å•å…ƒæ ¼æ•°æ®2|å•å…ƒæ ¼æ•°æ®3|</span><br><span class="line">|å•å…ƒæ ¼æ•°æ®4|å•å…ƒæ ¼æ•°æ®5|å•å…ƒæ ¼æ•°æ®6|</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>ç¤ºèŒƒ</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="left">å‚æ•°åç§°</th>
<th align="left">ç±»å‹</th>
<th align="left">å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td align="left">nfds</td>
<td align="left">int</td>
<td align="left">æ–‡ä»¶æè¿°ç¬¦æœ€å¤§å€¼+1</td>
</tr>
<tr>
<td align="left">readfds</td>
<td align="left">fd_set *</td>
<td align="left">è¯»äº‹ä»¶æ–‡ä»¶æè¿°ç¬¦é›†åˆ</td>
</tr>
<tr>
<td align="left">writefds</td>
<td align="left">fd_set *</td>
<td align="left">å†™äº‹ä»¶æ–‡ä»¶æè¿°ç¬¦é›†åˆ</td>
</tr>
<tr>
<td align="left">exceptfds</td>
<td align="left">fd_set *</td>
<td align="left">å¼‚å¸¸äº‹ä»¶æ–‡ä»¶æè¿°ç¬¦é›†åˆ</td>
</tr>
<tr>
<td align="left">timeout</td>
<td align="left">timeval *</td>
<td align="left">è¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡è¯¥æ—¶é—´å³ä½¿æ²¡æœ‰äº‹ä»¶åˆ°è¾¾ï¼Œselectä¹Ÿä¼šè¿”å›ï¼Œé¿å…æ— ä¼‘æ­¢åœ°ç­‰å¾…</td>
</tr>
</tbody></table>
<h3 id="è¡¨æ ¼å†…å®¹æ¢è¡Œ"><a href="#è¡¨æ ¼å†…å®¹æ¢è¡Œ" class="headerlink" title="è¡¨æ ¼å†…å®¹æ¢è¡Œ"></a>è¡¨æ ¼å†…å®¹æ¢è¡Œ</h3><ul>
<li>è‹¥æƒ³å¯¹ä¸€æ®µé•¿æ–‡æœ¬è¿›è¡Œæ¢è¡Œï¼Œå¯ä»¥åœ¨ <strong>ä¸­é—´</strong> æ’å…¥ä¸€ä¸ª <strong><code>&lt;br&gt;</code></strong> ï¼ˆ æ¢è¡Œæ ‡ç­¾ )<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">| è¡¨å¤´1 |  è¡¨å¤´2 |</span><br><span class="line">|:-:|:-:|</span><br><span class="line">|è¿™æ˜¯ç¬¬ä¸€è¡Œæ–‡æœ¬&lt;br&gt;è¿™æ˜¯å¦èµ·ä¸€è¡Œçš„æ–‡æœ¬|æ™®é€šæ–‡æœ¬|</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>ç¤ºèŒƒ</li>
</ul>
<table>
<thead>
<tr>
<th align="center">è¡¨å¤´1</th>
<th align="center">è¡¨å¤´2</th>
</tr>
</thead>
<tbody><tr>
<td align="center">è¿™æ˜¯ç¬¬ä¸€è¡Œæ–‡æœ¬<br>è¿™æ˜¯å¦èµ·ä¸€è¡Œçš„æ–‡æœ¬</td>
<td align="center">æ™®é€šæ–‡æœ¬</td>
</tr>
</tbody></table>
<h2 id="ä»£ç åŸŸ"><a href="#ä»£ç åŸŸ" class="headerlink" title="ä»£ç åŸŸ"></a>ä»£ç åŸŸ</h2><h3 id="è¡Œå†…ä»£ç "><a href="#è¡Œå†…ä»£ç " class="headerlink" title="è¡Œå†…ä»£ç "></a>è¡Œå†…ä»£ç </h3><ul>
<li>æ ¼å¼</li>
</ul>
<p>è¾“å…¥ä¸¤ä¸ªåæ’‡å·</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`è¿™æ˜¯ä¸€æ®µè¡Œå†…ä»£ç `</span><br><span class="line"></span><br><span class="line">`&lt;table border=&quot;1&quot; cellspacing=&quot;0&quot; width=&quot;500&quot; height=&quot;500&quot;&gt;`</span><br><span class="line"></span><br><span class="line">`print(&quot;Hello, World!&quot;)`</span><br><span class="line"></span><br><span class="line">`è¿™æ˜¯ä¸€è¡Œçªå‡ºæ˜¾ç¤ºçš„æ–‡æœ¬å†…å®¹`</span><br></pre></td></tr></table></figure>
<ul>
<li>ç¤ºèŒƒ</li>
</ul>
<p><code>è¿™æ˜¯ä¸€æ®µè¡Œå†…ä»£ç </code></p>
<p><code>&lt;table border=&quot;1&quot; cellspacing=&quot;0&quot; width=&quot;500&quot; height=&quot;500&quot;&gt;</code></p>
<p><code>print(&quot;Hello, World!&quot;)</code></p>
<p><code>è¿™æ˜¯ä¸€è¡Œçªå‡ºæ˜¾ç¤ºçš„æ–‡æœ¬å†…å®¹</code></p>
<h3 id="ä»£ç å—"><a href="#ä»£ç å—" class="headerlink" title="ä»£ç å—"></a>ä»£ç å—</h3><ul>
<li>æ ¼å¼</li>
</ul>
<ol>
<li>ä¸‰ä¸ªåæ’‡å·+è¯­è¨€ç§ç±»</li>
<li>ä¸‰ä¸ªæ³¢æµªå·+è¯­è¨€ç§ç±»</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">```è¯­è¨€ç§ç±»</span><br><span class="line">ä»£ç å†…å®¹</span><br><span class="line">ä»£ç å†…å®¹</span><br><span class="line">ä»£ç å†…å®¹</span><br></pre></td></tr></table></figure>

<h2 id="ä»»åŠ¡åˆ—è¡¨ï¼ˆä»£åŠï¼‰"><a href="#ä»»åŠ¡åˆ—è¡¨ï¼ˆä»£åŠï¼‰" class="headerlink" title="ä»»åŠ¡åˆ—è¡¨ï¼ˆä»£åŠï¼‰"></a>ä»»åŠ¡åˆ—è¡¨ï¼ˆä»£åŠï¼‰</h2><ul>
<li><p><code>-</code>+<code>ç©ºæ ¼</code>+[ ]+<code>ç©ºæ ¼</code>+ä»»åŠ¡å†…å®¹</p>
</li>
<li><p>æ ¼å¼</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- [ ] å¾…åŠä»»åŠ¡åˆ—è¡¨1</span><br><span class="line">- [ ] å¾…åŠä»»åŠ¡åˆ—è¡¨2</span><br><span class="line">- [x] å·²åŠä»»åŠ¡åˆ—è¡¨1    &lt;!-- è‹±æ–‡å­—æ¯X --&gt;</span><br><span class="line">- [x] å·²åŠä»»åŠ¡åˆ—è¡¨2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>ç¤ºèŒƒ</p>
</li>
<li><p><input disabled="" type="checkbox">  å¾…åŠä»»åŠ¡åˆ—è¡¨1</p>
</li>
<li><p><input disabled="" type="checkbox">  å¾…åŠä»»åŠ¡åˆ—è¡¨2</p>
</li>
<li><p><input checked="" disabled="" type="checkbox">  å·²åŠä»»åŠ¡åˆ—è¡¨1    <!-- è‹±æ–‡å­—æ¯X --></p>
</li>
<li><p><input checked="" disabled="" type="checkbox">  å·²åŠä»»åŠ¡åˆ—è¡¨2</p>
</li>
</ul>
<h2 id="æ³¨é‡Š"><a href="#æ³¨é‡Š" class="headerlink" title="æ³¨é‡Š"></a>æ³¨é‡Š</h2><p>markdownæ³¨é‡Šå’Œhtmlä¸€æ ·ï¼Œæ³¨é‡Šå†…å®¹åœ¨æ¸²æŸ“ç•Œé¢çœ‹ä¸è§</p>
<ul>
<li>æ ¼å¼<br>  <code>&lt;!-- æ³¨é‡Šçš„å†…å®¹ --&gt;</code></li>
<li>ç¤ºèŒƒ<br>  çœ‹ä¸è§çš„<!-- æ³¨é‡Šçš„å†…å®¹ --></li>
</ul>
<h2 id="å˜é‡"><a href="#å˜é‡" class="headerlink" title="å˜é‡"></a>å˜é‡</h2><h3 id="ç½‘é¡µé“¾æ¥å˜é‡"><a href="#ç½‘é¡µé“¾æ¥å˜é‡" class="headerlink" title="ç½‘é¡µé“¾æ¥å˜é‡"></a>ç½‘é¡µé“¾æ¥å˜é‡</h3><ul>
<li>æ ¼å¼<br>  [æ˜¾ç¤ºæ–‡æœ¬]+[å˜é‡å]</li>
<li>è®¾ç½®å˜é‡<br>  [å˜é‡å]+<code>:</code>+<code>ç©ºæ ¼</code>+é“¾æ¥åœ°å€</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[ç™¾åº¦ä¸€ä¸‹ï¼Œä½ å°±çŸ¥é“][åº¦å¨˜]</span><br><span class="line">[çŸ¥ä¹-æœ‰é—®é¢˜ï¼Œå°±ä¼šæœ‰ç­”æ¡ˆ][çŸ¥ä¹]</span><br><span class="line"></span><br><span class="line">&lt;!-- è¿™é‡Œæ˜¯å˜é‡åŒºåŸŸ --&gt;</span><br><span class="line">[åº¦å¨˜]: http://www.baidu.com </span><br><span class="line">[çŸ¥ä¹]: https://www.zhihu.com </span><br></pre></td></tr></table></figure>

<ul>
<li>ç¤ºèŒƒ</li>
</ul>
<p><a href="http://www.baidu.com/">ç™¾åº¦ä¸€ä¸‹ï¼Œä½ å°±çŸ¥é“</a><br><a href="https://www.zhihu.com/">çŸ¥ä¹-æœ‰é—®é¢˜ï¼Œå°±ä¼šæœ‰ç­”æ¡ˆ</a></p>
<h3 id="è„šæ³¨"><a href="#è„šæ³¨" class="headerlink" title="è„šæ³¨"></a>è„šæ³¨</h3><ul>
<li>æ ¼å¼<br>  [^è„šæ³¨ä»£å·]</li>
<li>è®¾ç½®å˜é‡<br>  [^è„šæ³¨ä»£å·]+<code>:</code>+<code>ç©ºæ ¼</code>+è„šæ³¨å†…å®¹</li>
<li>ç¤ºèŒƒ<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ ‘ä¸Šæ˜¥æ ‘[^1]</span><br><span class="line">ç±³æ´¥ç„å¸ˆ[^2]</span><br><span class="line">&lt;!-- è®¾ç½®å˜é‡ --&gt;</span><br><span class="line">[^1]: æ—¥æœ¬ä½œå®¶</span><br><span class="line">[^2]: æ—¥æœ¬æ­Œæ‰‹</span><br></pre></td></tr></table></figure>
æ ‘ä¸Šæ˜¥æ ‘<a href="%E6%97%A5%E6%9C%AC%E4%BD%9C%E5%AE%B6">^1</a><br>ç±³æ´¥ç„å¸ˆ<a href="%E6%97%A5%E6%9C%AC%E6%AD%8C%E6%89%8B">^2</a></li>
</ul>
<h2 id="æ‰©å±•æ–‡æœ¬"><a href="#æ‰©å±•æ–‡æœ¬" class="headerlink" title="æ‰©å±•æ–‡æœ¬"></a>æ‰©å±•æ–‡æœ¬</h2><h3 id="é”®ç›˜æ–‡æœ¬"><a href="#é”®ç›˜æ–‡æœ¬" class="headerlink" title="é”®ç›˜æ–‡æœ¬"></a>é”®ç›˜æ–‡æœ¬</h3><ul>
<li>æ ¼å¼<br><kbd>é”®ç›˜æ–‡æœ¬</kbd></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;kbd&gt;é”®ç›˜æ–‡æœ¬&lt;/kbd&gt;</span><br></pre></td></tr></table></figure>

<p>ps: é”®ç›˜æ–‡æœ¬å°±æ˜¯ä¸€ç§ç€é‡æ–‡æœ¬</p>
<h3 id="æ”¾å¤§æ–‡æœ¬"><a href="#æ”¾å¤§æ–‡æœ¬" class="headerlink" title="æ”¾å¤§æ–‡æœ¬"></a>æ”¾å¤§æ–‡æœ¬</h3><ul>
<li>æ”¾å¤§æ–‡æœ¬æ ¼å¼<br><big>è¿™æ˜¯ä¸€æ®µæ”¾å¤§äº†çš„æ–‡æœ¬</big><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;big&gt;è¿™æ˜¯ä¸€æ®µæ”¾å¤§äº†çš„æ–‡æœ¬&lt;/big&gt;</span><br></pre></td></tr></table></figure>
<h3 id="ç¼©å°æ–‡æœ¬"><a href="#ç¼©å°æ–‡æœ¬" class="headerlink" title="ç¼©å°æ–‡æœ¬"></a>ç¼©å°æ–‡æœ¬</h3></li>
<li>ç¼©å°æ–‡æœ¬æ ¼å¼<br><small>è¿™æ˜¯ä¸€æ®µç¼©å°æ–‡æœ¬</small><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;small&gt;è¿™æ˜¯ä¸€æ®µç¼©å°æ–‡æœ¬&lt;/small&gt;</span><br></pre></td></tr></table></figure>
<h3 id="å¤šå½©æ–‡æœ¬"><a href="#å¤šå½©æ–‡æœ¬" class="headerlink" title="å¤šå½©æ–‡æœ¬"></a>å¤šå½©æ–‡æœ¬</h3></li>
<li>å¤šå½©æ–‡æœ¬çš„æ ¼å¼<br><font color=violet>ç´«ç½—å…°è‰²</font><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;font color=violet&gt;ç´«ç½—å…°è‰²&lt;/font&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>ps :color æ”¯æŒè‹±æ–‡å•è¯ï¼Œ16ç¦æ­¢ï¼Œrgbï¼Œrgba</p>
<h2 id="æ‰©å±•æ–‡æœ¬-1"><a href="#æ‰©å±•æ–‡æœ¬-1" class="headerlink" title="æ‰©å±•æ–‡æœ¬"></a>æ‰©å±•æ–‡æœ¬</h2><h3 id="æ–‡æœ¬é«˜äº®"><a href="#æ–‡æœ¬é«˜äº®" class="headerlink" title="æ–‡æœ¬é«˜äº®"></a>æ–‡æœ¬é«˜äº®</h3><ul>
<li>æ–‡æœ¬é«˜äº®æ ¼å¼<br>==é«˜äº®å†…å®¹==<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">==é«˜äº®å†…å®¹==</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="ä¸Šæ ‡"><a href="#ä¸Šæ ‡" class="headerlink" title="ä¸Šæ ‡"></a>ä¸Šæ ‡</h3><ul>
<li>æ ¼å¼1<br><code>x^2^</code><br>x^2^<br>obsidianç¼–è¾‘å™¨ä¸æ”¯æŒ</li>
<li>æ ¼å¼2html<br><code>&lt;sup&gt;å†…å®¹&lt;/sup&gt;</code><br>x<sup>2</sup></li>
</ul>
<h3 id="ä¸‹æ ‡"><a href="#ä¸‹æ ‡" class="headerlink" title="ä¸‹æ ‡"></a>ä¸‹æ ‡</h3><ul>
<li>æ ¼å¼1<br>H<del>2</del>O<br><code>H~2~O</code><br>obsidianä¸æ”¯æŒ</li>
<li>æ ¼å¼2 html<br><code>&lt;sub&gt;è¿™é‡Œæ˜¯ä¸‹æ ‡å†…å®¹&lt;/sub&gt;</code><br>H<sub>2</sub>O</li>
</ul>
<h3 id="emojiç¬¦å·"><a href="#emojiç¬¦å·" class="headerlink" title="emojiç¬¦å·"></a>emojiç¬¦å·</h3><ul>
<li><p>æ ¼å¼<br>ä½¿ç”¨<code>:</code>åŒ…è£¹è‹±æ–‡</p>
</li>
<li><p>æµ‹è¯•<br><code>:smile:</code></p>
</li>
<li><p>æ•ˆæœ<br>:smile:</p>
</li>
</ul>
<p>ps:åªæœ‰éƒ¨åˆ†ç¼–è¾‘å™¨æ”¯æŒ</p>
<h2 id="è½¬ä¹‰å­—ç¬¦"><a href="#è½¬ä¹‰å­—ç¬¦" class="headerlink" title="è½¬ä¹‰å­—ç¬¦"></a>è½¬ä¹‰å­—ç¬¦</h2><ul>
<li>ä½¿ç”¨ä»£ç å—</li>
<li>ä½¿ç”¨è½¬ä¹‰å­—ç¬¦åæ–œæ <code>\</code></li>
</ul>
<h3 id="æ³¨æ„ä¸‹åæ’‡å·"><a href="#æ³¨æ„ä¸‹åæ’‡å·" class="headerlink" title="æ³¨æ„ä¸‹åæ’‡å·`"></a>æ³¨æ„ä¸‹åæ’‡å·<kbd>`</kbd></h3><ul>
<li>åœ¨è¡Œå†…ä»£ç ä¸­ï¼Œè®©åæ’‡å· <strong>`</strong> èƒ½è¢«æ˜¾ç¤ºå‡ºæ¥ï¼Œæœ‰ä¸¤ç§æ–¹æ³•<ol>
<li>é¦–å°¾ç”¨<strong>ä¸¤ä¸ªå¼•å·</strong>åŒ…è£¹<br> <strong><code>`æ˜¾ç¤º2ä¸ªåæ’‡å·`</code></strong> ï¼Œ <strong><code>`æ˜¾ç¤ºå•ä¸ªåæ’‡å·</code></strong> </li>
</ol>
<ul>
<li>  <strong>æ•ˆæœï¼š</strong> <strong><code>`æ˜¾ç¤ºä¸¤ä¸ªåæ’‡å·`</code></strong> ï¼Œ <strong><code> `æ˜¾ç¤ºå•ä¸ªåæ’‡å·</code></strong></li>
<li><strong>æ³¨æ„ï¼š</strong> ä¸­é—´çš„å†…å®¹ è·ç¦»é¦–å°¾å¼•å· å„æœ‰1ä¸ªç©ºæ ¼</li>
</ul>
<ol start="2">
<li>ä¹‹å‰æè¿‡ï¼Œè¡Œå†…ä»£ç ä¹Ÿå¯ä½œä¸º çªå‡ºæ˜¾ç¤ºçš„æ–‡æœ¬<br> å¯ä»¥åˆ©ç”¨å‰é¢ä»‹ç»çš„ é”®ç›˜æ–‡æœ¬ + è½¬ä¹‰ç¬¦å· <strong><code>\</code></strong> ï¼Œçªå‡ºæ˜¾ç¤ºåæ’‡å·<ul>
<li>  <strong>æ ¼å¼ï¼š</strong> <strong><code>&lt;kbd&gt;\`é¦–å°¾çš„åæ’‡å·ä¼šæ­£å¸¸æ˜¾ç¤º\`&lt;/kbd&gt;</code></strong></li>
<li>  <strong>æ•ˆæœï¼š</strong> <code>é¦–å°¾çš„åæ’‡å·ä¼šæ­£å¸¸æ˜¾ç¤º</code></li>
</ul>
</li>
</ol>
</li>
</ul>
<h2 id="ç©ºæ ¼-amp-æ¢è¡Œ-amp-å¼ºåˆ¶åˆ é™¤"><a href="#ç©ºæ ¼-amp-æ¢è¡Œ-amp-å¼ºåˆ¶åˆ é™¤" class="headerlink" title="ç©ºæ ¼&amp;æ¢è¡Œ&amp;å¼ºåˆ¶åˆ é™¤"></a>ç©ºæ ¼&amp;æ¢è¡Œ&amp;å¼ºåˆ¶åˆ é™¤</h2><h3 id="ç©ºæ ¼"><a href="#ç©ºæ ¼" class="headerlink" title="ç©ºæ ¼"></a>ç©ºæ ¼</h3><ul>
<li>ä½¿ç”¨htmlçš„<strong>ç©ºæ ¼</strong>å­—ç¬¦ï¼šâ€”â€” <code>&amp;nbsp;</code></li>
<li>å¤šä¸ªç©ºæ ¼ï¼š<ul>
<li><code>&amp;nbsp;&amp;nbsp;&amp;nbsp;</code></li>
</ul>
</li>
<li>æ•ˆæœ<ul>
<li>è¿™é‡Œæœ‰&nbsp;&nbsp;&nbsp;ä¸‰ä¸ªç©ºæ ¼</li>
</ul>
</li>
</ul>
<h3 id="æ¢è¡Œ"><a href="#æ¢è¡Œ" class="headerlink" title="æ¢è¡Œ"></a>æ¢è¡Œ</h3><ul>
<li>ä½¿ç”¨<code>&lt;br&gt;</code></li>
</ul>
<h3 id="å¼ºåˆ¶åˆ é™¤"><a href="#å¼ºåˆ¶åˆ é™¤" class="headerlink" title="å¼ºåˆ¶åˆ é™¤"></a>å¼ºåˆ¶åˆ é™¤</h3><ul>
<li>ä½¿ç”¨Shift+Backspaceå¼ºåˆ¶åˆ é™¤</li>
</ul>
<h2 id="åµŒå…¥"><a href="#åµŒå…¥" class="headerlink" title="åµŒå…¥"></a>åµŒå…¥</h2><p>markdownçš„æ‰€æœ‰åµŒå…¥éƒ½æ˜¯é€šè¿‡htmlå®ç°çš„</p>
<h3 id="åµŒå…¥éŸ³é¢‘"><a href="#åµŒå…¥éŸ³é¢‘" class="headerlink" title="åµŒå…¥éŸ³é¢‘"></a>åµŒå…¥éŸ³é¢‘</h3><ul>
<li>æ ¼å¼<br><code>&lt;audio controls=&quot;controls&quot; preload=&quot;none&quot; src=&quot;éŸ³é¢‘é“¾æ¥åœ°å€&quot;&gt;&lt;/audio&gt;</code></li>
<li>ç¤ºèŒƒ<br><code>&lt;audio controls=&quot;controls&quot; preload=&quot;none&quot; src=&quot;//music.163.com/outchain/player?type=2&amp;id=512359195&amp;auto=1&amp;height=66&quot;&gt;&lt;/audio&gt;</code></li>
<li>æ•ˆæœ</li>
</ul>
<p><audio controls="controls" preload="none" src="//music.163.com/outchain/player?type=2&id=512359195&auto=1&height=66"></audio></p>
<h3 id="åµŒå…¥è§†é¢‘"><a href="#åµŒå…¥è§†é¢‘" class="headerlink" title="åµŒå…¥è§†é¢‘"></a>åµŒå…¥è§†é¢‘</h3><ul>
<li>æ ¼å¼<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;video width=&quot;600&quot; height=&quot;420&quot; controls&gt;</span><br><span class="line">  &lt;source src=&quot;movie.mp4&quot; type=&quot;video/mp4&quot;&gt;</span><br><span class="line">  &lt;source src=&quot;movie.ogg&quot; type=&quot;video/ogg&quot;&gt;</span><br><span class="line">  &lt;source src=&quot;movie.webm&quot; type=&quot;video/webm&quot;&gt;  </span><br><span class="line">&lt;/video&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="åµŒå…¥é¡µé¢"><a href="#åµŒå…¥é¡µé¢" class="headerlink" title="åµŒå…¥é¡µé¢"></a>åµŒå…¥é¡µé¢</h3><ul>
<li><p>æ ¼å¼<br><code>&lt;iframe width=600 height=400 src=&quot;https://www.runoob.com/html/html-tutorial.html&quot; scrolling=&quot;auto&quot; border=&quot;0&quot; frameborder=&quot;no&quot; framespacing=&quot;0&quot; allowfullscreen=&quot;true&quot;&gt; &lt;/iframe&gt;</code></p>
</li>
<li><p>æ•ˆæœ</p>
<iframe width=600 height=400 src="https://www.bilibili.com" scrolling="auto" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe></li>
</ul>
<h2 id="Latex"><a href="#Latex" class="headerlink" title="Latex"></a>Latex</h2><p>ä¸»è¦æ˜¯ç”¨æ¥ä¹¦å†™<code>åŒ–å­¦å…¬å¼</code>å’Œ<code>æ•°å­¦å…¬å¼</code></p>
<ul>
<li><p>æ ¼å¼<br><code>$</code>+è¡Œå†…å…¬å¼+<code>$</code></p>
</li>
<li><p>å®ä¾‹<br><code>$\ce&#123;CO2 + C -&gt; 2 CO&#125;$</code><br><code>$x^2 + 2x + 5 + \sqrt x = 0$</code></p>
</li>
</ul>
<p>-æ•ˆæœ</p>
<p>$\ce{CO2 + C -&gt; 2 CO}$</p>
<p>$x^2 + 2x + 5 + \sqrt x = 0$</p>
<h3 id="å…¬å¼å—"><a href="#å…¬å¼å—" class="headerlink" title="å…¬å¼å—"></a>å…¬å¼å—</h3><ul>
<li>æ ¼å¼<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$$</span><br><span class="line">å…¬å¼å—</span><br><span class="line">$$</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Mermaid"><a href="#Mermaid" class="headerlink" title="Mermaid"></a>Mermaid</h2><p>é€šè¿‡mermaidæ¥ç”»å„ç§å„æ ·çš„å›¾</p>
<h3 id="æµç¨‹å›¾"><a href="#æµç¨‹å›¾" class="headerlink" title="æµç¨‹å›¾"></a>æµç¨‹å›¾</h3><ul>
<li><p>æºç </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">```mermaid</span><br><span class="line">graph LR</span><br><span class="line">emperor((æœ±å…«å…«))-.å­.-&gt;æœ±äº”å››-.å­.-&gt;æœ±å››ä¹-.å­.-&gt;æœ±ç™¾å…­</span><br><span class="line">æœ±é›„è‹±--é•¿å­--&gt;æœ±æ ‡--é•¿å­--&gt;emperor</span><br><span class="line">emperor2((æœ±å…ç‚†))--æ¬¡å­--&gt;æœ±æ ‡</span><br><span class="line">æœ±æ¨‰--æ¬¡å­--&gt;emperor</span><br><span class="line">æœ±æ£¡--ä¸‰å­--&gt;emperor</span><br><span class="line">emperor3((æœ±æ££))--å››å­--&gt;emperor</span><br><span class="line">emperor4((æœ±é«˜ç‚½))--é•¿å­--&gt;emperor3</span><br><span class="line">```</span><br></pre></td></tr></table></figure></li>
<li><p>æ¸²æŸ“å›¾</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">graph LR</span><br><span class="line">emperor((æœ±å…«å…«))-.å­.-&gt;æœ±äº”å››-.å­.-&gt;æœ±å››ä¹-.å­.-&gt;æœ±ç™¾å…­</span><br><span class="line">æœ±é›„è‹±--é•¿å­--&gt;æœ±æ ‡--é•¿å­--&gt;emperor</span><br><span class="line">emperor2((æœ±å…ç‚†))--æ¬¡å­--&gt;æœ±æ ‡</span><br><span class="line">æœ±æ¨‰--æ¬¡å­--&gt;emperor</span><br><span class="line">æœ±æ£¡--ä¸‰å­--&gt;emperor</span><br><span class="line">emperor3((æœ±æ££))--å››å­--&gt;emperor</span><br><span class="line">emperor4((æœ±é«˜ç‚½))--é•¿å­--&gt;emperor3</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="é¥¼å›¾"><a href="#é¥¼å›¾" class="headerlink" title="é¥¼å›¾"></a>é¥¼å›¾</h3><ul>
<li><p>æºç </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">```mermaid</span><br><span class="line">pie</span><br><span class="line">    title ä¸ºä»€ä¹ˆæ€»æ˜¯å®…åœ¨å®¶é‡Œï¼Ÿ</span><br><span class="line">    &quot;å¤¢ãªã—&quot; : 45</span><br><span class="line">    &quot;å‹é”ãªã—&quot; : 70</span><br><span class="line">    &quot;ãŠé‡‘ãªã—&quot; : 500</span><br><span class="line">	&quot;å®¶ãŒå¥½ã&quot; : 95</span><br><span class="line">```</span><br></pre></td></tr></table></figure></li>
<li><p>æ¸²æŸ“å›¾</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pie</span><br><span class="line">    title ä¸ºä»€ä¹ˆæ€»æ˜¯å®…åœ¨å®¶é‡Œï¼Ÿ</span><br><span class="line">    &quot;å¤¢ãªã—&quot; : 45</span><br><span class="line">    &quot;å‹é”ãªã—&quot; : 70</span><br><span class="line">    &quot;ãŠé‡‘ãªã—&quot; : 500</span><br><span class="line">	&quot;å®¶ãŒå¥½ã&quot; : 95</span><br></pre></td></tr></table></figure>

<h3 id="æ—¶åºå›¾"><a href="#æ—¶åºå›¾" class="headerlink" title="æ—¶åºå›¾"></a>æ—¶åºå›¾</h3><p>å¤ªå¤æ‚äº†ï¼Œå•ç‹¬å­¦è¯­æ³•å§</p>
<h3 id="ç”˜ç‰¹å›¾"><a href="#ç”˜ç‰¹å›¾" class="headerlink" title="ç”˜ç‰¹å›¾"></a>ç”˜ç‰¹å›¾</h3><ul>
<li><p>æºç </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">```mermaid</span><br><span class="line">gantt</span><br><span class="line">    title A Gantt Diagram</span><br><span class="line">    dateFormat  YYYY-MM-DD</span><br><span class="line">    section Section</span><br><span class="line">    A task           :a1, 2014-01-01, 30d</span><br><span class="line">    Another task     :after a1  , 20d</span><br><span class="line">    section Another</span><br><span class="line">    Task in sec      :2014-01-12  , 12d</span><br><span class="line">    another task      : 24d</span><br><span class="line">```</span><br></pre></td></tr></table></figure></li>
<li><p>æ¸²æŸ“å›¾</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gantt</span><br><span class="line">    title A Gantt Diagram</span><br><span class="line">    dateFormat  YYYY-MM-DD</span><br><span class="line">    section Section</span><br><span class="line">    A task           :a1, 2014-01-01, 30d</span><br><span class="line">    Another task     :after a1  , 20d</span><br><span class="line">    section Another</span><br><span class="line">    Task in sec      :2014-01-12  , 12d</span><br><span class="line">    another task      : 24d</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>åŠŸèƒ½æµ‹è¯•</category>
      </categories>
      <tags>
        <tag>markdown</tag>
        <tag>obsidian</tag>
      </tags>
  </entry>
  <entry>
    <title>vegetaæµ‹è¯•</title>
    <url>/2022/04/14/vegete%E6%B5%8B%E8%AF%95/</url>
    <content><![CDATA[<p>Vegeta æ˜¯ä¸€ä¸ªç”¨ Go è¯­è¨€ç¼–å†™çš„å¤šåŠŸèƒ½çš„ HTTP è´Ÿè½½æµ‹è¯•å·¥å…·ï¼Œå®ƒæä¾›äº†å‘½ä»¤è¡Œå·¥å…·å’Œä¸€ä¸ªå¼€å‘åº“ã€‚Â </p>
<span id="more"></span>

<!-- toc -->

<h2 id="ä»€ä¹ˆæ˜¯-Vegeta"><a href="#ä»€ä¹ˆæ˜¯-Vegeta" class="headerlink" title="ä»€ä¹ˆæ˜¯ Vegeta"></a><strong>ä»€ä¹ˆæ˜¯ Vegeta</strong></h2><p><a href="https://github.com/tsenart/vegeta">å®˜æ–¹åœ°å€</a></p>
<h2 id="Vegeta-ç”¨æ³•"><a href="#Vegeta-ç”¨æ³•" class="headerlink" title="Vegeta ç”¨æ³•"></a>Vegeta ç”¨æ³•</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vegeta --help  </span><br><span class="line">Usage: vegeta [global flags] &lt;command&gt; [command flags]  </span><br><span class="line">   </span><br><span class="line">global flags:  </span><br><span class="line"> -cpus int  </span><br><span class="line"> ä½¿ç”¨ CPU çš„æ•°é‡ (é»˜è®¤ä¸º 4 ä¸ª)  </span><br><span class="line"> -profile string  </span><br><span class="line"> æŒ‡å®šåœ¨æ‰§è¡ŒæœŸé—´å¯ç”¨å“ªä¸ªåˆ†æå™¨ï¼Œæ”¯æŒ cpu å’Œ heapã€‚   </span><br><span class="line"> -version  </span><br><span class="line"> æ‰“å°ç‰ˆæœ¬å¹¶é€€å‡ºã€‚  </span><br><span class="line">   </span><br><span class="line">attack command:  </span><br><span class="line"> -body string  </span><br><span class="line"> æŒ‡å®šè¯·æ±‚ä¸»ä½“æ–‡ä»¶é‡Œçš„å†…å®¹ã€‚  </span><br><span class="line"> -cert string  </span><br><span class="line"> æŒ‡å®šç”¨äº HTTPS è¯·æ±‚çš„ PEM æ ¼å¼çš„å®¢æˆ·ç«¯è¯ä¹¦æ–‡ä»¶ã€‚å¦‚æœ -key æœªæŒ‡å®šï¼Œå®ƒä¼šè¢«è®¾ç½®ä¸ºè¿™ä¸ªæ ‡å¿—çš„å€¼ã€‚  </span><br><span class="line"> -connections int  </span><br><span class="line"> æŒ‡å®šæ¯ä¸ªç›®æ ‡ä¸»æœºæ‰“å¼€çš„ç©ºé—²è¿æ¥çš„æœ€å¤§æ•°ç›®ï¼Œé»˜è®¤å€¼ä¸º 10000ã€‚  </span><br><span class="line"> -duration duration  </span><br><span class="line"> æŒ‡å®šå‘é€è¯·æ±‚åˆ°ç›®æ ‡ä¸»æœºçš„æ—¶é•¿ï¼Œç”¨ 0 è¡¨ç¤ºæ°¸ä¹…ã€‚  </span><br><span class="line"> -header value  </span><br><span class="line"> æŒ‡å®šç›®æ ‡çš„è¯·æ±‚å¤´ï¼Œå¯ä»¥é‡å¤æŒ‡å®šå¤šä¸ªè¯·æ±‚å¤´ã€‚  </span><br><span class="line"> -http2  </span><br><span class="line"> æŒ‡å®šæ˜¯å¦å‘æ”¯æŒçš„æœåŠ¡å™¨å‘é€ HTTP/2 è¯·æ±‚ï¼Œé»˜è®¤ä¸ºï¼štrueã€‚  </span><br><span class="line"> -insecure  </span><br><span class="line"> æŒ‡å®šæ˜¯å¦å¿½ç•¥æ— æ•ˆçš„æœåŠ¡å™¨ TLS è¯ä¹¦ã€‚  </span><br><span class="line"> -keepalive  </span><br><span class="line"> æŒ‡å®šæ˜¯å¦ä½¿ç”¨æŒä¹…é“¾æ¥ï¼Œé»˜è®¤å€¼ä¸ºï¼štrueã€‚  </span><br><span class="line"> -key string  </span><br><span class="line"> æŒ‡å®š HTTPS è¯·æ±‚ä¸­ä½¿ç”¨çš„ PEM ç¼–ç çš„ SSL å®¢æˆ·ç«¯è¯ä¹¦ç§é’¥æ–‡ä»¶ã€‚  </span><br><span class="line"> -laddr value  </span><br><span class="line"> æŒ‡å®šè¦ä½¿ç”¨çš„æœ¬åœ° I Påœ°å€ï¼Œé»˜è®¤å€¼ä¸ºï¼š0.0.0.0ã€‚  </span><br><span class="line"> -lazy  </span><br><span class="line"> æŒ‡å®šæ˜¯å¦ä½¿ç”¨å»¶è¿Ÿæ¨¡å¼è¯»å–ç›®æ ‡ã€‚  </span><br><span class="line"> -output string  </span><br><span class="line"> æŒ‡å®šè¾“å‡ºæ–‡ä»¶çš„ä½ç½®ï¼Œé»˜è®¤ä¸ºæ ‡å‡†è¾“å‡ºã€‚  </span><br><span class="line"> -rate uint  </span><br><span class="line"> æŒ‡å®šæ¯ç§’é’Ÿå¯¹ç›®æ ‡å‘é€çš„è¯·æ±‚æ•°ï¼Œé»˜è®¤å€¼ä¸ºï¼š50ã€‚  </span><br><span class="line"> -redirects int  </span><br><span class="line"> æŒ‡å®šæ¯ä¸ªè¯·æ±‚çš„é‡å®šå‘çš„æœ€å¤§æ¬¡æ•°ï¼Œé»˜è®¤ä¸º 10 æ¬¡ã€‚å½“å€¼ä¸º -1, ä¸ä¼šéµå¾ªé‡å®šå‘ä½†å“åº”æ ‡è®°ä¸ºæˆåŠŸã€‚  </span><br><span class="line"> -root-certs value  </span><br><span class="line"> æŒ‡å®šå¯ä¿¡çš„ TLS æ ¹è¯ä¹¦æ–‡ä»¶ï¼Œå¤šä¸ªçš„æƒ…å†µä¸‹ä½¿ç”¨é€—å·åˆ†éš”ã€‚å¦‚æœæœªæŒ‡å®šï¼Œä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„ CA è¯ä¹¦ã€‚  </span><br><span class="line"> -targets string  </span><br><span class="line"> æŒ‡å®šç›®æ ‡æ–‡ä»¶ï¼Œé»˜è®¤ä¸ºæ ‡å‡†è¾“å…¥ã€‚  </span><br><span class="line"> -timeout duration  </span><br><span class="line"> æŒ‡å®šæ¯ä¸ªè¯·æ±‚çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤å€¼ä¸º 30sã€‚  </span><br><span class="line"> -workers uint  </span><br><span class="line"> æŒ‡å®šåˆå§‹åŒ–è¿›ç¨‹æ•°é‡ï¼Œé»˜è®¤å€¼ä¸º 10ã€‚  </span><br><span class="line">  </span><br><span class="line">report command:  </span><br><span class="line"> -inputs string  </span><br><span class="line"> æŒ‡å®šæŠ¥å‘Šè¾“å…¥æ–‡ä»¶ï¼Œé»˜è®¤ä¸ºæ ‡å‡†è¾“å…¥ã€‚  </span><br><span class="line"> -output string  </span><br><span class="line"> æŒ‡å®šæŠ¥å‘Šè¾“å‡ºæ–‡ä»¶ï¼Œé»˜è®¤ä¸ºæ ‡å‡†è¾“å‡ºã€‚  </span><br><span class="line"> -reporter string  </span><br><span class="line"> æŒ‡å®šè¦ç”Ÿæˆçš„æŠ¥å‘Šçš„æ ¼å¼ï¼Œæ”¯æŒ textï¼Œjson, plot, hist[buckets]ã€‚é»˜è®¤ä¸ºæ–‡æœ¬ã€‚  </span><br><span class="line">   </span><br><span class="line">dump command:  </span><br><span class="line"> -dumper string  </span><br><span class="line"> æŒ‡å®šè½¬å­˜æ–‡ä»¶ï¼Œæ”¯æŒ json, csv æ ¼å¼ã€‚é»˜è®¤ä¸º json æ ¼å¼ã€‚  </span><br><span class="line"> -inputs string  </span><br><span class="line"> æŒ‡å®šè¦è½¬å­˜çš„è¾“å…¥æ–‡ä»¶ï¼Œé»˜è®¤ä¸ºæ ‡å‡†è¾“å…¥ï¼ŒæŒ‡å®šå¤šä¸ªç”¨é€—å·åˆ†éš”ã€‚  </span><br><span class="line"> -output string  </span><br><span class="line"> æŒ‡å®šè¦è½¬å­˜çš„è¾“å‡ºæ–‡ä»¶ï¼Œé»˜è®¤ä¸ºæ ‡å‡†è¾“å‡ºã€‚</span><br></pre></td></tr></table></figure>

<h2 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h2><h3 id="GET"><a href="#GET" class="headerlink" title="GET"></a>GET</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">echo &quot;GET http://www.baidu.com&quot; | vegeta attack -rate=50 -connections=1 -duration=1s | tee results.bin | vegeta report</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">tee houminxi.bin <span class="comment">#å°†vegetaçš„è¯·æ±‚ç»“æœä»¥äºŒè¿›åˆ¶çš„æ ¼å¼ä¿å­˜èµ·æ¥ã€‚è¿™ä¸ªæ–‡ä»¶æœ€ä¸»è¦çš„ä½œç”¨æ˜¯å¦‚æœä½ ä»¥ååˆ†å¸ƒå¼æ‰§è¡Œå‹æµ‹ï¼Œé‚£ä¹ˆæœ€åä½¿ç”¨vegeta reportç»Ÿè®¡ç»“æœçš„æ—¶å€™åˆ™éœ€è¦ä½¿ç”¨æ¯å°å‹æµ‹æœºå™¨ä¸Šè¯¥æ–‡ä»¶ã€‚</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>rate : æ¯ç§’å‘é€qingè¯·æ±‚æ•°</li>
<li>connection : ä¸»æœºæ‰“å¼€çš„ç©ºé—²è¿æ¥æ•°</li>
<li>duration : æ”¾æ¾è¯·æ±‚åˆ°ä¸»æœºçš„æ—¶é•¿</li>
</ul>
<p>è¿”å›ç»“æœ:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Requests      [total, rate, throughput]         50, 51.07, 49.21</span><br><span class="line">Duration      [total, attack, wait]             1.016s, 978.964ms, 37.086ms</span><br><span class="line">Latencies     [min, mean, 50, 90, 95, 99, max]  18.227ms, 51.221ms, 31.514ms, 116.864ms, 144.458ms, 240.26ms, 240.26ms</span><br><span class="line">Bytes In      [total, mean]                     17465200, 349304.00</span><br><span class="line">Bytes Out     [total, mean]                     0, 0.00</span><br><span class="line">Success       [ratio]                           100.00%</span><br><span class="line">Status Codes  [code:count]                      200:50</span><br><span class="line">Error Set:</span><br></pre></td></tr></table></figure>

<h3 id="POST"><a href="#POST" class="headerlink" title="POST"></a>POST</h3><p>postè¯·æ±‚è¦æŒ‰ç…§webserveræ‰€ç»™å‡ºçš„æ ¼å¼æ¥å¡«å†™å¯¹åº”çš„è·¯å¾„å’Œè¯·æ±‚å‚æ•°ã€‚vegetaæä¾›-targetsæ¥è¯»å–ä½ åœ¨æ–‡æœ¬å†…æ‰€å®šä¹‰çš„ç›®æ ‡è¯·æ±‚ç«¯ã€‚æä¾›-bodyæŒ‡å®šä¸€ä¸ªæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶çš„å†…å®¹å°†è¢«è®¾ç½®ä¸ºæ¯ä¸ªè¯·æ±‚çš„ä¸»ä½“ï¼Œæ³¨æ„è¯·æ±‚ä¸»é¢˜å¦‚æœåœ¨bodyä¸­æŒ‡å®šäº†å°±ä¸è¦åœ¨targetçš„æ–‡ä»¶ä¸­æŒ‡å®šäº†ï¼Œå¦åˆ™ä¼šè¢«targetæ–‡ä»¶ä¸­çš„è®¾ç½®æ‰€è¦†ç›–ã€‚</p>
<ul>
<li><p>åŸå§‹çš„curlå‘½ä»¤è°ƒç”¨</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl -H &quot;Accept: application/json&quot; -H &quot;Content-type: application/json&quot; -X POST -d &#x27;&#123;&quot;version&quot;:&quot;1.0&quot;,&quot;caller&quot;:&quot;DES&quot;,&quot;password&quot;:&quot;DES&quot;,&quot;callee&quot;:&quot;TDSQL&quot;,&quot;eventId&quot;:101,&quot;timestamp&quot;:1435749309,&quot;interface&quot;:&#123;&quot;interfaceName&quot;:&quot;TDSQL.GetInstance&quot;,&quot;para&quot;:&#123;&quot;instance&quot;:[&#123;&quot;id&quot;:&quot;set_1614047032_1141&quot;&#125;]&#125;&#125;&#125;&#x27; 9.30.1.233:8080/tdsql</span><br></pre></td></tr></table></figure></li>
<li><p>å®šä¹‰ä¸€ä¸ª<code>target.txt</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST http://9.30.1.233:8080/tdsql</span><br></pre></td></tr></table></figure></li>
<li><p>å®šä¹‰ä¸€ä¸ªjson <code>body.json</code></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;  </span><br><span class="line"> <span class="attr">&quot;version&quot;</span>:<span class="string">&quot;1.0&quot;</span>,  </span><br><span class="line"> <span class="attr">&quot;caller&quot;</span>:<span class="string">&quot;DES&quot;</span>,  </span><br><span class="line"> <span class="attr">&quot;password&quot;</span>:<span class="string">&quot;DES&quot;</span>,  </span><br><span class="line"> <span class="attr">&quot;callee&quot;</span>:<span class="string">&quot;TDSQL&quot;</span>,  </span><br><span class="line"> <span class="attr">&quot;eventId&quot;</span>:<span class="number">101</span>,  </span><br><span class="line"> <span class="attr">&quot;timestamp&quot;</span>:<span class="number">1435749309</span>,  </span><br><span class="line"> <span class="attr">&quot;interface&quot;</span>:&#123;  </span><br><span class="line">Â Â Â Â Â Â Â Â <span class="attr">&quot;interfaceName&quot;</span>:<span class="string">&quot;TDSQL.GetInstance&quot;</span>,  </span><br><span class="line">Â Â Â Â Â Â Â Â <span class="attr">&quot;para&quot;</span>:&#123;  </span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â <span class="attr">&quot;instance&quot;</span>:[  </span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â &#123;  </span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <span class="attr">&quot;id&quot;</span>:<span class="string">&quot;set_1614047032_1141&quot;</span>  </span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â &#125;  </span><br><span class="line">Â Â Â Â Â Â Â Â Â Â Â Â ]  </span><br><span class="line">Â Â Â Â Â Â Â Â &#125;  </span><br><span class="line">Â Â Â Â &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>vegetaå‘½ä»¤</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vegeta -cpus 24 attack -targets target.txt -body body.json -timeout=20s -rate 500 -duration=10s | vegeta report</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="ç»“æœåˆ†æ"><a href="#ç»“æœåˆ†æ" class="headerlink" title="ç»“æœåˆ†æ"></a>ç»“æœåˆ†æ</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Requests      [total, rate, throughput]         5000, 500.09, 487.50</span><br><span class="line">Duration      [total, attack, wait]             10.256s, 9.998s, 258.046ms</span><br><span class="line">Latencies     [min, mean, 50, 90, 95, 99, max]  36.38ms, 57.077ms, 51.602ms, 62.614ms, 70.48ms, 279.916ms, 1.124s</span><br><span class="line">Bytes In      [total, mean]                     705000, 141.00</span><br><span class="line">Bytes Out     [total, mean]                     1710000, 342.00</span><br><span class="line">Success       [ratio]                           100.00%</span><br><span class="line">Status Codes  [code:count]                      200:5000</span><br><span class="line">Error Set:</span><br></pre></td></tr></table></figure>

<p><code>Requests</code> :</p>
<ul>
<li>   <code>total</code>  : å…¨éƒ¨çš„è¯·æ±‚æ•°é‡</li>
<li>  <code>rate</code> : çœŸæ­£çš„æ¯ç§’è¯·æ±‚é€Ÿç‡</li>
<li>  <code>throughput</code> : æ•´ä¸ªå‘¨æœŸæœŸé—´æˆåŠŸçš„è¯·æ±‚é€Ÿç‡</li>
</ul>
<p><code>Duration</code> :</p>
<ul>
<li><code>attack</code> : æ‰€æœ‰è¯·æ±‚æ‰€ç”¨çš„æ—¶é—´(<code>total</code> - <code>wait</code>) </li>
<li><code>wait</code> : ç­‰å¾…æœ€åä¸€æ¬¡å‘å‡ºè¯·æ±‚å“åº”çš„ç­‰å¾…æ—¶é—´(<code>total</code> - <code>attack</code>)</li>
<li><code>total</code> : æ€»æ—¶é—´</li>
</ul>
<p><code>Latency</code> : </p>
<ul>
<li><code>min</code> : æ‰€æœ‰è¯·æ±‚ä¸­æœ€å°çš„å»¶è¿Ÿ</li>
<li><code>mean</code> : å¹³å‡</li>
<li>50ã€90ã€95ã€99 åˆ†åˆ«æ˜¯æ”»å‡»ä¸­æ‰€æœ‰è¯·æ±‚å»¶è¿Ÿçš„ç¬¬ 50ã€90ã€95 å’Œ 99 ä¸ªç™¾åˆ†ä½æ•°ã€‚</li>
<li><code>max</code> : æœ€å¤§çš„å»¶è¿Ÿ</li>
</ul>
<p><code>Bytes In</code> &amp; <code>Bytes Out</code></p>
<ul>
<li>ä¸è¯·æ±‚æˆ–å“åº”æ­£æ–‡ä¸€èµ·å‘é€ï¼ˆè¾“å‡ºï¼‰æˆ–æ¥æ”¶ï¼ˆè¾“å…¥ï¼‰çš„å­—èŠ‚æ€»æ•°ã€‚</li>
</ul>
<p><code>Success</code></p>
<ul>
<li><code>ratio</code> : æˆåŠŸç‡æ˜¾ç¤ºå“åº”æœªå‡ºé”™ä¸”çŠ¶æ€ä»£ç ä»‹äº 200 å’Œ 400ï¼ˆä¸åŒ…æ‹¬åœ¨å†…ï¼‰ä¹‹é—´çš„è¯·æ±‚çš„ç™¾åˆ†æ¯”ã€‚</li>
</ul>
<p><code>Status Codes</code></p>
<ul>
<li>æ˜¾ç¤ºçŠ¶æ€ä»£ç çš„ç›´æ–¹å›¾ã€‚ 0 çŠ¶æ€ç è¡¨ç¤ºè¯·æ±‚å‘é€å¤±è´¥ã€‚</li>
</ul>
<p><code>Error Set</code></p>
<ul>
<li>é”™è¯¯é›†æ˜¾ç¤ºæ‰€æœ‰å‘å‡ºçš„è¯·æ±‚è¿”å›çš„ä¸€ç»„å”¯ä¸€é”™è¯¯ã€‚ å…¶ä¸­åŒ…æ‹¬è·å¾—ä¸æˆåŠŸå“åº”çŠ¶æ€ä»£ç çš„è¯·æ±‚ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>æµ‹è¯•</category>
      </categories>
      <tags>
        <tag>vegeta</tag>
        <tag>æµ‹è¯•</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆè¯†grpcå’Œå¿«é€Ÿä¸Šæ‰‹</title>
    <url>/2022/05/17/%E5%88%9D%E8%AF%86grpc%E5%92%8C%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/</url>
    <content><![CDATA[<p>ç®€å•åˆæ­¥å­¦ä¹ ä¸‹grpcã€‚</p>
<span id="more"></span>

<!-- toc -->
<h2 id="grpcçš„åŠ¨æœº"><a href="#grpcçš„åŠ¨æœº" class="headerlink" title="grpcçš„åŠ¨æœº"></a>grpcçš„åŠ¨æœº</h2><ul>
<li>ä¸åŒè¯­è¨€ä¹‹é—´çš„é€šè¡Œ(å‰åç«¯è¯­è¨€ä¸åŒ )</li>
<li>æ›´é«˜æ•ˆçš„é€šä¿¡ </li>
<li>æ›´ç®€å•çš„é€šä¿¡ </li>
</ul>
<p> grpcæ˜¯ä»€ä¹ˆ</p>
<ul>
<li>è°·æ­Œå‘æ˜çš„rpcæ¡†æ¶</li>
<li><strong>rpc</strong> ï¼ˆromote procedure calls ï¼‰</li>
</ul>
<h3 id="grpcå¦‚ä½•å·¥ä½œçš„"><a href="#grpcå¦‚ä½•å·¥ä½œçš„" class="headerlink" title="grpcå¦‚ä½•å·¥ä½œçš„"></a>grpcå¦‚ä½•å·¥ä½œçš„</h3><ul>
<li>å®¢æˆ·ç«¯å…·æœ‰åœ¨æœåŠ¡å™¨ä¸­æä¾›ç›¸åŒæ–¹æ³•çš„å­˜æ ¹</li>
<li>ä½¿ç”¨<code>protocol buffer</code>ç”Ÿæˆä»£ç ï¼ˆå­˜æ ¹stubï¼‰</li>
</ul>
<h3 id="åè®®ç¼“å†²åŒºï¼ˆprotocol-bufferï¼‰"><a href="#åè®®ç¼“å†²åŒºï¼ˆprotocol-bufferï¼‰" class="headerlink" title="åè®®ç¼“å†²åŒºï¼ˆprotocol bufferï¼‰"></a>åè®®ç¼“å†²åŒºï¼ˆprotocol bufferï¼‰</h3><ul>
<li>å¯ä»¥ç”Ÿäº§å¤šç§è¯­è¨€çš„ä»£ç </li>
<li>ä¼ è¾“é€Ÿåº¦æ›´å¿«ï¼Œåºåˆ—åŒ–ç¨‹åº¦é«˜</li>
<li>å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æ›´å¼ºçš„é“¾æ¥</li>
<li>æ›´å¥½çš„apiæ¼”åŒ–è§„åˆ™</li>
</ul>
<h2 id="å¾®æœåŠ¡"><a href="#å¾®æœåŠ¡" class="headerlink" title="å¾®æœåŠ¡"></a>å¾®æœåŠ¡</h2><p>å¸¸ç”¨çš„å¾®æœåŠ¡æ¡†æ¶<br><img src="/2022/05/17/%E5%88%9D%E8%AF%86grpc%E5%92%8C%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/image-20220422231420347.png" title="å¾®æœåŠ¡æ¡†æ¶"><br>é€šè¿‡ä¸Šè¿°çš„æ¶æ„ï¼Œè§£å†³äº†å•ä½“æ¶æ„çš„å¼Šç«¯ã€‚</p>
<p>ä½†åŒæ—¶å¼•å…¥äº†æ–°çš„é—®é¢˜ï¼š</p>
<ol>
<li> ä»£ç å†—ä½™: é€šè¿‡è®¤è¯ä¸­å¿ƒç»Ÿä¸€ç›¸åŒæœåŠ¡</li>
<li> æœåŠ¡å’ŒæœåŠ¡ä¹‹é—´å­˜åœ¨è°ƒç”¨å…³ç³»: é€šè¿‡rpcè§£å†³ä¸åŒæœåŠ¡ä¹‹é—´çš„é€šä¿¡é—®é¢˜</li>
</ol>
<p><img src="/2022/05/17/%E5%88%9D%E8%AF%86grpc%E5%92%8C%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/image-20220422233632635.png" title="æ³¨å†Œä¸­å¿ƒ"><br>æœåŠ¡æ²»ç†ä¸­æœ‰ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µ<code>æœåŠ¡å‘ç°</code>ï¼ŒæœåŠ¡å‘ç°ä¸­æœ‰ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µå«åš<code>æ³¨å†Œä¸­å¿ƒ</code>ã€‚<br>æ¯ä¸ªæœåŠ¡å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå°†è‡ªèº«çš„æœåŠ¡å’Œipæ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒï¼Œå…¶ä»–æœåŠ¡è°ƒç”¨çš„æ—¶å€™ï¼Œåªéœ€è¦å‘æ³¨å†Œä¸­å¿ƒç”³è¯·åœ°å€å³å¯ã€‚</p>
<h2 id="protobuf"><a href="#protobuf" class="headerlink" title="protobuf"></a>protobuf</h2><p>gRPCé»˜è®¤ä½¿ç”¨<code>protocol buffers</code>ï¼Œè¿™æ˜¯googleå¼€æºçš„ä¸€å¥—æˆç†Ÿçš„ç»“æ„æ•°æ®åºåˆ—åŒ–æœºåˆ¶ã€‚</p>
<p><strong>åºåˆ—åŒ–</strong>ï¼šå°†æ•°æ®ç»“æ„æˆ–å¯¹è±¡è½¬æ¢æˆäºŒè¿›åˆ¶ä¸²çš„è¿‡ç¨‹ã€‚</p>
<p><strong>ååºåˆ—åŒ–</strong>ï¼šå°†åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„äºŒè¿›åˆ¶ä¸²è½¬æ¢æˆæ•°æ®ç»“æ„æˆ–å¯¹è±¡çš„è¿‡ç¨‹ã€‚</p>
<blockquote>
<p>å¦‚ä½•ä½¿ç”¨protobufå‘¢ï¼Ÿï¼ˆ1.å†™ä»£ç  2.ç¼–è¯‘ï¼‰</p>
</blockquote>
<ol>
<li>å®šä¹‰äº†ä¸€ç§æºæ–‡ä»¶ï¼Œæ‰©å±•åä¸º <code>.proto</code>ï¼Œä½¿ç”¨è¿™ç§æºæ–‡ä»¶ï¼Œå¯ä»¥å®šä¹‰å­˜å‚¨ç±»çš„å†…å®¹(æ¶ˆæ¯ç±»å‹)</li>
<li> protobufæœ‰è‡ªå·±çš„ç¼–è¯‘å™¨ <code>protoc</code>ï¼Œå¯ä»¥å°† <code>.proto</code> ç¼–è¯‘æˆå¯¹åº”è¯­è¨€çš„æ–‡ä»¶ï¼Œå°±å¯ä»¥è¿›è¡Œä½¿ç”¨äº†</li>
</ol>
<h3 id="protoç¼–å†™"><a href="#protoç¼–å†™" class="headerlink" title="protoç¼–å†™"></a>protoç¼–å†™</h3><figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æŒ‡å®šçš„å½“å‰protoè¯­æ³•çš„ç‰ˆæœ¬ï¼Œæœ‰2å’Œ3</span></span><br><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="comment">//option go_package = &quot;path;name&quot;; ath è¡¨ç¤ºç”Ÿæˆçš„goæ–‡ä»¶çš„å­˜æ”¾åœ°å€ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆç›®å½•çš„</span></span><br><span class="line"><span class="comment">// name è¡¨ç¤ºç”Ÿæˆçš„goæ–‡ä»¶æ‰€å±çš„åŒ…å</span></span><br><span class="line"><span class="keyword">option</span> go_package=<span class="string">&quot;../service&quot;</span>;</span><br><span class="line"><span class="comment">// æŒ‡å®šç­‰ä¼šæ–‡ä»¶ç”Ÿæˆå‡ºæ¥çš„package</span></span><br><span class="line"><span class="keyword">package</span> <span class="class"><span class="keyword">service</span>;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">message</span> User </span>&#123;</span><br><span class="line">  <span class="built_in">string</span> username = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">int32</span> age = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># ç¼–è¯‘user.protoä¹‹åè¾“å‡ºåˆ°serviceæ–‡ä»¶å¤¹</span><br><span class="line">protoc --go_out=../service user.proto</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæœ‰ä¸¤ä¸ªå‘:</p>
<ul>
<li><code>go install google.golang.org/protobuf/cmd/protoc-gen-go@latest</code>ä½¿ç”¨è¿™ä¸ªå‘½ä»¤æ‹‰å»goçš„protocç¼–è¯‘å™¨</li>
<li>ç¯å¢ƒå˜é‡æ·»åŠ ``export PATH=$PATH:$GOPATH/bin</li>
</ul>
<p>ä½¿ç”¨<br>demoä¾‹å­</p>
<figure class="highlight golang"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">   user := &amp;service.User&#123;  </span><br><span class="line">      Username: <span class="string">&quot;enming&quot;</span>,  </span><br><span class="line">      Age:      <span class="number">18</span>,  </span><br><span class="line">   &#125;  </span><br><span class="line">   <span class="comment">// åºåˆ—åŒ–  </span></span><br><span class="line">   marshal, err := proto.Marshal(user)  </span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">      fmt.Println(err)  </span><br><span class="line">      <span class="built_in">panic</span>(err)  </span><br><span class="line">   &#125;  </span><br><span class="line">   <span class="comment">// ååºåˆ—åŒ–  </span></span><br><span class="line">   oneUser := &amp;service.User&#123;&#125;  </span><br><span class="line">   err = proto.Unmarshal(marshal, oneUser)  </span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">      fmt.Println(err)  </span><br><span class="line">      <span class="built_in">panic</span>(err)  </span><br><span class="line">   &#125;  </span><br><span class="line">   fmt.Println(oneUser.String())  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="protoè¯­æ³•"><a href="#protoè¯­æ³•" class="headerlink" title="protoè¯­æ³•"></a>protoè¯­æ³•</h3><h4 id="message"><a href="#message" class="headerlink" title="message"></a>message</h4><p><code>message</code>ï¼š<code>protobuf</code>ä¸­å®šä¹‰ä¸€ä¸ªæ¶ˆæ¯ç±»å‹æ˜¯é€šè¿‡å…³é”®å­—<code>message</code>å­—æ®µæŒ‡å®šçš„ã€‚<br>æ¶ˆæ¯å°±æ˜¯éœ€è¦ä¼ è¾“çš„æ•°æ®æ ¼å¼çš„å®šä¹‰ã€‚<br>ç±»ä¼¼äºc++çš„ç±»</p>
<p>eg:</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">  <span class="built_in">string</span> username = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">int32</span> age = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">optional</span> <span class="built_in">string</span> password = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">repeated</span> <span class="built_in">string</span> address = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>required</code>:æ¶ˆæ¯ä½“ä¸­å¿…å¡«å­—æ®µï¼Œä¸è®¾ç½®ä¼šå¯¼è‡´ç¼–è§£ç å¼‚å¸¸ã€‚ï¼ˆä¾‹å¦‚ä½ç½®1ï¼‰</li>
<li><code>optional</code>: æ¶ˆæ¯ä½“ä¸­å¯é€‰å­—æ®µã€‚ï¼ˆä¾‹å¦‚ä½ç½®3ï¼‰</li>
<li>  <code>repeated</code>: æ¶ˆæ¯ä½“ä¸­å¯é‡å¤å­—æ®µï¼Œé‡å¤çš„å€¼çš„é¡ºåºä¼šè¢«ä¿ç•™ï¼ˆä¾‹å¦‚ä½ç½®3ï¼‰åœ¨goä¸­é‡å¤çš„ä¼šè¢«å®šä¹‰ä¸ºåˆ‡ç‰‡ã€‚</li>
</ul>
<p><code>æ ‡è¯†å·</code>ï¼šåœ¨æ¶ˆæ¯ä½“çš„å®šä¹‰ä¸­ï¼Œæ¯ä¸ªå­—æ®µéƒ½å¿…é¡»è¦æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†å·ï¼Œæ ‡è¯†å·æ˜¯[0,2^29-1]èŒƒå›´å†…çš„ä¸€ä¸ªæ•´æ•°ã€‚</p>
<h4 id="å®šä¹‰æœåŠ¡"><a href="#å®šä¹‰æœåŠ¡" class="headerlink" title="å®šä¹‰æœåŠ¡"></a>å®šä¹‰æœåŠ¡</h4><p>å¦‚æœæƒ³è¦å°†æ¶ˆæ¯ç±»å‹ç”¨åœ¨RPCç³»ç»Ÿä¸­ï¼Œå¯ä»¥åœ¨.protoæ–‡ä»¶ä¸­å®šä¹‰ä¸€ä¸ªRPCæœåŠ¡æ¥å£ï¼Œprotocol buffer ç¼–è¯‘å™¨å°†ä¼šæ ¹æ®æ‰€é€‰æ‹©çš„ä¸åŒè¯­è¨€ç”ŸæˆæœåŠ¡æ¥å£ä»£ç åŠå­˜æ ¹ã€‚</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">SearchService</span> </span>&#123;</span><br><span class="line">	<span class="comment">//rpc æœåŠ¡çš„å‡½æ•°å ï¼ˆä¼ å…¥å‚æ•°ï¼‰è¿”å›ï¼ˆè¿”å›å‚æ•°ï¼‰</span></span><br><span class="line">	<span class="function"><span class="keyword">rpc</span> Search (SearchRequest) <span class="keyword">returns</span> (SearchResponse)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°ä»£è¡¨è¡¨ç¤ºï¼Œå®šä¹‰äº†ä¸€ä¸ªRPCæœåŠ¡ï¼Œè¯¥æ–¹æ³•æ¥æ”¶SearchRequestè¿”å›SearchResponse</p>
<h2 id="grpcå®ä¾‹"><a href="#grpcå®ä¾‹" class="headerlink" title="grpcå®ä¾‹"></a>grpcå®ä¾‹</h2><p><a href="https://github.com/HannoKishi/grpc_demo">githubä»£ç </a><br><a href="https://grpc.io/docs/languages/go/quickstart/#regenerate-grpc-code">å®˜æ–¹å‚è€ƒå®ä¾‹</a></p>
<ul>
<li>ç”Ÿæˆä¸€ä¸ªæœåŠ¡å™¨çš„proto</li>
</ul>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="comment">// The greeting service definition.</span></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">Greeter</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Sends a greeting</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply) </span>&#123;&#125;</span><br><span class="line">  <span class="comment">// Sends another greeting</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> SayHelloAgain (HelloRequest) <span class="keyword">returns</span> (HelloReply) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The request message containing the user&#x27;s name.</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">HelloRequest</span> </span>&#123;</span><br><span class="line">  <span class="built_in">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The response message containing the greetings</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">HelloReply</span> </span>&#123;</span><br><span class="line">  <span class="built_in">string</span> <span class="class"><span class="keyword">message</span> = 1;</span></span><br><span class="line"><span class="class">&#125;</span></span><br></pre></td></tr></table></figure>

<p>å‘:  æå‰å®‰è£…æ’ä»¶å’Œç¯å¢ƒè·¯å¾„è®¾ç½®å¥½</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28</span><br><span class="line">$ go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.2</span><br></pre></td></tr></table></figure>

<ul>
<li><code>protoc --go-grpc_out=./ helloworld.proto</code> ç”Ÿæˆæ¥å£çš„pb.goæ–‡ä»¶</li>
<li><code>protoc --go_out=./ helloworld.proto</code> ç”Ÿæˆè¯·æ±‚å’Œè¿”å›çš„ç»“æ„ä½“çš„pb.goæ–‡ä»¶</li>
</ul>
<ul>
<li>å®ç°è¿™ä¸ªæ¥å£çš„æ–¹æ³•</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¿™ä¸ªæ˜¯ç”Ÿæˆçš„ helloworld_grpc.pb.goé‡Œé¢çš„æ¥å£</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//type GreeterServer interface &#123;  </span></span><br><span class="line"><span class="comment">// // Sends a greeting  </span></span><br><span class="line"><span class="comment">// SayHello(context.Context, *HelloRequest) (*HelloReply, error)  </span></span><br><span class="line"><span class="comment">// // Sends another greeting  </span></span><br><span class="line"><span class="comment">// SayHelloAgain(context.Context, *HelloRequest) (*HelloReply, error)  </span></span><br><span class="line"><span class="comment">// mustEmbedUnimplementedGreeterServer()  </span></span><br><span class="line"><span class="comment">//&#125;  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°è¯¥æ¥å£çš„æ‰€æœ‰æ–¹æ³•</span></span><br><span class="line"><span class="keyword">type</span> GreaterHandle <span class="keyword">struct</span> &#123;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *GreaterHandle)</span> <span class="title">SayHello</span><span class="params">(context context.Context, req *HelloRequest)</span> <span class="params">(*HelloReply, error)</span></span> &#123;  </span><br><span class="line">   <span class="keyword">return</span> &amp;HelloReply&#123;Message: <span class="string">&quot;nihao&quot;</span>&#125;, <span class="literal">nil</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *GreaterHandle)</span> <span class="title">SayHelloAgain</span><span class="params">(context context.Context, res *HelloRequest)</span> <span class="params">(*HelloReply, error)</span></span> &#123;  </span><br><span class="line">   <span class="keyword">return</span> &amp;HelloReply&#123;Message: <span class="string">&quot;nihao too&quot;</span>&#125;, <span class="literal">nil</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *GreaterHandle)</span> <span class="title">mustEmbedUnimplementedGreeterServer</span><span class="params">()</span></span> &#123;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>æœåŠ¡å™¨ä»£ç </p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">   <span class="string">&quot;google.golang.org/grpc&quot;</span>  </span><br><span class="line">   <span class="string">&quot;helloworld/service&quot;</span>   <span class="string">&quot;log&quot;</span>   <span class="string">&quot;net&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">   <span class="comment">// ç”Ÿæˆä¸€ä¸ªgrpcçš„æœåŠ¡å™¨  </span></span><br><span class="line">   server := grpc.NewServer()  </span><br><span class="line">   <span class="comment">// å‘æœåŠ¡å™¨æ³¨å†Œæ¥å£å’Œhandle  </span></span><br><span class="line">   service.RegisterProdServiceServer(server, &amp;service.ProductService&#123;&#125;)  </span><br><span class="line">   service.RegisterGreeterServer(server, &amp;service.GreaterHandle&#123;&#125;)  </span><br><span class="line">   listener, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;:8002&quot;</span>)  </span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">      log.Fatal(<span class="string">&quot;æœåŠ¡ç›‘å¬ç«¯å£å¤±è´¥&quot;</span>, err)  </span><br><span class="line">   &#125;  </span><br><span class="line">   <span class="comment">// æœåŠ¡å™¨å¯åŠ¨  </span></span><br><span class="line">   _ = server.Serve(listener)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>å®¢æˆ·ç«¯ä»£ç </p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">   <span class="string">&quot;context&quot;</span>  </span><br><span class="line">   <span class="string">&quot;fmt&quot;</span>   <span class="string">&quot;google.golang.org/grpc&quot;</span>   <span class="string">&quot;google.golang.org/grpc/credentials/insecure&quot;</span>   <span class="string">&quot;helloworld/service&quot;</span>   <span class="string">&quot;log&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">   <span class="comment">// 1. æ–°å»ºè¿æ¥ï¼Œç«¯å£æ˜¯æœåŠ¡ç«¯å¼€æ”¾çš„8002ç«¯å£  </span></span><br><span class="line">   <span class="comment">// æ²¡æœ‰è¯ä¹¦ä¼šæŠ¥é”™  </span></span><br><span class="line">   conn, err := grpc.Dial(<span class="string">&quot;:8002&quot;</span>, grpc.WithTransportCredentials(insecure.NewCredentials()))  </span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">      log.Fatal(err)  </span><br><span class="line">   &#125;  </span><br><span class="line">  </span><br><span class="line">   <span class="comment">// é€€å‡ºæ—¶å…³é—­é“¾æ¥  </span></span><br><span class="line">   <span class="keyword">defer</span> conn.Close()  </span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 2. è°ƒç”¨Product.pb.goä¸­çš„NewProdServiceClientæ–¹æ³•  </span></span><br><span class="line">   <span class="comment">// productServiceClient := service.NewProdServiceClient(conn)  </span></span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 3. ç›´æ¥åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·è°ƒç”¨GetProductStockæ–¹æ³•  </span></span><br><span class="line">   <span class="comment">// resp, err := productServiceClient.GetProductStock(context.Background(), &amp;service.ProductRequest&#123;ProdId: 233&#125;)  </span></span><br><span class="line">   greeterClient := service.NewGreeterClient(conn)  </span><br><span class="line">   resp, err := greeterClient.SayHello(context.Background(), &amp;service.HelloRequest&#123;Name: <span class="string">&quot;i&quot;</span>&#125;)  </span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">      log.Fatal(<span class="string">&quot;è°ƒç”¨gRPCæ–¹æ³•é”™è¯¯: &quot;</span>, err)  </span><br><span class="line">   &#125;  </span><br><span class="line">  </span><br><span class="line">   fmt.Println(<span class="string">&quot;è°ƒç”¨gRPCæ–¹æ³•æˆåŠŸï¼ŒProdStock = &quot;</span>, resp.Message)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>æ¡†æ¶å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>golang</tag>
        <tag>grpc</tag>
      </tags>
  </entry>
  <entry>
    <title>æ™ºèƒ½æŒ‡é’ˆä¸å†…å­˜ç®¡ç†</title>
    <url>/2022/03/31/%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%E4%B8%8E%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/</url>
    <content><![CDATA[<p>c++11/17/20æ–°ç‰¹æ€§å­¦ä¹ ç¬”è®°</p>
<span id="more"></span>

<!-- toc -->
<h2 id="RAII-ä¸å¼•ç”¨è®¡æ•°"><a href="#RAII-ä¸å¼•ç”¨è®¡æ•°" class="headerlink" title="RAII ä¸å¼•ç”¨è®¡æ•°"></a>RAII ä¸å¼•ç”¨è®¡æ•°</h2><ul>
<li>ä»€ä¹ˆæ˜¯RAIIï¼Ÿ<br><code>RAII</code>æ˜¯Resource Acquisition Is Initializationï¼ˆwikiä¸Šé¢ç¿»è¯‘æˆ â€œèµ„æºè·å–å°±æ˜¯åˆå§‹åŒ–â€ï¼‰çš„ç®€ç§°ï¼Œæ˜¯C++è¯­è¨€çš„ä¸€ç§ç®¡ç†èµ„æºã€é¿å…æ³„æ¼çš„æƒ¯ç”¨æ³•ã€‚åˆ©ç”¨çš„å°±æ˜¯C++æ„é€ çš„å¯¹è±¡æœ€ç»ˆä¼šè¢«é”€æ¯çš„åŸåˆ™ã€‚RAIIçš„åšæ³•æ˜¯ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨å…¶æ„é€ æ—¶è·å–å¯¹åº”çš„èµ„æºï¼Œåœ¨å¯¹è±¡ç”Ÿå‘½æœŸå†…æ§åˆ¶å¯¹èµ„æºçš„è®¿é—®ï¼Œä½¿ä¹‹å§‹ç»ˆä¿æŒæœ‰æ•ˆï¼Œæœ€ååœ¨å¯¹è±¡ææ„çš„æ—¶å€™ï¼Œé‡Šæ”¾æ„é€ æ—¶è·å–çš„èµ„æºã€‚<br>è€Œ C++11 å¼•å…¥äº†æ™ºèƒ½æŒ‡é’ˆçš„æ¦‚å¿µï¼Œä½¿ç”¨äº†å¼•ç”¨è®¡æ•°çš„æƒ³æ³•ï¼Œè®©ç¨‹åº å‘˜ä¸å†éœ€è¦å…³å¿ƒæ‰‹åŠ¨é‡Šæ”¾å†…å­˜ã€‚è¿™äº›æ™ºèƒ½æŒ‡é’ˆå°±åŒ…æ‹¬ <code>std::shared_ptr</code>/<code>std::unique_ptr</code>/<code>std::weak_ptr</code>ï¼Œ ä½¿ç”¨å®ƒä»¬éœ€è¦åŒ…å«å¤´æ–‡ä»¶ <memory>ã€‚</li>
</ul>
<h3 id="std-shared-ptr"><a href="#std-shared-ptr" class="headerlink" title="std::shared_ptr"></a>std::shared_ptr</h3><p>std::shared_ptr æ˜¯ä¸€ç§æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒèƒ½å¤Ÿè®°å½•å¤šå°‘ä¸ª shared_ptr å…±åŒæŒ‡å‘ä¸€ä¸ªå¯¹è±¡ï¼Œä»è€Œæ¶ˆé™¤æ˜¾ç¤ºçš„è°ƒç”¨ deleteï¼Œå½“å¼•ç”¨è®¡æ•°å˜ä¸ºé›¶çš„æ—¶å€™å°±ä¼šå°†å¯¹è±¡è‡ªåŠ¨åˆ é™¤ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç”ŸæˆsharedæŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">// æ˜ç¡®åªå‘</span></span><br><span class="line"><span class="keyword">auto</span> p = std::shared_ptr&lt;<span class="keyword">int</span>&gt;(<span class="keyword">new</span> <span class="built_in"><span class="keyword">int</span></span>(<span class="number">1</span>));</span><br><span class="line"><span class="comment">// ä½¿ç”¨make_sharedåˆå§‹åŒ–</span></span><br><span class="line"><span class="keyword">auto</span> pointer = std::make_shared&lt;<span class="keyword">int</span>&gt;(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//  std::shared_ptr å¯ä»¥é€šè¿‡ get() æ–¹æ³•æ¥è·å–åŸå§‹æŒ‡é’ˆï¼Œé€šè¿‡ reset() æ¥å‡å°‘ä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼Œå¹¶ é€šè¿‡ use_count() æ¥æŸ¥çœ‹ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚</span></span><br><span class="line"><span class="keyword">auto</span> pointer = std::make_shared&lt;<span class="keyword">int</span>&gt;(<span class="number">10</span>);  </span><br><span class="line"><span class="keyword">auto</span> pointer2 = pointer; <span class="comment">// å¼•ç”¨è®¡æ•° +1  </span></span><br><span class="line"><span class="keyword">auto</span> pointer3 = pointer; <span class="comment">// å¼•ç”¨è®¡æ•° +1  </span></span><br><span class="line"><span class="keyword">int</span> *p = pointer.<span class="built_in">get</span>(); <span class="comment">// è¿™æ ·ä¸ä¼šå¢åŠ å¼•ç”¨è®¡æ•°  </span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;pointer.use_count() = &quot;</span> &lt;&lt; pointer.<span class="built_in">use_count</span>() &lt;&lt; std::endl; <span class="comment">// 3 </span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;pointer2.use_count() = &quot;</span> &lt;&lt; pointer2.<span class="built_in">use_count</span>() &lt;&lt; std::endl; <span class="comment">// 3</span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;pointer3.use_count() = &quot;</span> &lt;&lt; pointer3.<span class="built_in">use_count</span>() &lt;&lt; std::endl; <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  ä½¿ç”¨resetæ¥å‡å°‘</span></span><br><span class="line">pointer2.<span class="built_in">reset</span>();  </span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;reset pointer2:&quot;</span> &lt;&lt; std::endl;  </span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;pointer.use_count() = &quot;</span> &lt;&lt; pointer.<span class="built_in">use_count</span>() &lt;&lt; std::endl; <span class="comment">// 2</span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;pointer2.use_count() = &quot;</span> &lt;&lt; pointer2.<span class="built_in">use_count</span>() &lt;&lt; std::endl; <span class="comment">// 0, pointer2 å·² reset </span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;pointer3.use_count() = &quot;</span> &lt;&lt; pointer3.<span class="built_in">use_count</span>() &lt;&lt; std::endl; <span class="comment">// 2</span></span><br></pre></td></tr></table></figure>

<h3 id="std-unique-ptr"><a href="#std-unique-ptr" class="headerlink" title="std::unique_ptr"></a>std::unique_ptr</h3><p>std::unique_ptr æ˜¯ä¸€ç§ç‹¬å çš„æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒç¦æ­¢å…¶ä»–æ™ºèƒ½æŒ‡é’ˆä¸å…¶å…±äº«åŒä¸€ä¸ªå¯¹è±¡ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">std::unique_ptr&lt;<span class="keyword">int</span>&gt; pointer = std::make_unique&lt;<span class="keyword">int</span>&gt;(<span class="number">10</span>); <span class="comment">// make_unique ä» C++14 å¼•å…¥ </span></span><br><span class="line">std::unique_ptr&lt;<span class="keyword">int</span>&gt; pointer2 = pointer; <span class="comment">// éæ³•</span></span><br></pre></td></tr></table></figure>
<p>è™½ç„¶æ˜¯ä¸å¯å¤åˆ¶çš„æŒ‡é’ˆï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡std::moveå°†å…¶è½¬ç§»ç»™å…¶ä»–çš„unque_ptr</p>
<h3 id="std-weak-ptr"><a href="#std-weak-ptr" class="headerlink" title="std::weak_ptr"></a>std::weak_ptr</h3><h4 id="std-shared-ptrçš„å¾ªç¯å¼•ç”¨é—®é¢˜"><a href="#std-shared-ptrçš„å¾ªç¯å¼•ç”¨é—®é¢˜" class="headerlink" title="std::shared_ptrçš„å¾ªç¯å¼•ç”¨é—®é¢˜"></a>std::shared_ptrçš„å¾ªç¯å¼•ç”¨é—®é¢˜</h4><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">A</span>;</span> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">B</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">A</span> &#123;</span>  </span><br><span class="line">	std::shared_ptr&lt;B&gt; pointer; </span><br><span class="line">	~<span class="built_in">A</span>() &#123;</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;A è¢«é”€æ¯&quot;</span> &lt;&lt; std::endl; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">B</span> &#123;</span></span><br><span class="line">	std::shared_ptr&lt;A&gt; pointer;</span><br><span class="line">	~<span class="built_in">B</span>() &#123; </span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;B è¢«é”€æ¯&quot;</span> &lt;&lt; std::endl; </span><br><span class="line">		&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; </span><br><span class="line">	<span class="keyword">auto</span> a = std::make_shared&lt;A&gt;(); </span><br><span class="line">	<span class="keyword">auto</span> b = std::make_shared&lt;B&gt;(); </span><br><span class="line">	a-&gt;pointer = b;  </span><br><span class="line">	b-&gt;pointer = a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœæ˜¯ A, B éƒ½ä¸ä¼šè¢«é”€æ¯ï¼Œè¿™æ˜¯å› ä¸º a,b å†…éƒ¨çš„ pointer åŒæ—¶åˆå¼•ç”¨äº† a,bï¼Œè¿™ä½¿å¾— a,b çš„å¼• ç”¨è®¡æ•°å‡å˜ä¸ºäº† 2ï¼Œè€Œç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œa,b æ™ºèƒ½æŒ‡é’ˆè¢«ææ„ï¼Œå´åªèƒ½é€ æˆè¿™å—åŒºåŸŸçš„å¼•ç”¨è®¡æ•°å‡ä¸€ï¼Œè¿™æ · å°±å¯¼è‡´äº† a,b å¯¹è±¡æŒ‡å‘çš„å†…å­˜åŒºåŸŸå¼•ç”¨è®¡æ•°ä¸ä¸ºé›¶ï¼Œè€Œå¤–éƒ¨å·²ç»æ²¡æœ‰åŠæ³•æ‰¾åˆ°è¿™å—åŒºåŸŸäº†ï¼Œä¹Ÿå°±é€ æˆäº†å†…å­˜æ³„éœ²ã€‚<br>è§£å†³è¿™ä¸ªé—®é¢˜çš„åŠæ³•å°±æ˜¯ä½¿ç”¨å¼±å¼•ç”¨æŒ‡é’ˆ <code>std::weak_ptr</code>, å¼±å¼•ç”¨ä¸ä¼šå¼•èµ·å¼•ç”¨è®¡æ•°å¢åŠ ã€‚<br><code>std::weak_ptr</code> æ²¡æœ‰ * è¿ç®—ç¬¦å’Œ -&gt; è¿ç®—ç¬¦ï¼Œæ‰€ä»¥ä¸èƒ½å¤Ÿå¯¹èµ„æºè¿›è¡Œæ“ä½œï¼Œå®ƒçš„å”¯ä¸€ä½œç”¨å°±æ˜¯ç”¨äº æ£€æŸ¥ <code>std::shared_ptr </code>æ˜¯å¦å­˜åœ¨ï¼Œå…¶ expired() æ–¹æ³•èƒ½åœ¨èµ„æºæœªè¢«é‡Šæ”¾æ—¶ï¼Œä¼šè¿”å› falseï¼Œå¦åˆ™è¿”å› trueã€‚</p>
]]></content>
      <categories>
        <category>è¯­è¨€å­¦ä¹ </category>
        <category>c++</category>
        <category>ç°ä»£c++</category>
      </categories>
      <tags>
        <tag>c++</tag>
      </tags>
  </entry>
  <entry>
    <title>å®¹å™¨å¼ºåŒ–</title>
    <url>/2022/03/31/%E5%AE%B9%E5%99%A8%E5%BC%BA%E5%8C%96/</url>
    <content><![CDATA[<p>c++11/17/20æ–°ç‰¹æ€§å­¦ä¹ ç¬”è®°</p>
<span id="more"></span>

<!-- toc -->
<h2 id="çº¿æ€§å®¹å™¨"><a href="#çº¿æ€§å®¹å™¨" class="headerlink" title="çº¿æ€§å®¹å™¨"></a>çº¿æ€§å®¹å™¨</h2><h3 id="std-array"><a href="#std-array" class="headerlink" title="std::array"></a>std::array</h3><p>åŸå› ï¼šstd::arrayå¤§å°æ˜¯å›ºå®šçš„ï¼Œè€Œstd::vectorä¼šè‡ªåŠ¨æ‰©å®¹</p>
<p>ä½¿ç”¨ std::array å¾ˆç®€å•ï¼Œåªéœ€æŒ‡å®šå…¶ç±»å‹å’Œå¤§å°å³å¯:</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">std::array&lt;<span class="keyword">int</span>, 4&gt; arr = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;;</span><br><span class="line">arr.<span class="built_in">empty</span>(); <span class="comment">// æ£€æŸ¥å®¹å™¨æ˜¯å¦ä¸ºç©º arr.size(); // è¿”å›å®¹çº³çš„å…ƒç´ æ•°</span></span><br><span class="line"><span class="comment">// è¿­ä»£å™¨æ”¯æŒ  </span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> &amp;i : arr) &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç”¨ lambda è¡¨è¾¾å¼æ’åº  </span></span><br><span class="line">std::<span class="built_in">sort</span>(arr.<span class="built_in">begin</span>(), arr.<span class="built_in">end</span>(), [](<span class="keyword">int</span> a, <span class="keyword">int</span> b) &#123;</span><br><span class="line">	<span class="keyword">return</span> b &lt; a; </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•°ç»„å¤§å°å‚æ•°å¿…é¡»æ˜¯å¸¸é‡è¡¨è¾¾å¼  </span></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">int</span> len = <span class="number">4</span>;  </span><br><span class="line">std::array&lt;<span class="keyword">int</span>, len&gt; arr = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="æ— åºå®¹å™¨"><a href="#æ— åºå®¹å™¨" class="headerlink" title="æ— åºå®¹å™¨"></a>æ— åºå®¹å™¨</h2><p>ä¼ ç»Ÿ C++ ä¸­çš„æœ‰åºå®¹å™¨ std::map/std::setï¼Œ å†…éƒ¨é€šè¿‡çº¢é»‘æ ‘è¿›è¡Œå®ç°ï¼Œ æ’å…¥å’Œæœç´¢çš„å¹³å‡å¤æ‚åº¦å‡ä¸º O(log(size))ã€‚<br>æ— åºå®¹å™¨ä¸­çš„å…ƒç´ æ˜¯ä¸è¿›è¡Œæ’åºçš„ï¼Œå†…éƒ¨é€šè¿‡ Hash è¡¨å®ç°ï¼Œæ’å…¥å’Œæœç´¢å…ƒç´ çš„å¹³å‡å¤æ‚åº¦ä¸º O(constant)åœ¨ä¸å…³å¿ƒå®¹å™¨å†…éƒ¨å…ƒç´ é¡ºåºæ—¶ï¼Œèƒ½å¤Ÿè·å¾—æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚<br>c++11å¼•å…¥äº† std::unordered_map/std::unordered_multimap å’Œ std::unordered_set/std::unordered_multiset</p>
<h2 id="å…ƒç»„"><a href="#å…ƒç»„" class="headerlink" title="å…ƒç»„"></a>å…ƒç»„</h2><h4 id="å…ƒç»„åŸºæœ¬æ“ä½œ"><a href="#å…ƒç»„åŸºæœ¬æ“ä½œ" class="headerlink" title="å…ƒç»„åŸºæœ¬æ“ä½œ"></a>å…ƒç»„åŸºæœ¬æ“ä½œ</h4><p>å…³äºå…ƒç»„çš„ä½¿ç”¨æœ‰ä¸‰ä¸ªæ ¸å¿ƒçš„å‡½æ•°: </p>
<ol>
<li>std::make_tuple: æ„é€ å…ƒç»„  </li>
<li>std::get: è·å¾—å…ƒç»„æŸä¸ªä½ç½®çš„å€¼ </li>
<li>std::tie: å…ƒç»„æ‹†åŒ…</li>
</ol>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">get_student</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// è¿”å›ç±»å‹è¢«æ¨æ–­ä¸º std::tuple&lt;double, char, std::string&gt;</span></span><br><span class="line">	<span class="keyword">if</span> (id == <span class="number">0</span>)  </span><br><span class="line">		<span class="keyword">return</span> std::<span class="built_in">make_tuple</span>(<span class="number">3.8</span>, â€™Aâ€™, <span class="string">&quot; å¼ ä¸‰&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (id == <span class="number">1</span>)  </span><br><span class="line">		<span class="keyword">return</span> std::<span class="built_in">make_tuple</span>(<span class="number">2.9</span>, â€™Câ€™, <span class="string">&quot; æå››&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (id == <span class="number">2</span>)  </span><br><span class="line">		<span class="keyword">return</span> std::<span class="built_in">make_tuple</span>(<span class="number">1.7</span>, â€™Dâ€™, <span class="string">&quot; ç‹äº”&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> std::<span class="built_in">make_tuple</span>(<span class="number">0.0</span>, â€™Dâ€™, <span class="string">&quot;null&quot;</span>);</span><br><span class="line">	<span class="comment">// å¦‚æœåªå†™ 0 ä¼šå‡ºç°æ¨æ–­é”™è¯¯, ç¼–è¯‘å¤±è´¥ </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å…ƒç»„æ‹†åŒ… </span></span><br><span class="line"><span class="keyword">double</span> gpa;</span><br><span class="line"><span class="keyword">char</span> grade;</span><br><span class="line">std::string name;</span><br><span class="line">std::<span class="built_in">tie</span>(gpa, grade, name) = <span class="built_in">get_student</span>(<span class="number">1</span>); </span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;ID: 1, &quot;</span>  </span><br><span class="line">&lt;&lt; <span class="string">&quot;GPA: &quot;</span> &lt;&lt; gpa &lt;&lt; <span class="string">&quot;, &quot;</span>  </span><br><span class="line">&lt;&lt; <span class="string">&quot; æˆç»©: &quot;</span> &lt;&lt; grade &lt;&lt; <span class="string">&quot;, &quot;</span>  </span><br><span class="line">&lt;&lt; <span class="string">&quot; å§“å: &quot;</span> &lt;&lt; name &lt;&lt; â€™\nâ€™;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// get æ‹†åŒ…</span></span><br><span class="line"><span class="function">std::tuple&lt;std::string, <span class="keyword">double</span>, <span class="keyword">double</span>, <span class="keyword">int</span>&gt; <span class="title">t</span><span class="params">(<span class="string">&quot;123&quot;</span>, <span class="number">4.5</span>, <span class="number">6.7</span>, <span class="number">8</span>)</span></span>;</span><br><span class="line">std::cout &lt;&lt; std::get&lt;std::string&gt;(t) &lt;&lt; std::endl;</span><br><span class="line"><span class="comment">//std::cout &lt;&lt; std::get&lt;double&gt;(t) &lt;&lt; std::endl; // éæ³•, å¼•å‘ç¼–è¯‘æœŸé”™è¯¯</span></span><br><span class="line">std::cout &lt;&lt; std::get&lt;<span class="number">3</span>&gt;(t) &lt;&lt; std::endl;</span><br></pre></td></tr></table></figure>

<h3 id="è¿è¡ŒæœŸç´¢å¼•"><a href="#è¿è¡ŒæœŸç´¢å¼•" class="headerlink" title="è¿è¡ŒæœŸç´¢å¼•"></a>è¿è¡ŒæœŸç´¢å¼•</h3><p>std::get&lt;&gt; ä¾èµ–ä¸€ä¸ªç¼–è¯‘æœŸçš„å¸¸é‡ï¼Œå› æ­¤ä¸‹é¢çš„ç”¨æ³•ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¸åˆç†</span></span><br><span class="line"><span class="keyword">int</span> index = <span class="number">1</span>;</span><br><span class="line">std::get&lt;index&gt;(t);</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ std::variant&lt;&gt;(C++ 17 å¼•å…¥)ï¼Œæä¾›ç»™ variant&lt;&gt; çš„ç±»å‹æ¨¡æ¿ å‚æ•°å¯ä»¥è®©ä¸€ä¸ª variant&lt;&gt; ä»è€Œå®¹çº³æä¾›çš„å‡ ç§ç±»å‹çš„å˜é‡ã€‚</p>
<h3 id="å…ƒç»„åˆå¹¶ä¸éå†"><a href="#å…ƒç»„åˆå¹¶ä¸éå†" class="headerlink" title="å…ƒç»„åˆå¹¶ä¸éå†"></a>å…ƒç»„åˆå¹¶ä¸éå†</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å…ƒç»„åˆå¹¶</span></span><br><span class="line"><span class="keyword">auto</span> new_tuple = std::<span class="built_in">tuple_cat</span>(<span class="built_in">get_student</span>(<span class="number">1</span>), std::<span class="built_in">move</span>(t));</span><br><span class="line"><span class="comment">// è¿è¡ŒæœŸé€šè¿‡éå¸¸æ•°ç´¢å¼• ä¸€ä¸ª tuple</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="function"><span class="keyword">auto</span> <span class="title">tuple_len</span><span class="params">(T &amp;tpl)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> std::tuple_size&lt;T&gt;::value; </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è¿­ä»£  </span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i != <span class="built_in">tuple_len</span>(new_tuple); ++i)</span><br><span class="line"><span class="comment">// è¿è¡ŒæœŸç´¢å¼•  </span></span><br><span class="line">std::cout &lt;&lt; <span class="built_in">tuple_index</span>(i, new_tuple) &lt;&lt; std::endl;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>è¯­è¨€å­¦ä¹ </category>
        <category>c++</category>
        <category>ç°ä»£c++</category>
      </categories>
      <tags>
        <tag>c++</tag>
      </tags>
  </entry>
  <entry>
    <title>æ­£åˆ™è¡¨è¾¾å¼&amp;å¹¶è¡Œå¹¶å‘&amp;æ‚é¡¹</title>
    <url>/2022/04/01/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
    <content><![CDATA[<p>c++11/17/20æ–°ç‰¹æ€§å­¦ä¹ ç¬”è®°</p>
<span id="more"></span>

<!-- toc -->
<h2 id="æ­£åˆ™è¡¨è¾¾å¼ç®€ä»‹"><a href="#æ­£åˆ™è¡¨è¾¾å¼ç®€ä»‹" class="headerlink" title="æ­£åˆ™è¡¨è¾¾å¼ç®€ä»‹"></a>æ­£åˆ™è¡¨è¾¾å¼ç®€ä»‹</h2><p>è€Œ C++11 æ­£å¼å°†æ­£åˆ™è¡¨è¾¾å¼çš„çš„å¤„ç†æ–¹æ³•çº³å…¥ æ ‡å‡†åº“çš„è¡Œåˆ—ï¼Œä»è¯­è¨€çº§ä¸Šæä¾›äº†æ ‡å‡†çš„æ”¯æŒï¼Œä¸å†ä¾èµ–ç¬¬ä¸‰æ–¹ã€‚</p>
<p>C++11 æä¾›çš„æ­£åˆ™è¡¨è¾¾å¼åº“æ“ä½œ std::string å¯¹è±¡ï¼Œæ¨¡å¼ std::regex (æœ¬è´¨æ˜¯std::basic_regex) è¿›è¡Œåˆå§‹åŒ–ï¼Œé€šè¿‡ std::regex_match è¿›è¡ŒåŒ¹é…ï¼Œä»è€Œäº§ç”Ÿstd::smatch(æœ¬è´¨æ˜¯ std::match_results å¯¹è±¡)ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">std::string fnames[] = &#123;<span class="string">&quot;foo.txt&quot;</span>, <span class="string">&quot;bar.txt&quot;</span>, <span class="string">&quot;test&quot;</span>, <span class="string">&quot;a0.txt&quot;</span>, <span class="string">&quot;AAA.txt&quot;</span>&#125;;</span><br><span class="line"><span class="comment">// åœ¨ C++ ä¸­ \ ä¼šè¢«ä½œä¸ºå­—ç¬¦ä¸²å†…çš„è½¬ä¹‰ç¬¦ï¼Œä¸ºä½¿ \. ä½œä¸ºæ­£åˆ™è¡¨è¾¾å¼ä¼ é€’è¿›å»ç”Ÿæ•ˆï¼Œéœ€è¦å¯¹ \ è¿›è¡ŒäºŒæ¬¡è½¬ä¹‰ï¼Œ</span></span><br><span class="line"><span class="function">std::regex <span class="title">txt_regex</span><span class="params">(<span class="string">&quot;[a-z]+\\.txt&quot;</span>)</span></span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;fname: fnames)</span><br><span class="line">	std::cout &lt;&lt; fname &lt;&lt; <span class="string">&quot;: &quot;</span> &lt;&lt; std::<span class="built_in">regex_match</span>(fname, txt_regex) &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ std::smatch å¯ä»¥æ–¹ä¾¿çš„å¯¹åŒ¹é…çš„ç»“æœè¿›è¡Œè·å–</span></span><br><span class="line"><span class="function">std::regex <span class="title">base_regex</span><span class="params">(<span class="string">&quot;([a-z]+)\\.txt&quot;</span>)</span></span>; </span><br><span class="line">std::smatch base_match;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">const</span> <span class="keyword">auto</span> &amp;fname: fnames) &#123;</span><br><span class="line">	<span class="keyword">if</span> (std::<span class="built_in">regex_match</span>(fname, base_match, base_regex)) &#123; </span><br><span class="line">	<span class="comment">// std::smatch çš„ç¬¬ä¸€ä¸ªå…ƒç´ åŒ¹é…æ•´ä¸ªå­—ç¬¦ä¸²  </span></span><br><span class="line">	<span class="comment">// std::smatch çš„ç¬¬äºŒä¸ªå…ƒç´ åŒ¹é…äº†ç¬¬ä¸€ä¸ªæ‹¬å·è¡¨è¾¾å¼  </span></span><br><span class="line">	<span class="keyword">if</span> (base_match.<span class="built_in">size</span>() == <span class="number">2</span>) &#123;</span><br><span class="line">		std::string base = base_match[<span class="number">1</span>].<span class="built_in">str</span>();</span><br><span class="line">		std::cout &lt;&lt; <span class="string">&quot;sub-match[0]: &quot;</span> &lt;&lt; base_match[<span class="number">0</span>].<span class="built_in">str</span>() &lt;&lt; std::endl;</span><br><span class="line">		std::cout &lt;&lt; fname &lt;&lt; <span class="string">&quot; sub-match[1]: &quot;</span> &lt;&lt; base &lt;&lt; std::endl; </span><br><span class="line">		&#125; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å‡ºï¼š</span></span><br><span class="line">foo.txt: <span class="number">1</span></span><br><span class="line">bar.txt: <span class="number">1</span></span><br><span class="line">test: <span class="number">0</span></span><br><span class="line">a0.txt: <span class="number">0</span></span><br><span class="line">AAA.txt: <span class="number">0</span></span><br><span class="line">sub-match[<span class="number">0</span>]: foo.txt</span><br><span class="line">foo.txt sub-match[<span class="number">1</span>]: foo</span><br><span class="line">sub-match[<span class="number">0</span>]: bar.txt</span><br><span class="line">bar.txt sub-match[<span class="number">1</span>]: bar</span><br></pre></td></tr></table></figure>

<h2 id="å¹¶è¡Œä¸å¹¶å‘"><a href="#å¹¶è¡Œä¸å¹¶å‘" class="headerlink" title="å¹¶è¡Œä¸å¹¶å‘"></a>å¹¶è¡Œä¸å¹¶å‘</h2><h3 id="å¹¶è¡ŒåŸºç¡€"><a href="#å¹¶è¡ŒåŸºç¡€" class="headerlink" title="å¹¶è¡ŒåŸºç¡€"></a>å¹¶è¡ŒåŸºç¡€</h3><p>c++11å¼€å§‹æä¾›äº†std::threadç±»</p>
<h3 id="äº’æ–¥é‡ä¸ä¸´ç•ŒåŒº"><a href="#äº’æ–¥é‡ä¸ä¸´ç•ŒåŒº" class="headerlink" title="äº’æ–¥é‡ä¸ä¸´ç•ŒåŒº"></a>äº’æ–¥é‡ä¸ä¸´ç•ŒåŒº</h3><p>é€šè¿‡å®ä¾‹åŒ– std::mutex å¯ä»¥åˆ›å»ºäº’æ–¥é‡ï¼Œè€Œé€šè¿‡ å…¶æˆå‘˜å‡½æ•° lock() å¯ä»¥è¿›è¡Œä¸Šé”ï¼Œunlock() å¯ä»¥è¿›è¡Œè§£é”ã€‚ä½†æ˜¯åœ¨åœ¨å®é™…ç¼–å†™ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œæœ€å¥½ä¸ å»ç›´æ¥è°ƒç”¨æˆå‘˜å‡½æ•°ï¼Œå› ä¸ºè°ƒç”¨æˆå‘˜å‡½æ•°å°±éœ€è¦åœ¨æ¯ä¸ªä¸´ç•ŒåŒºçš„å‡ºå£å¤„è°ƒç”¨ unlock()ï¼Œå½“ç„¶ï¼Œè¿˜åŒ…æ‹¬å¼‚ å¸¸ã€‚è¿™æ—¶å€™ C++11 è¿˜ä¸ºäº’æ–¥é‡æä¾›äº†ä¸€ä¸ª RAII è¯­æ³•çš„æ¨¡æ¿ç±»<code> std::lock_guard</code>ã€‚RAII åœ¨ä¸å¤±ä»£ç ç®€ æ´æ€§çš„åŒæ—¶ï¼Œå¾ˆå¥½çš„ä¿è¯äº†ä»£ç çš„å¼‚å¸¸å®‰å…¨æ€§ã€‚</p>
<ul>
<li><code>std::lock_guard</code> : </li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> v = <span class="number">1</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">critical_section</span><span class="params">(<span class="keyword">int</span> change_v)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">static</span> std::mutex mtx;</span><br><span class="line">	<span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mtx)</span></span>; </span><br><span class="line">	<span class="comment">// æ‰§è¡Œç«äº‰æ“ä½œ </span></span><br><span class="line">	v = change_v;</span><br><span class="line">	<span class="comment">// ç¦»å¼€æ­¤ä½œç”¨åŸŸå mtx ä¼šè¢«é‡Šæ”¾</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±äº C++ ä¿è¯äº†æ‰€æœ‰æ ˆå¯¹è±¡åœ¨å£°æ˜å‘¨æœŸç»“æŸæ—¶ä¼šè¢«é”€æ¯ï¼Œæ‰€ä»¥è¿™æ ·çš„ä»£ç ä¹Ÿæ˜¯å¼‚å¸¸å®‰å…¨çš„ã€‚æ— è®º critical_section() æ­£å¸¸è¿”å›ã€è¿˜æ˜¯åœ¨ä¸­é€”æŠ›å‡ºå¼‚å¸¸ï¼Œéƒ½ä¼šå¼•å‘å †æ ˆå›é€€ï¼Œä¹Ÿå°±è‡ªåŠ¨è°ƒç”¨äº† unlock()ã€‚</p>
<ul>
<li><code>std::unique_lock</code> :<br>std::unique_lock åˆ™ ç›¸ å¯¹ äº std::lock_guard å‡º ç° çš„ï¼Œstd::unique_lock æ›´ åŠ  çµ æ´»ï¼Œ std::unique_lock çš„å¯¹è±¡ä¼šä»¥ç‹¬å æ‰€æœ‰æƒ(æ²¡æœ‰å…¶ä»–çš„ unique_lock å¯¹è±¡åŒæ—¶æ‹¥æœ‰æŸä¸ª mutex å¯¹è±¡çš„æ‰€æœ‰æƒ)çš„æ–¹å¼ç®¡ç† mutex å¯¹è±¡ä¸Šçš„ä¸Šé”å’Œè§£é”çš„æ“ä½œã€‚æ‰€ä»¥åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œæ¨èä½¿ç”¨ std::unique_lockã€‚</li>
</ul>
<p>std::lock_guard ä¸èƒ½æ˜¾å¼çš„è°ƒç”¨ lock å’Œ unlockï¼Œè€Œ <strong>std::unique_lock å¯ä»¥åœ¨å£°æ˜åçš„ä»»æ„ä½ç½®è°ƒç”¨</strong>ï¼Œå¯ä»¥ç¼©å°é”çš„ä½œç”¨èŒƒå›´ï¼Œæä¾›æ›´é«˜çš„å¹¶å‘åº¦ã€‚</p>
<p>å¦‚æœä½ ç”¨åˆ°äº†æ¡ä»¶å˜é‡ std::condition_variable::wait åˆ™<strong>å¿…é¡»</strong>ä½¿ç”¨ std::unique_lock ä½œä¸ºå‚ æ•°ã€‚å› ä¸ºæ¡ä»¶å˜é‡çš„waitè¦å…ˆè§£é”ï¼Œè€Œåªæœ‰std::unique_lockæ‰æœ‰è§£é”åŠŸèƒ½ã€‚</p>
<h3 id="æœŸç‰©ï¼ˆFutureï¼‰"><a href="#æœŸç‰©ï¼ˆFutureï¼‰" class="headerlink" title="æœŸç‰©ï¼ˆFutureï¼‰"></a>æœŸç‰©ï¼ˆFutureï¼‰</h3><p>æœŸç‰©(Future)è¡¨ç°ä¸º std::futureï¼Œå®ƒæä¾›äº†ä¸€ä¸ªè®¿é—®å¼‚æ­¥æ“ä½œç»“æœçš„é€”å¾„</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å°†ä¸€ä¸ªè¿”å›å€¼ä¸º 7 çš„ lambda è¡¨è¾¾å¼å°è£…åˆ° task ä¸­  </span></span><br><span class="line"><span class="comment">// std::packaged_task çš„æ¨¡æ¿å‚æ•°ä¸ºè¦å°è£…å‡½æ•°çš„ç±»å‹</span></span><br><span class="line"><span class="function">std::packaged_task&lt;<span class="title">int</span><span class="params">()</span>&gt; <span class="title">task</span><span class="params">([]()&#123;<span class="keyword">return</span> <span class="number">7</span>;&#125;)</span></span>;</span><br><span class="line"><span class="comment">// è·å¾— task çš„æœŸç‰©</span></span><br><span class="line">std::future&lt;<span class="keyword">int</span>&gt; result = task.<span class="built_in">get_future</span>();</span><br><span class="line"><span class="comment">// åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œ task</span></span><br><span class="line">std::<span class="built_in">thread</span>(std::<span class="built_in">move</span>(task)).<span class="built_in">detach</span>();</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;waiting...&quot;</span>;</span><br><span class="line">result.<span class="built_in">wait</span>(); <span class="comment">// åœ¨æ­¤è®¾ç½®å±éšœï¼Œé˜»å¡åˆ°æœŸç‰©çš„å®Œæˆ</span></span><br><span class="line"><span class="comment">// è¾“å‡ºæ‰§è¡Œç»“æœ</span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;done!&quot;</span> &lt;&lt; std:: endl &lt;&lt; <span class="string">&quot;future result is &quot;</span> &lt;&lt; result.<span class="built_in">get</span>() &lt;&lt; std::endl;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="æ¡ä»¶å˜é‡"><a href="#æ¡ä»¶å˜é‡" class="headerlink" title="æ¡ä»¶å˜é‡"></a>æ¡ä»¶å˜é‡</h3><p>æ¡ä»¶å˜é‡ std::condition_variable æ˜¯ä¸ºäº†è§£å†³æ­»é”è€Œç”Ÿï¼Œå½“äº’æ–¥æ“ä½œä¸å¤Ÿç”¨è€Œå¼•å…¥çš„ã€‚æ¯”å¦‚ï¼Œçº¿ç¨‹ å¯èƒ½éœ€è¦ç­‰å¾…æŸä¸ªæ¡ä»¶ä¸ºçœŸæ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œè€Œä¸€ä¸ªå¿™ç­‰å¾…å¾ªç¯ä¸­å¯èƒ½ä¼šå¯¼è‡´æ‰€æœ‰å…¶ä»–çº¿ç¨‹éƒ½æ— æ³•è¿›å…¥ä¸´ ç•ŒåŒºä½¿å¾—æ¡ä»¶ä¸ºçœŸæ—¶ï¼Œå°±ä¼šå‘ç”Ÿæ­»é”ã€‚</p>
<h3 id="åŸå­æ“ä½œä¸å†…å­˜æ¨¡å‹"><a href="#åŸå­æ“ä½œä¸å†…å­˜æ¨¡å‹" class="headerlink" title="åŸå­æ“ä½œä¸å†…å­˜æ¨¡å‹"></a>åŸå­æ“ä½œä¸å†…å­˜æ¨¡å‹</h3><h4 id="åŸå­æ“ä½œ"><a href="#åŸå­æ“ä½œ" class="headerlink" title="åŸå­æ“ä½œ"></a>åŸå­æ“ä½œ</h4><p>std::mutex å¯ä»¥è§£å†³ä¸Šé¢å‡ºç°çš„å¹¶å‘è¯»å†™çš„é—®é¢˜ï¼Œä½†äº’æ–¥é”æ˜¯æ“ä½œç³»ç»Ÿçº§çš„åŠŸèƒ½ï¼Œè¿™æ˜¯å› ä¸ºä¸€ä¸ªäº’ æ–¥é”çš„å®ç°é€šå¸¸åŒ…å«ä¸¤æ¡åŸºæœ¬åŸç†:</p>
<ul>
<li> æä¾›çº¿ç¨‹é—´è‡ªåŠ¨çš„çŠ¶æ€è½¬æ¢ï¼Œå³ã€é”ä½ã€è¿™ä¸ªçŠ¶æ€</li>
<li> ä¿éšœåœ¨äº’æ–¥é”æ“ä½œæœŸé—´ï¼Œæ‰€æ“ä½œå˜é‡çš„å†…å­˜ä¸ä¸´ç•ŒåŒºå¤–è¿›è¡Œéš”ç¦»</li>
</ul>
<p>è¿™æ˜¯ä¸€ç»„éå¸¸å¼ºçš„åŒæ­¥æ¡ä»¶ï¼Œæ¢å¥è¯è¯´å½“æœ€ç»ˆç¼–è¯‘ä¸º CPU æŒ‡ä»¤æ—¶ä¼šè¡¨ç°ä¸ºéå¸¸å¤šçš„æŒ‡ä»¤(æˆ‘ä»¬ä¹‹ åå†æ¥çœ‹å¦‚ä½•å®ç°ä¸€ä¸ªç®€å•çš„äº’æ–¥é”)ã€‚è¿™å¯¹äºä¸€ä¸ªä»…éœ€åŸå­çº§æ“ä½œ(æ²¡æœ‰ä¸­é—´æ€)çš„å˜é‡ï¼Œä¼¼ä¹å¤ªè‹›åˆ»äº†ã€‚</p>
<p>åœ¨ç°ä»£ CPU ä½“ ç³»ç»“æ„ä¸‹æä¾›äº† CPU æŒ‡ä»¤çº§çš„åŸå­æ“ä½œï¼Œå› æ­¤åœ¨ C++11 ä¸­å¤šçº¿ç¨‹ä¸‹å…±äº«å˜é‡çš„è¯»å†™è¿™ä¸€é—®é¢˜ä¸Šï¼Œè¿˜å¼• å…¥äº† <code>std::atomic</code> æ¨¡æ¿ï¼Œä½¿å¾—æˆ‘ä»¬å®ä¾‹åŒ–ä¸€ä¸ªåŸå­ç±»å‹ï¼Œå°†ä¸€ä¸ªåŸå­ç±»å‹è¯»å†™æ“ä½œä»ä¸€ç»„æŒ‡ä»¤ï¼Œæœ€å°åŒ– åˆ°å•ä¸ª CPU æŒ‡ä»¤ã€‚<br><code>std::atomic&lt;int&gt; counter;</code><br>åŒ…æ‹¬ fetch_add, fetch_subç­‰ï¼ŒåŒæ—¶é€šè¿‡é‡è½½æ–¹ä¾¿çš„æä¾›äº†å¯¹åº”çš„ +ï¼Œ- ç‰ˆæœ¬ã€‚</p>
<ul>
<li>ä¾‹å­: </li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">std::thread <span class="title">t1</span><span class="params">([]()&#123; </span></span></span><br><span class="line"><span class="params"><span class="function">	count.fetch_add(<span class="number">1</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;)</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="function">std::thread <span class="title">t2</span><span class="params">([]()&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">	count++; </span></span></span><br><span class="line"><span class="params"><span class="function">	count += <span class="number">1</span>;</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="comment">// ç­‰ä»·äº fetch_add // ç­‰ä»·äº fetch_add</span></span></span></span><br><span class="line"><span class="params"><span class="function">&#125;)</span></span>;  </span><br><span class="line">t1.<span class="built_in">join</span>();  </span><br><span class="line">t2.<span class="built_in">join</span>();  </span><br><span class="line">std::cout &lt;&lt; count &lt;&lt; std::endl;</span><br></pre></td></tr></table></figure>

<h3 id="ä¸€è‡´æ€§æ¨¡å‹"><a href="#ä¸€è‡´æ€§æ¨¡å‹" class="headerlink" title="ä¸€è‡´æ€§æ¨¡å‹"></a>ä¸€è‡´æ€§æ¨¡å‹</h3><p>å››ç§ä¸åŒçš„ä¸€è‡´æ€§æ¨¡å‹: </p>
<ul>
<li>çº¿æ€§ä¸€è‡´æ€§:<ul>
<li>åˆç§°å¼ºä¸€è‡´æ€§æˆ–åŸå­ä¸€è‡´æ€§ï¼Œå¹¶ä¸”æ‰€æœ‰çº¿ç¨‹çš„æ“ä½œé¡ºåºä¸å…¨å±€æ—¶é’Ÿä¸‹çš„é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚</li>
</ul>
</li>
<li>é¡ºåºä¸€è‡´æ€§:<ul>
<li>åŒæ ·è¦æ±‚ä»»ä½•ä¸€æ¬¡è¯»æ“ä½œéƒ½èƒ½è¯»åˆ°æ•°æ®æœ€è¿‘ä¸€æ¬¡å†™å…¥çš„æ•°æ®ï¼Œä½†æœªè¦æ±‚ä¸å…¨å±€æ—¶é’Ÿçš„ é¡ºåºä¸€è‡´ã€‚</li>
</ul>
</li>
<li>å› æœå…³ç³»ä¸€è‡´æ€§: <ul>
<li>å®ƒçš„è¦æ±‚è¿›ä¸€æ­¥é™ä½ï¼Œåªéœ€è¦æœ‰å› æœå…³ç³»çš„æ“ä½œé¡ºåºå¾—åˆ°ä¿éšœï¼Œè€Œéå› æœå…³ç³»çš„æ“ä½œ é¡ºåºåˆ™ä¸åšè¦æ±‚ã€‚</li>
</ul>
</li>
<li>æœ€ç»ˆä¸€è‡´æ€§:<ul>
<li> æ˜¯æœ€å¼±çš„ä¸€è‡´æ€§è¦æ±‚ï¼Œå®ƒåªä¿éšœæŸä¸ªæ“ä½œåœ¨æœªæ¥çš„æŸä¸ªæ—¶é—´èŠ‚ç‚¹ä¸Šä¼šè¢«è§‚å¯Ÿåˆ°ï¼Œä½†å¹¶ æœªè¦æ±‚è¢«è§‚å¯Ÿåˆ°çš„æ—¶é—´ã€‚</li>
</ul>
</li>
</ul>
<h3 id="C-çš„å†…å­˜é¡ºåº"><a href="#C-çš„å†…å­˜é¡ºåº" class="headerlink" title="C++çš„å†…å­˜é¡ºåº"></a>C++çš„å†…å­˜é¡ºåº</h3><p>C++11 ä¸ºåŸå­æ“ä½œå®šä¹‰äº†å…­ç§ä¸åŒçš„å†…å­˜é¡ºåº std::memory_order çš„é€‰é¡¹ï¼Œè¡¨è¾¾äº†å››ç§å¤šçº¿ç¨‹é—´çš„åŒæ­¥æ¨¡å‹ã€‚</p>
<ul>
<li><p>å®½æ¾æ¨¡å‹:  åœ¨æ­¤æ¨¡å‹ä¸‹ï¼Œå•ä¸ªçº¿ç¨‹å†…çš„åŸå­æ“ä½œéƒ½æ˜¯é¡ºåºæ‰§è¡Œçš„ï¼Œä¸å…è®¸æŒ‡ä»¤é‡æ’ï¼Œä½†ä¸åŒçº¿ç¨‹é—´åŸå­æ“ä½œçš„é¡ºåºæ˜¯ä»»æ„çš„ã€‚<br><code>counter.fetch_add(1, std::memory_order_relaxed);</code></p>
</li>
<li><p>é‡Šæ”¾/æ¶ˆè´¹æ¨¡å‹:  å¦‚æœæŸä¸ªçº¿ç¨‹éœ€è¦ä¿®æ”¹æŸä¸ªå€¼ï¼Œä½† å¦ä¸€ä¸ªçº¿ç¨‹ä¼šå¯¹è¯¥å€¼çš„æŸæ¬¡æ“ä½œäº§ç”Ÿä¾èµ–ï¼Œå³åè€…<code>ä¾èµ–</code>å‰è€…ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç”Ÿäº§è€…ç”Ÿäº§</span></span><br><span class="line">ptr.<span class="built_in">store</span>(p, std::memory_order_release);</span><br><span class="line"><span class="comment">// æ¶ˆè´¹è€…æ¶ˆè´¹</span></span><br><span class="line">ptr.<span class="built_in">load</span>(std::memory_order_consume)</span><br></pre></td></tr></table></figure></li>
<li><p>é‡Šæ”¾/è·å–æ¨¡å‹<br>åœ¨é‡Šæ”¾ std::memory_order_release å’Œè·å– std::memory_order_acquire ä¹‹é—´è§„å®šæ—¶åºï¼Œå³å‘ç”Ÿåœ¨é‡Šæ”¾ æ“ä½œä¹‹å‰çš„æ‰€æœ‰å†™æ“ä½œï¼Œå¯¹å…¶ä»–çº¿ç¨‹çš„ä»»ä½•è·å–æ“ä½œéƒ½æ˜¯å¯è§çš„ï¼Œäº¦å³å‘ç”Ÿé¡ºåº(happens-before)ã€‚<br>std::memory_order_release ç¡®ä¿äº†å®ƒä¹‹åçš„å†™è¡Œä¸ºä¸ä¼šå‘ç”Ÿåœ¨é‡Šæ”¾æ“ä½œä¹‹å‰ã€‚æ˜¯ä¸€ä¸ªå‘å‰çš„å±éšœ<br>std::memory_order_acquire ç¡®ä¿äº†å®ƒä¹‹å‰çš„å†™è¡Œä¸ºï¼Œä¸ä¼šå‘ç”Ÿåœ¨è¯¥è·å–æ“ä½œ ä¹‹åï¼Œæ˜¯ä¸€ä¸ªå‘åçš„å±éšœ<br>std::memory_order_acq_rel è€Œè¨€ï¼Œåˆ™ç»“åˆäº†è¿™ä¸¤è€…çš„ç‰¹ç‚¹ï¼Œ å”¯ä¸€ç¡®å®šäº†ä¸€ä¸ªå†…å­˜å±éšœï¼Œä½¿å¾—å½“å‰çº¿ç¨‹å¯¹å†…å­˜çš„è¯»å†™ä¸ä¼šè¢«é‡æ’åˆ°æ­¤æ“ä½œçš„å‰åã€‚</p>
</li>
<li><p>é¡ºåºä¸€è‡´æ€§æ¨¡å‹<br>åœ¨æ­¤æ¨¡å‹ä¸‹ï¼ŒåŸå­æ“ä½œæ»¡è¶³é¡ºåºä¸€è‡´æ€§ï¼Œè¿›è€Œå¯èƒ½å¯¹æ€§èƒ½äº§ç”ŸæŸè€—ã€‚å¯æ˜¾å¼çš„é€šè¿‡ std::memory_order_seq_cst è¿›è¡ŒæŒ‡å®šã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">counter.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_seq_cst);</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="å…¶ä»–æ‚é¡¹"><a href="#å…¶ä»–æ‚é¡¹" class="headerlink" title="å…¶ä»–æ‚é¡¹"></a>å…¶ä»–æ‚é¡¹</h2><h3 id="æ–°ç±»å‹"><a href="#æ–°ç±»å‹" class="headerlink" title="æ–°ç±»å‹"></a>æ–°ç±»å‹</h3><h4 id="long-long-int"><a href="#long-long-int" class="headerlink" title="long long int"></a>long long int</h4><p>C++11 çš„å·¥ä½œåˆ™æ˜¯æ­£å¼æŠŠå®ƒçº³å…¥æ ‡å‡†åº“ï¼Œè§„å®šäº†ä¸€ä¸ª long long int ç±»å‹è‡³å°‘å…·å¤‡ 64 ä½çš„æ¯”ç‰¹æ•°ã€‚</p>
<h3 id="noexcept-çš„ä¿®é¥°å’Œæ“ä½œ"><a href="#noexcept-çš„ä¿®é¥°å’Œæ“ä½œ" class="headerlink" title="noexcept çš„ä¿®é¥°å’Œæ“ä½œ"></a>noexcept çš„ä¿®é¥°å’Œæ“ä½œ</h3><ul>
<li>C++11 å°†å¼‚å¸¸çš„å£°æ˜ç®€åŒ–ä¸ºä»¥ä¸‹ä¸¤ç§æƒ…å†µ:</li>
</ul>
<ol>
<li><p>å‡½æ•°å¯èƒ½æŠ›å‡ºä»»ä½•å¼‚å¸¸</p>
</li>
<li><p>å‡½æ•°ä¸èƒ½æŠ›å‡ºä»»ä½•å¼‚å¸¸<br>å¹¶ä½¿ç”¨ noexcept å¯¹è¿™ä¸¤ç§è¡Œä¸ºè¿›è¡Œé™åˆ¶</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">may_throw</span><span class="params">()</span></span>; <span class="comment">// å¯èƒ½æŠ›å‡ºå¼‚å¸¸  </span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">no_throw</span><span class="params">()</span> <span class="keyword">noexcept</span></span>; <span class="comment">// ä¸å¯èƒ½æŠ›å‡ºå¼‚å¸¸</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>ä½¿ç”¨ noexcept ä¿®é¥°è¿‡çš„å‡½æ•°å¦‚æœæŠ›å‡ºå¼‚å¸¸ï¼Œç¼–è¯‘å™¨ä¼šä½¿ç”¨ std::terminate() æ¥ç«‹å³ç»ˆæ­¢ç¨‹åºè¿è¡Œã€‚</p>
<p>noexcept è¿˜èƒ½å¤Ÿåšæ“ä½œç¬¦ï¼Œç”¨äºæ“ä½œä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå½“è¡¨è¾¾å¼æ— å¼‚å¸¸æ—¶ï¼Œè¿”å› trueï¼Œå¦åˆ™è¿”å› falseã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">std::cout &lt;&lt; std::boolalpha  </span><br><span class="line">&lt;&lt; <span class="string">&quot;may_throw() noexcept? &quot;</span> &lt;&lt; <span class="built_in"><span class="keyword">noexcept</span></span>(<span class="built_in">may_throw</span>()) &lt;&lt; std::endl</span><br></pre></td></tr></table></figure>
<p>noexcept ä¿®é¥°å®Œä¸€ä¸ªå‡½æ•°ä¹‹åèƒ½å¤Ÿèµ·åˆ°å°é”å¼‚å¸¸æ‰©æ•£çš„åŠŸæ•ˆï¼Œå¦‚æœå†…éƒ¨äº§ç”Ÿå¼‚å¸¸ï¼Œå¤–éƒ¨ä¹Ÿä¸ä¼šè§¦å‘ã€‚</p>
<h3 id="å­—é¢é‡"><a href="#å­—é¢é‡" class="headerlink" title="å­—é¢é‡"></a>å­—é¢é‡</h3><h4 id="åŸå§‹å­—ç¬¦ä¸²å­—é¢é‡"><a href="#åŸå§‹å­—ç¬¦ä¸²å­—é¢é‡" class="headerlink" title="åŸå§‹å­—ç¬¦ä¸²å­—é¢é‡"></a>åŸå§‹å­—ç¬¦ä¸²å­—é¢é‡</h4><p>C++11 æä¾›äº†åŸå§‹å­—ç¬¦ä¸²å­—é¢é‡çš„å†™æ³•ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªå­—ç¬¦ä¸²å‰æ–¹ä½¿ç”¨ R æ¥ä¿®é¥°è¿™ä¸ªå­—ç¬¦ä¸²ï¼ŒåŒæ—¶ï¼Œå°†åŸå§‹å­—ç¬¦ä¸²ä½¿ç”¨æ‹¬å·åŒ…è£¹</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">std::string str = <span class="string">R&quot;(C:\File\To\Path)&quot;</span>;</span><br></pre></td></tr></table></figure>
<h4 id="è‡ªå®šä¹‰å­—é¢é‡"><a href="#è‡ªå®šä¹‰å­—é¢é‡" class="headerlink" title="è‡ªå®šä¹‰å­—é¢é‡"></a>è‡ªå®šä¹‰å­—é¢é‡</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// å­—ç¬¦ä¸²å­—é¢é‡è‡ªå®šä¹‰å¿…é¡»è®¾ç½®å¦‚ä¸‹çš„å‚æ•°åˆ—è¡¨  </span><br><span class="line">std::string operator&quot;&quot; _wow1(const char *wow1, size_t len) &#123;</span><br><span class="line">	return std::string(wow1)+&quot;woooooooooow, amazing&quot;; </span><br><span class="line">&#125;</span><br><span class="line">std::string operator&quot;&quot; _wow2 (unsigned long long i) &#123; </span><br><span class="line">	return std::to_string(i)+&quot;woooooooooow, amazing&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ç›¸å½“äºé‡è½½äº†_wow1å’Œ_wow2</span><br><span class="line">// è°ƒç”¨</span><br><span class="line">int main() &#123;  </span><br><span class="line">	auto str = &quot;abc&quot;_wow1;  </span><br><span class="line">	auto num = 1_wow2;  </span><br><span class="line">	std::cout &lt;&lt; str &lt;&lt; std::endl; </span><br><span class="line">	std::cout &lt;&lt; num &lt;&lt; std::endl; </span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å†…å­˜å¯¹é½"><a href="#å†…å­˜å¯¹é½" class="headerlink" title="å†…å­˜å¯¹é½"></a>å†…å­˜å¯¹é½</h3><p>C++ 11 å¼•å…¥äº†ä¸¤ä¸ªæ–°çš„å…³é”®å­—<code> alignof</code> å’Œ <code>alignas</code> æ¥æ”¯æŒå¯¹å†…å­˜å¯¹é½è¿›è¡Œæ§åˆ¶ã€‚</p>
<p><code>alignof</code> å…³é”®å­— èƒ½å¤Ÿè·å¾—ä¸€ä¸ªä¸å¹³å°ç›¸å…³çš„ std::size_t ç±»å‹çš„å€¼ï¼Œç”¨äºæŸ¥è¯¢è¯¥å¹³å°çš„å¯¹é½æ–¹å¼ã€‚</p>
<p>C++ 11 è¿˜å¼•å…¥äº† <code>alignas</code> æ¥é‡æ–°ä¿®é¥°æŸä¸ªç»“æ„ çš„å¯¹é½æ–¹å¼ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Storage</span> &#123;</span> </span><br><span class="line">	<span class="keyword">char</span> a; </span><br><span class="line">	<span class="keyword">int</span> b; </span><br><span class="line">	<span class="keyword">double</span> c; </span><br><span class="line">	<span class="keyword">long</span> <span class="keyword">long</span> d;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="function">struct <span class="title">alignas</span><span class="params">(std::<span class="keyword">max_align_t</span>)</span> AlignasStorage </span>&#123; </span><br><span class="line">	<span class="keyword">char</span> a;</span><br><span class="line">	<span class="keyword">int</span>      b;</span><br><span class="line">	<span class="keyword">double</span>   c;</span><br><span class="line">	<span class="keyword">long</span> <span class="keyword">long</span> d; </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">	std::cout &lt;&lt; <span class="built_in"><span class="keyword">alignof</span></span>(Storage) &lt;&lt; std::endl; </span><br><span class="line">	std::cout &lt;&lt; <span class="built_in"><span class="keyword">alignof</span></span>(AlignasStorage) &lt;&lt; std::endl; </span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ <code>std::max_align_t</code> è¦æ±‚æ¯ä¸ªæ ‡é‡ç±»å‹çš„å¯¹é½æ–¹å¼ä¸¥æ ¼ä¸€æ ·ï¼Œå› æ­¤å®ƒå‡ ä¹æ˜¯æœ€å¤§æ ‡é‡æ²¡æœ‰å·®å¼‚ï¼Œ è¿›è€Œå¤§éƒ¨åˆ†å¹³å°ä¸Šå¾—åˆ°çš„ç»“æœä¸º long doubleï¼Œå› æ­¤æˆ‘ä»¬è¿™é‡Œå¾—åˆ°çš„ AlignasStorage çš„å¯¹é½è¦æ±‚æ˜¯ 8 æˆ– 16ã€‚</p>
]]></content>
      <categories>
        <category>è¯­è¨€å­¦ä¹ </category>
        <category>c++</category>
        <category>ç°ä»£c++</category>
      </categories>
      <tags>
        <tag>c++</tag>
      </tags>
  </entry>
  <entry>
    <title>è¯­è¨€å¯ç”¨æ€§</title>
    <url>/2022/03/27/%E8%AF%AD%E8%A8%80%E5%8F%AF%E7%94%A8%E6%80%A7/</url>
    <content><![CDATA[<p>c++11/17/20æ–°ç‰¹æ€§å­¦ä¹ ç¬”è®°</p>
<span id="more"></span>

<!-- toc -->
<h2 id="å¸¸é‡"><a href="#å¸¸é‡" class="headerlink" title="å¸¸é‡"></a>å¸¸é‡</h2><h3 id="nullptr"><a href="#nullptr" class="headerlink" title="nullptr"></a>nullptr</h3><p>nullptr å‡ºç°çš„ç›®çš„æ˜¯ä¸ºäº†æ›¿ä»£ NULLã€‚åœ¨æŸç§æ„ä¹‰ä¸Šæ¥è¯´ï¼Œä¼ ç»Ÿ C++ ä¼šæŠŠ NULLã€0 è§†ä¸ºåŒä¸€ç§ä¸œ è¥¿ï¼Œè¿™å–å†³äºç¼–è¯‘å™¨å¦‚ä½•å®šä¹‰ NULLï¼Œæœ‰äº›ç¼–è¯‘å™¨ä¼šå°† NULL å®šä¹‰ä¸º ((void*)0)ï¼Œæœ‰äº›åˆ™ä¼šç›´æ¥å°†å…¶å®šä¹‰ ä¸º 0ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒC++11 å¼•å…¥äº† nullptr å…³é”®å­—ï¼Œä¸“é—¨ç”¨æ¥åŒºåˆ†ç©ºæŒ‡é’ˆã€0ã€‚è€Œ nullptr çš„ç±»å‹ ä¸º nullptr_tï¼Œèƒ½å¤Ÿéšå¼çš„è½¬æ¢ä¸ºä»»ä½•æŒ‡é’ˆæˆ–æˆå‘˜æŒ‡é’ˆçš„ç±»å‹ï¼Œä¹Ÿèƒ½å’Œä»–ä»¬è¿›è¡Œç›¸ç­‰æˆ–è€…ä¸ç­‰çš„æ¯”è¾ƒã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">char</span> *)</span></span>; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="built_in">foo</span>(<span class="number">0</span>);  <span class="comment">// è°ƒç”¨ foo(int)</span></span><br><span class="line"><span class="comment">// foo(NULL); // è¯¥è¡Œä¸èƒ½é€šè¿‡ç¼–è¯‘ // è°ƒç”¨ foo(char*)</span></span><br><span class="line"><span class="built_in">foo</span>(<span class="literal">nullptr</span>); <span class="comment">// è°ƒç”¨ foo(char*)</span></span><br></pre></td></tr></table></figure>

<h3 id="constexpr"><a href="#constexpr" class="headerlink" title="constexpr"></a>constexpr</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> len_2 = len + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">int</span> len_2_constexpr = <span class="number">1</span> + <span class="number">2</span> + <span class="number">3</span>;</span><br><span class="line"><span class="comment">// char arr_4[len_2];   // éæ³•</span></span><br><span class="line"><span class="keyword">char</span> arr_4[len_2_constexpr]; <span class="comment">// åˆæ³•</span></span><br></pre></td></tr></table></figure>

<p>C++ æ ‡å‡†ä¸­æ•°ç»„çš„é•¿åº¦å¿…é¡»æ˜¯ä¸€ä¸ªå¸¸é‡è¡¨è¾¾å¼ï¼Œè€Œå¯¹ äº len_2 è€Œè¨€ï¼Œè¿™æ˜¯ä¸€ä¸ª const å¸¸æ•°ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå¸¸é‡è¡¨è¾¾å¼ã€‚<br>C++11 æä¾›äº† constexpr è®©ç”¨æˆ·æ˜¾å¼çš„å£°æ˜å‡½æ•°æˆ–å¯¹è±¡æ„é€ å‡½æ•°åœ¨ç¼–è¯‘æœŸä¼šæˆä¸ºå¸¸é‡è¡¨è¾¾å¼ï¼Œè¿™ ä¸ªå…³é”®å­—æ˜ç¡®çš„å‘Šè¯‰ç¼–è¯‘å™¨åº”è¯¥å»éªŒè¯ len_foo åœ¨ç¼–è¯‘æœŸå°±åº”è¯¥æ˜¯ä¸€ä¸ªå¸¸é‡è¡¨è¾¾å¼ã€‚</p>
<h2 id="å˜é‡åŠå…¶åˆå§‹åŒ–"><a href="#å˜é‡åŠå…¶åˆå§‹åŒ–" class="headerlink" title="å˜é‡åŠå…¶åˆå§‹åŒ–"></a>å˜é‡åŠå…¶åˆå§‹åŒ–</h2><h3 id="if-switch-å˜é‡å£°æ˜å¼ºåŒ–"><a href="#if-switch-å˜é‡å£°æ˜å¼ºåŒ–" class="headerlink" title="if/switch å˜é‡å£°æ˜å¼ºåŒ–"></a>if/switch å˜é‡å£°æ˜å¼ºåŒ–</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="comment">// å°†ä¸´æ—¶å˜é‡æ”¾åˆ° if è¯­å¥å†…  </span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">const</span> std::vector&lt;<span class="keyword">int</span>&gt;::iterator itr = std::<span class="built_in">find</span>(vec.<span class="built_in">begin</span>(), vec.<span class="built_in">end</span>(), <span class="number">3</span>);itr != vec.<span class="built_in">end</span>()) &#123;</span><br><span class="line">	*itr = <span class="number">4</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>c++17 å…è®¸åœ¨if/switché‡Œé¢å®šä¹‰ä¸´æ—¶å˜é‡äº†</p>
<h3 id="åˆå§‹åŒ–åˆ—è¡¨"><a href="#åˆå§‹åŒ–åˆ—è¡¨" class="headerlink" title="åˆå§‹åŒ–åˆ—è¡¨"></a>åˆå§‹åŒ–åˆ—è¡¨</h3><p>C++11 é¦–å…ˆæŠŠåˆå§‹åŒ–åˆ—è¡¨çš„æ¦‚å¿µç»‘å®šåˆ°äº†ç±»å‹ä¸Šï¼Œå¹¶å°†å…¶ç§°ä¹‹ä¸º std::initializer_listï¼Œ å…è®¸æ„é€ å‡½æ•°æˆ–å…¶ä»–å‡½æ•°åƒå‚æ•°ä¸€æ ·ä½¿ç”¨åˆå§‹åŒ–åˆ—è¡¨ï¼Œè¿™å°±ä¸ºç±»å¯¹è±¡çš„åˆå§‹åŒ–ä¸æ™®é€šæ•°ç»„å’Œ POD çš„åˆ å§‹åŒ–æ–¹æ³•æä¾›äº†ç»Ÿä¸€çš„æ¡¥æ¢ã€‚</p>
<figure class="highlight c++"><figcaption><span>ä¸‹é¢è¿™ç§æ„é€ å‡½æ•°ä¹Ÿä¼šè°ƒç”¨åˆå§‹åŒ–åˆ—è¡¨çš„æ–¹æ³•åˆå§‹åŒ–</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MagicFoo</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>ï¼š</span><br><span class="line">	std::vector&lt;<span class="keyword">int</span>&gt; vec;</span><br><span class="line">	<span class="built_in">MagicFoo</span>(std::initializer_list&lt;<span class="keyword">int</span>&gt; list)&#123;</span><br><span class="line">		<span class="keyword">for</span>(std::initializer_list&lt;<span class="keyword">int</span>&gt;::iterator it=list.<span class="built_in">begin</span>();it!=list.<span class="built_in">end</span>();++it)&#123;</span><br><span class="line">		vec.<span class="built_in">push_back</span>(*it);</span><br><span class="line">		&#125;	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="ç»“æ„åŒ–ç»‘å®š"><a href="#ç»“æ„åŒ–ç»‘å®š" class="headerlink" title="ç»“æ„åŒ–ç»‘å®š"></a>ç»“æ„åŒ–ç»‘å®š</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">std::tuple&lt;<span class="keyword">int</span>, <span class="keyword">double</span>, std::string&gt; <span class="title">f</span><span class="params">()</span> </span>&#123; </span><br><span class="line">	<span class="keyword">return</span> std::<span class="built_in">make_tuple</span>(<span class="number">1</span>, <span class="number">2.3</span>, <span class="string">&quot;456&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> [x, y, z] = <span class="built_in">f</span>();  </span><br><span class="line">std::cout &lt;&lt; x &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; y &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; z &lt;&lt; std::endl;</span><br></pre></td></tr></table></figure>
<p>c++17 æ–°ç»“æ„ä½“ tupleå…è®¸è¿”å›å¤šå€¼</p>
<h2 id="ç±»å‹æ¨å¯¼"><a href="#ç±»å‹æ¨å¯¼" class="headerlink" title="ç±»å‹æ¨å¯¼"></a>ç±»å‹æ¨å¯¼</h2><p>C++11 å¼•å…¥äº† <code>auto</code> å’Œ <code>decltype</code> è¿™ä¸¤ä¸ªå…³é”®å­—å®ç°äº†ç±»å‹æ¨å¯¼ï¼Œè®©ç¼–è¯‘å™¨æ¥æ“å¿ƒå˜é‡çš„ç±»å‹ã€‚</p>
<p><code>decltype</code> å…³é”®å­—æ˜¯ä¸ºäº†è§£å†³ <code>auto</code> å…³é”®å­—åªèƒ½å¯¹å˜é‡è¿›è¡Œç±»å‹æ¨å¯¼çš„ç¼ºé™·è€Œå‡ºç°çš„ã€‚å®ƒçš„ç”¨æ³•å’Œ <code>typeof</code> å¾ˆç›¸ä¼¼:</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (std::is_same&lt;<span class="keyword">decltype</span>(x), <span class="keyword">int</span>&gt;::value) </span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;type x == int&quot;</span> &lt;&lt; std::endl;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œstd::is_same&lt;T, U&gt; ç”¨äºåˆ¤æ–­ T å’Œ U è¿™ä¸¤ä¸ªç±»å‹æ˜¯å¦ç›¸ç­‰ã€‚</p>
<h3 id="å…³äºè¿”å›ç±»å‹æ¨å¯¼"><a href="#å…³äºè¿”å›ç±»å‹æ¨å¯¼" class="headerlink" title="å…³äºè¿”å›ç±»å‹æ¨å¯¼"></a>å…³äºè¿”å›ç±»å‹æ¨å¯¼</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> R, <span class="keyword">typename</span> T, <span class="keyword">typename</span> U&gt; R <span class="title">add</span><span class="params">(T x, U y)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> x+y </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">decltype</span>(x+y) <span class="built_in">add</span>(T x, U y) <span class="comment">// é”™è¯¯å†™æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// c++11 æ­£ç¡®å†™æ³•ï¼Œ å°¾è¿”å›ç±»å‹(trailing return type)</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> U&gt;  </span><br><span class="line"><span class="keyword">auto</span> <span class="built_in">add2</span>(T x, U y) -&gt; <span class="keyword">decltype</span>(x+y)&#123;</span><br><span class="line">	<span class="keyword">return</span> x + y; </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// c++14 å†™æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> U&gt; <span class="keyword">auto</span> <span class="title">add3</span><span class="params">(T x, U y)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> x + y; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c++14å¼€å§‹å¯ä»¥ç›´æ¥ä½¿ç”¨autoï¼Œè€Œä¸éœ€è¦å°¾è¿”å›ç±»å‹ç¡®è®¤ã€‚</p>
<h3 id="decltype-auto"><a href="#decltype-auto" class="headerlink" title="decltype(auto)"></a>decltype(auto)</h3><p>ç®€å•æ¥è¯´ï¼Œdecltype(auto) ä¸»è¦ç”¨äºå¯¹è½¬å‘å‡½æ•°æˆ–å°è£…çš„è¿”å›ç±»å‹è¿›è¡Œæ¨å¯¼ï¼Œå®ƒä½¿æˆ‘ä»¬æ— éœ€æ˜¾å¼çš„æŒ‡å®š decltype çš„å‚æ•°è¡¨è¾¾å¼ã€‚<br>è¯­è¨€è¿è¡Œæ—¶å¼ºåŒ–æ—¶å€™(<em><strong>å›å¤´å†æ¥çœ‹</strong></em>)</p>
<h2 id="æ§åˆ¶æµ"><a href="#æ§åˆ¶æµ" class="headerlink" title="æ§åˆ¶æµ"></a>æ§åˆ¶æµ</h2><h3 id="if-constexpr"><a href="#if-constexpr" class="headerlink" title="if constexpr"></a>if constexpr</h3><p>C++17 å°† <code>constexpr</code> è¿™ä¸ªå…³é”®å­—å¼•å…¥åˆ° if è¯­å¥ä¸­ï¼Œå…è®¸åœ¨ä»£ç ä¸­å£°æ˜å¸¸é‡ è¡¨è¾¾å¼çš„åˆ¤æ–­æ¡ä»¶ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">print_type_info</span><span class="params">(<span class="keyword">const</span> T&amp; t)</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(std::is_integral&lt;T&gt;::value)</span> </span>&#123; </span><br><span class="line">	<span class="keyword">return</span> t + <span class="number">1</span>;</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span> &#123;  </span><br><span class="line">	<span class="keyword">return</span> t + <span class="number">0.001</span>;</span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="forçš„åŒºé—´è¿­ä»£"><a href="#forçš„åŒºé—´è¿­ä»£" class="headerlink" title="forçš„åŒºé—´è¿­ä»£"></a>forçš„åŒºé—´è¿­ä»£</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> x: vec)&#123;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ¨¡ç‰ˆ"><a href="#æ¨¡ç‰ˆ" class="headerlink" title="æ¨¡ç‰ˆ"></a>æ¨¡ç‰ˆ</h2><p>æ¨¡æ¿çš„å“²å­¦åœ¨äºå°†ä¸€åˆ‡èƒ½å¤Ÿåœ¨ç¼–è¯‘æœŸå¤„ç†çš„é—®é¢˜ä¸¢åˆ°ç¼–è¯‘æœŸè¿›è¡Œå¤„ç†ï¼Œä»…åœ¨è¿è¡Œæ—¶å¤„ç†é‚£äº›æœ€æ ¸å¿ƒçš„åŠ¨ æ€æœåŠ¡ï¼Œè¿›è€Œå¤§å¹…ä¼˜åŒ–è¿è¡ŒæœŸçš„æ€§èƒ½ã€‚å› æ­¤æ¨¡æ¿ä¹Ÿè¢«å¾ˆå¤šäººè§†ä½œ C++ çš„é»‘é­”æ³•ä¹‹ä¸€ã€‚</p>
<h3 id="å¤–éƒ¨æ¨¡ç‰ˆ"><a href="#å¤–éƒ¨æ¨¡ç‰ˆ" class="headerlink" title="å¤–éƒ¨æ¨¡ç‰ˆ"></a>å¤–éƒ¨æ¨¡ç‰ˆ</h3><p>æ¨¡æ¿åªæœ‰åœ¨ä½¿ç”¨æ—¶æ‰ä¼šè¢«ç¼–è¯‘å™¨å®ä¾‹åŒ–ã€‚<br>æ¢å¥è¯è¯´ï¼Œåªè¦åœ¨æ¯ä¸ªç¼–è¯‘å•å…ƒ(æ–‡ä»¶)ä¸­ ç¼–è¯‘çš„ä»£ç ä¸­é‡åˆ°äº†è¢«å®Œæ•´å®šä¹‰çš„æ¨¡æ¿ï¼Œéƒ½ä¼šå®ä¾‹åŒ–ã€‚è¿™å°±äº§ç”Ÿäº†é‡å¤å®ä¾‹åŒ–è€Œå¯¼è‡´çš„ç¼–è¯‘æ—¶é—´çš„å¢åŠ ã€‚<br>c++11æ˜¾å¼çš„é€šçŸ¥ç¼–è¯‘å™¨ä½•æ—¶è¿›è¡Œæ¨¡æ¿çš„å®ä¾‹åŒ–</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> <span class="class"><span class="keyword">class</span> <span class="title">std</span>:</span>:vector&lt;<span class="keyword">bool</span>&gt;; <span class="comment">// å¼ºè¡Œå®ä¾‹åŒ–  </span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">template</span> <span class="class"><span class="keyword">class</span> <span class="title">std</span>:</span>:vector&lt;<span class="keyword">double</span>&gt;; <span class="comment">// ä¸åœ¨è¯¥å½“å‰ç¼–è¯‘æ–‡ä»¶ä¸­å®ä¾‹åŒ–æ¨¡æ¿</span></span><br></pre></td></tr></table></figure>

<h3 id="ç±»å‹åˆ«åæ¨¡æ¿"><a href="#ç±»å‹åˆ«åæ¨¡æ¿" class="headerlink" title="ç±»å‹åˆ«åæ¨¡æ¿"></a>ç±»å‹åˆ«åæ¨¡æ¿</h3><p>åœ¨ä¼ ç»Ÿ C++ ä¸­ï¼Œtypedef å¯ä»¥ä¸ºç±»å‹å®šä¹‰ä¸€ä¸ªæ–°çš„åç§°ï¼Œä½†æ˜¯å´æ²¡æœ‰åŠæ³•ä¸ºæ¨¡æ¿å®šä¹‰ä¸€ ä¸ªæ–°çš„åç§°ã€‚å› ä¸ºï¼Œæ¨¡æ¿ä¸æ˜¯ç±»å‹ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*process)</span><span class="params">(<span class="keyword">void</span> *)</span></span>;   <span class="comment">// å‡½æ•°æŒ‡é’ˆé˜…è¯»èµ·æ¥çœŸçš„å›°éš¾</span></span><br><span class="line"><span class="keyword">using</span> NewProcess = <span class="built_in"><span class="keyword">int</span></span>(*)(<span class="keyword">void</span> *);  </span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;  </span><br><span class="line"><span class="keyword">using</span> TrueDarkMagic = MagicType&lt;std::vector&lt;T&gt;, std::string&gt;;</span><br></pre></td></tr></table></figure>
<p>C++11 ä½¿ç”¨ using å¼•å…¥äº†ä¸‹é¢è¿™ç§å½¢å¼çš„å†™æ³•ï¼Œå¹¶ä¸”åŒæ—¶æ”¯æŒå¯¹ä¼ ç»Ÿ typedef ç›¸åŒçš„åŠŸæ•ˆ</p>
<h3 id="é»˜è®¤æ¨¡æ¿å‚æ•°"><a href="#é»˜è®¤æ¨¡æ¿å‚æ•°" class="headerlink" title="é»˜è®¤æ¨¡æ¿å‚æ•°"></a>é»˜è®¤æ¨¡æ¿å‚æ•°</h3><p>c++11å¼€å§‹å¯ä»¥æŒ‡å®šé»˜è®¤æ¨¡ç‰ˆå‚æ•°</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T </span>= <span class="keyword">int</span>, <span class="keyword">typename</span> U = <span class="keyword">int</span>&gt; <span class="keyword">auto</span> <span class="built_in">add</span>(T x, U y) -&gt; <span class="keyword">decltype</span>(x+y) &#123;</span><br><span class="line">	<span class="keyword">return</span> x+y; </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Call add function </span></span><br><span class="line"><span class="keyword">auto</span> ret = <span class="built_in">add</span>(<span class="number">1</span>,<span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<h3 id="å˜é•¿å‚æ•°æ¨¡æ¿"><a href="#å˜é•¿å‚æ•°æ¨¡æ¿" class="headerlink" title="å˜é•¿å‚æ•°æ¨¡æ¿"></a>å˜é•¿å‚æ•°æ¨¡æ¿</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span>... Ts&gt; <span class="keyword">void</span> <span class="title">magic</span><span class="params">(Ts... args)</span> </span>&#123;</span><br><span class="line">	std::cout &lt;&lt; <span class="keyword">sizeof</span>...(args) &lt;&lt; std::endl; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è§£åŒ…æ–¹å¼:</p>
<ul>
<li> é€’å½’æ¨¡æ¿å‡½æ•°</li>
<li>å˜å‚æ¨¡ç‰ˆå±•å¼€</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T0, <span class="keyword">typename</span>... T&gt; <span class="keyword">void</span> <span class="title">printf2</span><span class="params">(T0 t0, T... t)</span> </span>&#123;</span><br><span class="line">	std::cout &lt;&lt; t0 &lt;&lt; std::endl; </span><br><span class="line">	<span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(<span class="keyword">sizeof</span>...(t) &gt; <span class="number">0</span>)</span> <span class="title">printf2</span><span class="params">(t...)</span></span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>c++17æ”¯æŒä¾¿é¤æ¨¡ç‰ˆå±•å¼€</p>
<h3 id="éç±»å‹æ¨¡æ¿å‚æ•°æ¨å¯¼"><a href="#éç±»å‹æ¨¡æ¿å‚æ•°æ¨å¯¼" class="headerlink" title="éç±»å‹æ¨¡æ¿å‚æ•°æ¨å¯¼"></a>éç±»å‹æ¨¡æ¿å‚æ•°æ¨å¯¼</h3><p>å‰é¢æˆ‘ä»¬ä¸»è¦æåŠçš„æ˜¯æ¨¡æ¿å‚æ•°çš„ä¸€ç§å½¢å¼:ç±»å‹æ¨¡æ¿å‚æ•°ã€‚<br>éç±»å‹æ¨¡æ¿å‚æ•°:</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">int</span> BufSize&gt; <span class="class"><span class="keyword">class</span> <span class="title">buffer_t</span> &#123;</span>  </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function">T&amp; <span class="title">alloc</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(T&amp; item)</span></span>; </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"> T data[BufSize];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> åœ¨è¿™ç§æ¨¡æ¿å‚æ•°å½¢å¼ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å°† 100 ä½œä¸ºæ¨¡æ¿çš„å‚æ•°è¿›è¡Œä¼ é€’</p>
 <figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"> <span class="comment">// ç”šè‡³å¯ä»¥è®©ç¼–è¯‘å™¨æ¨å¯¼ç±»å‹</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">auto</span> value&gt; <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123; </span><br><span class="line">	std::cout &lt;&lt; value &lt;&lt; std::endl; </span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="é¢å‘å¯¹è±¡"><a href="#é¢å‘å¯¹è±¡" class="headerlink" title="é¢å‘å¯¹è±¡"></a>é¢å‘å¯¹è±¡</h2><h3 id="å§”æ‰˜æ„é€ "><a href="#å§”æ‰˜æ„é€ " class="headerlink" title="å§”æ‰˜æ„é€ "></a>å§”æ‰˜æ„é€ </h3><p>C++11 å¼•å…¥äº†å§”æ‰˜æ„é€ çš„æ¦‚å¿µï¼Œè¿™ä½¿å¾—æ„é€ å‡½æ•°å¯ä»¥åœ¨åŒä¸€ä¸ªç±»ä¸­ä¸€ä¸ªæ„é€ å‡½æ•°è°ƒç”¨å¦ä¸€ä¸ªæ„é€ å‡½ æ•°ï¼Œä»è€Œè¾¾åˆ°ç®€åŒ–ä»£ç çš„ç›®çš„ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Base</span>() &#123; </span><br><span class="line">	value1 = <span class="number">1</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Base</span>(<span class="keyword">int</span> value) : <span class="built_in">Base</span>() &#123; <span class="comment">// å§”æ‰˜ Base() æ„é€ å‡½æ•° value2 = value;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç»§æ‰¿æ„é€ "><a href="#ç»§æ‰¿æ„é€ " class="headerlink" title="ç»§æ‰¿æ„é€ "></a>ç»§æ‰¿æ„é€ </h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Subclass</span> :</span> <span class="keyword">public</span> Base &#123; </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="keyword">using</span> Base::Base; <span class="comment">// ç»§æ‰¿æ„é€  </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="æ˜¾ç¤ºè™šå‡½æ•°é‡è½½"><a href="#æ˜¾ç¤ºè™šå‡½æ•°é‡è½½" class="headerlink" title="æ˜¾ç¤ºè™šå‡½æ•°é‡è½½"></a>æ˜¾ç¤ºè™šå‡½æ•°é‡è½½</h3><p>åœ¨ä¼ ç»Ÿ C++ ä¸­ï¼Œç»å¸¸å®¹æ˜“å‘ç”Ÿæ„å¤–é‡è½½è™šå‡½æ•°çš„äº‹æƒ…</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Base</span> &#123;</span>  </span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;  </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SubClass</span>:</span> Base &#123;</span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// è¿™é‡Œæ˜¾ç¤ºé‡è½½äº†è™šå‡½æ•°</span></span><br></pre></td></tr></table></figure>

<p>C++11 å¼•å…¥äº† override å’Œ final è¿™ä¸¤ä¸ªå…³é”®å­—æ¥é˜²æ­¢ä¸Šè¿°æƒ…å½¢çš„å‘ç”Ÿã€‚<br>override å½“é‡è½½è™šå‡½æ•°æ—¶ï¼Œå¼•å…¥ override å…³é”®å­—å°†æ˜¾å¼çš„å‘ŠçŸ¥ç¼–è¯‘å™¨è¿›è¡Œé‡è½½ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Base</span> &#123;</span>  </span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line">&#125;;  </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SubClass</span>:</span> Base &#123;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span>)</span> <span class="keyword">override</span></span>; <span class="comment">// åˆæ³•</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">float</span>)</span> <span class="keyword">override</span></span>; <span class="comment">// éæ³•, çˆ¶ç±»æ²¡æœ‰æ­¤è™šå‡½æ•° </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p> final final åˆ™æ˜¯ä¸ºäº†é˜²æ­¢ç±»è¢«ç»§ç»­ç»§æ‰¿ä»¥åŠç»ˆæ­¢è™šå‡½æ•°ç»§ç»­é‡è½½å¼•å…¥çš„ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Base</span> &#123;</span>  </span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span> <span class="keyword">final</span></span>;</span><br><span class="line">&#125;;  </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SubClass1</span> <span class="keyword">final</span>:</span> Base &#123; &#125;; <span class="comment">// åˆæ³•</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SubClass2</span> :</span> SubClass1 &#123; &#125;; <span class="comment">// éæ³•, SubClass1 å·² final</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SubClass3</span>:</span> Base &#123;  </span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>; <span class="comment">// éæ³•, foo å·² final</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="æ˜¾å¼ç¦ç”¨é»˜è®¤å‡½æ•°"><a href="#æ˜¾å¼ç¦ç”¨é»˜è®¤å‡½æ•°" class="headerlink" title="æ˜¾å¼ç¦ç”¨é»˜è®¤å‡½æ•°"></a>æ˜¾å¼ç¦ç”¨é»˜è®¤å‡½æ•°</h3><p>å¦‚æœç¨‹åºå‘˜æ²¡æœ‰æä¾›ï¼Œç¼–è¯‘å™¨ä¼šé»˜è®¤ä¸ºå¯¹è±¡ç”Ÿæˆé»˜è®¤æ„é€ å‡½æ•°ã€å¤åˆ¶æ„é€ ã€èµ‹å€¼ ç®—ç¬¦ä»¥åŠææ„å‡½æ•°ã€‚<br>c++11 æä¾›äº†æ–¹æ³•</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Magic</span> &#123;</span> </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">Magic</span>() = <span class="keyword">default</span>; <span class="comment">// æ˜¾å¼å£°æ˜ä½¿ç”¨ç¼–è¯‘å™¨ç”Ÿæˆçš„æ„é€   </span></span><br><span class="line">	Magic&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> Magic&amp;) = <span class="keyword">delete</span>; <span class="comment">// æ˜¾å¼å£°æ˜æ‹’ç»ç¼–è¯‘å™¨ç”Ÿæˆæ„é€  </span></span><br><span class="line">	<span class="built_in">Magic</span>(<span class="keyword">int</span> magic_number);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å¼ºç±»å‹æšä¸¾"><a href="#å¼ºç±»å‹æšä¸¾" class="headerlink" title="å¼ºç±»å‹æšä¸¾"></a>å¼ºç±»å‹æšä¸¾</h3><p> C++11 å¼•å…¥äº†æšä¸¾ç±»(enumeration class)ï¼Œå¹¶ä½¿ç”¨ enum class çš„è¯­æ³•è¿›è¡Œå£°æ˜:</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="keyword">class</span> <span class="title">new_enum</span> :</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> &#123; </span><br><span class="line">  value1,</span><br><span class="line"> value2,</span><br><span class="line"> value3 = <span class="number">100</span>,</span><br><span class="line"> value4 = <span class="number">100</span> </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>è¯­è¨€å­¦ä¹ </category>
        <category>c++</category>
        <category>ç°ä»£c++</category>
      </categories>
      <tags>
        <tag>c++</tag>
      </tags>
  </entry>
  <entry>
    <title>golangçš„listå®ç°</title>
    <url>/2022/05/24/golang%E7%9A%84list%E5%AE%9E%E7%8E%B0/</url>
    <content><![CDATA[<p>åœ¨leetcodeåˆ·é¢˜æ—¶å€™ï¼Œä¼šç”¨åˆ°é“¾è¡¨çš„æ•°æ®ç»“æ„ã€‚åœ¨goè¯­è¨€ä¸­ï¼Œé“¾è¡¨çš„å®ç°æ˜¯æœ‰ç°æˆçš„æ¥å£çš„ã€‚</p>
<span id="more"></span>

<!-- toc -->

<p>åœ¨Goè¯­è¨€ä¸­ï¼Œåˆ—è¡¨ä½¿ç”¨ container/list åŒ…æ¥å®ç°ï¼Œå†…éƒ¨çš„å®ç°åŸç†æ˜¯åŒé“¾è¡¨ï¼Œåˆ—è¡¨èƒ½å¤Ÿé«˜æ•ˆåœ°è¿›è¡Œä»»æ„ä½ç½®çš„å…ƒç´ æ’å…¥å’Œåˆ é™¤æ“ä½œã€‚</p>
<ul>
<li><code>container/list</code>åŒ…ä¸­å¯¼å…¥<br>list åŒ…å®ç°äº†ä¸€ä¸ªåŒé“¾è¡¨ï¼ˆdoubly linked listï¼‰ã€‚<h2 id="Elementç±»å‹"><a href="#Elementç±»å‹" class="headerlink" title="Elementç±»å‹"></a>Elementç±»å‹</h2>Element ç”¨äºä»£è¡¨åŒé“¾è¡¨çš„å…ƒç´ </li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> Element <span class="keyword">struct</span> &#123;</span><br><span class="line">    next, prev *Element</span><br><span class="line">    list       *List</span><br><span class="line">    <span class="comment">// any æ˜¯æ¥å£ç±»å‹</span></span><br><span class="line">    Value      any</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ–¹æ³•</span></span><br><span class="line"><span class="comment">// Next returns the next list element or nil.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Element)</span> <span class="title">Next</span><span class="params">()</span> *<span class="title">Element</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Element)</span> <span class="title">Prev</span><span class="params">()</span> *<span class="title">Element</span></span></span><br></pre></td></tr></table></figure>

<h2 id="Listç±»å‹"><a href="#Listç±»å‹" class="headerlink" title="Listç±»å‹"></a>Listç±»å‹</h2><p>List ç”¨äºè¡¨ç¤ºåŒé“¾è¡¨ã€‚<br>ç©ºåˆ—è¡¨å¯ä»¥ç”¨ä½œ List çš„é›¶å€¼ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> List <span class="keyword">struct</span> &#123;</span><br><span class="line">    root Element</span><br><span class="line">    <span class="built_in">len</span>  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    l := list.New()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°¾éƒ¨æ·»åŠ , è¿”å›element</span></span><br><span class="line">    e1 := l.PushBack(<span class="string">&quot;canon&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤´éƒ¨æ·»åŠ </span></span><br><span class="line">    e2 := l.PushFront(<span class="number">67</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°¾éƒ¨æ·»åŠ åä¿å­˜å…ƒç´ å¥æŸ„</span></span><br><span class="line">    element := l.PushBack(<span class="string">&quot;fist&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨fistä¹‹åæ·»åŠ high</span></span><br><span class="line">    l.InsertAfter(<span class="string">&quot;high&quot;</span>, element)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨fistä¹‹å‰æ·»åŠ noon</span></span><br><span class="line">    l.InsertBefore(<span class="string">&quot;noon&quot;</span>, element)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç§»é™¤æŒ‡å®šå…ƒç´ , è¿”å›value</span></span><br><span class="line">    l.Remove(element)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ----- éå† ------</span></span><br><span class="line">	<span class="keyword">for</span> i := l.Front(); i != <span class="literal">nil</span>; i = i.Next() &#123;</span><br><span class="line">	    fmt.Println(i.Value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title>å­˜å‚¨ä¸æ£€ç´¢</title>
    <url>/2022/06/01/%E5%AD%98%E5%82%A8%E4%B8%8E%E6%A3%80%E7%B4%A2/</url>
    <content><![CDATA[<p>è®¾è®¡æ•°æ®å¯†é›†å‹åº”ç”¨ç¨‹åºï¼Œä¸€äº›å¸¸ç”¨çš„å­˜å‚¨å¼•æ“ä¸ç´¢å¼•ã€‚</p>
<span id="more"></span>

<!-- toc -->

<h2 id="å“ˆå¸Œç´¢å¼•"><a href="#å“ˆå¸Œç´¢å¼•" class="headerlink" title="å“ˆå¸Œç´¢å¼•"></a>å“ˆå¸Œç´¢å¼•</h2><p>é”®å€¼å­˜å‚¨ä¸åœ¨å¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€ä¸­å¯ä»¥æ‰¾åˆ°çš„å­—å…¸(dictionary)ç±»å‹éå¸¸ç›¸ä¼¼ï¼Œé€šå¸¸å­—å…¸éƒ½æ˜¯ ç”¨æ•£åˆ—æ˜ å°„(hash map)(æˆ–å“ˆå¸Œè¡¨(hash table))å®ç°çš„ã€‚<br>é‚£ä¹ˆæœ€ç®€å•çš„ç´¢å¼•ç­– ç•¥å°±æ˜¯:ä¿ç•™ä¸€ä¸ªå†…å­˜ä¸­çš„å“ˆå¸Œæ˜ å°„ï¼Œå…¶ä¸­æ¯ä¸ªé”®éƒ½æ˜ å°„åˆ°ä¸€ä¸ªæ•°æ®æ–‡ä»¶ä¸­çš„å­—èŠ‚åç§»é‡ï¼Œ æŒ‡æ˜äº†å¯ä»¥æ‰¾åˆ°å¯¹åº”å€¼çš„ä½ç½®ã€‚</p>
<p>ps: è¿½åŠ å†™å…¥ï¼ˆè¿½åŠ å’Œåˆ†æ®µåˆå¹¶æ˜¯é¡ºåºå†™å…¥æ“ä½œï¼Œé€šå¸¸æ¯”éšæœºå†™å…¥å¿«å¾—å¤šï¼‰ï¼Œè€Œä¸æ˜¯åˆ é™¤åŸå…ˆçš„é”®å€¼ã€‚</p>
<p>ä½†æ˜¯ï¼Œå“ˆå¸Œè¡¨ç´¢å¼•ä¹Ÿæœ‰å±€é™æ€§:</p>
<ul>
<li><p>æ•£åˆ—è¡¨å¿…é¡»èƒ½æ”¾è¿›å†…å­˜</p>
<p>  å¦‚æœä½ æœ‰éå¸¸å¤šçš„é”®ï¼Œé‚£çœŸæ˜¯å€’éœ‰ã€‚åŸåˆ™ä¸Šå¯ä»¥åœ¨ç£ç›˜ä¸Šä¿ç•™ä¸€ä¸ªå“ˆå¸Œæ˜ å°„ï¼Œä¸å¹¸çš„æ˜¯ ç£ç›˜å“ˆå¸Œæ˜ å°„å¾ˆéš¾è¡¨ç°ä¼˜ç§€ã€‚å®ƒéœ€è¦å¤§é‡çš„éšæœºè®¿é—®I/Oï¼Œå½“å®ƒå˜æ»¡æ—¶å¢é•¿æ˜¯å¾ˆæ˜‚è´µçš„ï¼Œ å¹¶ä¸”æ•£åˆ—å†²çªéœ€è¦å¾ˆå¤šçš„é€»è¾‘ã€5ã€‘ã€‚</p>
</li>
<li><p>èŒƒå›´æŸ¥è¯¢æ•ˆç‡ä¸é«˜ã€‚</p>
<p>  ä¾‹å¦‚ï¼Œæ‚¨æ— æ³•è½»æ¾æ‰«ækitty00000å’Œkitty99999ä¹‹é—´çš„æ‰€æœ‰é”®â€”â€”æ‚¨ å¿…é¡»åœ¨æ•£åˆ—æ˜ å°„ä¸­å•ç‹¬æŸ¥æ‰¾æ¯ä¸ªé”®ã€‚</p>
</li>
</ul>
<h2 id="SSTablesï¼ˆSorted-String-Tableï¼‰æ’åºå­—ç¬¦ä¸²è¡¨"><a href="#SSTablesï¼ˆSorted-String-Tableï¼‰æ’åºå­—ç¬¦ä¸²è¡¨" class="headerlink" title="SSTablesï¼ˆSorted String Tableï¼‰æ’åºå­—ç¬¦ä¸²è¡¨"></a>SSTablesï¼ˆSorted String Tableï¼‰æ’åºå­—ç¬¦ä¸²è¡¨</h2><p>SSTable æ–‡ä»¶ç”¨äº Bigtable å†…éƒ¨æ•°æ®å­˜å‚¨ã€‚SSTable æ–‡ä»¶æ˜¯ä¸€ä¸ªæ’åºçš„ã€ä¸å¯å˜çš„ã€æŒä¹…åŒ–çš„ map ç»“æ„ï¼Œå…¶ä¸­ map çš„ key-value éƒ½å¯ä»¥æ˜¯ä»»æ„å­—èŠ‚çš„å­—ç¬¦ä¸²ã€‚æ”¯æŒä½¿ç”¨æŒ‡å®šé”®æ¥æŸ¥æ‰¾å€¼ï¼Œæˆ–é€šè¿‡ç»™å®šé”®èŒƒå›´éå†æ‰€æœ‰çš„ key-value å¯¹ã€‚</p>
<p><img src="/2022/06/01/%E5%AD%98%E5%82%A8%E4%B8%8E%E6%A3%80%E7%B4%A2/sstable.png" title="å†…å­˜ç´¢å¼•çš„sstable"></p>
<p>å·¥ä½œæ–¹å¼: </p>
<ul>
<li>å†™å…¥æ—¶ï¼Œå°†å…¶æ·»åŠ åˆ°å†…å­˜ä¸­çš„å¹³è¡¡æ ‘æ•°æ®ç»“æ„(ä¾‹å¦‚ï¼Œçº¢é»‘æ ‘)ã€‚è¿™ä¸ªå†…å­˜æ ‘æœ‰æ—¶è¢«ç§° ä¸ºå†…å­˜è¡¨(memtable)</li>
<li>å½“å†…å­˜è¡¨å¤§äºæŸä¸ªé˜ˆå€¼(é€šå¸¸ä¸ºå‡ å…†å­—èŠ‚)æ—¶ï¼Œå°†å…¶ä½œä¸ºSSTableæ–‡ä»¶å†™å…¥ç£ç›˜ã€‚å½“SSTableè¢«å†™å…¥ç£ç›˜æ—¶ï¼Œå†™å…¥å¯ä»¥ç»§ç»­åˆ°ä¸€ä¸ªæ–°çš„å†…å­˜è¡¨å®ä¾‹ã€‚</li>
<li>ä¸ºäº†æä¾›è¯»å–è¯·æ±‚ï¼Œ<code>é¦–å…ˆ</code>å°è¯•åœ¨å†…å­˜è¡¨ä¸­æ‰¾åˆ°å…³é”®å­—ï¼Œ<code>ç„¶å</code>åœ¨æœ€è¿‘çš„ç£ç›˜æ®µä¸­ï¼Œ<code>ç„¶å</code>åœ¨ ä¸‹ä¸€ä¸ªè¾ƒæ—§çš„æ®µä¸­æ‰¾åˆ°è¯¥å…³é”®å­—ã€‚</li>
<li>æœ‰æ—¶ä¼šåœ¨åå°è¿è¡Œåˆå¹¶å’Œå‹ç¼©è¿‡ç¨‹ä»¥ç»„åˆæ®µæ–‡ä»¶å¹¶ä¸¢å¼ƒè¦†ç›–æˆ–åˆ é™¤çš„å€¼ã€‚</li>
</ul>
<p>è¿™ç§å°±æ˜¯å¸¸è¯´çš„<strong>LSMæ ‘</strong>ï¼ˆLog Structured Merge Treeï¼Œç»“æ„åŒ–åˆå¹¶<strong>æ ‘</strong>ï¼‰</p>
<h2 id="Bæ ‘"><a href="#Bæ ‘" class="headerlink" title="Bæ ‘"></a>Bæ ‘</h2><p><img src="/2022/06/01/%E5%AD%98%E5%82%A8%E4%B8%8E%E6%A3%80%E7%B4%A2/b%E6%A0%91.png" title="bæ ‘"></p>
<p>Bæ ‘å°†æ•°æ®åº“åˆ†è§£æˆå›ºå®šå¤§å°çš„å—æˆ–é¡µé¢ï¼Œä¼ ç»Ÿä¸Šå¤§ å°ä¸º4KB(æœ‰æ—¶ä¼šæ›´å¤§)ï¼Œæ¯ä¸ªé¡µé¢éƒ½å¯ä»¥ä½¿ç”¨åœ°å€æˆ–ä½ç½®æ¥æ ‡è¯†ï¼Œè¿™å…è®¸ä¸€ä¸ªé¡µé¢å¼•ç”¨å¦ä¸€ä¸ªé¡µé¢ â€”â€” ç±»ä¼¼äºæŒ‡é’ˆï¼Œ ä½†åœ¨ç£ç›˜è€Œä¸æ˜¯åœ¨å†…å­˜ä¸­ã€‚<br>ä¸€ä¸ªé¡µé¢ä¼šè¢«æŒ‡å®šä¸ºBæ ‘çš„æ ¹;åœ¨ç´¢å¼•ä¸­æŸ¥æ‰¾ä¸€ä¸ªé”®æ—¶ï¼Œå°±ä»è¿™é‡Œå¼€å§‹ã€‚è¯¥é¡µé¢åŒ…å«å‡ ä¸ªé”®å’Œ å¯¹å­é¡µé¢çš„å¼•ç”¨ã€‚æ¯ä¸ªå­é¡µé¢è´Ÿè´£ä¸€æ®µè¿ç»­èŒƒå›´çš„é”®ï¼Œå¼•ç”¨ä¹‹é—´çš„é”®ï¼ŒæŒ‡æ˜äº†å¼•ç”¨å­é¡µé¢çš„ é”®èŒƒå›´ã€‚</p>
<p>å·¥ä½œæ–¹å¼:</p>
<ul>
<li>å¦‚æœè¦æ›´æ–°Bæ ‘ä¸­ç°æœ‰é”®çš„å€¼ï¼Œåˆ™æœç´¢åŒ…å«è¯¥é”®çš„å¶é¡µï¼Œæ›´æ”¹è¯¥é¡µä¸­çš„å€¼ï¼Œå¹¶å°†è¯¥é¡µå†™å›åˆ°ç£ ç›˜(å¯¹è¯¥é¡µçš„ä»»ä½•å¼•ç”¨ä¿æŒæœ‰æ•ˆ) ã€‚</li>
<li>å¦‚æœä½ æƒ³æ·»åŠ ä¸€ä¸ªæ–°çš„é”®ï¼Œä½ éœ€è¦æ‰¾åˆ°å…¶èŒƒå›´åŒ…å«æ–°é”® çš„é¡µé¢ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°è¯¥é¡µé¢ã€‚å¦‚æœé¡µé¢ä¸­æ²¡æœ‰è¶³å¤Ÿçš„å¯ç”¨ç©ºé—´å®¹çº³æ–°é”®ï¼Œåˆ™å°†å…¶åˆ†æˆä¸¤ä¸ª åŠæ»¡é¡µé¢ï¼Œå¹¶æ›´æ–°çˆ¶é¡µé¢ä»¥è§£é‡Šé”®èŒƒå›´çš„æ–°åˆ†åŒº</li>
</ul>
<h2 id="æ¯”è¾ƒBæ ‘å’ŒLSMæ ‘"><a href="#æ¯”è¾ƒBæ ‘å’ŒLSMæ ‘" class="headerlink" title="æ¯”è¾ƒBæ ‘å’ŒLSMæ ‘"></a>æ¯”è¾ƒBæ ‘å’ŒLSMæ ‘</h2><p>æ ¹æ®ç»éªŒï¼Œé€š å¸¸LSMæ ‘çš„å†™å…¥é€Ÿåº¦æ›´å¿«ï¼Œè€ŒBæ ‘çš„è¯»å–é€Ÿåº¦æ›´å¿«ã€‚ LSMæ ‘ä¸Šçš„è¯»å–é€šå¸¸æ¯”è¾ƒæ…¢ï¼Œå›  ä¸ºå®ƒä»¬å¿…é¡»åœ¨å‹ç¼©çš„ä¸åŒé˜¶æ®µæ£€æŸ¥å‡ ä¸ªä¸åŒçš„æ•°æ®ç»“æ„å’ŒSSTablesã€‚</p>
<h3 id="LSMæ ‘çš„ä¼˜ç‚¹"><a href="#LSMæ ‘çš„ä¼˜ç‚¹" class="headerlink" title="LSMæ ‘çš„ä¼˜ç‚¹"></a>LSMæ ‘çš„ä¼˜ç‚¹</h3><p>bæ ‘å†™æ•°æ®è‡³å°‘ä¸¤æ¬¡: 1. ä¸€æ¬¡é¢„å…ˆå†™å…¥æ—¥å¿— 2. ä¸€æ¬¡å†™å…¥æ ‘æœ¬èº«ï¼ˆè¿˜æœ‰å¯èƒ½ä¼šåˆ†é¡µï¼‰å³ä½¿åœ¨è¯¥é¡µé¢ä¸­åªæœ‰å‡ ä¸ªå­—èŠ‚å‘ç”Ÿäº†å˜åŒ–ï¼Œä¹Ÿéœ€è¦ä¸€æ¬¡ç¼–å†™æ•´ä¸ªé¡µé¢çš„å¼€é”€ã€‚</p>
<ul>
<li>å†™é€Ÿåº¦çªå‡º<ul>
<li>LSMæ ‘é€šå¸¸èƒ½å¤Ÿæ¯”Bæ ‘æ”¯æŒæ›´é«˜çš„å†™å…¥ååé‡ï¼Œéƒ¨åˆ†åŸå› æ˜¯å®ƒä»¬æœ‰æ—¶å…·æœ‰è¾ƒä½çš„å†™æ”¾å¤§ (å°½ç®¡è¿™å–å†³äºå­˜å‚¨å¼•æ“é…ç½®å’Œå·¥ä½œè´Ÿè½½)ï¼Œéƒ¨åˆ†æ˜¯å› ä¸ºå®ƒä»¬é¡ºåºåœ°å†™å…¥ç´§å‡‘çš„SSTableæ–‡ä»¶ è€Œä¸æ˜¯å¿…é¡»è¦†ç›–æ ‘ä¸­çš„å‡ ä¸ªé¡µé¢ã€‚é¡ºåºå†™å…¥ æ¯”éšæœºå†™å…¥å¿«å¾—å¤šã€‚</li>
</ul>
</li>
<li>ç£ç›˜åˆ©ç”¨ç‡é«˜<ul>
<li>LSMæ ‘å¯ä»¥è¢«å‹ç¼©å¾—æ›´å¥½ï¼Œå› æ­¤ç»å¸¸æ¯”Bæ ‘åœ¨ç£ç›˜ä¸Šäº§ç”Ÿæ›´å°çš„æ–‡ä»¶ã€‚ Bæ ‘å­˜å‚¨å¼•æ“ä¼šç”±äºåˆ† å‰²è€Œç•™ä¸‹ä¸€äº›æœªä½¿ç”¨çš„ç£ç›˜ç©ºé—´:å½“é¡µé¢è¢«æ‹†åˆ†æˆ–æŸè¡Œä¸èƒ½æ”¾å…¥ç°æœ‰é¡µé¢æ—¶ï¼Œé¡µé¢ä¸­çš„æŸäº› ç©ºé—´ä»æœªè¢«ä½¿ç”¨ã€‚ç”±äºLSMæ ‘ä¸æ˜¯é¢å‘é¡µé¢çš„ï¼Œå¹¶ä¸”å®šæœŸé‡å†™SSTablesä»¥å»é™¤ç¢ç‰‡ï¼Œæ‰€ä»¥å®ƒ ä»¬å…·æœ‰è¾ƒä½çš„å­˜å‚¨å¼€é”€ï¼Œç‰¹åˆ«æ˜¯å½“ä½¿ç”¨å¹³å¦å‹ç¼©æ—¶</li>
</ul>
</li>
</ul>
<h3 id="LSMçš„ç¼ºç‚¹"><a href="#LSMçš„ç¼ºç‚¹" class="headerlink" title="LSMçš„ç¼ºç‚¹"></a>LSMçš„ç¼ºç‚¹</h3><ul>
<li>æ—¥å¿—ç»“æ„å­˜å‚¨çš„ç¼ºç‚¹æ˜¯å‹ç¼©è¿‡ç¨‹æœ‰æ—¶ä¼šå¹²æ‰°æ­£åœ¨è¿›è¡Œçš„è¯»å†™æ“ä½œã€‚å°½ç®¡å­˜å‚¨å¼•æ“å°è¯•é€æ­¥æ‰§ è¡Œå‹ç¼©è€Œä¸å½±å“å¹¶å‘è®¿é—®ï¼Œä½†æ˜¯ç£ç›˜èµ„æºæœ‰é™ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å‘ç”Ÿè¯·æ±‚éœ€è¦ç­‰å¾…è€Œç£ç›˜å®Œæˆæ˜‚ è´µçš„å‹ç¼©æ“ä½œã€‚</li>
<li>å‹ç¼©çš„å¦ä¸€ä¸ªé—®é¢˜å‡ºç°åœ¨é«˜å†™å…¥ååé‡:ç£ç›˜çš„æœ‰é™å†™å…¥å¸¦å®½éœ€è¦åœ¨åˆå§‹å†™å…¥(è®°å½•å’Œåˆ·æ–°å†…å­˜è¡¨åˆ°ç£ç›˜)å’Œåœ¨åå°è¿è¡Œçš„å‹ç¼©çº¿ç¨‹ä¹‹é—´å…±äº«ã€‚</li>
<li>å¦‚æœå†™å…¥ååé‡å¾ˆé«˜ï¼Œå¹¶ä¸”å‹ç¼©æ²¡æœ‰ä»”ç»†é…ç½®ï¼Œå‹ç¼©è·Ÿä¸ä¸Šå†™å…¥é€Ÿç‡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç£ç›˜ ä¸Šæœªåˆå¹¶æ®µçš„æ•°é‡ä¸æ–­å¢åŠ ï¼Œç›´åˆ°ç£ç›˜ç©ºé—´ç”¨å®Œï¼Œè¯»å–é€Ÿåº¦ä¹Ÿä¼šå‡æ…¢ï¼Œå› ä¸ºå®ƒä»¬éœ€è¦æ£€æŸ¥æ›´ å¤šæ®µæ–‡ä»¶ã€‚</li>
</ul>
<p>Bæ ‘çš„ä¼˜ç‚¹ï¼šåœ¨è®¸å¤šå…³ç³»æ•°æ®åº“ä¸­ï¼Œäº‹åŠ¡éš”ç¦»æ˜¯é€šè¿‡åœ¨é”®èŒƒå›´ä¸Šä½¿ç”¨é”æ¥å®ç°çš„ï¼Œåœ¨Bæ ‘ç´¢å¼•ä¸­ï¼Œè¿™äº› é”å¯ä»¥ç›´æ¥è¿æ¥åˆ°æ ‘ã€‚ï¼ˆBæ ‘çš„ç´¢å¼•åªæœ‰å”¯ä¸€çš„ä¸€ä¸ªï¼Œè€Œæ—¥å¿—ç»“æ„åŒ–å­˜å‚¨å¼•æ“åˆ™å¯èƒ½åœ¨ä¸åŒçš„æ®µä¸­æœ‰ç›¸åŒçš„å‰¯æœ¬ï¼‰</p>
<h2 id="å…¶ä»–ç´¢å¼•"><a href="#å…¶ä»–ç´¢å¼•" class="headerlink" title="å…¶ä»–ç´¢å¼•"></a>å…¶ä»–ç´¢å¼•</h2><h3 id="å€¼å­˜åœ¨ç´¢å¼•ä¸­"><a href="#å€¼å­˜åœ¨ç´¢å¼•ä¸­" class="headerlink" title="å€¼å­˜åœ¨ç´¢å¼•ä¸­"></a>å€¼å­˜åœ¨ç´¢å¼•ä¸­</h3><ul>
<li>ç´¢å¼•ä¸­çš„å…³é”®å­—æ˜¯æŸ¥è¯¢æœç´¢çš„å†…å®¹ï¼Œä½†æ˜¯è¯¥å€¼å¯ä»¥æ˜¯ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¹‹ä¸€:å®ƒå¯ä»¥æ˜¯æ‰€è®¨è®ºçš„ å®é™…è¡Œ(æ–‡æ¡£ï¼Œé¡¶ç‚¹)ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯¹å­˜å‚¨åœ¨åˆ«å¤„çš„è¡Œçš„å¼•ç”¨ã€‚è¡Œè¢«å­˜å‚¨çš„ åœ°æ–¹è¢«ç§°ä¸ºå †æ–‡ä»¶(heap file)ï¼Œå¹¶ä¸”å­˜å‚¨çš„æ•°æ®æ²¡æœ‰ç‰¹å®šçš„é¡ºåºã€‚</li>
<li>å°†ç´¢å¼•è¡Œç›´æ¥å­˜å‚¨åœ¨ç´¢å¼•ä¸­ã€‚è¿™è¢«ç§°ä¸º<code>èšé›†ç´¢å¼•</code>ã€‚ä¾‹å¦‚ï¼Œåœ¨MySQLçš„InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œè¡¨çš„ä¸»é”® æ€»æ˜¯ä¸€ä¸ªèšç°‡ç´¢å¼•ã€‚</li>
<li>åœ¨<code>èšé›†ç´¢å¼•(clustered index)</code>(åœ¨ç´¢å¼•ä¸­å­˜å‚¨æ‰€æœ‰è¡Œæ•°æ®)å’Œ<code>éèšé›†ç´¢å¼•(nonclustered index)</code>(ä»…åœ¨ç´¢å¼•ä¸­å­˜å‚¨å¯¹æ•°æ®çš„å¼•ç”¨)ä¹‹é—´çš„æŠ˜è¡·è¢«ç§°ä¸ºåŒ…å«åˆ—çš„ç´¢å¼•(index with included columns)æˆ–<code>è¦†ç›–ç´¢å¼•(covering index)</code>ï¼Œå…¶å­˜å‚¨è¡¨çš„ä¸€éƒ¨åˆ†åœ¨ç´¢å¼•å†…ã€‚</li>
</ul>
<h3 id="å¤šåˆ—ç´¢å¼•"><a href="#å¤šåˆ—ç´¢å¼•" class="headerlink" title="å¤šåˆ—ç´¢å¼•"></a>å¤šåˆ—ç´¢å¼•</h3><ul>
<li><code>è¿æ¥ç´¢å¼•(concatenated index)</code>ï¼Œå®ƒé€šè¿‡å°†ä¸€åˆ—çš„å€¼è¿½åŠ åˆ°å¦ä¸€ åˆ—åé¢ï¼Œç®€å•åœ°å°†å¤šä¸ªå­—æ®µç»„åˆæˆä¸€ä¸ªé”®(ç´¢å¼•å®šä¹‰ä¸­æŒ‡å®šäº†å­—æ®µçš„è¿æ¥é¡ºåº)ã€‚</li>
<li><code>å¤šç»´ç´¢å¼•(multi-dimensional index)</code>æ˜¯ä¸€ç§æŸ¥è¯¢å¤šä¸ªåˆ—çš„æ›´ä¸€èˆ¬çš„æ–¹æ³•ï¼Œè¿™å¯¹äºåœ°ç†ç©ºé—´ æ•°æ®å°¤ä¸ºé‡è¦ã€‚(æ‰©å±•åˆ°Ræ ‘)</li>
</ul>
<h3 id="å…¨æ–‡æœç´¢å’Œæ¨¡ç³Šç´¢å¼•"><a href="#å…¨æ–‡æœç´¢å’Œæ¨¡ç³Šç´¢å¼•" class="headerlink" title="å…¨æ–‡æœç´¢å’Œæ¨¡ç³Šç´¢å¼•"></a>å…¨æ–‡æœç´¢å’Œæ¨¡ç³Šç´¢å¼•</h3><h3 id="äº‹åŠ¡å¤„ç†ä¸åˆ†æ"><a href="#äº‹åŠ¡å¤„ç†ä¸åˆ†æ" class="headerlink" title="äº‹åŠ¡å¤„ç†ä¸åˆ†æ"></a>äº‹åŠ¡å¤„ç†ä¸åˆ†æ</h3><p>å³ä½¿æ•°æ®åº“å¼€å§‹è¢«ç”¨äºè®¸å¤šä¸åŒç±»å‹çš„åšå®¢æ–‡ç« ï¼Œæ¸¸æˆä¸­çš„åŠ¨ä½œï¼Œåœ°å€ç°¿ä¸­çš„è”ç³»äººç­‰ç­‰ï¼Œ åŸºæœ¬è®¿é—®æ¨¡å¼ä»ç„¶ç±»ä¼¼äºå¤„ç†ä¸šåŠ¡äº‹åŠ¡ã€‚åº”ç”¨ç¨‹åºé€šå¸¸ä½¿ç”¨ç´¢å¼•é€šè¿‡æŸä¸ªé”®æŸ¥æ‰¾å°‘é‡è®°å½•ã€‚ æ ¹æ®ç”¨æˆ·çš„è¾“å…¥æ’å…¥æˆ–æ›´æ–°è®°å½•ã€‚ç”±äºè¿™äº›åº”ç”¨ç¨‹åºæ˜¯äº¤äº’å¼çš„ï¼Œå› æ­¤è®¿é—®æ¨¡å¼è¢«ç§°ä¸ºåœ¨çº¿ äº‹åŠ¡å¤„ç†(OLTP, OnLine Transaction Processing)ã€‚</p>
<p>è¿™äº›æŸ¥è¯¢é€šå¸¸ç”±ä¸šåŠ¡åˆ†æå¸ˆç¼–å†™ï¼Œå¹¶æä¾›ç»™å¸®åŠ©å…¬å¸ç®¡ç†å±‚åšå‡ºæ›´å¥½å†³ç­–(å•†ä¸šæ™ºèƒ½)çš„æŠ¥ å‘Šã€‚ä¸ºäº†åŒºåˆ†è¿™ç§ä½¿ç”¨æ•°æ®åº“çš„äº‹åŠ¡å¤„ç†æ¨¡å¼ï¼Œå®ƒè¢«ç§°ä¸ºåœ¨çº¿åˆ†æå¤„ç†(OLAP, OnLine Analytice Processing)</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul>
<li>OLTPç³»ç»Ÿé€šå¸¸é¢å‘ç”¨æˆ·ï¼Œè¿™æ„å‘³ç€ä»–ä»¬å¯èƒ½ä¼šçœ‹åˆ°å¤§é‡çš„è¯·æ±‚ã€‚ä¸ºäº†å¤„ç†è´Ÿè½½ï¼Œåº”ç”¨ç¨‹ åºé€šå¸¸åªè§¦åŠæ¯ä¸ªæŸ¥è¯¢ä¸­çš„å°‘é‡è®°å½•ã€‚åº”ç”¨ç¨‹åºä½¿ç”¨æŸç§é”®æ¥è¯·æ±‚è®°å½•ï¼Œå­˜å‚¨å¼•æ“ä½¿ç”¨ ç´¢å¼•æ¥æŸ¥æ‰¾æ‰€è¯·æ±‚çš„é”®çš„æ•°æ®ã€‚ç£ç›˜å¯»é“æ—¶é—´å¾€å¾€æ˜¯è¿™é‡Œçš„ç“¶é¢ˆã€‚ </li>
<li>OLAPæ•°æ®ä»“åº“å’Œç±»ä¼¼çš„åˆ†æç³»ç»Ÿä¸å¤ªçŸ¥åï¼Œå› ä¸ºå®ƒä»¬ä¸»è¦ç”±ä¸šåŠ¡åˆ†æäººå‘˜ä½¿ç”¨ï¼Œè€Œä¸æ˜¯ç”±æœ€ ç»ˆç”¨æˆ·ä½¿ç”¨ã€‚å®ƒä»¬å¤„ç†æ¯”OLTPç³»ç»Ÿå°‘å¾—å¤šçš„æŸ¥è¯¢é‡ï¼Œä½†æ˜¯æ¯ä¸ªæŸ¥è¯¢é€šå¸¸è¦æ±‚å¾ˆé«˜ï¼Œéœ€è¦ åœ¨çŸ­æ—¶é—´å†…æ‰«ææ•°ç™¾ä¸‡æ¡è®°å½•ã€‚ç£ç›˜å¸¦å®½(ä¸æ˜¯æŸ¥æ‰¾æ—¶é—´)å¾€å¾€æ˜¯ç“¶é¢ˆï¼Œåˆ—å¼å­˜å‚¨æ˜¯è¿™ ç§å·¥ä½œè´Ÿè½½è¶Šæ¥è¶Šæµè¡Œçš„è§£å†³æ–¹æ¡ˆã€‚</li>
</ul>
]]></content>
      <categories>
        <category>è¯»ä¹¦ç¬”è®°</category>
        <category>è®¾è®¡æ•°æ®å¯†é›†å‹åº”ç”¨ç¨‹åº</category>
      </categories>
      <tags>
        <tag>æ•°æ®åº“</tag>
        <tag>å­˜å‚¨</tag>
      </tags>
  </entry>
  <entry>
    <title>goçš„åˆ‡ç‰‡å’ŒæŒ‡é’ˆ</title>
    <url>/2022/06/17/go%E7%9A%84%E5%88%87%E7%89%87%E5%92%8C%E6%8C%87%E9%92%88/</url>
    <content><![CDATA[<hr>
<p>åˆ‡ç‰‡æœ¬èº«å¹¶ä¸æ˜¯åŠ¨æ€æ•°ç»„æˆ–è€…æ•°ç»„æŒ‡é’ˆã€‚å®ƒå†…éƒ¨å®ç°çš„æ•°æ®ç»“æ„é€šè¿‡æŒ‡é’ˆå¼•ç”¨åº•å±‚æ•°ç»„ï¼Œè®¾å®šç›¸å…³å±æ€§å°†æ•°æ®è¯»å†™æ“ä½œé™å®šåœ¨æŒ‡å®šçš„åŒºåŸŸå†…ã€‚<strong>åˆ‡ç‰‡æœ¬èº«æ˜¯ä¸€ä¸ªåªè¯»å¯¹è±¡ï¼Œå…¶å·¥ä½œæœºåˆ¶ç±»ä¼¼æ•°ç»„æŒ‡é’ˆçš„ä¸€ç§å°è£…</strong>ã€‚</p>
<span id="more"></span>
<!-- toc -->

<p>[toc]</p>
<p><a href="https://halfrost.com/go_slice/">å‚è€ƒæ–‡ç« </a></p>
<h2 id="goè¯­è¨€æŒ‡é’ˆ"><a href="#goè¯­è¨€æŒ‡é’ˆ" class="headerlink" title="goè¯­è¨€æŒ‡é’ˆ"></a>goè¯­è¨€æŒ‡é’ˆ</h2><p>Goä¸­çš„æŒ‡é’ˆåŠä¸æŒ‡é’ˆå¯¹æŒ‡é’ˆçš„æ“ä½œä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š</p>
<ul>
<li><p>ä¸€æ™®é€šçš„æŒ‡é’ˆç±»å‹ï¼Œä¾‹å¦‚Â var intptr *Tï¼Œå®šä¹‰ä¸€ä¸ªTç±»å‹æŒ‡é’ˆå˜é‡ã€‚</p>
</li>
<li><p>äºŒå†…ç½®ç±»å‹uintptrï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªæ— ç¬¦å·çš„æ•´å‹ï¼Œå®ƒçš„é•¿åº¦æ˜¯è·Ÿå¹³å°ç›¸å…³çš„ï¼Œå®ƒçš„é•¿åº¦å¯ä»¥ç”¨æ¥ä¿å­˜ä¸€ä¸ªæŒ‡é’ˆåœ°å€ã€‚</p>
</li>
<li><p>ä¸‰æ˜¯unsafeåŒ…æä¾›çš„Pointerï¼Œè¡¨ç¤ºå¯ä»¥æŒ‡å‘ä»»æ„ç±»å‹çš„æŒ‡é’ˆã€‚</p>
</li>
</ul>
<h3 id="æ™®é€šæŒ‡é’ˆ"><a href="#æ™®é€šæŒ‡é’ˆ" class="headerlink" title="æ™®é€šæŒ‡é’ˆ"></a>æ™®é€šæŒ‡é’ˆ</h3><p>é€šè¿‡å¼•ç”¨æ¥ä¿®æ”¹å€¼</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">count := <span class="number">1</span></span><br><span class="line">Counter(&amp;count)</span><br><span class="line">fmt.Println(count)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Counter</span><span class="params">(count *<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    *count++</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="uintptr"><a href="#uintptr" class="headerlink" title="uintptr"></a>uintptr</h3><p>uintptrç”¨æ¥è¿›è¡ŒæŒ‡é’ˆè®¡ç®—ï¼Œå› ä¸ºå®ƒæ˜¯æ•´å‹ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“è®¡ç®—å‡ºä¸‹ä¸€ä¸ªæŒ‡é’ˆæ‰€æŒ‡å‘çš„ä½ç½®ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// uintptr is an integer type that is large enough to hold the bit pattern of  </span></span><br><span class="line"><span class="comment">// any pointer. </span></span><br><span class="line"><span class="keyword">type</span> <span class="keyword">uintptr</span> <span class="keyword">uintptr</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// eg:</span></span><br><span class="line">n := <span class="number">10</span></span><br><span class="line"></span><br><span class="line">b := <span class="built_in">make</span>([]<span class="keyword">int</span>, n)</span><br><span class="line"><span class="keyword">for</span> i:= <span class="number">0</span>;i&lt; n;i++ &#123;</span><br><span class="line">    b[i] = i</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(b)</span><br><span class="line"><span class="comment">// [0 1 2 3 4 5 6 7 8 9]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å–sliceçš„æœ€åçš„ä¸€ä¸ªå…ƒç´  åšoffsetä½ç§»</span></span><br><span class="line">end := unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;b[<span class="number">0</span>])) + <span class="number">9</span> * unsafe.Sizeof(b[<span class="number">0</span>]))</span><br><span class="line"><span class="comment">// ç­‰ä»·äºunsafe.Pointer(&amp;b[9])</span></span><br><span class="line">fmt.Println(*(*<span class="keyword">int</span>)(end))</span><br><span class="line"><span class="comment">// 9</span></span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼šè™½ç„¶uintprä¿å­˜äº†ä¸€ä¸ªæŒ‡é’ˆåœ°å€ï¼Œä½†å®ƒåªæ˜¯ä¸€ä¸ªå€¼ï¼Œä¸å¼•ç”¨ä»»ä½•å¯¹è±¡ã€‚</p>
<ul>
<li>å¦‚æœuintptråœ°å€ç›¸å…³è”å¯¹è±¡ç§»åŠ¨ï¼Œåˆ™å…¶å€¼ä¹Ÿä¸ä¼šæ›´æ–°ã€‚ä¾‹å¦‚goroutineçš„å †æ ˆä¿¡æ¯å‘ç”Ÿå˜åŒ–</li>
<li>uintptråœ°å€å…³è”çš„å¯¹è±¡å¯ä»¥è¢«åƒåœ¾å›æ”¶ã€‚GCä¸è®¤ä¸ºuintptræ˜¯æ´»å¼•ç”¨ï¼Œ<strong>å› æ­¤unitptråœ°å€æŒ‡å‘çš„å¯¹è±¡å¯ä»¥è¢«åƒåœ¾æ”¶é›†ã€‚</strong></li>
</ul>
<p>ä¸€ä¸ªuintptrå¯ä»¥è¢«è½¬æ¢æˆunsafe.Pointer,åŒæ—¶unsafe.Pointerä¹Ÿå¯ä»¥è¢«è½¬æ¢ä¸ºuintptrã€‚å¯ä»¥ä½¿ç”¨ä½¿ç”¨uintptr + offsetè®¡ç®—å‡ºåœ°å€ï¼Œç„¶åä½¿ç”¨unsafe.Pointerè¿›è¡Œè½¬æ¢ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š<code>p = unsafe.Pointer(uintptr(p) + offset)</code></p>
<p><strong>æ€»ç»“</strong>ï¼š<em><strong>uintptr</strong></em>æŒ‡é’ˆç”¨æ¥åšæ•°å­¦è¿ç®—</p>
<h3 id="unsafe-Pointer"><a href="#unsafe-Pointer" class="headerlink" title="unsafe.Pointer"></a>unsafe.Pointer</h3><p>unsafe.Pointeræ˜¯ç‰¹åˆ«å®šä¹‰çš„ä¸€ç§æŒ‡é’ˆç±»å‹,å®ƒå¯ä»¥åŒ…å«ä»»æ„ç±»å‹å˜é‡çš„åœ°å€ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ArbitraryType is here for the purposes of documentation only and is not actually</span></span><br><span class="line"><span class="comment">// part of the unsafe package. It represents the type of an arbitrary Go expression.</span></span><br><span class="line"><span class="comment">// ArbitraryTypeåœ¨è¿™é‡Œä¸æ˜¯unsafeåŒ…çš„å®é™…çš„ä¸€éƒ¨åˆ†ï¼Œä»…ä»…æ˜¯ä¸ºäº†æ–‡æ¡£è®°å½•</span></span><br><span class="line"><span class="keyword">type</span> ArbitraryType <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Pointer *ArbitraryType</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®˜æ–¹æ–‡æ¡£</span></span><br><span class="line">Pointer represents a pointer to an arbitrary <span class="keyword">type</span>. There are four special operations</span><br><span class="line">available <span class="keyword">for</span> <span class="keyword">type</span> Pointer that are not available <span class="keyword">for</span> other types:    <span class="comment">//  Pointerä»£è¡¨äº†ä¸€ä¸ªä»»æ„ç±»å‹çš„æŒ‡é’ˆã€‚Pointerç±»å‹æœ‰å››ç§ç‰¹æ®Šçš„æ“ä½œæ˜¯å…¶ä»–ç±»å‹ä¸èƒ½ä½¿ç”¨çš„:</span></span><br><span class="line">Â  Â - A pointer value of any <span class="keyword">type</span> can be converted to a Pointer.       <span class="comment">//  ä»»æ„ç±»å‹çš„æŒ‡é’ˆå¯ä»¥è¢«è½¬æ¢ä¸ºPointer</span></span><br><span class="line">Â  Â - A Pointer can be converted to a pointer value of any <span class="keyword">type</span>.       <span class="comment">//  Pointerå¯ä»¥è¢«è½¬æ¢ä¸ºä»»åŠ¡ç±»å‹çš„å€¼çš„æŒ‡é’ˆ</span></span><br><span class="line">Â  Â - A <span class="keyword">uintptr</span> can be converted to a Pointer.                         <span class="comment">//  uintptrå¯ä»¥è¢«è½¬æ¢ä¸ºPointer</span></span><br><span class="line">Â  Â - A Pointer can be converted to a <span class="keyword">uintptr</span>.                         <span class="comment">//  Pointerå¯ä»¥è¢«è½¬æ¢ä¸ºuintptr</span></span><br><span class="line">Pointer therefore allows a program to defeat the <span class="keyword">type</span> system and read and write</span><br><span class="line">arbitrary memory. It should be used with extreme care.                <span class="comment">//  å› æ­¤Pointerå…è®¸ç¨‹åºä¸æŒ‰ç±»å‹ç³»ç»Ÿçš„è¦æ±‚æ¥è¯»å†™ä»»æ„çš„å†…å­˜ï¼Œåº”è¯¥éå¸¸å°å¿ƒåœ°ä½¿ç”¨å®ƒã€‚</span></span><br></pre></td></tr></table></figure>

<p><strong>æ€»ç»“</strong>ï¼šæ‰€ä»¥<code>unsafe.Pointer</code>åšçš„ä¸»è¦æ˜¯ç”¨æ¥è¿›è¡Œæ¡¥æ¥ï¼Œç”¨äºä¸åŒç±»å‹çš„æŒ‡é’ˆè¿›è¡Œäº’ç›¸è½¬æ¢ã€‚</p>
<h3 id="unsafe-Pointer-uintpträ¸æ™®é€šæŒ‡é’ˆçš„äº’ç›¸è½¬æ¢"><a href="#unsafe-Pointer-uintpträ¸æ™®é€šæŒ‡é’ˆçš„äº’ç›¸è½¬æ¢" class="headerlink" title="unsafe.Pointer,uintpträ¸æ™®é€šæŒ‡é’ˆçš„äº’ç›¸è½¬æ¢"></a>unsafe.Pointer,uintpträ¸æ™®é€šæŒ‡é’ˆçš„äº’ç›¸è½¬æ¢</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> f <span class="keyword">float64</span> = <span class="number">1.0</span></span><br><span class="line">fmt.Println(Float64bits(f))</span><br><span class="line"><span class="comment">// 4607182418800017408</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Float64bits</span><span class="params">(f <span class="keyword">float64</span>)</span> <span class="title">uint64</span></span> &#123;</span><br><span class="line">	<span class="comment">// (*uint64*) è½¬æ¢æˆuint64æŒ‡é’ˆ åœ¨*å·å–å€¼</span></span><br><span class="line">    <span class="keyword">return</span> *((*<span class="keyword">uint64</span>)(unsafe.Pointer(&amp;f)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="goä¸­å¸¸ç”¨çš„å¸¸é‡"><a href="#goä¸­å¸¸ç”¨çš„å¸¸é‡" class="headerlink" title="goä¸­å¸¸ç”¨çš„å¸¸é‡"></a>goä¸­å¸¸ç”¨çš„å¸¸é‡</h2><ul>
<li><strong>^uintptr(0)</strong>:<ul>
<li>math.MaxUint64</li>
<li>2 çš„ 64 æ¬¡æ–¹å‡ 1</li>
</ul>
</li>
<li><strong>maxAlloc</strong>:<ul>
<li><strong>å…è®¸ç”¨æˆ·åˆ†é…çš„æœ€å¤§è™šæ‹Ÿå†…å­˜ç©ºé—´</strong>ã€‚åœ¨ 64 ä½ï¼Œç†è®ºä¸Šå¯åˆ†é…æœ€å¤§ <code>1 &lt;&lt; heapAddrBits</code> å­—èŠ‚ã€‚åœ¨ 32 ä½ï¼Œæœ€å¤§å¯åˆ†é…å°äº <code>1 &lt;&lt; 32</code> å­—èŠ‚</li>
</ul>
</li>
</ul>
<h2 id="sliceæºç é˜…è¯»"><a href="#sliceæºç é˜…è¯»" class="headerlink" title="sliceæºç é˜…è¯»"></a><strong>slice</strong>æºç é˜…è¯»</h2><ul>
<li>sliceæ•°æ®ç»“æ„</li>
</ul>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span> &#123;  </span><br><span class="line"> <span class="comment">// Pointer æ˜¯æŒ‡å‘ä¸€ä¸ªæ•°ç»„çš„æŒ‡é’ˆ</span></span><br><span class="line"> array unsafe.Pointer  </span><br><span class="line"> <span class="comment">// len ä»£è¡¨å½“å‰åˆ‡ç‰‡çš„é•¿åº¦</span></span><br><span class="line"> <span class="built_in">len</span>   <span class="keyword">int</span>  </span><br><span class="line"> <span class="comment">// cap æ˜¯å½“å‰åˆ‡ç‰‡çš„å®¹é‡</span></span><br><span class="line"> <span class="built_in">cap</span>   <span class="keyword">int</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åˆ›å»ºåˆ‡ç‰‡"><a href="#åˆ›å»ºåˆ‡ç‰‡" class="headerlink" title="åˆ›å»ºåˆ‡ç‰‡"></a>åˆ›å»ºåˆ‡ç‰‡</h3><p>make å‡½æ•°å…è®¸åœ¨è¿è¡ŒæœŸåŠ¨æ€æŒ‡å®šæ•°ç»„é•¿åº¦ï¼Œç»•å¼€äº†æ•°ç»„ç±»å‹å¿…é¡»ä½¿ç”¨ç¼–è¯‘æœŸå¸¸é‡çš„é™åˆ¶ã€‚</p>
<p>åˆ›å»ºåˆ‡ç‰‡æœ‰ä¸¤ç§å½¢å¼ï¼Œmake åˆ›å»ºåˆ‡ç‰‡ï¼Œç©ºåˆ‡ç‰‡ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¯¥å‡½æ•°ä¼ å…¥éœ€è¦åˆå§‹åŒ–çš„åˆ‡ç‰‡çš„ç±»å‹ï¼Œé•¿åº¦ä»¥åŠå®¹é‡ï¼Œè¿”å›çš„æŒ‡é’ˆä¼šé€šè¿‡è°ƒç”¨æ–¹ç»„å»ºæˆä¸€ä¸ªå®Œæˆçš„sliceç»“æ„ä½“</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeslice</span><span class="params">(et *_type, <span class="built_in">len</span>, <span class="built_in">cap</span> <span class="keyword">int</span>)</span> <span class="title">unsafe</span>.<span class="title">Pointer</span></span> &#123;</span><br><span class="line"><span class="comment">// åˆ¤æ–­ç±»å‹ï¼Œå’Œå®¹é‡çš„ä¹˜ç§¯ä¼šä¸ä¼šè¶…è¿‡å¯åˆ†é…å†…å­˜çš„å¤§å°ï¼Œä»¥åŠé•¿åº¦æ˜¯å¦ä¸º0å’Œå®¹é‡æ˜¯å¦å°äºé•¿åº¦</span></span><br><span class="line"> mem, overflow := math.MulUintptr(et.size, <span class="keyword">uintptr</span>(<span class="built_in">cap</span>))  </span><br><span class="line"> <span class="keyword">if</span> overflow || mem &gt; maxAlloc || <span class="built_in">len</span> &lt; <span class="number">0</span> || <span class="built_in">len</span> &gt; <span class="built_in">cap</span> &#123;  </span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> Produce a &#x27;len out of range&#x27; error instead of a  </span></span><br><span class="line">  <span class="comment">// &#x27;cap out of range&#x27; error when someone does make([]T, bignumber).  // &#x27;cap out of range&#x27; is true too, but since the cap is only being  // supplied implicitly, saying len is clearer.  // See golang.org/issue/4085.  mem, overflow := math.MulUintptr(et.size, uintptr(len))  </span></span><br><span class="line">  <span class="keyword">if</span> overflow || mem &gt; maxAlloc || <span class="built_in">len</span> &lt; <span class="number">0</span> &#123;  </span><br><span class="line">   panicmakeslicelen()  </span><br><span class="line">  &#125;  </span><br><span class="line">  panicmakeslicecap()  </span><br><span class="line"> &#125;  </span><br><span class="line">  <span class="comment">// å¦‚æœéƒ½æ­£å¸¸ï¼Œåˆ™è°ƒç”¨æ­¤å‡½æ•°ç”³è¯·è¿”å›ä¸€ä¸ªè¿ç»­ åˆ‡ç‰‡ä¸­å…ƒç´ å¤§å°Ã—åˆ‡ç‰‡å®¹é‡ é•¿åº¦çš„å†…å­˜ç©ºé—´çš„æŒ‡é’ˆ</span></span><br><span class="line"> <span class="keyword">return</span> mallocgc(mem, et, <span class="literal">true</span>)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="nilå’Œç©ºåˆ‡ç‰‡"><a href="#nilå’Œç©ºåˆ‡ç‰‡" class="headerlink" title="nilå’Œç©ºåˆ‡ç‰‡"></a>nilå’Œç©ºåˆ‡ç‰‡</h3><p>ç©ºåˆ‡ç‰‡å’Œ nil åˆ‡ç‰‡çš„åŒºåˆ«åœ¨äºï¼Œç©ºåˆ‡ç‰‡æŒ‡å‘çš„åœ°å€ä¸æ˜¯nilï¼ŒæŒ‡å‘çš„æ˜¯ä¸€ä¸ªå†…å­˜åœ°å€ï¼Œä½†æ˜¯å®ƒæ²¡æœ‰åˆ†é…ä»»ä½•å†…å­˜ç©ºé—´ï¼Œå³åº•å±‚å…ƒç´ åŒ…å«0ä¸ªå…ƒç´ ã€‚</p>
<h3 id="åˆ‡ç‰‡çš„æ‰©å®¹"><a href="#åˆ‡ç‰‡çš„æ‰©å®¹" class="headerlink" title="åˆ‡ç‰‡çš„æ‰©å®¹"></a>åˆ‡ç‰‡çš„æ‰©å®¹</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">growslice</span><span class="params">(et *_type, old slice, <span class="built_in">cap</span> <span class="keyword">int</span>)</span> <span class="title">slice</span></span> &#123;</span><br><span class="line">	<span class="comment">// å¦‚æœéœ€æ±‚çš„å®¹é‡å°äºå°±å®¹é‡åˆ™æŠ¥é”™</span></span><br><span class="line">  <span class="comment">// ç†è®ºä¸Šæ¥è®²ä¸åº”è¯¥å‡ºç°è¿™ä¸ªé—®é¢˜</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">cap</span> &lt; old.<span class="built_in">cap</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(errorString(<span class="string">&quot;growslice: cap out of range&quot;</span>))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// append æ²¡æ³•åˆ›å»ºä¸€ä¸ªnilæŒ‡é’ˆçš„ä½†æ˜¯lenä¸ä¸º0çš„åˆ‡ç‰‡</span></span><br><span class="line">	<span class="keyword">if</span> et.size == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> slice&#123;unsafe.Pointer(&amp;zerobase), old.<span class="built_in">len</span>, <span class="built_in">cap</span>&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	newcap := old.<span class="built_in">cap</span></span><br><span class="line">	doublecap := newcap + newcap</span><br><span class="line">  <span class="comment">// å¦‚æœéœ€æ±‚å®¹é‡å¤§äºåŒå€çš„æ—§å®¹é‡é‚£å°±ç›´æ¥ä½¿ç”¨éœ€æ±‚å®¹é‡</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">cap</span> &gt; doublecap &#123;</span><br><span class="line">		newcap = <span class="built_in">cap</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰lenå°äº1024åˆ™å®¹é‡ç›´æ¥ç¿»å€ï¼Œå¦åˆ™æŒ‰ç…§1.25å€å»é€’å¢ç›´åˆ°æ»¡è¶³éœ€æ±‚å®¹é‡</span></span><br><span class="line">		<span class="keyword">if</span> old.<span class="built_in">len</span> &lt; <span class="number">1024</span> &#123;</span><br><span class="line">			newcap = doublecap</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> <span class="number">0</span> &lt; newcap &amp;&amp; newcap &lt; <span class="built_in">cap</span> &#123;</span><br><span class="line">				newcap += newcap / <span class="number">4</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> newcap &lt;= <span class="number">0</span> &#123;</span><br><span class="line">				newcap = <span class="built_in">cap</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> overflow <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">var</span> lenmem, newlenmem, capmem <span class="keyword">uintptr</span></span><br><span class="line"><span class="comment">// åœ¨æ‰©å®¹æ—¶ä¸èƒ½å•å•æŒ‰ç…§lenæ¥åˆ¤æ–­æ‰©å®¹æ‰€éœ€è¦çš„å†…å­˜é•¿åº¦</span></span><br><span class="line"><span class="comment">// è¿˜è¦æ ¹æ®åˆ‡ç‰‡çš„å…ƒç´ ç±»å‹å»è¿›è¡Œå†…å­˜å¯¹é½</span></span><br><span class="line"><span class="comment">// å½“å…ƒç´ çš„å ç”¨å­—èŠ‚æ•°ä¸º1ï¼Œ8 æˆ–è€…2çš„å€æ•°æ—¶ä¼šè¿›è¡Œå†…å­˜å¯¹å¯¹é½</span></span><br><span class="line"><span class="comment">// å†…å­˜å¯¹é½ç­–ç•¥æŒ‰ç…§å‘ä¸Šå–æ•´æ–¹å¼è¿›è¡Œ</span></span><br><span class="line"><span class="comment">// å–æ•´çš„ç›®æ ‡æ—¶goå†…å­˜åˆ†é…ç­–ç•¥ä¸­67ä¸ªclassåˆ†é¡µä¸­çš„å¤§å°è¿›è¡Œå–æ•´</span></span><br><span class="line">	<span class="keyword">switch</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> et.size == <span class="number">1</span>:</span><br><span class="line">		lenmem = <span class="keyword">uintptr</span>(old.<span class="built_in">len</span>)</span><br><span class="line">		newlenmem = <span class="keyword">uintptr</span>(<span class="built_in">cap</span>)</span><br><span class="line">		capmem = roundupsize(<span class="keyword">uintptr</span>(newcap))</span><br><span class="line">		overflow = <span class="keyword">uintptr</span>(newcap) &gt; maxAlloc</span><br><span class="line">		newcap = <span class="keyword">int</span>(capmem)</span><br><span class="line">	<span class="keyword">case</span> et.size == sys.PtrSize:</span><br><span class="line">		lenmem = <span class="keyword">uintptr</span>(old.<span class="built_in">len</span>) * sys.PtrSize</span><br><span class="line">		newlenmem = <span class="keyword">uintptr</span>(<span class="built_in">cap</span>) * sys.PtrSize</span><br><span class="line">		capmem = roundupsize(<span class="keyword">uintptr</span>(newcap) * sys.PtrSize)</span><br><span class="line">		overflow = <span class="keyword">uintptr</span>(newcap) &gt; maxAlloc/sys.PtrSize</span><br><span class="line">		newcap = <span class="keyword">int</span>(capmem / sys.PtrSize)</span><br><span class="line">	<span class="keyword">case</span> isPowerOfTwo(et.size):</span><br><span class="line">		<span class="keyword">var</span> shift <span class="keyword">uintptr</span></span><br><span class="line">		<span class="keyword">if</span> sys.PtrSize == <span class="number">8</span> &#123;</span><br><span class="line">			<span class="comment">// Mask shift for better code generation.</span></span><br><span class="line">			shift = <span class="keyword">uintptr</span>(sys.Ctz64(<span class="keyword">uint64</span>(et.size))) &amp; <span class="number">63</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			shift = <span class="keyword">uintptr</span>(sys.Ctz32(<span class="keyword">uint32</span>(et.size))) &amp; <span class="number">31</span></span><br><span class="line">		&#125;</span><br><span class="line">		lenmem = <span class="keyword">uintptr</span>(old.<span class="built_in">len</span>) &lt;&lt; shift</span><br><span class="line">		newlenmem = <span class="keyword">uintptr</span>(<span class="built_in">cap</span>) &lt;&lt; shift</span><br><span class="line">		capmem = roundupsize(<span class="keyword">uintptr</span>(newcap) &lt;&lt; shift)</span><br><span class="line">		overflow = <span class="keyword">uintptr</span>(newcap) &gt; (maxAlloc &gt;&gt; shift)</span><br><span class="line">		newcap = <span class="keyword">int</span>(capmem &gt;&gt; shift)</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		lenmem = <span class="keyword">uintptr</span>(old.<span class="built_in">len</span>) * et.size</span><br><span class="line">		newlenmem = <span class="keyword">uintptr</span>(<span class="built_in">cap</span>) * et.size</span><br><span class="line">		capmem, overflow = math.MulUintptr(et.size, <span class="keyword">uintptr</span>(newcap))</span><br><span class="line">		capmem = roundupsize(capmem)</span><br><span class="line">		newcap = <span class="keyword">int</span>(capmem / et.size)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœæ‰€éœ€è¦çš„å†…å­˜è¶…è¿‡äº†æœ€å¤§å¯åˆ†é…å†…å­˜åˆ™panic</span></span><br><span class="line">	<span class="keyword">if</span> overflow || capmem &gt; maxAlloc &#123;</span><br><span class="line">		<span class="built_in">panic</span>(errorString(<span class="string">&quot;growslice: cap out of range&quot;</span>))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> p unsafe.Pointer</span><br><span class="line">  <span class="comment">// å¦‚æœå½“å‰å…ƒç´ ç±»å‹ä¸æ˜¯æŒ‡é’ˆï¼Œåˆ™ä¼šå°†è¶…å‡ºåˆ‡ç‰‡å½“å‰é•¿åº¦çš„ä½ç½®æ¸…ç©º</span></span><br><span class="line">  <span class="comment">// å¹¶åœ¨æœ€åä½¿ç”¨ å°†åŸæ•°ç»„å†…å­˜ä¸­çš„å†…å®¹æ‹·è´åˆ°æ–°ç”³è¯·çš„å†…å­˜ä¸­ã€‚</span></span><br><span class="line">	<span class="keyword">if</span> et.ptrdata == <span class="number">0</span> &#123;</span><br><span class="line">		p = mallocgc(capmem, <span class="literal">nil</span>, <span class="literal">false</span>)</span><br><span class="line">		memclrNoHeapPointers(add(p, newlenmem), capmem-newlenmem)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯æŒ‡é’ˆä¼šæ ¹æ®è¿›è¡Œgcæ–¹é¢å¯¹å…¶è¿›è¡ŒåŠ ä»¥ä¿æŠ¤ä»¥å…ç©ºæŒ‡é’ˆåœ¨åˆ†é…æœŸé—´è¢«gcå›æ”¶</span></span><br><span class="line">		p = mallocgc(capmem, et, <span class="literal">true</span>)</span><br><span class="line">		<span class="keyword">if</span> lenmem &gt; <span class="number">0</span> &amp;&amp; writeBarrier.enabled &#123;</span><br><span class="line">			bulkBarrierPreWriteSrcOnly(<span class="keyword">uintptr</span>(p), <span class="keyword">uintptr</span>(old.array), lenmem-et.size+et.ptrdata)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	memmove(p, old.array, lenmem)</span><br><span class="line">	<span class="comment">//è¯¥å‡½æ•°æœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªæ–°çš„åˆ‡ç‰‡</span></span><br><span class="line">	<span class="keyword">return</span> slice&#123;p, old.<span class="built_in">len</span>, newcap&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Go ä¸­åˆ‡ç‰‡æ‰©å®¹çš„ç­–ç•¥æ˜¯è¿™æ ·çš„ï¼š</p>
<ul>
<li>  é¦–å…ˆåˆ¤æ–­ï¼Œå¦‚æœæ–°ç”³è¯·å®¹é‡ï¼ˆcapï¼‰å¤§äº2å€çš„æ—§å®¹é‡ï¼ˆold.capï¼‰ï¼Œæœ€ç»ˆå®¹é‡ï¼ˆnewcapï¼‰å°±æ˜¯æ–°ç”³è¯·çš„å®¹é‡ï¼ˆcapï¼‰</li>
<li>  å¦åˆ™åˆ¤æ–­ï¼Œå¦‚æœæ—§åˆ‡ç‰‡çš„é•¿åº¦å°äº1024ï¼Œåˆ™æœ€ç»ˆå®¹é‡(newcap)å°±æ˜¯æ—§å®¹é‡(old.cap)çš„ä¸¤å€ï¼Œå³ï¼ˆnewcap=doublecapï¼‰</li>
<li>  å¦åˆ™åˆ¤æ–­ï¼Œå¦‚æœæ—§åˆ‡ç‰‡é•¿åº¦å¤§äºç­‰äº1024ï¼Œåˆ™æœ€ç»ˆå®¹é‡ï¼ˆnewcapï¼‰ä»æ—§å®¹é‡ï¼ˆold.capï¼‰å¼€å§‹å¾ªç¯å¢åŠ åŸæ¥çš„ 1/4ï¼Œå³ï¼ˆnewcap=old.cap,for {newcap += newcap/4}ï¼‰ç›´åˆ°æœ€ç»ˆå®¹é‡ï¼ˆnewcapï¼‰å¤§äºç­‰äºæ–°ç”³è¯·çš„å®¹é‡(cap)ï¼Œå³ï¼ˆnewcap &gt;= capï¼‰</li>
<li>  å¦‚æœæœ€ç»ˆå®¹é‡ï¼ˆcapï¼‰è®¡ç®—å€¼æº¢å‡ºï¼Œåˆ™æœ€ç»ˆå®¹é‡ï¼ˆcapï¼‰å°±æ˜¯æ–°ç”³è¯·å®¹é‡ï¼ˆcapï¼‰</li>
</ul>
<p><del>å¦‚æœåˆ‡ç‰‡çš„å®¹é‡å°äº 1024 ä¸ªå…ƒç´ ï¼Œäºæ˜¯æ‰©å®¹çš„æ—¶å€™å°±ç¿»å€å¢åŠ å®¹é‡ã€‚ä¸Šé¢é‚£ä¸ªä¾‹å­ä¹ŸéªŒè¯äº†è¿™ä¸€æƒ…å†µï¼Œæ€»å®¹é‡ä»åŸæ¥çš„4ä¸ªç¿»å€åˆ°ç°åœ¨çš„8ä¸ªã€‚</del></p>
<p><del>ä¸€æ—¦å…ƒç´ ä¸ªæ•°è¶…è¿‡ 1024 ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆå¢é•¿å› å­å°±å˜æˆ 1.25 ï¼Œå³æ¯æ¬¡å¢åŠ åŸæ¥å®¹é‡çš„å››åˆ†ä¹‹ä¸€ã€‚</del></p>
<p><strong>æ³¨æ„ï¼šæ‰©å®¹æ‰©å¤§çš„å®¹é‡éƒ½æ˜¯é’ˆå¯¹åŸæ¥çš„å®¹é‡è€Œè¨€çš„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹åŸæ¥æ•°ç»„çš„é•¿åº¦è€Œè¨€çš„ã€‚</strong></p>
<p>è¿™ç§æƒ…å†µï¼Œç”±äºåŸæ•°ç»„è¿˜æœ‰å®¹é‡å¯ä»¥æ‰©å®¹ï¼Œæ‰€ä»¥æ‰§è¡Œ append() æ“ä½œä»¥åï¼Œä¼šåœ¨åŸæ•°ç»„ä¸Šç›´æ¥æ“ä½œï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µä¸‹ï¼Œæ‰©å®¹ä»¥åçš„æ•°ç»„è¿˜æ˜¯æŒ‡å‘åŸæ¥çš„æ•°ç»„ã€‚</p>
<h3 id="åˆ‡ç‰‡çš„æ‹·è´"><a href="#åˆ‡ç‰‡çš„æ‹·è´" class="headerlink" title="åˆ‡ç‰‡çš„æ‹·è´"></a>åˆ‡ç‰‡çš„æ‹·è´</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">slicecopy</span><span class="params">(toPtr unsafe.Pointer, toLen <span class="keyword">int</span>, fmPtr unsafe.Pointer, fmLen <span class="keyword">int</span>, width <span class="keyword">uintptr</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> fmLen == <span class="number">0</span> || toLen == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	n := fmLen</span><br><span class="line">	<span class="keyword">if</span> toLen &lt; n &#123;</span><br><span class="line">		n = toLen</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> width == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> n</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	size := <span class="keyword">uintptr</span>(n) * width</span><br><span class="line">	<span class="keyword">if</span> size == <span class="number">1</span> &#123;  </span><br><span class="line">    <span class="comment">// å¦‚æœå°±1ä¸ªå…ƒç´  ç›´æ¥èµ‹å€¼è¿‡å»å°±å¥½äº†</span></span><br><span class="line">		*(*<span class="keyword">byte</span>)(toPtr) = *(*<span class="keyword">byte</span>)(fmPtr)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ç›´æ¥è¿›è¡Œå†…å­˜çš„æ‹·è´ï¼Œå¦‚æœsliceæ•°æ®é‡è¿‡å¤§å°†ä¼šå½±å“æ€§èƒ½</span></span><br><span class="line">		memmove(toPtr, fmPtr, size)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> n</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åˆ‡ç‰‡çš„æ·±æ‹·è´å’Œæµ…æ‹·è´"><a href="#åˆ‡ç‰‡çš„æ·±æ‹·è´å’Œæµ…æ‹·è´" class="headerlink" title="åˆ‡ç‰‡çš„æ·±æ‹·è´å’Œæµ…æ‹·è´"></a>åˆ‡ç‰‡çš„æ·±æ‹·è´å’Œæµ…æ‹·è´</h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æµ…æ‹·è´</span></span><br><span class="line">slice1 := []<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125; </span><br><span class="line">slice2 := slice1 </span><br><span class="line">fmt.Println(slice1) </span><br><span class="line">fmt.Println(slice2)</span><br><span class="line"><span class="comment">//åŒæ—¶æ”¹å˜ä¸¤ä¸ªæ•°ç»„ </span></span><br><span class="line">slice1[<span class="number">1</span>]=<span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·±æ‹·è´</span></span><br><span class="line">slice1 := []<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;</span><br><span class="line">slice2 := <span class="built_in">make</span>([]<span class="keyword">int</span>,<span class="number">5</span>,<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">copy</span>(slice2,slice1)</span><br><span class="line">fmt.Println(slice1)</span><br><span class="line">fmt.Println(slice2)</span><br><span class="line">slice1[<span class="number">1</span>]=<span class="number">100</span>  <span class="comment">//åªä¼šå½±å“slice1</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>copyå‡½æ•°</strong><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// The copy built-in function copies elements from a source slice into a  </span></span><br><span class="line"><span class="comment">// destination slice. (As a special case, it also will copy bytes from a  </span></span><br><span class="line"><span class="comment">// string to a slice of bytes.) The source and destination may overlap. Copy  </span></span><br><span class="line"><span class="comment">// returns the number of elements copied, which will be the minimum of  </span></span><br><span class="line"><span class="comment">// len(src) and len(dst).  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">copy</span><span class="params">(dst, src []Type)</span> <span class="title">int</span></span></span><br><span class="line"><span class="comment">// ## åˆ‡ç‰‡ dst éœ€è¦å…ˆåˆå§‹åŒ–é•¿åº¦</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// ## æºåˆ‡ç‰‡ä¸­å…ƒç´ ç±»å‹ä¸ºå¼•ç”¨ç±»å‹æ—¶ï¼Œæ‹·è´çš„æ˜¯å¼•ç”¨</span></span><br></pre></td></tr></table></figure></li>
<li>  å¦‚æœ dst é•¿åº¦å°äº src çš„é•¿åº¦ï¼Œåˆ™ copy éƒ¨åˆ†ï¼›</li>
<li>  å¦‚æœå¤§äºï¼Œåˆ™å…¨éƒ¨æ‹·è´è¿‡æ¥ï¼Œåªæ˜¯æ²¡å æ»¡ dst çš„å‘ä½è€Œå·²ï¼›</li>
<li>  ç›¸ç­‰æ—¶åˆšå¥½ä¸å¤šä¸å°‘ copy è¿‡æ¥ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>è¯­è¨€å­¦ä¹ </category>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
        <tag>æºç é˜…è¯»</tag>
      </tags>
  </entry>
  <entry>
    <title>golangå¹¶æŸ¥é›†</title>
    <url>/2022/07/27/golang%E5%B9%B6%E6%9F%A5%E9%9B%86/</url>
    <content><![CDATA[<hr>
<p>å¹¶æŸ¥é›†è¢«å¾ˆå¤šOIerè®¤ä¸ºæ˜¯æœ€ç®€æ´è€Œä¼˜é›…çš„æ•°æ®ç»“æ„ä¹‹ä¸€ï¼Œä¸»è¦ç”¨äºè§£å†³ä¸€äº›<strong>å…ƒç´ åˆ†ç»„</strong>çš„é—®é¢˜ã€‚å®ƒç®¡ç†ä¸€ç³»åˆ—<strong>ä¸ç›¸äº¤çš„é›†åˆ</strong>ï¼Œå¹¶æ”¯æŒä¸¤ç§æ“ä½œï¼š</p>
<ul>
<li>  <strong>åˆå¹¶</strong>ï¼ˆUnionï¼‰ï¼šæŠŠä¸¤ä¸ªä¸ç›¸äº¤çš„é›†åˆåˆå¹¶ä¸ºä¸€ä¸ªé›†åˆã€‚</li>
<li>  <strong>æŸ¥è¯¢</strong>ï¼ˆFindï¼‰ï¼šæŸ¥è¯¢ä¸¤ä¸ªå…ƒç´ æ˜¯å¦åœ¨åŒä¸€ä¸ªé›†åˆä¸­ã€‚<br><a href="https://zhuanlan.zhihu.com/p/93647900">å¹¶æŸ¥é›†-çŸ¥ä¹</a></li>
</ul>
<span id="more"></span>
<!-- toc -->
<h2 id="å¹¶æŸ¥é›†ç®€ä»‹"><a href="#å¹¶æŸ¥é›†ç®€ä»‹" class="headerlink" title="å¹¶æŸ¥é›†ç®€ä»‹"></a>å¹¶æŸ¥é›†ç®€ä»‹</h2><p><strong>å‚è€ƒæ–‡ç« </strong></p>
<p>å½“ç„¶ï¼Œè¿™æ ·çš„å®šä¹‰æœªå…å¤ªè¿‡å­¦æœ¯åŒ–ï¼Œçœ‹å®Œåææ€•ä¸å¤ªèƒ½ç†è§£å®ƒå…·ä½“æœ‰ä»€ä¹ˆç”¨ã€‚æ‰€ä»¥æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å¹¶æŸ¥é›†æœ€ç›´æ¥çš„ä¸€ä¸ªåº”ç”¨åœºæ™¯ï¼š<strong>äº²æˆšé—®é¢˜</strong>ã€‚</p>
<p>è¿™æ˜¯ä¸€ä¸ª<strong>æ ‘</strong>çŠ¶çš„ç»“æ„ï¼Œè¦å¯»æ‰¾é›†åˆçš„ä»£è¡¨å…ƒç´ ï¼Œåªéœ€è¦ä¸€å±‚ä¸€å±‚å¾€ä¸Šè®¿é—®<strong>çˆ¶èŠ‚ç‚¹</strong>ï¼ˆå›¾ä¸­ç®­å¤´æ‰€æŒ‡çš„åœ†ï¼‰ï¼Œç›´è¾¾æ ‘çš„<strong>æ ¹èŠ‚ç‚¹</strong>ï¼ˆå›¾ä¸­æ©™è‰²çš„åœ†ï¼‰å³å¯ã€‚æ ¹èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æ˜¯å®ƒè‡ªå·±ã€‚</p>
<p><img src="/2022/07/27/golang%E5%B9%B6%E6%9F%A5%E9%9B%86/20220726164121.png" alt="å¹¶æŸ¥é›†ç»“æ„"></p>
<h2 id="å¹¶æŸ¥é›†golangå®ç°"><a href="#å¹¶æŸ¥é›†golangå®ç°" class="headerlink" title="å¹¶æŸ¥é›†golangå®ç°"></a>å¹¶æŸ¥é›†golangå®ç°</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¾“å…¥:</span><br><span class="line">å…³ç³»</span><br><span class="line">[2,3],[1,3],[4,2]</span><br><span class="line">è¾“å‡ºï¼š</span><br><span class="line">1ï¼ˆ1ç»„å…³ç³»ï¼‰</span><br></pre></td></tr></table></figure>

<h3 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h3><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//leetcode submit region begin(Prohibit modification and deletion)  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">numIslands</span><span class="params">(grid [][]<span class="keyword">byte</span>)</span> <span class="title">int</span></span> &#123;  </span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//leetcode submit region end(Prohibit modification and deletion)  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> DisjointSet <span class="keyword">struct</span> &#123;  </span><br><span class="line">   fa     []<span class="keyword">int</span> <span class="comment">// æ¯ä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹, åˆå§‹åŒ–æˆåŠŸæ—¶ä¸ºè‡ªå·±  </span></span><br><span class="line">   height []<span class="keyword">int</span> <span class="comment">// è¯¥èŠ‚ç‚¹çš„é«˜åº¦  </span></span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// åˆå§‹åŒ–  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *DisjointSet)</span> <span class="title">init</span><span class="params">(n <span class="keyword">int</span>)</span></span> &#123;  </span><br><span class="line">   d.fa = <span class="built_in">make</span>([]<span class="keyword">int</span>, n+<span class="number">1</span>)  </span><br><span class="line">   d.height = <span class="built_in">make</span>([]<span class="keyword">int</span>, n+<span class="number">1</span>)  </span><br><span class="line">   <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= n; i++ &#123;  </span><br><span class="line">      d.fa[i] = i <span class="comment">// è¡¨ç¤ºè‡ªå·±ä¸ºä¸€ä¸ªé›†åˆ  </span></span><br><span class="line">      d.height[i] = <span class="number">1</span>  </span><br><span class="line">   &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// æŸ¥æ‰¾çˆ¶èŠ‚ç‚¹  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *DisjointSet)</span> <span class="title">find</span><span class="params">(i <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;  </span><br><span class="line">   <span class="comment">// çˆ¶èŠ‚ç‚¹æ˜¯è‡ªå·±åˆ™ä»£è¡¨æ‰¾åˆ°  </span></span><br><span class="line">   <span class="keyword">if</span> i == d.fa[i] &#123;  </span><br><span class="line">      <span class="keyword">return</span> i  </span><br><span class="line">   &#125;  </span><br><span class="line">   <span class="comment">// é€’å½’æŸ¥æ‰¾  </span></span><br><span class="line">   d.fa[i] = d.find(d.fa[i])  </span><br><span class="line">   <span class="comment">// ä¼˜åŒ–è·¯å¾„(é™ä½æ ‘çš„é«˜åº¦)  </span></span><br><span class="line">   <span class="keyword">return</span> d.fa[i]  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// åˆå¹¶ä¸¤ä¸ªé›†åˆ  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *DisjointSet)</span> <span class="title">merge</span><span class="params">(i, j <span class="keyword">int</span>)</span></span> &#123;  </span><br><span class="line">   <span class="comment">// è¿™é‡Œæœ‰ä¸ªä¼˜åŒ–, è°åˆå¹¶è°, çŸ®çš„å¾€é«˜åˆå¹¶  </span></span><br><span class="line">   f1, f2 := d.find(i), d.find(j)  </span><br><span class="line">   h1, h2 := d.height[f1], d.height[f2]  </span><br><span class="line">   <span class="keyword">if</span> h1 &lt; h2 &#123;  </span><br><span class="line">      d.fa[f1] = f2  </span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">      d.fa[f2] = f1  </span><br><span class="line">   &#125;  </span><br><span class="line">   <span class="keyword">if</span> h1 == h2 &amp;&amp; f1 != f2 &#123;  </span><br><span class="line">      d.height[f1]++  </span><br><span class="line">   &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// è®¡ç®—é›†åˆä¸ªæ•°  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *DisjointSet)</span> <span class="title">count</span><span class="params">()</span> <span class="params">(res <span class="keyword">int</span>)</span></span> &#123;  </span><br><span class="line">   <span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="built_in">len</span>(d.fa); i++ &#123;  </span><br><span class="line">      <span class="keyword">if</span> d.fa[i] == i &#123;  </span><br><span class="line">         res++  </span><br><span class="line">      &#125;  </span><br><span class="line">   &#125;  </span><br><span class="line">   <span class="keyword">return</span> res  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">   parent := <span class="built_in">new</span>(DisjointSet)  </span><br><span class="line">   parent.init(<span class="number">10</span>)  </span><br><span class="line">   parent.merge(<span class="number">1</span>, <span class="number">2</span>)  </span><br><span class="line">   parent.merge(<span class="number">2</span>, <span class="number">3</span>)  </span><br><span class="line">   parent.merge(<span class="number">1</span>, <span class="number">3</span>)  </span><br><span class="line">   fmt.Println(parent.count())  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>æ•°æ®ç»“æ„&amp;ç®—æ³•</category>
        <category>æ•°æ®ç»“æ„</category>
        <category>å¹¶æŸ¥é›†</category>
      </categories>
      <tags>
        <tag>golang</tag>
        <tag>ç®—æ³•</tag>
      </tags>
  </entry>
</search>
